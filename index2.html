<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <title>èŠ±è“®è»ŠéšŠ - ä¹˜å®¢å«è»Š</title>
  
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
  <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAIxc6PEhHgUs_A9lyRUg8dNbmwOpSamY8"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

  <style>
    /* --- UI è¨­è¨ˆç¸½ç›£ï¼šä¹˜å®¢å°ˆç”¨ä»‹é¢ --- */
    body { margin: 0; padding: 0; font-family: -apple-system, "Microsoft JhengHei", sans-serif; overflow: hidden; background: #f5f5f5; }
    #map { width: 100vw; height: 100vh; }

    /* 1. å³ä¸Šè§’å®¢æœæŒ‰éˆ• (ä»¿å¸æ©Ÿç«¯ç©ºè»Šç¶ éˆ•) */
    .service-btn {
        position: absolute; top: 15px; right: 15px; z-index: 20;
        width: 65px; height: 65px; border-radius: 50%;
        background: linear-gradient(145deg, #2ecc71, #27ae60); /* å¸æ©Ÿç«¯ç¶ è‰² */
        color: white; border: 3px solid rgba(255,255,255,0.3);
        box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        display: flex; flex-direction: column; justify-content: center; align-items: center;
        text-decoration: none; transition: transform 0.1s;
    }
    .service-btn:active { transform: scale(0.95); }
    .service-btn i { font-size: 24px; margin-bottom: 2px; }
    .service-btn span { font-size: 12px; font-weight: bold; }

    /* 2. åº•éƒ¨æ»‘å‹•é¸å–® (Carousel) */
    #driver-carousel {
        position: absolute; bottom: 20px; left: 0; width: 100%;
        display: flex; gap: 15px; padding: 10px 20px; box-sizing: border-box;
        overflow-x: auto; scroll-snap-type: x mandatory; /* æ»‘å‹•æ™‚æœƒè‡ªå‹•å°é½Š */
        z-index: 20; -webkit-overflow-scrolling: touch; /* iOS æ»‘å‹•å„ªåŒ– */
        /* éš±è—æ»¾å‹•æ¢ */
        scrollbar-width: none; 
    }
    #driver-carousel::-webkit-scrollbar { display: none; }

    /* å¸æ©Ÿå¡ç‰‡ */
    .driver-card {
        flex: 0 0 85%; /* æ¯å¼µå¡ç‰‡ä½”å¯¬åº¦ 85%ï¼Œè®“ä½¿ç”¨è€…çœ‹åˆ°ä¸‹ä¸€å¼µçš„ä¸€è§’ */
        max-width: 350px;
        background: white; border-radius: 16px;
        padding: 15px; box-sizing: border-box;
        box-shadow: 0 5px 20px rgba(0,0,0,0.15);
        scroll-snap-align: center; /* æ»‘å‹•å°é½Šé» */
        display: flex; align-items: center; justify-content: space-between;
        transition: transform 0.2s;
    }
    .driver-card:active { transform: scale(0.98); }

    /* å¡ç‰‡å…§å®¹ */
    .d-info { display: flex; align-items: center; }
    .d-avatar { 
        width: 50px; height: 50px; background: #f0f2f5; 
        border-radius: 50%; color: #555; 
        display: flex; justify-content: center; align-items: center; 
        font-size: 24px; margin-right: 12px; 
    }
    .d-text h3 { margin: 0; font-size: 18px; color: #333; }
    .d-text p { margin: 4px 0 0 0; font-size: 14px; color: #666; display: flex; align-items: center; }
    .status-badge { 
        font-size: 12px; padding: 2px 6px; border-radius: 4px; margin-left: 5px; 
    }
    .badge-queue { background: #e3f2fd; color: #3498db; } /* æ’ç­è— */
    .badge-empty { background: #e8f5e9; color: #2ecc71; } /* ç©ºè»Šç¶  */

    /* å‘¼å«æŒ‰éˆ• (åœ“å½¢é›»è©±) */
    .call-btn {
        width: 45px; height: 45px; border-radius: 50%;
        background: linear-gradient(135deg, #00C853, #64DD17);
        color: white; display: flex; justify-content: center; align-items: center;
        text-decoration: none; font-size: 18px; box-shadow: 0 4px 10px rgba(46, 204, 113, 0.3);
    }

    /* ç©ºç‹€æ…‹æç¤º */
    #empty-state {
        position: absolute; bottom: 30px; left: 50%; transform: translateX(-50%);
        background: rgba(0,0,0,0.7); color: white; padding: 12px 25px;
        border-radius: 30px; font-size: 16px; font-weight: bold;
        display: none; white-space: nowrap; z-index: 20;
    }

    /* é ‚éƒ¨ç‹€æ…‹åˆ— (ç°¡æ˜“ç‰ˆ) */
    #top-status {
        position: absolute; top: 20px; left: 20px; 
        background: white; padding: 8px 15px; border-radius: 20px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1); font-size: 14px; color: #333; font-weight: bold;
        z-index: 10;
    }
  </style>
</head>
<body>

  <div id="top-status"><i class="fa-solid fa-location-arrow"></i> å®šä½ä¸­...</div>

  <a href="https://lin.ee/9Davl6e" class="service-btn">
      <i class="fa-solid fa-headset"></i>
      <span>å®¢æœ</span>
  </a>

  <div id="map"></div>

  <div id="driver-carousel">
      </div>

  <div id="empty-state">ğŸš« é™„è¿‘ 20km ç„¡å¸æ©Ÿæœå‹™</div>

  <script>
    // --- Config ---
    const firebaseConfig = { databaseURL: "https://hualientaxi-bb32f-default-rtdb.asia-southeast1.firebasedatabase.app/" };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    var map, userMarker, userLat, userLng;
    var markers = {}; 

    // è»Šå­åœ–æ¨™
    const getCarIcon = (color) => {
        const carPath = "M17.402,0H5.643C2.526,0,0,3.467,0,6.584v34.804c0,3.116,2.526,5.644,5.643,5.644h11.759c3.116,0,5.644-2.527,5.644-5.644 V6.584C23.044,3.467,20.518,0,17.402,0z M22.057,14.188v11.665l-2.729,0.351v-4.806L22.057,14.188z M20.625,10.049l-0.638,5.723 H3.049l-0.638-5.723H20.625z M5.719,8.756h11.599v0.564H5.719V8.756z M1.023,14.188l2.762,7.21v4.806L1.023,25.853V14.188z";
        return {
            path: carPath, fillColor: color, fillOpacity: 1, strokeColor: "white", strokeWeight: 1, scale: 1.2, anchor: new google.maps.Point(11.5, 23)
        };
    };

    window.onload = initMap;

    function initMap() {
        map = new google.maps.Map(document.getElementById("map"), {
            center: { lat: 23.991, lng: 121.601 }, zoom: 14,
            disableDefaultUI: true, zoomControl: false, clickableIcons: false,
            styles: [ { "featureType": "poi", "stylers": [ { "visibility": "off" } ] } ]
        });

        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition((pos) => {
                userLat = pos.coords.latitude; userLng = pos.coords.longitude;
                
                // é¡¯ç¤ºä¹˜å®¢è‡ªå·±
                userMarker = new google.maps.Marker({
                    position: { lat: userLat, lng: userLng }, map: map,
                    icon: { path: google.maps.SymbolPath.CIRCLE, scale: 8, fillColor: "#4285F4", fillOpacity: 1, strokeColor: "white", strokeWeight: 3 },
                    zIndex: 999
                });
                
                map.setCenter({ lat: userLat, lng: userLng });
                map.setZoom(14);
                document.getElementById('top-status').innerHTML = `<i class="fa-solid fa-location-dot"></i> å·²é–å®šæ‚¨çš„ä½ç½®`;
                
                listenToDrivers();
            }, () => {
                document.getElementById('top-status').innerText = "âš ï¸ ç„¡æ³•å®šä½ï¼Œé¡¯ç¤ºå…¨å€";
                listenToDrivers(); // æ²’å®šä½ä¹Ÿè¦é¡¯ç¤ºè»Šå­
            });
        } else { listenToDrivers(); }
    }

    function listenToDrivers() {
        db.ref('drivers').on('value', (snapshot) => {
            const data = snapshot.val();
            if (!data) return;

            const now = Date.now();
            let validDrivers = [];
            const activeIds = new Set();

            Object.keys(data).forEach(id => {
                const d = data[id];
                
                // 1. åŸºç¤éæ¿¾ (æœ‰åº§æ¨™ + ä¸Šç·šä¸­ + ç©ºè»Š/æ’ç­ + 1å°æ™‚å…§)
                if (!d.lat || !d.lng) return;
                if (d.status !== 'online') return;
                if (d.workStatus === 'busy') return; 
                if (now - d.lastUpdate > 3600000) return;

                // 2. è¨ˆç®—è·é›¢ (å¦‚æœä¹˜å®¢æœ‰å®šä½)
                let dist = 9999;
                if (userLat && userLng) {
                    dist = getDistance(userLat, userLng, d.lat, d.lng);
                }

                // 3. è·é›¢éæ¿¾ï¼šåªæ”¶ 20km å…§çš„
                if (dist <= 20) {
                    d.id = id;
                    d.dist = dist;
                    validDrivers.push(d);
                    activeIds.add(id);
                }
            });

            // 4. æ’åºï¼šè¿‘ -> é 
            validDrivers.sort((a, b) => a.dist - b.dist);

            // 5. æ•¸é‡é™åˆ¶ï¼šæœ€å¤š 10 å°
            validDrivers = validDrivers.slice(0, 10);

            // --- UI æ›´æ–° ---
            updateMarkers(validDrivers, activeIds);
            renderCarousel(validDrivers);
        });
    }

    function updateMarkers(drivers, activeIds) {
        // æ›´æ–°åœ°åœ–ä¸Šçš„è»Š
        drivers.forEach(d => {
            const pos = { lat: d.lat, lng: d.lng };
            const color = d.workStatus === 'queue' ? '#3498db' : '#2ecc71'; 

            if (!markers[d.id]) {
                markers[d.id] = new google.maps.Marker({
                    position: pos, map: map, icon: getCarIcon(color), title: d.name
                });
                // é»æ“Šåœ°åœ–è»Šå­ï¼Œè‡ªå‹•æ»¾å‹•ä¸‹æ–¹é¸å–®åˆ°è©²å¸æ©Ÿ
                markers[d.id].addListener('click', () => {
                    const card = document.getElementById(`card-${d.id}`);
                    if(card) card.scrollIntoView({ behavior: 'smooth', block: 'nearest', inline: 'center' });
                });
            } else {
                markers[d.id].setPosition(pos);
                markers[d.id].setIcon(getCarIcon(color));
            }
        });

        // æ¸…é™¤ä¸åœ¨åˆ—è¡¨ä¸­çš„ Marker (ä¾‹å¦‚é–‹å¤ªé æˆ–ä¸‹ç·š)
        for (let id in markers) {
            if (!activeIds.has(id)) {
                markers[id].setMap(null);
                delete markers[id];
            }
        }
    }

    function renderCarousel(drivers) {
        const container = document.getElementById('driver-carousel');
        const emptyState = document.getElementById('empty-state');

        // 0 å°è»Šçš„è™•ç†
        if (drivers.length === 0) {
            container.style.display = 'none';
            emptyState.style.display = 'block';
            return;
        }

        container.style.display = 'flex';
        emptyState.style.display = 'none';
        container.innerHTML = ""; // æ¸…ç©ºé‡ç¹ª

        drivers.forEach(d => {
            const distText = d.dist < 1 ? `${(d.dist*1000).toFixed(0)}m` : `${d.dist.toFixed(1)}km`;
            const badgeClass = d.workStatus === 'queue' ? 'badge-queue' : 'badge-empty';
            const badgeText = d.workStatus === 'queue' ? 'æ’ç­ä¸­' : 'ç©ºè»Š';

            const card = document.createElement('div');
            card.className = 'driver-card';
            card.id = `card-${d.id}`;
            
            // é»æ“Šå¡ç‰‡ï¼Œåœ°åœ–é£›éå»
            card.onclick = () => {
                map.panTo({ lat: d.lat, lng: d.lng });
                map.setZoom(16);
            };

            card.innerHTML = `
                <div class="d-info">
                    <div class="d-avatar"><i class="fa-solid fa-taxi"></i></div>
                    <div class="d-text">
                        <h3>${d.name} <span class="status-badge ${badgeClass}">${badgeText}</span></h3>
                        <p>
                            <span style="font-family:monospace; margin-right:8px; background:#eee; padding:1px 5px; border-radius:4px;">${d.car}</span> 
                            <i class="fa-solid fa-location-dot" style="font-size:10px; margin-right:3px;"></i>${distText}
                        </p>
                    </div>
                </div>
                <a href="tel:${d.phone}" class="call-btn">
                    <i class="fa-solid fa-phone"></i>
                </a>
            `;
            container.appendChild(card);
        });
    }

    // è·é›¢å…¬å¼
    function getDistance(lat1, lon1, lat2, lon2) {
        const R = 6371; 
        const dLat = (lat2 - lat1) * Math.PI / 180; const dLon = (lon2 - lon1) * Math.PI / 180;
        const a = Math.sin(dLat/2) * Math.sin(dLat/2) + Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * Math.sin(dLon/2) * Math.sin(dLon/2);
        return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
    }
  </script>
</body>
</html>
