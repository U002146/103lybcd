<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>èŠ±è“®è»ŠéšŠ - ä¹˜å®¢å«è»Š</title>
  
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
  <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAIxc6PEhHgUs_A9lyRUg8dNbmwOpSamY8"></script>

  <style>
    /* --- UI: æ¸…æ–°æ˜äº®é¢¨æ ¼ (é©åˆä¹˜å®¢) --- */
    body { margin: 0; padding: 0; font-family: -apple-system, Roboto, sans-serif; overflow: hidden; }
    #map { width: 100vw; height: 100vh; }

    /* åº•éƒ¨å«è»Šé¢æ¿ */
    #bottom-panel {
        position: absolute; bottom: 0; left: 0; width: 100%;
        background: white; border-top-left-radius: 20px; border-top-right-radius: 20px;
        box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
        padding: 20px; box-sizing: border-box; z-index: 10;
        text-align: center; transition: transform 0.3s;
    }
    
    h2 { margin: 0 0 10px 0; color: #333; font-size: 20px; }
    p { margin: 0 0 15px 0; color: #666; font-size: 14px; }

    /* å«è»ŠæŒ‰éˆ• */
    .call-taxi-btn {
        background: linear-gradient(135deg, #00C853, #64DD17);
        color: white; border: none; padding: 15px 0; width: 100%;
        border-radius: 50px; font-size: 18px; font-weight: bold;
        box-shadow: 0 4px 15px rgba(0, 200, 83, 0.4);
        cursor: pointer; text-decoration: none; display: block;
    }
    .call-taxi-btn:active { transform: scale(0.98); }

    /* é™„è¿‘è»Šè¼›æ•¸æç¤º */
    #nearby-count {
        position: absolute; top: 20px; left: 50%; transform: translateX(-50%);
        background: rgba(255, 255, 255, 0.9); padding: 8px 15px;
        border-radius: 20px; box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        font-weight: bold; color: #333; z-index: 10; display: flex; align-items: center;
    }
    .dot { width: 10px; height: 10px; background: #2ecc71; border-radius: 50%; margin-right: 8px; }

    /* å¸æ©Ÿè³‡è¨Šå½ˆçª— (Info Window) æ¨£å¼æœƒç”± Google Maps æ±ºå®šï¼Œé€™è£¡åªè¨­å…¨åŸŸ */
    .driver-info-window { padding: 5px; text-align: center; }
    .driver-name { font-weight: bold; font-size: 16px; margin-bottom: 5px; }
    .driver-car { color: #666; font-size: 12px; margin-bottom: 8px; }
    .driver-phone-btn {
        background: #2ecc71; color: white; text-decoration: none;
        padding: 5px 15px; border-radius: 15px; font-size: 14px; display: inline-block;
    }
  </style>
</head>
<body>

  <div id="nearby-count"><span class="dot"></span> æœå°‹é™„è¿‘è»Šè¼›ä¸­...</div>

  <div id="map"></div>

  <div id="bottom-panel">
      <h2 id="status-title">æ­£åœ¨å®šä½æ‚¨çš„ä½ç½®...</h2>
      <p>èŠ±è“®åœ¨åœ°è»ŠéšŠï¼Œå®‰å…¨å¯é ï¼Œéš¨å«éš¨åˆ°</p>
      <a href="https://line.me/R/ti/p/@103lybcd" class="call-taxi-btn">
          ğŸ“ å‘¼å«è»ŠéšŠ (LINE)
      </a>
  </div>

  <script>
    // --- Config ---
    const firebaseConfig = { databaseURL: "https://hualientaxi-bb32f-default-rtdb.asia-southeast1.firebasedatabase.app/" };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    var map, userMarker;
    var markers = {}; // å­˜æ”¾å¸æ©Ÿ Marker
    var myLat = null, myLng = null;
    var infoWindow; // å½ˆå‡ºè¦–çª—

    // å¸æ©Ÿåœ–æ¨™ (ç¶ è‰²=ç©ºè»Š, è—è‰²=æ’ç­)
    const getIcon = (color) => {
        return {
            path: "M10,0 C4.5,0 0,4.5 0,10 C0,18 10,30 10,30 C10,30 20,18 20,10 C20,4.5 15.5,0 10,0 Z",
            fillColor: color, fillOpacity: 1, strokeColor: '#fff', strokeWeight: 2, scale: 1.5, anchor: new google.maps.Point(10, 30)
        };
    };

    window.onload = function() {
        initMap();
    };

    function initMap() {
        // é è¨­èŠ±è“®ä¸­å¿ƒ
        map = new google.maps.Map(document.getElementById("map"), {
            center: { lat: 23.991, lng: 121.601 }, zoom: 14,
            disableDefaultUI: true, // ç°¡æ½”æ¨¡å¼
            zoomControl: true, // å…è¨±ä¹˜å®¢ç¸®æ”¾
        });

        infoWindow = new google.maps.InfoWindow();

        // 1. æŠ“ä¹˜å®¢ä½ç½®
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition((pos) => {
                myLat = pos.coords.latitude;
                myLng = pos.coords.longitude;
                const latLng = { lat: myLat, lng: myLng };

                // é¡¯ç¤ºä¹˜å®¢è‡ªå·±
                userMarker = new google.maps.Marker({
                    position: latLng, map: map,
                    icon: {
                        path: google.maps.SymbolPath.CIRCLE,
                        scale: 8, fillColor: "#4285F4", fillOpacity: 1, strokeColor: "white", strokeWeight: 2
                    },
                    title: "æ‚¨çš„ä½ç½®"
                });

                map.setCenter(latLng);
                map.setZoom(15);
                document.getElementById('status-title').innerText = "å·²é–å®šæ‚¨çš„ä½ç½®";
                
                // é–‹å§‹ç›£è½å¸æ©Ÿ
                listenToDrivers();
            }, () => {
                document.getElementById('status-title').innerText = "ç„¡æ³•å–å¾—å®šä½ï¼Œé¡¯ç¤ºé è¨­åœ°åœ–";
                listenToDrivers(); // å°±ç®—æ²’å®šä½ä¹Ÿé¡¯ç¤ºè»Šå­
            });
        } else {
            listenToDrivers();
        }
    }

    function listenToDrivers() {
        db.ref('drivers').on('value', (snapshot) => {
            const data = snapshot.val();
            if (!data) return;

            const now = Date.now();
            let count = 0;
            const activeIds = new Set();

            Object.keys(data).forEach(id => {
                const d = data[id];

                // --- æ ¸å¿ƒéæ¿¾é‚è¼¯ ---
                // 1. å¿…é ˆæœ‰ä½ç½®
                if (!d.lat || !d.lng) return;
                // 2. å¿…é ˆæ˜¯ä¸Šç·šç‹€æ…‹ (status == 'online')
                if (d.status !== 'online') return;
                // 3. å¿…é ˆæ˜¯ç©ºè»Šæˆ–æ’ç­ (workStatus == 'empty' or 'queue')
                // â˜… é—œéµï¼šè¼‰å®¢ä¸­ (busy) çš„è»Šå­ç›´æ¥éš±å½¢ â˜…
                if (d.workStatus === 'busy') return;
                // 4. è¨Šè™Ÿå¿…é ˆæ–°é®® (10åˆ†é˜å…§)
                if (now - d.lastUpdate > 600000) return;

                activeIds.add(id);
                count++;
                
                const pos = { lat: d.lat, lng: d.lng };
                const color = d.workStatus === 'queue' ? '#3498db' : '#2ecc71'; // è—=æ’ç­, ç¶ =ç©ºè»Š

                if (!markers[id]) {
                    // æ–°å¢ Marker
                    const marker = new google.maps.Marker({
                        position: pos, map: map,
                        icon: getIcon(color),
                        title: d.name
                    });

                    // é»æ“Šäº‹ä»¶ï¼šé¡¯ç¤ºå¸æ©Ÿè³‡è¨Š & é›»è©±
                    marker.addListener("click", () => {
                        const content = `
                            <div class="driver-info-window">
                                <div class="driver-name">${d.name} é‹å°‡</div>
                                <div class="driver-car">${d.car || 'è¨ˆç¨‹è»Š'}</div>
                                <a href="tel:${d.phone}" class="driver-phone-btn">ğŸ“ ${d.phone}</a>
                            </div>
                        `;
                        infoWindow.setContent(content);
                        infoWindow.open(map, marker);
                    });
                    
                    markers[id] = marker;
                } else {
                    // æ›´æ–° Marker
                    markers[id].setPosition(pos);
                    markers[id].setIcon(getIcon(color));
                }
            });

            // æ¸…é™¤å·²ä¸‹ç·šæˆ–è¼‰å®¢çš„è»Š
            for (let id in markers) {
                if (!activeIds.has(id)) {
                    markers[id].setMap(null);
                    delete markers[id];
                }
            }

            // æ›´æ–°ä¸Šæ–¹æç¤º
            document.getElementById('nearby-count').innerHTML = 
                `<span class="dot"></span> é™„è¿‘æœ‰ ${count} å°ç©ºè»Š`;
        });
    }
  </script>
</body>
</html>
