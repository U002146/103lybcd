<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <title>花蓮車隊 - 乘客叫車</title>
  <meta name="apple-mobile-web-app-capable" content="yes">
  
  <meta property="og:title" content="花蓮車隊 - 即時叫車">
  <meta property="og:description" content="免下載 APP，點擊連結直接看附近空車！">
  <meta property="og:image" content="preview.jpg">

  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
  <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAIxc6PEhHgUs_A9lyRUg8dNbmwOpSamY8&libraries=geometry"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

  <style>
    body { margin: 0; padding: 0; font-family: -apple-system, Roboto, sans-serif; overflow: hidden; background: #f0f2f5; }
    #map { width: 100vw; height: 100vh; }

    #top-bar { position: absolute; top: 15px; left: 15px; right: 15px; z-index: 10; display: flex; justify-content: space-between; pointer-events: none; }
    .status-pill { background: white; padding: 10px 20px; border-radius: 30px; box-shadow: 0 4px 15px rgba(0,0,0,0.15); font-weight: bold; color: #333; pointer-events: auto; display: flex; align-items: center; }
    .btn-customer { background: linear-gradient(135deg, #00C853, #64DD17); color: white; width: 50px; height: 50px; border-radius: 50%; display: flex; flex-direction: column; justify-content: center; align-items: center; box-shadow: 0 4px 15px rgba(0,0,0,0.2); text-decoration: none; pointer-events: auto; font-size: 12px; font-weight: bold; border: 2px solid white; }
    .btn-customer i { font-size: 20px; margin-bottom: 2px; }

    #driver-carousel { position: absolute; bottom: 30px; left: 0; width: 100%; display: flex; gap: 15px; padding: 10px 20px; box-sizing: border-box; overflow-x: auto; scroll-snap-type: x mandatory; z-index: 20; scrollbar-width: none; }
    #driver-carousel::-webkit-scrollbar { display: none; }
    
    .driver-card { flex: 0 0 90%; max-width: 350px; background: white; border-radius: 20px; padding: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.15); scroll-snap-align: center; display: flex; align-items: center; transition: transform 0.2s; border: 1px solid #eee; position: relative; }
    .d-avatar { width: 60px; height: 60px; background: #eee; border-radius: 50%; overflow: hidden; margin-right: 15px; border: 2px solid #fff; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
    .d-avatar img { width: 100%; height: 100%; object-fit: cover; }
    .d-info { flex: 1; }
    .d-name { font-size: 18px; font-weight: 800; color: #333; margin-bottom: 4px; display: flex; align-items: center; }
    .tag { font-size: 10px; padding: 2px 6px; border-radius: 4px; margin-left: 8px; font-weight: normal; }
    .tag-empty { background: #e8f5e9; color: #2e7d32; }
    .tag-queue { background: #e3f2fd; color: #1565c0; }
    .d-meta { font-size: 13px; color: #666; display: flex; gap: 10px; }
    
    .btn-call { width: 50px; height: 50px; border-radius: 50%; background: linear-gradient(135deg, #00C853, #64DD17); color: white; display: flex; justify-content: center; align-items: center; text-decoration: none; font-size: 20px; box-shadow: 0 4px 10px rgba(76, 175, 80, 0.3); transition: transform 0.1s; }
    .btn-call:active { transform: scale(0.9); }

    #btn-loc { position: absolute; bottom: 220px; right: 20px; width: 45px; height: 45px; background: white; border-radius: 50%; box-shadow: 0 4px 15px rgba(0,0,0,0.15); display: flex; justify-content: center; align-items: center; font-size: 20px; color: #666; cursor: pointer; z-index: 15; }
  </style>
</head>
<body>

  <div id="top-bar">
    <div class="status-pill" id="location-pill"><i class="fa-solid fa-location-dot" style="color:#e74c3c;margin-right:8px;"></i> <span id="loc-text">定位中...</span></div>
    <a href="https://line.me/R/ti/p/@853jdocd" target="_blank" class="btn-customer"><i class="fa-solid fa-headset"></i>客服</a>
  </div>

  <div id="map"></div>
  <div id="btn-loc" onclick="centerMap()"><i class="fa-solid fa-crosshairs"></i></div>
  <div id="driver-carousel"></div>

  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <script>
    const LIFF_ID = "2008907691-CzDqd7mm"; 
    const firebaseConfig = { databaseURL: "https://hualientaxi-bb32f-default-rtdb.asia-southeast1.firebasedatabase.app/" };
    
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    
    var map, userMarker, markers = {};

    // v4.4: 水滴造型 + 文字 (空/排)
    const getPinIcon = (type) => {
        // 設定顏色與文字
        const isQueue = type === 'queue';
        const color = isQueue ? '#00B0FF' : '#00C853'; // 藍色 / 綠色
        const labelText = isQueue ? "排" : "空";
        
        return {
            // SVG 水滴路徑
            path: "M0-48c-9.8 0-17.7 7.8-17.7 17.4 0 15.5 17.7 30.6 17.7 30.6s17.7-15.4 17.7-30.6c0-9.6-7.9-17.4-17.7-17.4z",
            fillColor: color,
            fillOpacity: 1,
            strokeColor: "#fff",
            strokeWeight: 2,
            scale: 1.1,
            labelOrigin: new google.maps.Point(0, -28) // 文字位置
        };
    };

    window.onload = async function() {
        initMap();
        await initLiff();
        listenToDrivers();
    };

    function initMap() {
        map = new google.maps.Map(document.getElementById("map"), {
            center: { lat: 23.991, lng: 121.601 }, zoom: 15,
            disableDefaultUI: true, styles: [ { featureType: "poi", elementType: "labels", stylers: [{ visibility: "off" }] } ]
        });
        if(navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(pos => {
                const p = { lat: pos.coords.latitude, lng: pos.coords.longitude };
                userMarker = new google.maps.Marker({ position: p, map: map, icon: { path: google.maps.SymbolPath.CIRCLE, scale: 8, fillColor: "#4285F4", fillOpacity: 1, strokeColor: "white", strokeWeight: 2 }, title: "我" });
                map.panTo(p);
                getAddress(p.lat, p.lng);
            });
        }
    }

    async function initLiff() { try { await liff.init({ liffId: LIFF_ID }); if(!liff.isLoggedIn()) liff.login(); } catch(e){} }

    function listenToDrivers() {
        db.ref('drivers').on('value', snapshot => {
            const data = snapshot.val();
            if (!data) return;
            const now = Date.now();
            const activeDrivers = [];
            const activeIds = new Set();

            Object.keys(data).forEach(key => {
                const d = data[key];
                
                // 防幽靈車邏輯：排班60分，空車10分
                const timeout = d.workStatus === 'queue' ? 3600000 : 600000;
                
                if (d.status !== 'online') return;
                if (now - d.lastUpdate > timeout) return; 
                if (d.workStatus === 'busy') return; // 不顯示載客中

                activeIds.add(key);
                const pos = { lat: d.lat, lng: d.lng };
                
                // v4.4: 判斷要顯示 "空" 還是 "排"
                const iconType = d.workStatus === 'queue' ? 'queue' : 'empty';
                const labelText = d.workStatus === 'queue' ? '排' : '空';

                if (!markers[key]) {
                    markers[key] = new google.maps.Marker({
                        position: pos,
                        map: map,
                        icon: getPinIcon(iconType),
                        label: { text: labelText, color: "white", fontSize: "14px", fontWeight: "bold" },
                        title: d.name
                    });
                    markers[key].addListener('click', () => {
                        const card = document.getElementById(`card-${key}`);
                        if(card) card.scrollIntoView({ behavior: 'smooth', inline: 'center' });
                    });
                } else {
                    markers[key].setPosition(pos);
                    // 更新狀態圖示
                    markers[key].setIcon(getPinIcon(iconType));
                    markers[key].setLabel({ text: labelText, color: "white", fontSize: "14px", fontWeight: "bold" });
                }

                let distUser = 999;
                if(userMarker) {
                    distUser = google.maps.geometry.spherical.computeDistanceBetween(userMarker.getPosition(), new google.maps.LatLng(d.lat, d.lng)) / 1000;
                }
                d.id = key;
                d.distUser = distUser;
                activeDrivers.push(d);
            });

            for(let k in markers) { if(!activeIds.has(k)) { markers[k].setMap(null); delete markers[k]; } }
            updateCarousel(activeDrivers.sort((a,b) => a.distUser - b.distUser));
        });
    }

    function updateCarousel(drivers) {
        const container = document.getElementById('driver-carousel');
        container.innerHTML = drivers.length ? '' : '<div style="width:100%;text-align:center;color:#999;padding:20px;">附近暫無空車</div>';
        
        drivers.forEach(d => {
            const statusTag = d.workStatus === 'queue' ? '<span class="tag tag-queue">排班中</span>' : '<span class="tag tag-empty">空車</span>';
            const distText = d.distUser < 1 ? (d.distUser*1000).toFixed(0)+'m' : d.distUser.toFixed(1)+'km';
            const avatar = d.photo || 'https://cdn-icons-png.flaticon.com/512/3237/3237472.png';
            
            const card = document.createElement('div');
            card.className = 'driver-card';
            card.id = `card-${d.id}`;
            card.onclick = () => map.panTo({lat:d.lat, lng:d.lng});
            card.innerHTML = `
                <div class="d-avatar"><img src="${avatar}"></div>
                <div class="d-info">
                    <div class="d-name">${d.name} ${statusTag}</div>
                    <div class="d-meta">
                        <span><i class="fa-solid fa-taxi"></i> ${d.car || '計程車'}</span>
                        <span><i class="fa-solid fa-location-arrow"></i> ${distText}</span>
                    </div>
                </div>
                <a href="tel:${d.phone}" class="btn-call"><i class="fa-solid fa-phone"></i></a>
            `;
            container.appendChild(card);
        });
    }

    function centerMap(){ if(userMarker) { map.panTo(userMarker.getPosition()); map.setZoom(15); } }
    function getAddress(lat, lng) {
        const geocoder = new google.maps.Geocoder();
        geocoder.geocode({ location: { lat: lat, lng: lng } }, (results, status) => {
            if (status === "OK" && results[0]) {
                let addr = results[0].address_components.find(c => c.types.includes('route'))?.short_name || "您的位置";
                document.getElementById('loc-text').innerText = addr;
            }
        });
    }
  </script>
</body>
</html>
