<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <title>èŠ±è“®è»ŠéšŠ - ä¹˜å®¢å«è»Š</title>
  
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
  <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAIxc6PEhHgUs_A9lyRUg8dNbmwOpSamY8"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

  <style>
    /* --- UI è¨­è¨ˆç¸½ç›£ï¼šç¾ä»£ç°¡ç´„é¢¨ --- */
    body { margin: 0; padding: 0; font-family: -apple-system, "Microsoft JhengHei", sans-serif; overflow: hidden; background: #f5f5f5; }
    #map { width: 100vw; height: 100vh; }

    /* é ‚éƒ¨ç‹€æ…‹åˆ— */
    #top-bar {
        position: absolute; top: 15px; left: 50%; transform: translateX(-50%);
        background: rgba(255, 255, 255, 0.95); padding: 10px 20px;
        border-radius: 30px; box-shadow: 0 4px 15px rgba(0,0,0,0.15);
        font-weight: bold; color: #333; z-index: 10; display: flex; align-items: center; white-space: nowrap;
    }
    .pulse-dot { width: 10px; height: 10px; background: #2ecc71; border-radius: 50%; margin-right: 8px; animation: pulse 1.5s infinite; }
    @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(46, 204, 113, 0.7); } 70% { box-shadow: 0 0 0 10px rgba(46, 204, 113, 0); } 100% { box-shadow: 0 0 0 0 rgba(46, 204, 113, 0); } }

    /* åº•éƒ¨åç‰‡é¢æ¿ (æ ¸å¿ƒè¨­è¨ˆ) */
    #bottom-card {
        position: absolute; bottom: 0; left: 0; width: 100%;
        background: white; border-top-left-radius: 24px; border-top-right-radius: 24px;
        box-shadow: 0 -5px 25px rgba(0,0,0,0.1);
        padding: 25px; padding-bottom: 40px; box-sizing: border-box; z-index: 20;
        transition: transform 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
    }

    /* åç‰‡å…§å®¹å€ */
    .card-content { display: none; text-align: left; }
    .card-content.active { display: block; animation: slideUp 0.3s; }

    /* æ¨¡å¼ A: æœå°‹ä¸­ */
    .mode-searching h2 { margin: 0 0 5px 0; font-size: 22px; color: #333; }
    .mode-searching p { margin: 0 0 20px 0; color: #888; font-size: 14px; }

    /* æ¨¡å¼ B: å¸æ©Ÿåç‰‡ */
    .driver-profile { display: flex; align-items: center; margin-bottom: 15px; }
    .driver-avatar { width: 60px; height: 60px; background: #eee; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 30px; margin-right: 15px; color: #555; }
    .driver-info h2 { margin: 0; font-size: 24px; color: #333; }
    .driver-info .car-badge { background: #f1f2f6; color: #555; padding: 4px 8px; border-radius: 6px; font-size: 13px; font-weight: bold; margin-top: 4px; display: inline-block; }
    .distance-tag { position: absolute; top: 25px; right: 25px; background: #e8f5e9; color: #2ecc71; padding: 5px 12px; border-radius: 20px; font-size: 14px; font-weight: bold; }

    /* é€šç”¨å¤§æŒ‰éˆ• */
    .main-btn {
        display: flex; justify-content: center; align-items: center;
        width: 100%; padding: 16px; border-radius: 16px;
        border: none; font-size: 18px; font-weight: bold; color: white;
        cursor: pointer; text-decoration: none; box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        transition: transform 0.1s;
    }
    .main-btn:active { transform: scale(0.98); }
    .btn-fleet { background: linear-gradient(135deg, #333, #555); }
    .btn-call { background: linear-gradient(135deg, #00C853, #64DD17); }
    .main-btn i { margin-right: 10px; }

    /* å®šä½æŒ‰éˆ• */
    .gps-btn {
        position: absolute; bottom: 220px; right: 20px;
        width: 50px; height: 50px; background: white; border-radius: 50%;
        display: flex; align-items: center; justify-content: center;
        box-shadow: 0 4px 10px rgba(0,0,0,0.2); z-index: 15; font-size: 20px; color: #333;
        cursor: pointer;
    }

    @keyframes slideUp { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
  </style>
</head>
<body>

  <div id="top-bar"><div class="pulse-dot"></div><span id="fleet-status">æœå°‹é™„è¿‘è»Šè¼›...</span></div>

  <div id="map"></div>

  <div class="gps-btn" onclick="panToUser()"><i class="fa-solid fa-crosshairs"></i></div>

  <div id="bottom-card">
      
      <div id="card-default" class="card-content active mode-searching">
          <h2>ğŸ‘‹ æ‚¨å¥½ï¼Œè¦å»å“ªè£¡ï¼Ÿ</h2>
          <p>é»æ“Šåœ°åœ–ä¸Šçš„è»Šè¼›æŸ¥çœ‹å¸æ©Ÿè³‡è¨Š</p>
          <a href="https://line.me/R/ti/p/@YOUR_LINE_ID" class="main-btn btn-fleet">
              <i class="fa-brands fa-line"></i> å‘¼å«è»ŠéšŠæ´¾è»Š
          </a>
      </div>

      <div id="card-driver" class="card-content">
          <div class="driver-profile">
              <div class="driver-avatar"><i class="fa-solid fa-user-tie"></i></div>
              <div class="driver-info">
                  <h2 id="d-name">å¸æ©Ÿå</h2>
                  <div class="car-badge" id="d-car">è»Šè™Ÿ</div>
              </div>
              <div class="distance-tag" id="d-dist">0.5 km</div>
          </div>
          <a id="d-call-btn" href="#" class="main-btn btn-call">
              <i class="fa-solid fa-phone"></i> ç›´æ¥æ’¥çµ¦å¸æ©Ÿ
          </a>
          <div style="text-align:center; margin-top:10px;">
              <span style="color:#999; font-size:13px; cursor:pointer;" onclick="deselectDriver()">é—œé–‰åç‰‡ âœ•</span>
          </div>
      </div>

  </div>

  <script>
    const firebaseConfig = { databaseURL: "https://hualientaxi-bb32f-default-rtdb.asia-southeast1.firebasedatabase.app/" };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    var map, userMarker, userLat, userLng;
    var markers = {}; 
    var selectedDriverId = null;

    // --- åœ–æ¨™è¨­è¨ˆ (SVG) ---
    // 1. ä¹˜å®¢åœ–æ¨™ (è—è‰²é›·é”é»)
    const userIcon = {
        path: google.maps.SymbolPath.CIRCLE,
        scale: 8, fillColor: "#4285F4", fillOpacity: 1, strokeColor: "white", strokeWeight: 3
    };

    // 2. è¨ˆç¨‹è»Šåœ–æ¨™ (ç²¾ç·»å°è»Š - ä¿¯è¦–åœ–)
    const getCarIcon = (color) => {
        // é€™æ˜¯ä¸€å€‹ä¿¯è¦–çš„è»Šå­å½¢ç‹€ SVG Path
        const carPath = "M17.402,0H5.643C2.526,0,0,3.467,0,6.584v34.804c0,3.116,2.526,5.644,5.643,5.644h11.759c3.116,0,5.644-2.527,5.644-5.644 V6.584C23.044,3.467,20.518,0,17.402,0z M22.057,14.188v11.665l-2.729,0.351v-4.806L22.057,14.188z M20.625,10.049l-0.638,5.723 H3.049l-0.638-5.723H20.625z M5.719,8.756h11.599v0.564H5.719V8.756z M1.023,14.188l2.762,7.21v4.806L1.023,25.853V14.188z";
        
        return {
            path: carPath,
            fillColor: color, fillOpacity: 1,
            strokeColor: "white", strokeWeight: 1,
            scale: 1.2, 
            anchor: new google.maps.Point(11.5, 23), // ä¸­å¿ƒé»è¨­å®š
            rotation: 0 // ä¹‹å¾Œå¯ä»¥ç”¨ GPS heading æ—‹è½‰
        };
    };

    window.onload = initMap;

    function initMap() {
        map = new google.maps.Map(document.getElementById("map"), {
            center: { lat: 23.991, lng: 121.601 }, zoom: 14,
            disableDefaultUI: true, clickableIcons: false, styles: [ { "featureType": "poi", "elementType": "labels", "stylers": [ { "visibility": "off" } ] } ]
        });

        // é»æ“Šåœ°åœ–ç©ºç™½è™•ï¼Œå–æ¶ˆé¸å–å¸æ©Ÿ
        map.addListener("click", deselectDriver);

        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition((pos) => {
                userLat = pos.coords.latitude; userLng = pos.coords.longitude;
                updateUserMarker(userLat, userLng);
                map.setCenter({ lat: userLat, lng: userLng });
                map.setZoom(15);
                listenToDrivers();
            }, () => listenToDrivers());
        } else { listenToDrivers(); }
    }

    function updateUserMarker(lat, lng) {
        const pos = { lat: lat, lng: lng };
        if (!userMarker) {
            userMarker = new google.maps.Marker({ position: pos, map: map, icon: userIcon, zIndex: 999 });
            // æ·»åŠ é›·é”å‹•ç•«æ•ˆæœ (åœ“åœˆ)
            new google.maps.Circle({
                strokeColor: "#4285F4", strokeOpacity: 0.3, strokeWeight: 1,
                fillColor: "#4285F4", fillOpacity: 0.1,
                map: map, center: pos, radius: 100 // 100ç±³ç¯„åœ
            });
        } else {
            userMarker.setPosition(pos);
        }
    }

    function panToUser() {
        if(userLat && userLng) {
            map.panTo({lat: userLat, lng: userLng});
            map.setZoom(16);
        }
    }

    function listenToDrivers() {
        db.ref('drivers').on('value', (snapshot) => {
            const data = snapshot.val();
            if (!data) return;

            const now = Date.now();
            let count = 0;
            const activeIds = new Set();

            Object.keys(data).forEach(id => {
                const d = data[id];
                if (!d.lat || !d.lng) return;
                if (d.status !== 'online') return;
                if (d.workStatus === 'busy') return; 
                // å¯¬é¬†åˆ¤æ–·ï¼š1å°æ™‚å…§éƒ½ç®—æ´»è‘—
                if (now - d.lastUpdate > 3600000) return;

                activeIds.add(id);
                count++;
                
                const pos = { lat: d.lat, lng: d.lng };
                // é¡è‰²ï¼šæ’ç­=è—, ç©ºè»Š=ç¶ 
                const color = d.workStatus === 'queue' ? '#3498db' : '#2ecc71'; 

                if (!markers[id]) {
                    const marker = new google.maps.Marker({
                        position: pos, map: map,
                        icon: getCarIcon(color),
                        title: d.name
                    });
                    
                    // â˜… é»æ“Šäº‹ä»¶ï¼šåˆ‡æ›åˆ°åº•éƒ¨åç‰‡ â˜…
                    marker.addListener("click", () => selectDriver(id, d));
                    markers[id] = marker;
                } else {
                    markers[id].setPosition(pos);
                    markers[id].setIcon(getCarIcon(color));
                    
                    // å¦‚æœç›®å‰æ­£é¸ä¸­é€™ä½å¸æ©Ÿï¼Œå³æ™‚æ›´æ–°è·é›¢
                    if(selectedDriverId === id) updateDriverDistance(d.lat, d.lng);
                }
            });

            for (let id in markers) { if (!activeIds.has(id)) { markers[id].setMap(null); delete markers[id]; } }
            
            document.getElementById('fleet-status').innerText = `é™„è¿‘æœ‰ ${count} å°ç©ºè»Š`;
        });
    }

    // --- åç‰‡é‚è¼¯ ---
    function selectDriver(id, d) {
        selectedDriverId = id;
        
        // 1. å¡«å…¥è³‡æ–™
        document.getElementById('d-name').innerText = d.name || "å¸æ©Ÿ";
        document.getElementById('d-car').innerText = d.car || "è¨ˆç¨‹è»Š";
        document.getElementById('d-call-btn').href = `tel:${d.phone}`;
        
        // 2. è¨ˆç®—è·é›¢
        updateDriverDistance(d.lat, d.lng);

        // 3. UI åˆ‡æ›
        document.getElementById('card-default').classList.remove('active');
        document.getElementById('card-driver').classList.add('active');
    }

    function deselectDriver() {
        selectedDriverId = null;
        document.getElementById('card-driver').classList.remove('active');
        document.getElementById('card-default').classList.add('active');
    }

    function updateDriverDistance(dLat, dLng) {
        if(userLat && userLng) {
            const dist = getDistance(userLat, userLng, dLat, dLng);
            document.getElementById('d-dist').innerText = dist < 1 ? `${(dist*1000).toFixed(0)} m` : `${dist.toFixed(1)} km`;
        } else {
            document.getElementById('d-dist').innerText = "è¨ˆç®—ä¸­...";
        }
    }

    // è·é›¢å…¬å¼ (Haversine)
    function getDistance(lat1, lon1, lat2, lon2) {
        const R = 6371; const dLat = (lat2 - lat1) * Math.PI / 180; const dLon = (lon2 - lon1) * Math.PI / 180;
        const a = Math.sin(dLat/2) * Math.sin(dLat/2) + Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * Math.sin(dLon/2) * Math.sin(dLon/2);
        return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
    }
  </script>
</body>
</html>
