<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  
  <title>èŠ±è“®æ•¬è€æ„›å¿ƒè»ŠéšŠï¼šé›™å‘å®šä½ç³»çµ±</title> <meta name="apple-mobile-web-app-capable" content="yes">
  
  <meta property="og:title" content="é€šè©±å«è»Šï¼šé›™å‘å®šä½ç³»çµ±">
  <meta property="og:description" content="å…¨èŠ±è“®å”¯ä¸€ï¼æŒ‰ä¸‹é€šè©±è‡ªå‹•å‚³é€ä½ç½®ï¼Œå…å ±è·¯åã€‚å¸æ©Ÿä½ç½®å³æ™‚çœ‹ï¼Œé•·è¼©å®‰å¿ƒï¼Œå­å¥³æ”¾å¿ƒã€‚">
  <meta property="og:image" content="preview.jpg"> 

  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
  <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAIxc6PEhHgUs_A9lyRUg8dNbmwOpSamY8&libraries=geometry"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

  <style>
    body { margin: 0; padding: 0; font-family: -apple-system, Roboto, sans-serif; overflow: hidden; background: #f0f2f5; }
    #map { width: 100vw; height: 100vh; }

    #top-bar { position: absolute; top: 15px; left: 15px; right: 15px; z-index: 10; display: flex; justify-content: space-between; pointer-events: none; }
    .status-pill { background: white; padding: 10px 20px; border-radius: 30px; box-shadow: 0 4px 15px rgba(0,0,0,0.15); font-weight: bold; color: #333; pointer-events: auto; display: flex; align-items: center; }
    .btn-customer { background: linear-gradient(135deg, #00C853, #64DD17); color: white; width: 50px; height: 50px; border-radius: 50%; display: flex; flex-direction: column; justify-content: center; align-items: center; box-shadow: 0 4px 15px rgba(0,0,0,0.2); text-decoration: none; pointer-events: auto; font-size: 12px; font-weight: bold; border: 2px solid white; }
    .btn-customer i { font-size: 20px; margin-bottom: 2px; }

    #driver-carousel { position: absolute; bottom: 30px; left: 0; width: 100%; display: flex; gap: 15px; padding: 10px 20px; box-sizing: border-box; overflow-x: auto; scroll-snap-type: x mandatory; z-index: 20; scrollbar-width: none; }
    #driver-carousel::-webkit-scrollbar { display: none; }
    
    .driver-card { flex: 0 0 90%; max-width: 350px; background: white; border-radius: 20px; padding: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.15); scroll-snap-align: center; display: flex; align-items: center; transition: transform 0.2s; border: 1px solid #eee; position: relative; }
    .d-avatar { width: 60px; height: 60px; background: #eee; border-radius: 50%; overflow: hidden; margin-right: 15px; border: 2px solid #fff; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
    .d-avatar img { width: 100%; height: 100%; object-fit: cover; }
    .d-info { flex: 1; }
    .d-name { font-size: 18px; font-weight: 800; color: #333; margin-bottom: 4px; display: flex; align-items: center; }
    .tag { font-size: 10px; padding: 2px 6px; border-radius: 4px; margin-left: 8px; font-weight: normal; }
    .tag-empty { background: #e8f5e9; color: #2e7d32; }
    .tag-queue { background: #e3f2fd; color: #1565c0; }
    .d-meta { font-size: 13px; color: #666; display: flex; gap: 10px; }
    
    .btn-call { width: 50px; height: 50px; border-radius: 50%; background: linear-gradient(135deg, #00C853, #64DD17); color: white; display: flex; justify-content: center; align-items: center; text-decoration: none; font-size: 20px; box-shadow: 0 4px 10px rgba(76, 175, 80, 0.3); transition: transform 0.1s; cursor: pointer; border: none; }
    .btn-call:active { transform: scale(0.9); }
    .btn-call:disabled { background: #ccc; cursor: not-allowed; transform: none; }

    #btn-loc { position: absolute; bottom: 220px; right: 20px; width: 45px; height: 45px; background: white; border-radius: 50%; box-shadow: 0 4px 15px rgba(0,0,0,0.15); display: flex; justify-content: center; align-items: center; font-size: 20px; color: #666; cursor: pointer; z-index: 15; }
  </style>
</head>
<body>

  <div id="top-bar">
    <div class="status-pill" id="location-pill"><i class="fa-solid fa-location-dot" style="color:#e74c3c;margin-right:8px;"></i> <span id="loc-text">å®šä½ä¸­...</span></div>
    <a href="https://lin.ee/9Davl6e" target="_blank" class="btn-customer"><i class="fa-solid fa-headset"></i>å®¢æœ</a>
  </div>

  <div id="map"></div>
  <div id="btn-loc" onclick="centerMap()"><i class="fa-solid fa-crosshairs"></i></div>
  <div id="driver-carousel"></div>

  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <script>
    // v7.1 ä¹˜å®¢ç«¯æ•ˆèƒ½èˆ‡æµé‡é›™é‡å„ªåŒ–ç‰ˆ (15ç§’æƒæ + åœ°åœ–APIé˜²è­·)
    const LIFF_ID = "2008907691-CzDqd7mm"; 
    const GAS_URL = "https://script.google.com/macros/s/AKfycbzjWZ8j394jfKoMVbPWGvHJHqwF7RBCQxnxyju1ifWKoKdM7RE512F7qrhUsQqQGoWg/exec"; 
    
    const firebaseConfig = { databaseURL: "https://hualientaxi-bb32f-default-rtdb.asia-southeast1.firebasedatabase.app/" };
    
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    
    var map, userMarker, markers = {};
    var myLat = null, myLng = null; 
    var lastGeocodePos = null; // è¨˜éŒ„ä¸Šæ¬¡è½‰æ›è·¯åçš„åº§æ¨™

    const getPinIcon = (type) => {
        const isQueue = type === 'queue';
        const color = isQueue ? '#00B0FF' : '#00C853';
        const labelText = isQueue ? "æ’" : "ç©º";
        return {
            path: "M0-48c-9.8 0-17.7 7.8-17.7 17.4 0 15.5 17.7 30.6 17.7 30.6s17.7-15.4 17.7-30.6c0-9.6-7.9-17.4-17.7-17.4z",
            fillColor: color, fillOpacity: 1, strokeColor: "#fff", strokeWeight: 2, scale: 1.1,
            labelOrigin: new google.maps.Point(0, -28)
        };
    };

    window.onload = async function() {
        initMap();
        await initLiff();
        
        // ğŸš€ v7.1ï¼šå•Ÿå‹• 15 ç§’é›·é”æƒæï¼Œå–ä»£åŸæœ¬çš„ .on()
        fetchDriversData();
        setInterval(fetchDriversData, 15000); 
    };

    function initMap() {
        map = new google.maps.Map(document.getElementById("map"), {
            center: { lat: 23.991, lng: 121.601 }, zoom: 15,
            disableDefaultUI: true, styles: [ { featureType: "poi", elementType: "labels", stylers: [{ visibility: "off" }] } ]
        });
        
        if(navigator.geolocation) {
            navigator.geolocation.watchPosition(pos => {
                myLat = pos.coords.latitude;
                myLng = pos.coords.longitude;
                const p = { lat: myLat, lng: myLng };
                
                if(!userMarker) {
                    userMarker = new google.maps.Marker({ position: p, map: map, icon: { path: google.maps.SymbolPath.CIRCLE, scale: 8, fillColor: "#4285F4", fillOpacity: 1, strokeColor: "white", strokeWeight: 2 }, title: "æˆ‘" });
                    map.panTo(p);
                } else {
                    userMarker.setPosition(p);
                }
                
                // ğŸ›¡ï¸ v7.1 é˜²ç ´ç”¢æ©Ÿåˆ¶ï¼šç§»å‹•è¶…é 100 å…¬å°ºæ‰é‡æ–°å‘¼å« Google æŠ“è·¯å
                const currentGooglePos = new google.maps.LatLng(myLat, myLng);
                if (!lastGeocodePos || google.maps.geometry.spherical.computeDistanceBetween(lastGeocodePos, currentGooglePos) > 100) {
                    getAddress(myLat, myLng);
                    lastGeocodePos = currentGooglePos;
                }
                
            }, (err) => console.log(err), { enableHighAccuracy: true });
        }
    }

    async function initLiff() { try { await liff.init({ liffId: LIFF_ID }); if(!liff.isLoggedIn()) liff.login(); } catch(e){} }

    // ğŸš€ v7.1 æ ¸å¿ƒï¼šæ”¹ç‚º .once() å–®æ¬¡è®€å–
    function fetchDriversData() {
        db.ref('drivers').once('value').then(snapshot => {
            const data = snapshot.val();
            if (!data) return;
            const now = Date.now();
            const activeDrivers = [];
            const activeIds = new Set();

            Object.keys(data).forEach(key => {
                const d = data[key];
                const timeout = d.workStatus === 'queue' ? 3600000 : 600000;
                
                if (d.status !== 'online') return;
                if (now - d.lastUpdate > timeout) return; 
                if (d.workStatus === 'busy') return; 

                activeIds.add(key);
                const pos = { lat: d.lat, lng: d.lng };
                const iconType = d.workStatus === 'queue' ? 'queue' : 'empty';
                const labelText = d.workStatus === 'queue' ? 'æ’' : 'ç©º';

                if (!markers[key]) {
                    markers[key] = new google.maps.Marker({
                        position: pos, map: map, icon: getPinIcon(iconType),
                        label: { text: labelText, color: "white", fontSize: "14px", fontWeight: "bold" },
                        title: d.name
                    });
                    markers[key].addListener('click', () => {
                        const card = document.getElementById(`card-${key}`);
                        if(card) card.scrollIntoView({ behavior: 'smooth', inline: 'center' });
                    });
                } else {
                    markers[key].setPosition(pos);
                    markers[key].setIcon(getPinIcon(iconType));
                    markers[key].setLabel({ text: labelText, color: "white", fontSize: "14px", fontWeight: "bold" });
                }

                let distUser = 999;
                if(myLat && myLng) {
                    distUser = google.maps.geometry.spherical.computeDistanceBetween(new google.maps.LatLng(myLat, myLng), new google.maps.LatLng(d.lat, d.lng)) / 1000;
                }
                d.id = key;
                d.distUser = distUser;
                activeDrivers.push(d);
            });

            for(let k in markers) { if(!activeIds.has(k)) { markers[k].setMap(null); delete markers[k]; } }
            updateCarousel(activeDrivers.sort((a,b) => a.distUser - b.distUser));
        }).catch(err => console.error("ç²å–å¸æ©Ÿè³‡æ–™å¤±æ•—", err));
    }

    function updateCarousel(drivers) {
        const container = document.getElementById('driver-carousel');
        
        // ğŸ¨ v7.1 UIé˜²å‘†ï¼šè¨˜éŒ„ç•¶ä¸‹æ²å‹•ä½ç½®ï¼Œé¿å…æ›´æ–°æ™‚ç•«é¢è·³å‹•
        const currentScroll = container.scrollLeft;
        
        if (drivers.length === 0) {
            container.innerHTML = '<div style="width:100%;text-align:center;color:#999;padding:20px;background:white;border-radius:20px;box-shadow:0 5px 15px rgba(0,0,0,0.1);">é™„è¿‘æš«ç„¡ç©ºè»Š</div>';
            return;
        }

        let newHTML = '';
        drivers.forEach(d => {
            const statusTag = d.workStatus === 'queue' ? '<span class="tag tag-queue">æ’ç­ä¸­</span>' : '<span class="tag tag-empty">ç©ºè»Š</span>';
            const distText = d.distUser < 1 ? (d.distUser*1000).toFixed(0)+'m' : d.distUser.toFixed(1)+'km';
            const avatar = d.photo || 'https://cdn-icons-png.flaticon.com/512/3237/3237472.png';
            
            newHTML += `
                <div class="driver-card" id="card-${d.id}" onclick="map.panTo({lat:${d.lat}, lng:${d.lng}})">
                    <div class="d-avatar"><img src="${avatar}"></div>
                    <div class="d-info">
                        <div class="d-name">${d.name} ${statusTag}</div>
                        <div class="d-meta">
                            <span><i class="fa-solid fa-taxi"></i> ${d.car || 'è¨ˆç¨‹è»Š'}</span>
                            <span><i class="fa-solid fa-location-arrow"></i> ${distText}</span>
                        </div>
                    </div>
                    <button class="btn-call" onclick="callDriver('${d.id}', '${d.phone}', this); event.stopPropagation();"><i class="fa-solid fa-phone"></i></button>
                </div>
            `;
        });
        
        container.innerHTML = newHTML;
        container.scrollLeft = currentScroll; // æ¢å¾©æ²å‹•ä½ç½®
    }

    async function callDriver(driverId, phone, btn) {
        const originalContent = btn.innerHTML;
        btn.innerHTML = '<i class="fa-solid fa-circle-notch fa-spin"></i>';
        btn.disabled = true;

        const makeCall = () => {
            btn.innerHTML = originalContent;
            btn.disabled = false;
            window.location.href = `tel:${phone}`;
        };

        if (!myLat || !myLng) {
            makeCall();
            return;
        }

        try {
            const writePromise = db.ref('drivers/' + driverId + '/request').set({
                lat: myLat, lng: myLng, timestamp: firebase.database.ServerValue.TIMESTAMP
            });

            const pushPromise = fetch(GAS_URL, {
                method: 'POST', mode: 'no-cors',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ source: 'web_app', driverId: driverId })
            });

            const timeoutPromise = new Promise((resolve) => setTimeout(resolve, 2000));
            await Promise.race([Promise.all([writePromise, pushPromise]), timeoutPromise]);
        } catch (error) {
            console.error("ç™¼é€å¤±æ•—:", error);
        } finally {
            makeCall();
        }
    }

    function centerMap(){ if(userMarker) { map.panTo(userMarker.getPosition()); map.setZoom(15); } }
    
    function getAddress(lat, lng) {
        const geocoder = new google.maps.Geocoder();
        geocoder.geocode({ location: { lat: lat, lng: lng } }, (results, status) => {
            if (status === "OK" && results[0]) {
                let addr = results[0].address_components.find(c => c.types.includes('route'))?.short_name || "æ‚¨çš„ä½ç½®";
                document.getElementById('loc-text').innerText = addr;
            }
        });
    }
  </script>
</body>
</html>
