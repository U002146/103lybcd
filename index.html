<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>èŠ±è“®åœ°åœ–å«è»Š</title>
  <!-- å¼•å…¥ Leaflet åœ°åœ–æ¨£å¼ -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    /* CSS æ¨£å¼å€ */
    body { margin: 0; padding: 0; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; overflow: hidden; background: #f0f0f0; }
    #map { width: 100vw; height: 100vh; z-index: 1; }
    
    /* ä¹˜å®¢è³‡è¨Šå¡ HUD (å·¦ä¸Šè§’) */
    #hud {
      position: absolute; top: 15px; left: 15px; z-index: 999;
      background: rgba(30, 30, 30, 0.85); color: white; padding: 10px 15px;
      border-radius: 30px; font-size: 14px; font-weight: bold;
      backdrop-filter: blur(5px); box-shadow: 0 4px 15px rgba(0,0,0,0.2);
      display: flex; align-items: center; gap: 8px; pointer-events: none; /* è®“é»æ“Šç©¿é€ */
    }
    .status-dot { width: 10px; height: 10px; border-radius: 50%; display: inline-block; }
    
    /* å¸æ©Ÿæ§åˆ¶é¢æ¿å®¹å™¨ (å³ä¸Šè§’) */
    #driver-controls {
      display: none; /* é è¨­éš±è—ï¼Œå¸æ©Ÿç™»å…¥æ‰é¡¯ç¤º */
      position: absolute; top: 15px; right: 15px; z-index: 1000;
      flex-direction: column; align-items: center; gap: 15px;
    }

    /* åœ“å½¢æŒ‰éˆ•é€šç”¨æ¨£å¼ */
    .circle-btn {
      border: none; border-radius: 50%; color: white;
      font-weight: bold; cursor: pointer;
      box-shadow: 0 4px 15px rgba(0,0,0,0.3);
      display: flex; flex-direction: column; justify-content: center; align-items: center;
      transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); /* å½ˆæ€§å‹•ç•« */
      text-shadow: 0 1px 2px rgba(0,0,0,0.2);
    }
    .circle-btn:active { transform: scale(0.9); box-shadow: 0 2px 5px rgba(0,0,0,0.2); }

    /* ä¸»é–‹é—œæŒ‰éˆ• (å¤§) */
    #btn-power {
      width: 75px; height: 75px; font-size: 18px;
    }
    
    /* ç‹€æ…‹æŒ‰éˆ• (å°) */
    #btn-status {
      width: 60px; height: 60px; font-size: 14px;
      opacity: 0; transform: translateY(-20px) scale(0.5); pointer-events: none; /* é è¨­éš±è— */
    }
    /* ç‹€æ…‹æŒ‰éˆ•é¡¯ç¤ºæ™‚çš„æ¨£å¼ */
    #btn-status.show {
      opacity: 1; transform: translateY(0) scale(1); pointer-events: auto;
    }

    /* é¡è‰²å®šç¾© */
    .bg-green { background: linear-gradient(135deg, #2ecc71, #27ae60); } /* ä¸Šç·š/ç©ºè»Š */
    .bg-red   { background: linear-gradient(135deg, #e74c3c, #c0392b); } /* ä¸‹ç·š/è¼‰å®¢ */
    .bg-gray  { background: linear-gradient(135deg, #95a5a6, #7f8c8d); } /* é›¢ç·šç° */

    .sub-text { font-size: 10px; opacity: 0.8; font-weight: normal; margin-top: 2px; }

    /* å¸æ©Ÿåç‰‡ Popup */
    .driver-popup { text-align: center; font-size: 15px; min-width: 150px; }
    .call-btn {
      display: block; margin-top: 8px; padding: 10px 0;
      background: #2ecc71; color: white; text-decoration: none;
      border-radius: 20px; font-weight: bold; box-shadow: 0 2px 5px rgba(0,0,0,0.2);
    }
    
    /* Leaflet æ§åˆ¶é …ä½ç½®èª¿æ•´ (é¿å…æ“‹åˆ°æŒ‰éˆ•) */
    .leaflet-top.leaflet-right { top: 120px; } 

  </style>
</head>
<body>

  <!-- å·¦ä¸Šè§’è³‡è¨Š HUD -->
  <div id="hud">
    <span class="status-dot" style="background:gray;"></span> é€£ç·šä¸­...
  </div>

  <!-- åœ°åœ– -->
  <div id="map"></div>

  <!-- å³ä¸Šè§’å¸æ©Ÿæ§åˆ¶å° -->
  <div id="driver-controls">
    <!-- 1. ä¸»é–‹é—œ (ä¸Šç·š/ä¸‹ç·š) -->
    <button id="btn-power" class="circle-btn bg-gray" onclick="togglePower()">
      <span>ä¸Šç·š</span>
      <span class="sub-text">OFF</span>
    </button>
    
    <!-- 2. ç‹€æ…‹é–‹é—œ (ç©ºè»Š/è¼‰å®¢) - é è¨­éš±è— -->
    <button id="btn-status" class="circle-btn bg-green" onclick="toggleStatus()">
      <span>ç©ºè»Š</span>
    </button>
  </div>

  <!-- ç¨‹å¼é‚è¼¯ -->
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
    // ========= è¨­å®šå€ (è«‹ä¿®æ”¹é€™è£¡) =========
    const GAS_URL = "https://script.google.com/macros/s/AKfycbyfNTgci2gZE2Etxvv6SHaP3puw7Mxt8ineL4gZve7Zyh2UGrcna4Zxap6EOyRICQ/exec"; 
    const LIFF_ID = "2008907691-7ntMtfbA"; 
    // =====================================

    var map, markers = {};
    var currentUser = null;
    var isDriver = false;
    
    // å¸æ©Ÿç‹€æ…‹è®Šæ•¸
    var isOnline = false; // æ˜¯å¦ä¸Šç­
    var isBusy = false;   // æ˜¯å¦è¼‰å®¢
    var updateTimer = null; // ä¸Šå‚³ä½ç½®çš„è¨ˆæ™‚å™¨

    // è‡ªå®šç¾© Icon
    const iconEmpty = L.divIcon({ html: '<div style="font-size:32px; filter: drop-shadow(2px 4px 6px rgba(0,0,0,0.4));">ğŸš•</div>', className: '', iconSize: [32, 32], iconAnchor: [16, 16] });
    const iconBusy = L.divIcon({ html: '<div style="font-size:32px; filter: grayscale(100%) opacity(0.7);">ğŸš•</div>', className: '', iconSize: [32, 32], iconAnchor: [16, 16] });

    window.onload = async function() {
      initMap();
      await initLiff();
    };

    function initMap() {
      // 1. åˆå§‹åŒ–åœ°åœ– (èŠ±è“®å¸‚ä¸­å¿ƒï¼Œç¸®æ”¾ 13 é©åˆå¸‚å€å°èˆª)
      map = L.map('map', { zoomControl: false }).setView([23.99000, 121.60684], 13);
      
      // å°‡ç¸®æ”¾æŒ‰éˆ•ç§»åˆ°å³ä¸‹è§’ï¼Œé¿å…è·Ÿæˆ‘å€‘çš„æŒ‰éˆ•æ‰“æ¶
      L.control.zoom({ position: 'bottomright' }).addTo(map);

      // 2. Google Maps æ¨™æº–è¡—é“åœ– (å…è²»æ–¹å¼)
      L.tileLayer('https://{s}.google.com/vt/lyrs=m&x={x}&y={y}&z={z}', {
        maxZoom: 20,
        subdomains: ['mt0', 'mt1', 'mt2', 'mt3'],
        attribution: 'Map data &copy; Google'
      }).addTo(map);
    }

    async function initLiff() {
      try {
        await liff.init({ liffId: LIFF_ID });
        if (!liff.isLoggedIn()) {
          liff.login();
          return;
        }
        const profile = await liff.getProfile();
        currentUser = profile;
        
        checkRole(profile.userId);
        fetchDrivers();
        setInterval(fetchDrivers, 10000);

      } catch (err) {
        // å¦‚æœåœ¨ç€è¦½å™¨æ¸¬è©¦å¯ä»¥å¿½ç•¥ LIFF éŒ¯èª¤
        console.log("LIFF Init Error (Dev Mode):", err);
      }
    }

    // --- èº«åˆ†é©—è­‰ ---
    function checkRole(uid) {
      fetch(`${GAS_URL}?op=check_role&uid=${uid}`)
        .then(res => res.json())
        .then(data => {
          if (data.role === 'driver') {
            isDriver = true;
            // é¡¯ç¤ºå³ä¸Šè§’æ§åˆ¶å°
            document.getElementById('driver-controls').style.display = 'flex';
            // æ­¡è¿è¨Šæ¯
            // alert(`é‹å°‡ ${data.name} æ­¡è¿é–‹å·¥ï¼`);
          }
        });
    }

    // --- å¸æ©Ÿç«¯åŠŸèƒ½ (UI æ›´æ–°é‚è¼¯) ---
    function togglePower() {
      isOnline = !isOnline;
      const btnPower = document.getElementById('btn-power');
      const btnStatus = document.getElementById('btn-status');

      if (isOnline) {
        // == è®Šç‚ºä¸Šç·šç‹€æ…‹ ==
        // 1. ä¸»æŒ‰éˆ•è®Šç´…è‰² (é¡¯ç¤ºç‚ºå¯ä¸‹ç·š)
        btnPower.className = "circle-btn bg-red";
        btnPower.innerHTML = `<span>ä¸‹ç·š</span><span class="sub-text">ON</span>`;
        
        // 2. é¡¯ç¤ºç‹€æ…‹å­æŒ‰éˆ• (æ»‘å…¥å‹•ç•«)
        btnStatus.classList.add('show');
        
        // 3. é–‹å§‹å‚³é€ GPS
        uploadLocation();
        updateTimer = setInterval(uploadLocation, 30000); 

      } else {
        // == è®Šç‚ºä¸‹ç·šç‹€æ…‹ ==
        // 1. ä¸»æŒ‰éˆ•è®Šç°è‰²/ç¶ è‰² (é¡¯ç¤ºç‚ºå¯ä¸Šç·š)
        btnPower.className = "circle-btn bg-green"; // é€™è£¡æ”¹æˆç¶ è‰²å¼•å°ä¸Šç·š
        btnPower.innerHTML = `<span>ä¸Šç·š</span><span class="sub-text">OFF</span>`;
        
        // 2. éš±è—ç‹€æ…‹å­æŒ‰éˆ•
        btnStatus.classList.remove('show');
        
        // 3. åœæ­¢ GPS ä¸¦å‚³é€ä¸‹ç·šè¨Šè™Ÿ
        clearInterval(updateTimer);
        postData('offline', isBusy ? 'busy' : 'empty', 0, 0);
      }
    }

    function toggleStatus() {
      isBusy = !isBusy;
      const btnStatus = document.getElementById('btn-status');
      
      if (isBusy) {
        // è®Šç‚ºè¼‰å®¢ä¸­ (ç´…)
        btnStatus.className = "circle-btn bg-red show";
        btnStatus.innerHTML = `<span>è¼‰å®¢</span>`;
      } else {
        // è®Šç‚ºç©ºè»Š (ç¶ )
        btnStatus.className = "circle-btn bg-green show";
        btnStatus.innerHTML = `<span>ç©ºè»Š</span>`;
      }
      // ç‹€æ…‹è®Šæ›´ç«‹åˆ»ä¸Šå‚³ä¸€æ¬¡
      uploadLocation();
    }

    function uploadLocation() {
      if (!isOnline) return;
      
      navigator.geolocation.getCurrentPosition(pos => {
        const lat = pos.coords.latitude;
        const lng = pos.coords.longitude;
        // å¸æ©Ÿè‡ªå·±åœ°åœ–è·Ÿéš¨ (å¯é¸)
        // map.panTo([lat, lng]);
        
        postData('online', isBusy ? 'busy' : 'empty', lat, lng);
      }, err => {
        console.error("GPS Error");
      });
    }

    function postData(status, work, lat, lng) {
      const payload = {
        userId: currentUser.userId,
        status: status,
        work: work,
        lat: lat,
        lng: lng
      };
      // é€™è£¡ä½¿ç”¨ no-cors æ¨¡å¼é¿å…éƒ¨åˆ†è·¨åŸŸå•é¡Œï¼Œä½† GAS å¿…é ˆæ­£ç¢ºè™•ç† doPost
      fetch(GAS_URL, {
        method: 'POST',
        mode: 'no-cors', // å¦‚æœé‡åˆ° CORS éŒ¯èª¤å¯ä»¥åŠ é€™è¡Œï¼Œä½†é€šå¸¸å»ºè­° GAS ç«¯è™•ç†å¥½ header
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      }).catch(e => console.log(e));
    }

    // --- ä¹˜å®¢ç«¯ (åœ°åœ–é¡¯ç¤º) ---
    function fetchDrivers() {
      fetch(`${GAS_URL}?op=get_drivers`)
        .then(res => res.json())
        .then(drivers => {
          updateMap(drivers);
          updateHUD(drivers.length);
        });
    }

    function updateMap(drivers) {
      // ç‚ºäº†æ•ˆèƒ½ï¼Œé€™è£¡å…ˆå…¨æ¸…å†å…¨ç•« (è»ŠéšŠè¦æ¨¡å°æ–¼100å°æ™‚æ²’å•é¡Œ)
      for (let id in markers) { map.removeLayer(markers[id]); }
      markers = {};

      drivers.forEach(d => {
        let icon = d.workStatus === 'busy' ? iconBusy : iconEmpty;
        let marker = L.marker([d.lat, d.lng], {icon: icon}).addTo(map);
        
        // åç‰‡å…§å®¹
        let popupContent = `
          <div class="driver-popup">
            <b style="font-size:16px;">ğŸš• ${d.name}</b><br>
            <span style="color:${d.workStatus==='busy'?'red':'green'}; font-size:12px; font-weight:bold;">
              â— ${d.workStatus === 'busy' ? 'è¼‰å®¢ä¸­' : 'ç›®å‰ç©ºè»Š'}
            </span><br>
            <a href="tel:${d.phone}" class="call-btn">ğŸ“ ç›´æ¥å«è»Š</a>
          </div>
        `;
        marker.bindPopup(popupContent);
        markers[d.id] = marker;
      });
    }

    function updateHUD(count) {
      const hud = document.getElementById('hud');
      const dot = hud.querySelector('.status-dot');
      if (count > 0) {
        dot.style.background = "#2ecc71";
        hud.innerHTML = `<span class="status-dot" style="background:#2ecc71;"></span> ç·šä¸Šé‹å°‡ï¼š${count} äºº`;
      } else {
        dot.style.background = "#e74c3c";
        hud.innerHTML = `<span class="status-dot" style="background:#e74c3c;"></span> ç›®å‰ç„¡å¸æ©Ÿæœå‹™`;
      }
    }
  </script>
</body>
</html>
