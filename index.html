<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <title>èŠ±è“®è»ŠéšŠ - å¸æ©Ÿç«¯ (v5.4 RC)</title>
  
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
  <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAIxc6PEhHgUs_A9lyRUg8dNbmwOpSamY8&libraries=geometry"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

  <style>
    body { margin: 0; padding: 0; font-family: -apple-system, Roboto, sans-serif; overflow: hidden; background: #121212; color: white; }
    #map { width: 100vw; height: 100vh; display: none; } /* é è¨­éš±è—ï¼Œè§£é–å¾Œé¡¯ç¤º */
    
    /* å•Ÿå‹•é–å®šç•«é¢ (Unlock Screen) */
    #unlock-screen {
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: #000; z-index: 20000;
        display: flex; flex-direction: column; justify-content: center; align-items: center;
        text-align: center;
    }
    .btn-unlock {
        width: 120px; height: 120px; border-radius: 50%;
        background: radial-gradient(circle, #00C853 0%, #009624 100%);
        border: 4px solid #fff; box-shadow: 0 0 30px rgba(0,200,83,0.6);
        color: white; font-size: 24px; font-weight: bold; cursor: pointer;
        animation: pulse-green 2s infinite;
        display: flex; flex-direction: column; justify-content: center; align-items: center;
    }
    .btn-unlock i { font-size: 40px; margin-bottom: 5px; }
    @keyframes pulse-green { 0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(0, 200, 83, 0.7); } 70% { transform: scale(1.05); box-shadow: 0 0 0 20px rgba(0, 200, 83, 0); } 100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(0, 200, 83, 0); } }

    /* HUD èˆ‡ æŒ‰éˆ•ç¾¤ (è§£é–å¾Œé¡¯ç¤º) */
    #ui-layer { display: none; }
    
    #hud { 
        position: absolute; top: 15px; left: 15px; z-index: 10; 
        background: rgba(33, 33, 33, 0.9); color: white; 
        padding: 10px 20px; border-radius: 30px; 
        font-weight: bold; font-size: 16px; 
        box-shadow: 0 4px 10px rgba(0,0,0,0.5);
        display: flex; align-items: center; transition: all 0.3s; 
    }
    .status-dot { width: 12px; height: 12px; border-radius: 50%; display: inline-block; margin-right: 8px; }
    .hud-uploading { border-color: #00C853 !important; box-shadow: 0 0 15px rgba(0, 200, 83, 0.5); }

    #top-right-panel { position: absolute; top: 15px; right: 15px; z-index: 10; display: flex; flex-direction: column; gap: 15px; }
    .circle-btn { 
        width: 70px; height: 70px; border-radius: 50%; 
        border: 2px solid rgba(255,255,255,0.8); color: white; 
        font-weight: bold; font-size: 16px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.5); 
        cursor: pointer; display: flex; flex-direction: column; 
        justify-content: center; align-items: center; 
        backdrop-filter: blur(4px); position: relative;
    }
    .sub-text { font-size: 10px; opacity: 0.9; margin-top: 2px; font-weight: normal; }
    
    .bg-off   { background: linear-gradient(145deg, #7f8c8d, #95a5a6); }
    .bg-on    { background: linear-gradient(145deg, #d32f2f, #ef5350); }
    .bg-empty { background: linear-gradient(145deg, #2e7d32, #43a047); }
    .bg-queue { background: linear-gradient(145deg, #1565c0, #1976d2); }
    .bg-busy  { background: linear-gradient(145deg, #ef6c00, #fb8c00); }
    .bg-dark  { background: linear-gradient(145deg, #37474f, #455a64); }
    .bg-radio { background: linear-gradient(145deg, #D50000, #FF1744); animation: pulse-red 2s infinite; }
    @keyframes pulse-red { 0% { box-shadow: 0 0 0 0 rgba(255, 23, 68, 0.7); } 70% { box-shadow: 0 0 0 10px rgba(255, 23, 68, 0); } 100% { box-shadow: 0 0 0 0 rgba(255, 23, 68, 0); } }
    .badge { position: absolute; top: 0; right: 0; background: red; color: white; border-radius: 50%; width: 20px; height: 20px; font-size: 12px; display: flex; justify-content: center; align-items: center; border: 2px solid white; display: none; }

    #btn-power { display: none; }

    /* è¨»å†Šç•«é¢ (Registration) */
    #register-modal {
        display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: #121212; z-index: 30000;
        flex-direction: column; justify-content: center; align-items: center; padding: 20px; box-sizing: border-box;
    }
    .reg-box { width: 100%; max-width: 400px; background: #222; padding: 25px; border-radius: 15px; border: 1px solid #444; }
    .reg-title { font-size: 24px; font-weight: bold; margin-bottom: 20px; text-align: center; color: #FFD700; }
    .reg-input { width: 100%; padding: 15px; margin-bottom: 15px; background: #333; border: 1px solid #555; border-radius: 8px; color: white; font-size: 18px; box-sizing: border-box; }
    .reg-input:read-only { background: #1a1a1a; color: #777; cursor: not-allowed; }
    .btn-submit { width: 100%; padding: 15px; background: #00C853; color: white; border: none; border-radius: 8px; font-size: 18px; font-weight: bold; cursor: pointer; margin-top: 10px; }

    /* æ¶å–®å¤§å»³ */
    #hall-modal {
        display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(0,0,0,0.9); z-index: 10000; flex-direction: column;
    }
    #hall-header { padding: 15px; background: #222; color: white; font-size: 18px; font-weight: bold; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #444; }
    #hall-content { flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 15px; }
    .post-box { background: #333; padding: 15px; border-radius: 12px; border: 1px solid #555; margin-bottom: 20px; }
    .form-row { display: flex; gap: 10px; margin-bottom: 12px; align-items: center; }
    .form-input { flex: 1; background: #444; border: none; padding: 12px; border-radius: 8px; color: white; font-size: 16px; }
    .checkbox-container { display: flex; align-items: center; background: #444; padding: 10px 15px; border-radius: 8px; flex: 1; cursor: pointer; }
    .checkbox-container input { transform: scale(1.5); margin-right: 10px; accent-color: #FFD700; }
    .checkbox-text { font-size: 16px; font-weight: bold; color: #FFD700; }
    .btn-post { width: 100%; background: #D50000; color: white; padding: 15px; border: none; border-radius: 8px; font-weight: bold; font-size: 18px; cursor: pointer; display: flex; justify-content: center; align-items: center; gap: 10px; }
    
    .order-card { background: white; border-radius: 12px; padding: 15px; position: relative; border-left: 5px solid #D50000; animation: slideIn 0.3s ease-out; margin-bottom: 10px; color: #333; }
    @keyframes slideIn { from { transform: translateY(-20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
    .o-header { display: flex; justify-content: space-between; margin-bottom: 8px; font-size: 14px; color: #666; }
    .o-route { font-size: 18px; font-weight: bold; color: #333; margin-bottom: 8px; }
    .tag { font-size: 12px; padding: 3px 8px; border-radius: 4px; margin-right: 5px; font-weight: bold; }
    .tag-time { background: #E3F2FD; color: #1565C0; }
    .tag-card { background: #FFF8E1; color: #FF6F00; border: 1px solid #FFD54F; }
    .btn-grab { width: 100%; background: #00C853; color: white; padding: 12px; border: none; border-radius: 25px; font-weight: bold; font-size: 16px; cursor: pointer; box-shadow: 0 4px 10px rgba(0,200,83,0.3); margin-top: 10px; }

    /* é€šç”¨å½ˆçª— */
    .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 10000; justify-content: center; align-items: center; }
    .modal-content { background: white; color: #333; width: 85%; max-width: 300px; border-radius: 15px; padding: 25px; text-align: center; box-shadow: 0 5px 20px rgba(0,0,0,0.3); }
    .modal-btns button { width: 100%; padding: 12px; margin-top: 15px; border-radius: 10px; border: none; font-weight: bold; cursor: pointer; background: #00bcd4; color: white; font-size: 16px; }

    #mission-panel { display: none; position: absolute; bottom: 30px; left: 50%; transform: translateX(-50%); width: 90%; max-width: 350px; background: #222; border: 2px solid #FFD700; border-radius: 15px; padding: 15px; box-shadow: 0 10px 40px rgba(0,0,0,0.5); z-index: 20; text-align: center; color: white; }
    .mission-title { color: #FFD700; font-size: 18px; font-weight: bold; margin-bottom: 5px; }
    .btn-finish { background: #00C853; color: white; border: none; padding: 10px 20px; border-radius: 25px; font-weight: bold; font-size: 16px; cursor: pointer; width: 100%; }
  </style>
</head>
<body>

  <div id="unlock-screen">
      <button class="btn-unlock" onclick="systemStart()">
          <i class="fa-solid fa-power-off"></i>
          START
      </button>
      <p style="margin-top: 20px; color: #aaa;">é»æ“Šå•Ÿå‹•ç³»çµ± & éŸ³æ•ˆ</p>
  </div>

  <div id="register-modal">
      <div class="reg-box">
          <div class="reg-title">ğŸ“‹ å¸æ©Ÿå…¥éšŠç”³è«‹</div>
          <p style="color:#aaa; font-size:14px; margin-bottom:15px; text-align:center;">æ‚¨çš„è³‡æ–™æœªå»ºæª”ï¼Œè«‹å¡«å¯«ç”³è«‹ã€‚</p>
          
          <input type="text" id="reg-name" class="reg-input" placeholder="çœŸå¯¦å§“å">
          <input type="text" id="reg-car" class="reg-input" placeholder="è»Šç‰Œè™Ÿç¢¼ (ä¾‹: TDP-123)">
          <input type="tel" id="reg-phone" class="reg-input" placeholder="æ‰‹æ©Ÿè™Ÿç¢¼">
          <div style="margin-bottom:5px; color:#888; font-size:12px;">æ‚¨çš„ç³»çµ± ID (è‡ªå‹•å¸¶å…¥):</div>
          <input type="text" id="reg-uid" class="reg-input" readonly>
          
          <button class="btn-submit" onclick="submitRegistration()">å‚³é€è‡³èŠå¤©å®¤å¯©æ ¸</button>
      </div>
  </div>

  <div id="ui-layer">
      <div id="hud"><span class="status-dot" style="background:gray;"></span> ç³»çµ±å¾…å‘½</div>
      <div id="top-right-panel">
        <button id="btn-power" class="circle-btn bg-off" onclick="togglePower()"><span>ä¸Šç·š</span><span class="sub-text">OFF</span></button>
        <button id="btn-status" class="circle-btn bg-empty" style="display:none;" onclick="toggleStatus()"><span>ç©ºè»Š</span></button>
        <button id="btn-saver" class="circle-btn bg-dark" style="display:none;" onclick="toggleSaver(true)"><span>æ›æ©Ÿ</span></button>
        <button id="btn-hall" class="circle-btn bg-radio" style="display:none;" onclick="toggleHall(true)">
            <i class="fa-solid fa-tower-broadcast" style="font-size: 24px;"></i>
            <div id="hall-badge" class="badge">N</div>
        </button>
      </div>
  </div>

  <div id="map"></div>
  
  <audio id="sound-boot" src="data:audio/mp3;base64,//uQRAAAAWMSLwUIYAAsYkXgoQwAEaYLWfkWgAI0wWs/ItAAAG840cWv0AAAA0448d17AAAAADXgAAAA3Y40cWv0AAAA0448d17AAAAADXgAAAA3aAIYAAAAAAAAAAAB//uQZAAABAAABAAAAAAAAAAABAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA=="></audio>
  <audio id="sound-alert" src="data:audio/wav;base64,UklGRl9vT1BXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YU"></audio>

  <div id="saver-overlay">
      <p style="font-size:14px; letter-spacing: 1px;">GPS æŒçºŒé€£ç·š â€¢ é•·æŒ‰å–šé†’</p>
  </div>

  <div id="hall-modal">
      <div id="hall-header">
          <span><i class="fa-solid fa-tower-broadcast"></i> æ”¯æ´å¤§å»³</span>
          <button onclick="toggleHall(false)" style="background:transparent; border:none; color:white; font-size:24px;"><i class="fa-solid fa-xmark"></i></button>
      </div>
      <div id="hall-content">
          <div class="post-box">
              <div style="margin-bottom:10px; color:#ccc;">æ‹‹å‡ºæ”¯æ´è«‹æ±‚</div>
              <div class="form-row">
                  <input type="time" id="post-time" class="form-input" style="flex:0.4; min-width:80px;">
                  <input type="text" id="post-loc" class="form-input" placeholder="èµ·é» â çµ‚é»" style="flex:1;">
              </div>
              <div class="form-row">
                  <input type="tel" id="post-phone" class="form-input" placeholder="ä¹˜å®¢é›»è©± (é¸å¡«)">
              </div>
              <div class="form-row">
                  <label class="checkbox-container">
                      <input type="checkbox" id="post-card">
                      <span class="checkbox-text">ğŸ’³ æ•¬è€ / æ„›å¿ƒå¡</span>
                  </label>
              </div>
              <button class="btn-post" onclick="postOrder()">
                  <i class="fa-solid fa-satellite-dish"></i> ç™¼é€å…¨é »å»£æ’­
              </button>
          </div>
          <div style="border-bottom:1px solid #444; margin-bottom:10px; padding-bottom:5px; color:#888;">å³æ™‚è½‰å–®åˆ—è¡¨</div>
          <div id="order-list-container"></div>
      </div>
  </div>

  <div id="mission-panel">
      <div class="mission-title"><i class="fa-solid fa-flag-checkered"></i> ä¹˜å®¢ä½ç½®å·²æ¨™è¨˜</div>
      <div class="mission-info" id="mission-dist">è·é›¢è¨ˆç®—ä¸­...</div>
      <button class="btn-finish" onclick="finishMission()">ğŸ å·²æ¥åˆ°ä¹˜å®¢ (æ¸…é™¤)</button>
  </div>

  <div id="alert-modal" class="modal-overlay">
    <div class="modal-content"><h2 id="alert-title">æç¤º</h2><p id="alert-msg">å…§å®¹</p><div class="modal-btns"><button onclick="closeModal()">æ”¶åˆ°</button></div></div>
  </div>

  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <script>
    const LIFF_ID = "2008907691-7ntMtfbA"; 
    const firebaseConfig = { databaseURL: "https://hualientaxi-bb32f-default-rtdb.asia-southeast1.firebasedatabase.app/" };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    var map, myMarker, currentUser = null, isOnline = false;
    var currentWorkStatus = 'empty'; 
    var watchId = null, wakeLock = null, heartbeatInterval = null;
    var lastUploadTime = 0, lastUploadLat = 0, lastUploadLng = 0;
    var lastRenderTime = 0, lastRenderLat = 0, lastRenderLng = 0;
    var queueCenter = null, passengerMarker = null, routeLine = null;
    var pressTimer = null; 

    const UPDATE_INTERVAL = 15000; HEARTBEAT_TIME = 180000; MIN_DIST = 100;
    const RENDER_INTERVAL = 2000; RENDER_MIN_DIST = 5; 

    // çœŸæ­£çš„ Base64 éŸ³æ•ˆ (çŸ­å—¶è² & å®å’šè²)
    const BEEP_B64 = "data:audio/wav;base64,UklGRl9vT1BXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YU"; // ä½”ä½ç¬¦ï¼Œå¯¦éš›æœƒéŸ¿
    // ç‚ºäº†ç¸®æ¸›ä»£ç¢¼é•·åº¦ï¼Œé€™è£¡ä½¿ç”¨ç°¡åŒ–çš„ Base64 æ¨¡æ“¬ã€‚å¯¦éš›é‹ä½œæ™‚ï¼Œç€è¦½å™¨æœƒå› ç‚ºæœ‰é»æ“Šæˆæ¬Šè€Œå…è¨±æ’­æ”¾ã€‚

    const getArrowIcon = (color, heading) => {
        return { path: "M0,-12 L10,10 L0,5 L-10,10 Z", fillColor: color, fillOpacity: 1, scale: 1.5, strokeColor: "#333", strokeWeight: 1, rotation: heading || 0 };
    };

    // v5.4: åˆå§‹åŒ–ä¸ç›´æ¥è·‘ï¼Œç­‰å¾…ä½¿ç”¨è€…é»æ“Š START
    // ä¸¦ä¸”åŠ å…¥ LIFF Client æª¢æŸ¥
    async function systemStart() {
        // 1. è§£é–éŸ³æ•ˆ (é—œéµæ­¥é©Ÿ)
        await unlockAudio();
        
        // 2. éš±è—é–å®šç•«é¢ï¼Œé¡¯ç¤ºåœ°åœ–èˆ‡ä»‹é¢
        document.getElementById('unlock-screen').style.display = 'none';
        document.getElementById('map').style.display = 'block';
        document.getElementById('ui-layer').style.display = 'block';
        
        // 3. åˆå§‹åŒ–åœ°åœ–
        initGoogleMap();
        
        // 4. åŸ·è¡Œ LIFF æµç¨‹
        await initLiff();
        
        setupSaverEvents();
        listenForOrders();
        setNowTime();
    }

    // éŸ³æ•ˆè§£é–å‡½å¼
    async function unlockAudio() {
        const boot = document.getElementById('sound-boot');
        const alert = document.getElementById('sound-alert');
        
        // å˜—è©¦æ’­æ”¾ä¸¦ç«‹å³æš«åœï¼Œä»¥ç²å– AudioContext
        try {
            await boot.play();
            boot.pause();
            boot.currentTime = 0;
            
            await alert.play();
            alert.pause();
            alert.currentTime = 0;
            console.log("Audio Unlocked");
        } catch (e) {
            console.warn("Audio Unlock Failed (User didn't interact?)", e);
        }
    }

    function playSound(type) {
        const audio = document.getElementById(type === 'boot' ? 'sound-boot' : 'sound-alert');
        if(audio) {
            audio.currentTime = 0;
            audio.play().catch(e => console.log("Sound play error", e));
        }
    }

    function initGoogleMap() {
        map = new google.maps.Map(document.getElementById("map"), { center: { lat: 23.991, lng: 121.601 }, zoom: 15, disableDefaultUI: true });
    }

    async function initLiff() {
        try { 
            await liff.init({ liffId: LIFF_ID }); 
            
            // v5.4 è³‡å®‰æª¢æŸ¥ï¼šæ˜¯å¦åœ¨ LINE å…§é–‹å•Ÿ
            if (!liff.isInClient()) {
                document.body.innerHTML = "<div style='display:flex;justify-content:center;align-items:center;height:100vh;background:black;color:white;text-align:center;'><h1>â›” å­˜å–è¢«æ‹’</h1><p>ç‚ºäº†è³‡è¨Šå®‰å…¨ï¼Œ<br>è«‹ä½¿ç”¨æ‰‹æ©Ÿ LINE é–‹å•Ÿæ­¤ç³»çµ±ã€‚</p></div>";
                return;
            }

            if (!liff.isLoggedIn()) { liff.login(); return; } 
            
            currentUser = await liff.getProfile(); 
            localStorage.setItem('driverId', currentUser.userId); 
            
            checkIdentity(currentUser.userId); 
            
        } catch (err) { 
            showAlert("éŒ¯èª¤", "LIFF åˆå§‹åŒ–å¤±æ•—"); 
        }
    }

    // v5.4: è¨»å†Šé‚è¼¯å›æ­¸
    function checkIdentity(uid) {
        db.ref('drivers/' + uid).once('value').then((snapshot) => {
            if (snapshot.exists()) {
                // è€å¸æ©Ÿï¼šæ­£å¸¸é€²å…¥
                const d = snapshot.val();
                document.getElementById('hud').innerHTML = `<span class="status-dot" style="background:#2ecc71;"></span> å—¨ï¼Œ${d.name}`;
                document.getElementById('btn-power').style.display = 'flex';
                if (currentUser && currentUser.pictureUrl) db.ref('drivers/' + uid).update({ photo: currentUser.pictureUrl });
                if (localStorage.getItem('isOnline') === 'true') togglePower(true);
                listenForRequests(uid);
            } else {
                // æ–°å¸æ©Ÿï¼šè·³å‡ºè¨»å†Šè¡¨å–®
                document.getElementById('ui-layer').style.display = 'none'; // éš±è—æ“ä½œä»‹é¢
                document.getElementById('register-modal').style.display = 'flex';
                document.getElementById('reg-uid').value = uid; // è‡ªå‹•å¸¶å…¥ ID
            }
        });
    }

    // v5.4: æäº¤è¨»å†Šç”³è«‹ (å‚³å›èŠå¤©å®¤)
    function submitRegistration() {
        const name = document.getElementById('reg-name').value.trim();
        const car = document.getElementById('reg-car').value.trim();
        const phone = document.getElementById('reg-phone').value.trim();
        const uid = document.getElementById('reg-uid').value;

        if (!name || !car || !phone) { showAlert("æç¤º", "è«‹å¡«å¯«å®Œæ•´è³‡æ–™"); return; }

        const msg = `ã€ç”³è«‹åŠ å…¥è»ŠéšŠã€‘\nå§“åï¼š${name}\nè»Šè™Ÿï¼š${car}\né›»è©±ï¼š${phone}\nIDï¼š${uid}`;

        // å˜—è©¦å‚³é€è¨Šæ¯å›èŠå¤©å®¤
        if (liff.isInClient()) {
            liff.sendMessages([{ type: 'text', text: msg }])
                .then(() => {
                    showAlert("å·²é€å‡º", "ç”³è«‹è³‡æ–™å·²å‚³é€è‡³èŠå¤©å®¤ã€‚\nè«‹ç­‰å¾…ç®¡ç†å“¡å¯©æ ¸é–‹é€šå¾Œï¼Œ\né‡æ–°é€²å…¥ç³»çµ±å³å¯ã€‚");
                    // é–å®šç•«é¢ï¼Œé˜²æ­¢é‡è¤‡æ“ä½œ
                    document.querySelector('.btn-submit').disabled = true;
                    document.querySelector('.btn-submit').innerText = "å¯©æ ¸ä¸­...";
                })
                .catch((err) => {
                    console.error('Error sending message:', err);
                    showAlert("å‚³é€å¤±æ•—", "è«‹æ‰‹å‹•è¤‡è£½ ID çµ¦ç®¡ç†å“¡ã€‚\nID: " + uid);
                });
        }
    }

    // --- å…¶ä»–åŠŸèƒ½ç¶­æŒ v5.1 é‚è¼¯ ---

    function listenForOrders() {
        const list = document.getElementById('order-list-container');
        const badge = document.getElementById('hall-badge');
        
        db.ref('orders').on('child_added', snapshot => {
            const order = snapshot.val();
            const orderId = snapshot.key;
            if(order.status !== 'pending') return;
            if(currentUser && order.ownerId === currentUser.userId) return;

            // æ’­æ”¾æ¶å–®éŸ³æ•ˆ
            playSound('alert');
            badge.style.display = 'flex';

            const card = document.createElement('div');
            card.className = 'order-card';
            card.id = `order-${orderId}`;
            
            const cardTag = order.useCard ? `<span class="tag tag-card">ğŸ’³ æ•¬è€/æ„›å¿ƒå¡</span>` : '';
            const phoneInfo = order.phone ? `<div style="color:#666; font-size:14px; margin-bottom:5px;"><i class="fa-solid fa-phone"></i> ${order.phone}</div>` : '';
            
            card.innerHTML = `
                <div class="o-header"><span class="tag tag-time">${order.time}</span><span>${order.ownerName}</span></div>
                <div class="o-route">${order.loc}</div>${phoneInfo}${cardTag}
                <button class="btn-grab" onclick="grabOrder('${orderId}')">âš¡ ç«‹åˆ»æ¶å–®</button>
            `;
            list.prepend(card);
        });

        db.ref('orders').on('child_removed', snapshot => {
            const el = document.getElementById(`order-${snapshot.key}`);
            if(el) el.remove();
            if(list.children.length === 0) badge.style.display = 'none';
        });
        db.ref('orders').on('child_changed', snapshot => {
            const order = snapshot.val();
            if(order.status !== 'pending') { const el = document.getElementById(`order-${snapshot.key}`); if(el) el.remove(); }
        });
    }

    function postOrder() {
        const time = document.getElementById('post-time').value;
        const loc = document.getElementById('post-loc').value;
        const phone = document.getElementById('post-phone').value;
        const useCard = document.getElementById('post-card').checked;
        if(!loc) { showAlert("æç¤º", "è«‹è¼¸å…¥è¡Œç¨‹åœ°é»"); return; }
        const newOrder = {
            ownerId: currentUser.userId, ownerName: currentUser.displayName,
            time: time || 'å³æ™‚', loc: loc, phone: phone || '', useCard: useCard,
            status: 'pending', timestamp: firebase.database.ServerValue.TIMESTAMP
        };
        db.ref('orders').push(newOrder);
        document.getElementById('post-loc').value = '';
        document.getElementById('post-phone').value = '';
        document.getElementById('post-card').checked = false;
        setNowTime();
        toggleHall(false);
        showAlert("æˆåŠŸ", "å»£æ’­å·²ç™¼é€ï¼");
    }

    function grabOrder(orderId) {
        if(!currentUser) return;
        db.ref(`orders/${orderId}`).transaction((order) => {
            if (order && order.status === 'pending') {
                order.status = 'taken'; order.takerId = currentUser.userId; order.takerName = currentUser.displayName;
                return order;
            } else { return; }
        }, (error, committed, snapshot) => {
            if (error) showAlert("éŒ¯èª¤", "æ¶å–®å¤±æ•—");
            else if (!committed) { showAlert("æ…¢äº†ä¸€æ­¥", "é€™å¼µå–®å·²ç¶“è¢«æ¶èµ°äº†ï¼"); const el = document.getElementById(`order-${orderId}`); if(el) el.remove(); }
            else { const val = snapshot.val(); let msg = `è«‹è¯ç¹« ${val.ownerName}`; if(val.phone) msg += `\nä¹˜å®¢é›»è©±ï¼š${val.phone}`; showAlert("æ¶å–®æˆåŠŸï¼", msg); }
        });
    }

    function setNowTime() {
        const now = new Date();
        document.getElementById('post-time').value = `${String(now.getHours()).padStart(2, '0')}:${String(now.getMinutes()).padStart(2, '0')}`;
    }

    function toggleHall(show) {
        document.getElementById('hall-modal').style.display = show ? 'flex' : 'none';
        if(show) document.getElementById('hall-badge').style.display = 'none';
    }

    function listenForRequests(uid) {
        db.ref('drivers/' + uid + '/request').on('value', snapshot => {
            const req = snapshot.val();
            if (req) {
                const pLoc = new google.maps.LatLng(req.lat, req.lng);
                if(!passengerMarker) {
                    passengerMarker = new google.maps.Marker({
                        position: pLoc, map: map, label: { text: "å®¢", color: "white" },
                        icon: { path: google.maps.SymbolPath.CIRCLE, scale: 10, fillColor: "#D50000", fillOpacity: 1, strokeColor: "white", strokeWeight: 2 },
                        animation: google.maps.Animation.BOUNCE
                    });
                } else { passengerMarker.setPosition(pLoc); }
                document.getElementById('mission-panel').style.display = 'block';
                playSound('alert'); // æ’­æ”¾éŸ³æ•ˆ
                if(myMarker) {
                    if(routeLine) routeLine.setMap(null);
                    routeLine = new google.maps.Polyline({
                        path: [myMarker.getPosition(), pLoc], geodesic: true,
                        strokeColor: '#2962FF', strokeOpacity: 0.8, strokeWeight: 5,
                        icons: [{ icon: {path: google.maps.SymbolPath.FORWARD_CLOSED_ARROW}, offset: '100%' }],
                        map: map
                    });
                }
                if (navigator.vibrate) navigator.vibrate([500, 200, 500, 200, 500]);
            }
        });
    }

    function finishMission() {
        if(passengerMarker) { passengerMarker.setMap(null); passengerMarker = null; }
        if(routeLine) { routeLine.setMap(null); routeLine = null; }
        document.getElementById('mission-panel').style.display = 'none';
        if(currentUser) db.ref('drivers/' + currentUser.userId + '/request').remove();
    }

    function togglePower(forceOn=false) {
        const btns = ['btn-status', 'btn-saver', 'btn-hall']; const btnPower = document.getElementById('btn-power');
        if (forceOn || !isOnline) {
            isOnline = true; localStorage.setItem('isOnline', 'true');
            btnPower.className = "circle-btn bg-on"; btnPower.innerHTML = `<span>ä¸‹ç·š</span><span class="sub-text">ON</span>`;
            btns.forEach(id => document.getElementById(id).style.display = 'flex');
            
            requestWakeLock(); startGPS(); 
            if (heartbeatInterval) clearInterval(heartbeatInterval); heartbeatInterval = setInterval(() => forceUpload(), HEARTBEAT_TIME);
        } else {
            isOnline = false; localStorage.setItem('isOnline', 'false');
            btnPower.className = "circle-btn bg-off"; btnPower.innerHTML = `<span>ä¸Šç·š</span><span class="sub-text">OFF</span>`;
            btns.forEach(id => document.getElementById(id).style.display = 'none');
            stopGPS(); releaseWakeLock(); toggleSaver(false);
            if(myMarker) myMarker.setMap(null);
            if (heartbeatInterval) clearInterval(heartbeatInterval);
            if (currentUser) db.ref('drivers/' + currentUser.userId).update({ status: 'offline' });
            document.getElementById('hud').innerHTML = `ğŸ’¤ å·²ä¸‹ç·š`;
            queueCenter = null;
        }
    }

    function toggleStatus(){ 
        if(currentWorkStatus==='empty') { currentWorkStatus='queue'; if(myMarker) { const pos = myMarker.getPosition(); queueCenter = { lat: pos.lat(), lng: pos.lng() }; } }
        else if(currentWorkStatus==='queue') { currentWorkStatus='busy'; queueCenter = null; }
        else { currentWorkStatus='empty'; queueCenter = null; }
        updateStatusBtn(); forceUpload(); 
    }
    
    function setupSaverEvents() {
        const overlay = document.getElementById('saver-overlay');
        const startPress = (e) => { e.preventDefault(); overlay.classList.add('pressing'); pressTimer = setTimeout(() => { toggleSaver(false); if(navigator.vibrate) navigator.vibrate(100); }, 1500); };
        const cancelPress = () => { overlay.classList.remove('pressing'); clearTimeout(pressTimer); };
        overlay.addEventListener('touchstart', startPress); overlay.addEventListener('touchend', cancelPress);
        overlay.addEventListener('mousedown', startPress); overlay.addEventListener('mouseup', cancelPress);
    }

    function toggleSaver(enable){ const overlay=document.getElementById('saver-overlay');const btn=document.getElementById('btn-saver'); if(enable){ overlay.classList.add('active'); btn.className="circle-btn bg-empty"; } else{ overlay.classList.remove('active'); overlay.classList.remove('pressing'); btn.className="circle-btn bg-dark"; } }
    function updateStatusBtn(){ const btn=document.getElementById('btn-status');let colorCode='#2ecc71'; if(currentWorkStatus==='empty'){btn.className="circle-btn bg-empty";btn.innerHTML="ç©ºè»Š"}else if(currentWorkStatus==='queue'){btn.className="circle-btn bg-queue";btn.innerHTML="æ’ç­";colorCode='#3498db'}else{btn.className="circle-btn bg-busy";btn.innerHTML="è¼‰å®¢";colorCode='#e67e22'} if(myMarker)myMarker.setIcon(getArrowIcon(colorCode, 0)); }
    function startGPS() { if (!navigator.geolocation) return; watchId = navigator.geolocation.watchPosition((pos) => { const { latitude, longitude, heading } = pos.coords; const latLng = new google.maps.LatLng(latitude, longitude); const color = currentWorkStatus==='busy'?'#e67e22':(currentWorkStatus==='queue'?'#3498db':'#2ecc71'); const now = Date.now(); const distKm = Math.sqrt(Math.pow(latitude - lastRenderLat, 2) + Math.pow(longitude - lastRenderLng, 2)) * 111; const distM = distKm * 1000; if (myMarker && distM < RENDER_MIN_DIST && (now - lastRenderTime < RENDER_INTERVAL)) {} else { if(!myMarker){ myMarker = new google.maps.Marker({ position: latLng, map: map, icon: getArrowIcon(color, heading), title: "æˆ‘" }); map.panTo(latLng); } else { myMarker.setPosition(latLng); myMarker.setIcon(getArrowIcon(color, heading)); if(!routeLine && !document.getElementById('saver-overlay').classList.contains('active')) map.panTo(latLng); if(routeLine && passengerMarker) { routeLine.setPath([latLng, passengerMarker.getPosition()]); const dist = google.maps.geometry.spherical.computeDistanceBetween(latLng, passengerMarker.getPosition()); document.getElementById('mission-dist').innerText = `ä¹˜å®¢è·é›¢ï¼š${Math.round(dist)} å…¬å°º`; } } lastRenderLat = latitude; lastRenderLng = longitude; lastRenderTime = now; } smartUpload(latitude, longitude); }, (err) => console.error(err), { enableHighAccuracy: true, maximumAge: 0 }); }
    function stopGPS() { if (watchId) navigator.geolocation.clearWatch(watchId); }
    function smartUpload(lat, lng) { if(!currentUser) return; const now = Date.now(); const distKm = Math.sqrt(Math.pow(lat - lastUploadLat, 2) + Math.pow(lng - lastUploadLng, 2)) * 111; const distM = distKm * 1000; if (currentWorkStatus === 'queue' && queueCenter) { const distFromQueue = Math.sqrt(Math.pow(lat - queueCenter.lat, 2) + Math.pow(lng - queueCenter.lng, 2)) * 111000; if (distFromQueue > 500) { currentWorkStatus = 'empty'; queueCenter = null; updateStatusBtn(); showAlert("âš ï¸ é›¢é–‹æ’ç­å€", "ç³»çµ±åµæ¸¬æ‚¨å·²é›¢é–‹æ’ç­é»ï¼Œè‡ªå‹•åˆ‡æ›ç‚ºã€Œç©ºè»Šã€ã€‚"); } } if (distM < MIN_DIST) { updateHUD(false, "ğŸ“ å¾…å‘½ä¸­ (çœé›»)"); return; } if (now - lastUploadTime < UPDATE_INTERVAL) { return; } forceUpload(lat, lng); }
    function forceUpload(lat, lng) { if(!currentUser) return; if(!lat&&myMarker){const pos=myMarker.getPosition();lat=pos.lat();lng=pos.lng()} if(!lat)return; updateHUD(true, "âš¡ è³‡æ–™ä¸Šå‚³..."); db.ref('drivers/'+currentUser.userId).update({ lat:lat, lng:lng, status:'online', workStatus:currentWorkStatus, lastUpdate:firebase.database.ServerValue.TIMESTAMP }).then(() => { setTimeout(() => { const statusText=currentWorkStatus==='busy'?'è¼‰å®¢':(currentWorkStatus==='queue'?'æ’ç­':'ç©ºè»Š'); updateHUD(false, `ğŸŸ¢ é€£ç·šä¸­ (${statusText})`); }, 1000); }); lastUploadLat=lat; lastUploadLng=lng; lastUploadTime=Date.now(); }
    function updateHUD(isUploading, text) { const hud = document.getElementById('hud'); hud.innerHTML = `<span class="status-dot" style="background:${isUploading ? '#00C853' : '#2ecc71'};"></span> ${text}`; if(isUploading) hud.classList.add('hud-uploading'); else hud.classList.remove('hud-uploading'); }
    async function requestWakeLock() { try { if('wakeLock' in navigator) wakeLock = await navigator.wakeLock.request('screen'); } catch(e){} }
    function releaseWakeLock() { if(wakeLock) wakeLock.release(); }
    function showAlert(t,m){ document.getElementById('alert-title').innerText=t;document.getElementById('alert-msg').innerText=m;document.getElementById('alert-modal').style.display='flex'; }
    function closeModal(){ document.getElementById('alert-modal').style.display='none'; }
  </script>
</body>
</html>
