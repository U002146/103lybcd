<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>èŠ±è“®æ•¬è€æ„›å¿ƒä¹˜è»Šæ”¯æ´å¹³å°</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    /* CSS æ¨£å¼å€ */
    body { margin: 0; padding: 0; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; overflow: hidden; background: #f0f0f0; }
    #map { width: 100vw; height: 100vh; z-index: 1; }
    
    /* === HUD === */
    #hud {
      position: absolute; top: 15px; left: 15px; z-index: 999;
      background: rgba(30, 30, 30, 0.85); color: white; padding: 10px 15px;
      border-radius: 30px; font-size: 14px; font-weight: bold;
      backdrop-filter: blur(5px); box-shadow: 0 4px 15px rgba(0,0,0,0.2);
      display: flex; align-items: center; gap: 8px; pointer-events: none;
    }
    .status-dot { width: 10px; height: 10px; border-radius: 50%; display: inline-block; }
    
    /* === å³ä¸Šè§’åŠŸèƒ½å€ === */
    #top-right-area {
      position: absolute; top: 15px; right: 15px; z-index: 1000;
      display: flex; flex-direction: column; align-items: flex-end; gap: 10px;
    }

    /* è¨»å†ŠæŒ‰éˆ• */
    #btn-register {
      background: #3498db; color: white; border: none;
      padding: 8px 15px; border-radius: 20px; font-weight: bold;
      box-shadow: 0 2px 5px rgba(0,0,0,0.2); cursor: pointer;
      font-size: 14px;
    }

    /* === å¸æ©Ÿæ§åˆ¶é¢æ¿ === */
    #driver-controls {
      display: none; /* é è¨­éš±è— */
      flex-direction: column; align-items: center; gap: 15px;
    }

    .circle-btn {
      border: none; border-radius: 50%; color: white;
      font-weight: bold; cursor: pointer;
      box-shadow: 0 4px 15px rgba(0,0,0,0.3);
      display: flex; flex-direction: column; justify-content: center; align-items: center;
      transition: all 0.3s; text-shadow: 0 1px 2px rgba(0,0,0,0.2);
    }
    .circle-btn:active { transform: scale(0.95); box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
    
    #btn-power { width: 75px; height: 75px; font-size: 18px; }
    
    .sub-controls {
      display: flex; flex-direction: column; gap: 10px; 
      opacity: 0; transform: translateY(-20px); pointer-events: none; transition: 0.3s;
    }
    .sub-controls.show { opacity: 1; transform: translateY(0); pointer-events: auto; }

    #btn-status { width: 60px; height: 60px; font-size: 14px; }
    .small-btn { width: 50px; height: 50px; font-size: 12px; }
    
    #btn-eco { background: linear-gradient(135deg, #f1c40f, #f39c12); }
    #btn-black { background: linear-gradient(135deg, #34495e, #2c3e50); }

    /* === é»‘å±è¦†è“‹å±¤ === */
    #black-overlay {
      display: none; position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
      background: #000000; z-index: 99999;
      flex-direction: column; justify-content: center; align-items: center;
      color: #333; touch-action: manipulation;
    }
    #black-overlay.active { display: flex; }
    .saver-text { font-size: 20px; font-weight: bold; margin-bottom: 20px; color: #555; }
    .saver-hint { font-size: 14px; color: #444; }

    /* === åº•éƒ¨å¡ç‰‡ (æ‰€æœ‰äººå¯è¦‹) === */
    #passenger-carousel {
      position: absolute; bottom: 20px; left: 0; width: 100%; z-index: 1000;
      display: flex; overflow-x: auto; gap: 12px; padding: 0 15px 10px 15px; box-sizing: border-box;
      scroll-snap-type: x mandatory; -webkit-overflow-scrolling: touch;
      scrollbar-width: none;
    }
    #passenger-carousel::-webkit-scrollbar { display: none; }

    .driver-card {
      flex: 0 0 85%; max-width: 320px; background: white; border-radius: 16px; padding: 15px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.15); scroll-snap-align: center;
      display: flex; align-items: center; justify-content: space-between; position: relative;
    }
    .card-info { flex: 1; }
    .card-name { font-size: 16px; font-weight: bold; color: #333; }
    .card-status { font-size: 12px; font-weight: bold; margin-top: 4px; }
    .card-call-btn {
      background: #2ecc71; color: white; width: 45px; height: 45px; border-radius: 50%;
      display: flex; justify-content: center; align-items: center; text-decoration: none; font-size: 20px;
    }
    .empty-card { flex: 0 0 100%; text-align: center; background: rgba(255,255,255,0.9); padding: 15px; border-radius: 12px; color: #666; }

    /* é¡è‰²å®šç¾© */
    .bg-green { background: linear-gradient(135deg, #2ecc71, #27ae60); }
    .bg-red   { background: linear-gradient(135deg, #e74c3c, #c0392b); }
    .bg-gray  { background: linear-gradient(135deg, #95a5a6, #7f8c8d); }
    .bg-eco-on { background: linear-gradient(135deg, #3498db, #2980b9); border: 2px solid white; }
    
    .text-green { color: #27ae60; }
    .text-red { color: #c0392b; }
    .sub-text { font-size: 10px; opacity: 0.8; font-weight: normal; margin-top: 2px; }
    
    .driver-popup { text-align: center; font-size: 14px; min-width: 160px; }
    .popup-call-btn { display: block; margin-top: 8px; padding: 8px 0; background: #2ecc71; color: white; text-decoration: none; border-radius: 20px; font-weight: bold; }
    
    /* èª¿æ•´ Leaflet ä½ç½® */
    .leaflet-bottom { bottom: 120px !important; }

  </style>
</head>
<body>

  <!-- HUD -->
  <div id="hud"><span class="status-dot" style="background:gray;"></span> å®šä½ä¸­...</div>

  <!-- åœ°åœ– -->
  <div id="map"></div>

  <!-- é»‘å±ä¿è­·å±¤ -->
  <div id="black-overlay" onclick="disableBlackScreen()">
    <div class="saver-text">çœé›»æ¨¡å¼é‹ä½œä¸­</div>
    <div class="saver-hint">é»æ“Šè¢å¹•å–šé†’</div>
  </div>

  <!-- å³ä¸Šè§’å€åŸŸ (åˆ†æµé‚è¼¯) -->
  <div id="top-right-area">
    
    <!-- 1. å¸æ©Ÿè¨»å†ŠæŒ‰éˆ• (è·¯äººé¡¯ç¤º) -->
    <button id="btn-register" onclick="registerProcess()">ğŸ“ æˆ‘æ˜¯å¸æ©Ÿ (è¨»å†Š)</button>

    <!-- 2. å¸æ©Ÿæ§åˆ¶é¢æ¿ (å¸æ©Ÿé¡¯ç¤º) -->
    <div id="driver-controls">
      <button id="btn-power" class="circle-btn bg-gray" onclick="togglePower()">
        <span>ä¸Šç·š</span><span class="sub-text">OFF</span>
      </button>
      <div id="sub-controls" class="sub-controls">
        <button id="btn-status" class="circle-btn bg-green" onclick="toggleStatus()">
          <span>ç©ºè»Š</span>
        </button>
        <button id="btn-eco" class="circle-btn small-btn" onclick="toggleEco()">
          <span>çœé›»</span><span class="sub-text" id="eco-text">OFF</span>
        </button>
        <button id="btn-black" class="circle-btn small-btn" onclick="enableBlackScreen()">
          <span>é»‘å±</span>
        </button>
      </div>
    </div>
  </div>

  <!-- åº•éƒ¨å¡ç‰‡ (æ‰€æœ‰äººå¯è¦‹) -->
  <div id="passenger-carousel"><div class="empty-card">æœå°‹é™„è¿‘å¸æ©Ÿä¸­...</div></div>

  <!-- é‚è¼¯è…³æœ¬ -->
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
    // ========= è¨­å®šå€ =========
    const GAS_URL = "https://script.google.com/macros/s/AKfycbyfNTgci2gZE2Etxvv6SHaP3puw7Mxt8ineL4gZve7Zyh2UGrcna4Zxap6EOyRICQ/exec"; 
    const LIFF_ID = "2008907691-7ntMtfbA"; 
    // ========================

    var map, markers = {};
    var currentUser = null;
    var isDriver = false;
    var myLat = null, myLng = null;
    var isOnline = false, isBusy = false, isEco = false;
    var updateTimer = null, updateInterval = 30000;
    let wakeLock = null;

    const iconEmpty = L.divIcon({ html: '<div style="font-size:32px; filter: drop-shadow(2px 4px 6px rgba(0,0,0,0.4));">ğŸš•</div>', className: '', iconSize: [32, 32], iconAnchor: [16, 16] });
    const iconBusy = L.divIcon({ html: '<div style="font-size:32px; filter: grayscale(100%) opacity(0.7);">ğŸš•</div>', className: '', iconSize: [32, 32], iconAnchor: [16, 16] });

    window.onload = async function() {
      initMap();
      await initLiff();
    };

    function initMap() {
      map = L.map('map', { zoomControl: false }).setView([23.99000, 121.60684], 13);
      L.control.zoom({ position: 'bottomright' }).addTo(map);
      L.tileLayer('https://{s}.google.com/vt/lyrs=m&x={x}&y={y}&z={z}', {
        maxZoom: 20, subdomains: ['mt0', 'mt1', 'mt2', 'mt3'], attribution: 'Map data &copy; Google'
      }).addTo(map);
    }

    async function initLiff() {
      try {
        await liff.init({ liffId: LIFF_ID });
        if (!liff.isLoggedIn()) { liff.login(); return; }
        currentUser = await liff.getProfile();
        
        startTrackingLocation();
        checkRole(currentUser.userId);
        
        fetchDrivers();
        setInterval(fetchDrivers, 10000);
      } catch (err) { console.log("LIFF Error:", err); }
    }

    function startTrackingLocation() {
      if (navigator.geolocation) {
        navigator.geolocation.watchPosition(
          (pos) => { myLat = pos.coords.latitude; myLng = pos.coords.longitude; },
          (err) => console.error(err), { enableHighAccuracy: true }
        );
      }
    }

    // --- èº«åˆ†åˆ¤æ–· ---
    function checkRole(uid) {
      fetch(`${GAS_URL}?op=check_role&uid=${uid}`)
        .then(res => res.json())
        .then(data => {
          if (data.role === 'driver') {
            isDriver = true;
            document.getElementById('driver-controls').style.display = 'flex';
            document.getElementById('btn-register').style.display = 'none';
          } else {
            isDriver = false;
            document.getElementById('driver-controls').style.display = 'none';
            document.getElementById('btn-register').style.display = 'block';
          }
        });
    }

    // --- å¸æ©Ÿè¨»å†Š ---
    function registerProcess() {
      var name = prompt("è«‹è¼¸å…¥æ‚¨çš„ã€å§“åã€‘ï¼š\n(ä¾‹å¦‚ï¼šé˜¿è²¡)"); if (!name) return;
      var phone = prompt("è«‹è¼¸å…¥æ‚¨çš„ã€é›»è©±ã€‘ï¼š\n(ä¾‹å¦‚ï¼š0912345678)"); if (!phone) return;
      var car = prompt("è«‹è¼¸å…¥æ‚¨çš„ã€è»Šç‰Œã€‘ï¼š\n(ä¾‹å¦‚ï¼šTDP-1123)"); if (!car) car = "æœªå¡«å¯«";
      var msg = `#è¨»å†Š å§“å:${name} é›»è©±:${phone} è»Šç‰Œ:${car} ID:${currentUser.userId}`;

      if (liff.isInClient()) {
        liff.sendMessages([{ 'type': 'text', 'text': msg }])
          .then(() => { alert('âœ… è¨»å†Šç”³è«‹å·²é€å‡ºï¼'); liff.closeWindow(); })
          .catch(() => alert('ç™¼é€å¤±æ•—'));
      } else { alert("è«‹æ‰‹å‹•è¼¸å…¥æŒ‡ä»¤ï¼š\n" + msg); }
    }

    // --- å¸æ©Ÿæ§åˆ¶é‚è¼¯ ---
    function togglePower() {
      if (!currentUser) { alert("å°šæœªç™»å…¥ï¼Œç„¡æ³•ä¸Šç·š"); return; } // é˜²å‘†
      
      isOnline = !isOnline;
      const btnPower = document.getElementById('btn-power');
      const subControls = document.getElementById('sub-controls');
      
      if (isOnline) {
        btnPower.className = "circle-btn bg-red";
        btnPower.innerHTML = `<span>ä¸‹ç·š</span><span class="sub-text">ON</span>`;
        subControls.classList.add('show');
        uploadLocation();
        restartTimer();
      } else {
        btnPower.className = "circle-btn bg-green";
        btnPower.innerHTML = `<span>ä¸Šç·š</span><span class="sub-text">OFF</span>`;
        subControls.classList.remove('show');
        clearInterval(updateTimer);
        disableBlackScreen();
        postData('offline', isBusy ? 'busy' : 'empty', 0, 0);
      }
    }

    function toggleStatus() {
      isBusy = !isBusy;
      const btnStatus = document.getElementById('btn-status');
      if (isBusy) {
        btnStatus.className = "circle-btn bg-red";
        btnStatus.innerHTML = `<span>è¼‰å®¢</span>`;
      } else {
        btnStatus.className = "circle-btn bg-green";
        btnStatus.innerHTML = `<span>ç©ºè»Š</span>`;
      }
      uploadLocation();
    }

    function toggleEco() {
      isEco = !isEco;
      const btnEco = document.getElementById('btn-eco');
      const ecoText = document.getElementById('eco-text');
      if (isEco) {
        updateInterval = 120000; 
        btnEco.className = "circle-btn small-btn bg-eco-on";
        ecoText.innerText = "ON";
      } else {
        updateInterval = 30000; 
        btnEco.className = "circle-btn small-btn";
        btnEco.style.background = "#f1c40f"; 
        ecoText.innerText = "OFF";
      }
      if (isOnline) restartTimer();
    }

    async function enableBlackScreen() {
      document.getElementById('black-overlay').classList.add('active');
      if ('wakeLock' in navigator) {
        try { wakeLock = await navigator.wakeLock.request('screen'); } catch(e){}
      }
    }
    function disableBlackScreen() {
      document.getElementById('black-overlay').classList.remove('active');
      if (wakeLock !== null) { wakeLock.release().then(() => { wakeLock = null; }); }
    }

    function restartTimer() {
      if (updateTimer) clearInterval(updateTimer);
      updateTimer = setInterval(uploadLocation, updateInterval);
    }

    function uploadLocation() {
      if (!isOnline) return;
      // é—œéµä¿®å¾©ï¼šåŠ å…¥ GPS éŒ¯èª¤è™•ç†èˆ‡é«˜ç²¾åº¦é¸é …
      navigator.geolocation.getCurrentPosition(
        pos => {
          postData('online', isBusy ? 'busy' : 'empty', pos.coords.latitude, pos.coords.longitude);
        },
        err => {
          console.error("GPS Error:", err);
          // åœ¨é€™è£¡å¯ä»¥é¸æ“‡æ˜¯å¦è·³å‡º alert æé†’å¸æ©Ÿ
        },
        { enableHighAccuracy: true, timeout: 10000 }
      );
    }

    function postData(status, work, lat, lng) {
      if (!currentUser) return;
      const payload = { userId: currentUser.userId, status: status, work: work, lat: lat, lng: lng };
      
      // é—œéµä¿®å¾©ï¼šç§»é™¤ Content-Type header ä»¥ç¬¦åˆ no-cors è¦ç¯„ï¼Œé¿å…è¢«ç€è¦½å™¨æ“‹ä¸‹
      fetch(GAS_URL, {
        method: 'POST', 
        mode: 'no-cors',
        // headers: { 'Content-Type': 'application/json' }, // ç§»é™¤é€™è¡Œ
        body: JSON.stringify(payload)
      }).catch(e => console.log(e));
    }

    // --- è³‡æ–™æŠ“å–èˆ‡æ¸²æŸ“ ---
    function fetchDrivers() {
      fetch(`${GAS_URL}?op=get_drivers`)
        .then(res => res.json())
        .then(drivers => {
          drivers.forEach(d => { d.distance = calculateDistance(myLat, myLng, d.lat, d.lng); });
          drivers.sort((a, b) => a.distance - b.distance);
          
          updateMap(drivers);
          renderCarousel(drivers);
          updateHUD(drivers.length);
        });
    }

    function calculateDistance(lat1, lon1, lat2, lon2) {
      if (!lat1 || !lon1 || !lat2 || !lon2) return 9999;
      const R = 6371; 
      const dLat = (lat2 - lat1) * Math.PI / 180;
      const dLon = (lon2 - lon1) * Math.PI / 180;
      const a = Math.sin(dLat/2) * Math.sin(dLat/2) + Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * Math.sin(dLon/2) * Math.sin(dLon/2);
      return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
    }

    function updateMap(drivers) {
      for (let id in markers) { map.removeLayer(markers[id]); }
      markers = {};
      drivers.forEach(d => {
        let icon = d.workStatus === 'busy' ? iconBusy : iconEmpty;
        let marker = L.marker([d.lat, d.lng], {icon: icon}).addTo(map);
        let distText = (d.distance < 100) ? `(ç´„ ${d.distance.toFixed(1)} km)` : '';
        marker.bindPopup(`<div class="driver-popup"><b style="font-size:16px;">ğŸš• ${d.name}</b><br><span style="color:${d.workStatus==='busy'?'red':'green'}; font-size:12px; font-weight:bold;">â— ${d.workStatus === 'busy' ? 'è¼‰å®¢ä¸­' : 'ç›®å‰ç©ºè»Š'} ${distText}</span><br><a href="tel:${d.phone}" class="popup-call-btn">ğŸ“ ç›´æ¥å«è»Š</a></div>`);
        markers[d.id] = marker;
      });
    }

    function renderCarousel(drivers) {
      const container = document.getElementById('passenger-carousel');
      if (drivers.length === 0) {
        container.innerHTML = '<div class="empty-card">ğŸ”´ ç›®å‰é™„è¿‘ç„¡å¸æ©Ÿæœå‹™<br>è«‹ç¨å¾Œå†è©¦</div>'; return;
      }
      let html = '';
      drivers.slice(0, 5).forEach(d => {
        const statusText = d.workStatus === 'busy' ? 'è¼‰å®¢ä¸­' : 'ç›®å‰ç©ºè»Š';
        const statusClass = d.workStatus === 'busy' ? 'text-red' : 'text-green';
        const distText = (d.distance < 100) ? `${d.distance.toFixed(1)} km` : 'è¨ˆç®—ä¸­...';
        html += `<div class="driver-card" onclick="map.setView([${d.lat}, ${d.lng}], 15)"><div class="card-info"><div class="card-name">ğŸš• ${d.name}</div><div class="card-status ${statusClass}">â— ${statusText}</div><span class="card-dist">ğŸ“ è·é›¢ ${distText}</span></div><a href="tel:${d.phone}" class="card-call-btn">ğŸ“</a></div>`;
      });
      container.innerHTML = html;
    }

    function updateHUD(count) {
      const hud = document.getElementById('hud');
      const dot = hud.querySelector('.status-dot');
      if (count > 0) { dot.style.background = "#2ecc71"; hud.innerHTML = `<span class="status-dot" style="background:#2ecc71;"></span> ç·šä¸Šé‹å°‡ï¼š${count} äºº`; } 
      else { dot.style.background = "#e74c3c"; hud.innerHTML = `<span class="status-dot" style="background:#e74c3c;"></span> ç›®å‰ç„¡å¸æ©Ÿæœå‹™`; }
    }
  </script>
</body>
</html>
