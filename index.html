<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>èŠ±è“®æ•¬è€æ„›å¿ƒä¹˜è»Šæ”¯æ´å¹³å°</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    body { margin: 0; padding: 0; font-family: -apple-system, system-ui, BlinkMacSystemFont, "Segoe UI", Roboto; overflow: hidden; background: #f0f0f0; }
    #map { width: 100vw; height: 100vh; z-index: 1; transition: opacity 0.5s; }
    
    /* å·¦ä¸Šè§’ HUD */
    #hud {
      position: absolute; top: 15px; left: 15px; z-index: 999;
      background: rgba(30, 30, 30, 0.9); color: white; padding: 12px 20px;
      border-radius: 30px; font-size: 16px; font-weight: bold;
      backdrop-filter: blur(5px); box-shadow: 0 4px 15px rgba(0,0,0,0.3);
      display: flex; align-items: center; gap: 10px; pointer-events: none;
    }
    .status-dot { width: 12px; height: 12px; border-radius: 50%; display: inline-block; }
    
    /* å³ä¸Šè§’æ§åˆ¶å€å®¹å™¨ */
    #top-right-panel {
      position: absolute; top: 15px; right: 15px; z-index: 1000;
      display: flex; flex-direction: column; align-items: center; gap: 15px;
    }

    .circle-btn {
      border: none; border-radius: 50%; color: white;
      font-weight: bold; cursor: pointer;
      box-shadow: 0 6px 20px rgba(0,0,0,0.4);
      display: flex; flex-direction: column; justify-content: center; align-items: center;
      transition: all 0.2s;
      text-shadow: 0 1px 2px rgba(0,0,0,0.3);
      position: relative;
    }
    .circle-btn:active { transform: scale(0.9); box-shadow: 0 2px 10px rgba(0,0,0,0.2); }
    
    /* æŒ‰éˆ•å°ºå¯¸å®šç¾© */
    #btn-power { width: 80px; height: 80px; font-size: 18px; z-index: 2; }
    #btn-status { width: 75px; height: 75px; font-size: 16px; display: none; z-index: 2; }
    #btn-share { width: 60px; height: 60px; font-size: 13px; background: linear-gradient(135deg, #3498db, #2980b9); z-index: 1; }
    #btn-register { width: 75px; height: 75px; font-size: 15px; background: linear-gradient(135deg, #f39c12, #e67e22); display: none; }

    /* å€’æ•¸è¨ˆæ™‚æ¨™ç±¤ */
    .timer-badge {
      position: absolute;
      bottom: -10px;
      background: #333;
      color: #fff;
      font-size: 10px;
      padding: 2px 8px;
      border-radius: 10px;
      white-space: nowrap;
      box-shadow: 0 2px 5px rgba(0,0,0,0.2);
      display: none; /* é è¨­éš±è— */
    }

    /* é€šç”¨å½ˆçª— */
    .modal-overlay {
      display: none; position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
      background: rgba(0,0,0,0.8); z-index: 3000; justify-content: center; align-items: center;
      backdrop-filter: blur(5px);
    }
    .modal-content {
      background: white; width: 85%; max-width: 350px; border-radius: 24px;
      padding: 25px; box-sizing: border-box; text-align: center;
    }

    /* QR Code é¡¯ç¤ºå€ */
    #qrcode-container {
      background: #f9f9f9; padding: 15px; border-radius: 15px; margin: 15px 0;
      display: flex; justify-content: center; align-items: center;
    }
    #qrcode-container img { width: 200px; height: 200px; }

    /* è¨»å†Šè¡¨å–® */
    .form-group { margin-bottom: 15px; text-align: left; }
    .form-group label { display: block; font-size: 13px; color: #666; margin-bottom: 5px; }
    .form-group input { width: 100%; padding: 12px; border: 2px solid #eee; border-radius: 10px; box-sizing: border-box; font-size: 16px; }
    .modal-btns button { width: 100%; padding: 15px; border-radius: 12px; border: none; font-size: 16px; font-weight: bold; cursor: pointer; margin-top: 10px; }

    /* åº•éƒ¨å¡ç‰‡ */
    #passenger-carousel { position: absolute; bottom: 20px; left: 0; width: 100%; z-index: 1000; display: none; overflow-x: auto; gap: 12px; padding: 0 15px 15px 15px; box-sizing: border-box; scroll-snap-type: x mandatory; -webkit-overflow-scrolling: touch; }
    .driver-card { flex: 0 0 88%; max-width: 340px; background: white; border-radius: 20px; padding: 18px; box-shadow: 0 8px 25px rgba(0,0,0,0.2); scroll-snap-align: center; display: flex; align-items: center; justify-content: space-between; position: relative; }
    .update-time { font-size: 10px; color: #999; position: absolute; top: 10px; right: 15px; background: #f5f5f5; padding: 2px 6px; border-radius: 10px; }
    
    .bg-green { background: linear-gradient(135deg, #2ecc71, #27ae60); }
    .bg-red   { background: linear-gradient(135deg, #e74c3c, #c0392b); }
    .bg-gray  { background: linear-gradient(135deg, #bdc3c7, #95a5a6); }
    .sub-text { font-size: 12px; opacity: 0.9; margin-top: 4px; }
    .leaflet-bottom { bottom: 140px !important; }
  </style>
</head>
<body>

  <!-- åˆ†äº«å½ˆçª— -->
  <div id="share-modal" class="modal-overlay">
    <div class="modal-content">
      <h3 style="margin-top:0;">æƒç¢¼åŠ å…¥å¹³å°</h3>
      <p style="font-size: 14px; color: #666;">è®“å…¶ä»–å¸æ©Ÿæˆ–ä¹˜å®¢æƒææ­¤ç¢¼<br>å³å¯ç«‹å³é–‹å•Ÿæœå‹™</p>
      <div id="qrcode-container">
        <img id="qrcode-img" src="" alt="QR Code">
      </div>
      <div class="modal-btns">
        <button style="background:#eee; color:#333;" onclick="closeModal('share-modal')">é—œé–‰</button>
      </div>
    </div>
  </div>

  <!-- è¨»å†Šå½ˆçª— -->
  <div id="reg-modal" class="modal-overlay">
    <div class="modal-content">
      <h3 style="margin-top:0;">å¸æ©Ÿè¨»å†Šç”³è«‹</h3>
      <div class="form-group">
        <label>LINE ID</label>
        <input type="text" id="reg-uid" readonly style="background:#f0f0f0;">
      </div>
      <div class="form-group">
        <label>å¸æ©Ÿæš±ç¨±</label>
        <input type="text" id="reg-name" placeholder="ä¾‹å¦‚ï¼šç‹å¤§å“¥">
      </div>
      <div class="form-group">
        <label>è»Šç‰Œè™Ÿç¢¼</label>
        <input type="text" id="reg-car" placeholder="ä¾‹å¦‚ï¼šABC-1234">
      </div>
      <div class="form-group">
        <label>é€£çµ¡é›»è©±</label>
        <input type="tel" id="reg-phone" placeholder="09xx-xxx-xxx">
      </div>
      <div class="modal-btns">
        <button style="background:#2ecc71; color:white;" onclick="submitRegistration()">é€å‡ºè³‡æ–™</button>
        <button style="background:#eee; color:#666;" onclick="closeModal('reg-modal')">å–æ¶ˆ</button>
      </div>
    </div>
  </div>

  <div id="hud">
    <span class="status-dot" style="background:gray;"></span> å®šä½ä¸­...
  </div>

  <div id="map"></div>

  <!-- å³ä¸Šè§’æ§åˆ¶å€ -->
  <div id="top-right-panel">
    <!-- å¸æ©ŸæŒ‰éˆ• -->
    <button id="btn-power" class="circle-btn bg-gray" style="display:none;" onclick="togglePower()">
      <span>ä¸Šç·š</span>
      <span class="sub-text">OFF</span>
    </button>
    
    <!-- ç©ºè»Š/è¼‰å®¢åˆ‡æ›éˆ•ï¼ŒåŒ…å«å€’æ•¸æ¨™ç±¤ -->
    <button id="btn-status" class="circle-btn bg-green" onclick="toggleStatus()">
      <span>ç©ºè»Š</span>
      <span class="sub-text">é»æ“ŠçºŒæ™‚</span>
      <div id="timer-label" class="timer-badge">60åˆ†</div>
    </button>

    <!-- ä¹˜å®¢æŒ‰éˆ• -->
    <button id="btn-register" class="circle-btn" onclick="openModal('reg-modal')">
      <span>å¸æ©Ÿ<br>è¨»å†Š</span>
    </button>

    <!-- å…±æœ‰æŒ‰éˆ•ï¼šæƒç¢¼åˆ†äº« -->
    <button id="btn-share" class="circle-btn" onclick="openShareModal()">
      <span>åˆ†äº«<br>å¹³å°</span>
    </button>
  </div>

  <!-- ä¹˜å®¢å¡ç‰‡ -->
  <div id="passenger-carousel"></div>

  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
    // ========= è¨­å®šå€ =========
    const GAS_URL = "https://script.google.com/macros/s/AKfycbyfNTgci2gZE2Etxvv6SHaP3puw7Mxt8ineL4gZve7Zyh2UGrcna4Zxap6EOyRICQ/exec"; 
    const LIFF_ID = "2008907691-7ntMtfbA"; 
    // =========================

    var map, markers = {};
    var currentUser = null;
    var isDriver = false;
    var myLat = null, myLng = null;
    
    // ç‹€æ…‹è®Šæ•¸
    var isOnline = false;
    var isBusy = false; // false=ç©ºè»Š, true=è¼‰å®¢
    var updateTimer = null; // ç”¨æ–¼è¼‰å®¢æ™‚çš„è‡ªå‹•æ›´æ–°
    var expirationTime = 0; // è‡ªå‹•ä¸‹ç·šæ™‚é–“æˆ³
    var countdownInterval = null; // å€’æ•¸è¨ˆæ™‚é¡¯ç¤ºç”¨

    const iconEmpty = L.divIcon({ html: '<div style="font-size:36px;">ğŸš•</div>', className: '', iconSize: [36, 36], iconAnchor: [18, 18] });
    const iconBusy = L.divIcon({ html: '<div style="font-size:36px; filter: grayscale(100%) opacity(0.6);">ğŸš•</div>', className: '', iconSize: [36, 36], iconAnchor: [18, 18] });

    window.onload = async function() {
      initMap();
      await initLiff();
    };

    function openShareModal() {
      const liffUrl = `https://liff.line.me/${LIFF_ID}`;
      const qrApiUrl = `https://api.qrserver.com/v1/create-qr-code/?size=250x250&data=${encodeURIComponent(liffUrl)}`;
      document.getElementById('qrcode-img').src = qrApiUrl;
      openModal('share-modal');
    }

    function initMap() {
      map = L.map('map', { zoomControl: false }).setView([23.99000, 121.60684], 13);
      L.control.zoom({ position: 'bottomright' }).addTo(map);
      L.tileLayer('https://{s}.google.com/vt/lyrs=m&x={x}&y={y}&z={z}', {
        maxZoom: 20, subdomains: ['mt0', 'mt1', 'mt2', 'mt3'],
        attribution: 'Map data &copy; Google'
      }).addTo(map);
    }

    async function initLiff() {
      try {
        await liff.init({ liffId: LIFF_ID });
        if (!liff.isLoggedIn()) { liff.login(); return; }
        currentUser = await liff.getProfile();
        startTrackingLocation();
        checkRole(currentUser.userId);
        fetchDrivers();
        setInterval(fetchDrivers, 15000); // ä¹˜å®¢ç«¯æ¯15ç§’æ›´æ–°ä¸€æ¬¡
      } catch (err) { console.log("LIFF Error:", err); }
    }

    function startTrackingLocation() {
      if (navigator.geolocation) {
        navigator.geolocation.watchPosition((pos) => {
          myLat = pos.coords.latitude; myLng = pos.coords.longitude;
        }, (err) => console.error(err), { enableHighAccuracy: true });
      }
    }

    function checkRole(uid) {
      fetch(`${GAS_URL}?op=check_role&uid=${uid}`)
        .then(res => res.json())
        .then(data => {
          isDriver = (data.role === 'driver');
          if (isDriver) {
            document.getElementById('btn-power').style.display = 'flex';
            document.getElementById('btn-register').style.display = 'none';
            document.getElementById('passenger-carousel').style.display = 'none';
          } else {
            document.getElementById('btn-power').style.display = 'none';
            document.getElementById('btn-register').style.display = 'flex';
            document.getElementById('passenger-carousel').style.display = 'flex';
          }
        });
    }

    // --- æ ¸å¿ƒé‚è¼¯ï¼šä¸Šç·š/ä¸‹ç·š ---
    function togglePower() {
      const btnPower = document.getElementById('btn-power');
      const btnStatus = document.getElementById('btn-status');
      
      if (!isOnline) {
        // [å‹•ä½œ] é»æ“Šä¸Šç·š
        isOnline = true;
        isBusy = false; 
        
        // è®Šæ›´ UI
        btnPower.className = "circle-btn bg-red";
        btnPower.innerHTML = `<span>ä¸‹ç·š</span><span class="sub-text">ON</span>`;
        btnStatus.style.display = 'flex';
        
        // åŸ·è¡Œæ‰“å¡ (ä¸Šå‚³è³‡æ–™)
        refreshEmptyStatus(); 
        
      } else {
        // [å‹•ä½œ] é»æ“Šä¸‹ç·š
        isOnline = false;
        
        // è®Šæ›´ UI
        btnPower.className = "circle-btn bg-green";
        btnPower.innerHTML = `<span>ä¸Šç·š</span><span class="sub-text">OFF</span>`;
        btnStatus.style.display = 'none';
        document.getElementById('timer-label').style.display = 'none';
        
        clearInterval(updateTimer);
        clearInterval(countdownInterval);
        
        // ä¸‹ç·šæ™‚ï¼Œå‚³é€æœ€å¾Œå·²çŸ¥ä½ç½®ï¼Œè€Œä¸æ˜¯ 0,0
        // å¦‚æœæ²’æœ‰ myLat (ä¾‹å¦‚æ²’é–‹ GPS)ï¼Œæ‰å‚³ 0,0
        postData('offline', 'empty', myLat || 0, myLng || 0);
      }
    }

    // --- æ ¸å¿ƒé‚è¼¯ï¼šç‹€æ…‹åˆ‡æ› ---
    function toggleStatus() {
      if (!isOnline) return;

      if (!isBusy) {
         // ç¶  -> ç´… (è¼‰å®¢)
         switchToBusy();
      } else {
         // ç´… -> ç¶  (ç©ºè»Š/çºŒæ™‚)
         switchToEmpty();
      }
    }

    function switchToEmpty() {
      isBusy = false;
      const btnStatus = document.getElementById('btn-status');
      btnStatus.className = "circle-btn bg-green";
      btnStatus.innerHTML = `<span>ç©ºè»Š</span><span class="sub-text">é»æ“Šè¼‰å®¢</span><div id="timer-label" class="timer-badge">60åˆ†</div>`;
      
      clearInterval(updateTimer);
      refreshEmptyStatus(); // æ‰“å¡ä¸¦é‡ç½®æ™‚é–“
    }

    function switchToBusy() {
      isBusy = true;
      const btnStatus = document.getElementById('btn-status');
      btnStatus.className = "circle-btn bg-red";
      btnStatus.innerHTML = `<span>è¼‰å®¢</span><span class="sub-text">ç§»å‹•ä¸­</span>`;
      document.getElementById('timer-label').style.display = 'none';

      // è¼‰å®¢ç‹€æ…‹ä¸‹ï¼Œå¦‚æœè¢å¹•é–‹è‘—ï¼Œæ¯ 60 ç§’æ›´æ–°ä¸€æ¬¡
      uploadLocation(); 
      updateTimer = setInterval(uploadLocation, 60000); 
    }

    // [æ‰“å¡é‚è¼¯] 
    function refreshEmptyStatus() {
      if (isBusy) return;

      // å¼·åˆ¶å˜—è©¦æŠ“å– GPS
      uploadLocation(true); // true ä»£è¡¨é€™æ˜¯ä¸€æ¬¡æ‰‹å‹•æ‰“å¡ï¼Œè¦é¡¯ç¤º Alert

      // è¨­å®š 60 åˆ†é˜å€’æ•¸
      const MINUTES = 60;
      expirationTime = Date.now() + (MINUTES * 60 * 1000);
      startCountdownUI();
    }

    function startCountdownUI() {
      clearInterval(countdownInterval);
      const label = document.getElementById('timer-label');
      label.style.display = 'block';

      // ç«‹å³æ›´æ–°ä¸€æ¬¡
      const initialRemaining = Math.ceil((expirationTime - Date.now()) / 60000);
      label.innerText = initialRemaining + "åˆ†";

      countdownInterval = setInterval(() => {
        const remaining = Math.ceil((expirationTime - Date.now()) / 60000);
        if (remaining <= 0) {
          // æ™‚é–“åˆ°ï¼Œè‡ªå‹•ä¸‹ç·š
          togglePower(); 
          alert("â° æ’ç­æ™‚é–“çµæŸï¼Œç³»çµ±å·²è‡ªå‹•å¹«æ‚¨ä¸‹ç·šã€‚");
        } else {
          label.innerText = remaining + "åˆ†";
        }
      }, 10000);
    }

    function uploadLocation(isShowAlert = false) {
      if (!isOnline && !isShowAlert) return;
      if (!navigator.geolocation) { alert("ç„¡æ³•å–å¾— GPS"); return; }

      navigator.geolocation.getCurrentPosition(
        (pos) => {
          // æ›´æ–°å…¨åŸŸè®Šæ•¸ï¼Œç¢ºä¿ä¸‹ç·šæ™‚æœ‰ä½ç½®å¯å‚³
          myLat = pos.coords.latitude;
          myLng = pos.coords.longitude;

          postData('online', isBusy ? 'busy' : 'empty', myLat, myLng);
          
          if (isShowAlert) {
             alert(`âœ… æ‰“å¡æˆåŠŸï¼\nå·²æ›´æ–°ä½ç½®ï¼Œå°‡åœ¨ 60 åˆ†é˜å¾Œè‡ªå‹•éš±è—ã€‚\næ‚¨å¯ä»¥å®‰å¿ƒé—œé–‰ç¶²é æ›æ©Ÿã€‚`);
          }
        },
        (err) => {
          console.error("GPS Error:", err);
          if (isShowAlert) alert("âš ï¸ æ‰“å¡å¤±æ•—ï¼šç„¡æ³•å–å¾—ä½ç½®ï¼\nè«‹æª¢æŸ¥ GPS èˆ‡ LINE æ¬Šé™ã€‚");
        },
        { enableHighAccuracy: true, timeout: 10000 }
      );
    }

    function postData(status, work, lat, lng) {
      const payload = { 
        userId: currentUser.userId, 
        status: status, 
        work: work, 
        lat: lat, 
        lng: lng,
        timestamp: Date.now() 
      };
      
      fetch(GAS_URL, {
        method: 'POST', mode: 'no-cors',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      }).catch(e => console.log(e));
    }

    // --- è¨»å†Š & åˆ†äº« ---
    function openModal(id) {
      if (id === 'reg-modal') document.getElementById('reg-uid').value = currentUser.userId;
      document.getElementById(id).style.display = 'flex';
    }
    function closeModal(id) { document.getElementById(id).style.display = 'none'; }

    async function submitRegistration() {
      const name = document.getElementById('reg-name').value;
      const car = document.getElementById('reg-car').value;
      const phone = document.getElementById('reg-phone').value;
      if (!name || !car || !phone) { alert("è³‡æ–™ä¸å®Œæ•´"); return; }
      const msg = `ğŸš– ã€å¸æ©Ÿè¨»å†Šç”³è«‹ã€‘\næš±ç¨±ï¼š${name}\nè»Šè™Ÿï¼š${car}\né›»è©±ï¼š${phone}\nIDï¼š${currentUser.userId}`;
      try {
        if (!liff.isInClient()) throw new Error();
        await liff.sendMessages([{ type: 'text', text: msg }]);
        alert("å·²é€å‡ºç”³è«‹");
        closeModal('reg-modal');
      } catch (err) {
        window.location.href = `https://line.me/R/oaMessage/@103lybcd/?${encodeURIComponent(msg)}`;
      }
    }

    // --- [ä¹˜å®¢ç«¯] é‚è¼¯æ›´æ–° ---
    function fetchDrivers() {
      fetch(`${GAS_URL}?op=get_drivers`)
        .then(res => res.json())
        .then(drivers => {
          // 1. éæ¿¾æ‰ç‹€æ…‹ç‚º offline çš„å¸æ©Ÿ
          // 2. éæ¿¾æ‰è¶…é 60 åˆ†é˜æ²’æ›´æ–°çš„å¸æ©Ÿ (è‡ªå‹•ä¸‹ç·šé‚è¼¯)
          const now = new Date();
          
          const validDrivers = drivers.filter(d => {
            // å¦‚æœ GAS æ²’å›å‚³æ™‚é–“ï¼Œé è¨­é¡¯ç¤º (é¿å…å…¨æ»…)
            // è©¦ç®—è¡¨ Column I æ˜¯æ™‚é–“ï¼Œå‡è¨­ GAS JSON key æ˜¯ 'time' æˆ–é™£åˆ—ç´¢å¼•
            // é€™è£¡å‡è¨­ d.time æ˜¯ ISO å­—ä¸²æˆ–æ™‚é–“æˆ³
            
            if (d.status === 'offline') return false;

            // è¨ˆç®—æ™‚é–“å·® (å¦‚æœå¾Œç«¯æœ‰å›å‚³æ™‚é–“)
            if (d.time) {
               const lastUpdate = new Date(d.time);
               const diffMins = (now - lastUpdate) / 60000;
               d.diffMins = Math.floor(diffMins); // å­˜èµ·ä¾†ç­‰ä¸‹é¡¯ç¤ºç”¨
               if (diffMins > 60) return false; // è¶…æ™‚éš±è—
            } else {
               d.diffMins = 0; // æ²’æ™‚é–“è³‡æ–™æ™‚çš„é è¨­å€¼
            }
            
            return true; 
          });

          validDrivers.forEach(d => d.distance = calculateDistance(myLat, myLng, d.lat, d.lng));
          validDrivers.sort((a, b) => a.distance - b.distance);
          
          updateMap(validDrivers);
          if (!isDriver) renderCarousel(validDrivers);
          updateHUD(validDrivers.length);
        });
    }

    function calculateDistance(lat1, lon1, lat2, lon2) {
      if (!lat1 || !lon1 || !lat2 || !lon2) return 9999;
      const R = 6371;
      const dLat = (lat2 - lat1) * Math.PI / 180;
      const dLon = (lon2 - lon1) * Math.PI / 180;
      const a = Math.sin(dLat/2) * Math.sin(dLat/2) + Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * Math.sin(dLon/2) * Math.sin(dLon/2);
      return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
    }

    function updateMap(drivers) {
      for (let id in markers) { map.removeLayer(markers[id]); }
      markers = {};
      drivers.forEach(d => {
        let icon = d.workStatus === 'busy' ? iconBusy : iconEmpty;
        let marker = L.marker([d.lat, d.lng], {icon: icon}).addTo(map);
        let distText = (d.distance < 100) ? `(ç´„ ${d.distance.toFixed(1)} km)` : '';
        
        // Popup å…§å®¹ä¹ŸåŠ ä¸Šæ›´æ–°æ™‚é–“
        let timeText = d.diffMins !== undefined ? `<br><span style="font-size:12px; color:#666;">â±ï¸ ${d.diffMins} åˆ†é˜å‰æ›´æ–°</span>` : '';
        
        marker.bindPopup(`<div style="text-align:center;"><b>ğŸš• ${d.name}</b><br><span style="color:${d.workStatus==='busy'?'red':'green'};">â— ${d.workStatus==='busy'?'è¼‰å®¢ä¸­':'ç›®å‰ç©ºè»Š'} ${distText}</span>${timeText}<br><a href="tel:${d.phone}" style="display:block; margin-top:10px; padding:10px; background:#2ecc71; color:white; border-radius:10px; text-decoration:none; font-weight:bold;">ğŸ“ è¯çµ¡å¸æ©Ÿ</a></div>`);
        markers[d.id] = marker;
      });
    }

    function renderCarousel(drivers) {
      const container = document.getElementById('passenger-carousel');
      if (drivers.length === 0) {
        container.innerHTML = '<div style="flex:0 0 100%; text-align:center; padding:20px; background:white; border-radius:20px;">ğŸ”´ ç›®å‰é™„è¿‘ç„¡å¸æ©Ÿæœå‹™</div>';
        return;
      }
      container.innerHTML = drivers.slice(0, 5).map(d => `
        <div class="driver-card" onclick="map.setView([${d.lat}, ${d.lng}], 15)">
          <div class="update-time">â±ï¸ ${d.diffMins || 0} åˆ†å‰</div>
          <div class="card-info">
            <div class="card-name">ğŸš• ${d.name}</div>
            <div style="font-size:14px; margin:5px 0; color:${d.workStatus==='busy'?'red':'green'}">â— ${d.workStatus==='busy'?'è¼‰å®¢ä¸­':'ç›®å‰ç©ºè»Š'}</div>
            <div style="font-size:14px; color:#666;">ğŸ“ è·é›¢ç´„ ${d.distance.toFixed(1)} km</div>
          </div>
          <a href="tel:${d.phone}" class="card-call-btn">ğŸ“</a>
        </div>
      `).join('');
    }

    function updateHUD(count) {
      const hud = document.getElementById('hud');
      if (count > 0) hud.innerHTML = `<span class="status-dot" style="background:#2ecc71;"></span> ç·šä¸Šé‹å°‡ï¼š${count} äºº`;
      else hud.innerHTML = `<span class="status-dot" style="background:#e74c3c;"></span> ç›®å‰ç„¡å¸æ©Ÿæœå‹™`;
    }
  </script>
</body>
</html>
