<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>èŠ±è“®åœ°åœ–å«è»Š</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    /* CSS æ¨£å¼å€ */
    body { margin: 0; padding: 0; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; overflow: hidden; }
    #map { width: 100vw; height: 100vh; z-index: 1; }
    
    /* ä¹˜å®¢è³‡è¨Šå¡ HUD */
    #hud {
      position: absolute; top: 15px; left: 15px; z-index: 999;
      background: rgba(0,0,0,0.7); color: white; padding: 10px 15px;
      border-radius: 30px; font-size: 14px; font-weight: bold;
      backdrop-filter: blur(5px); box-shadow: 0 4px 6px rgba(0,0,0,0.1);
      display: flex; align-items: center; gap: 8px;
    }
    .status-dot { width: 10px; height: 10px; border-radius: 50%; display: inline-block; }
    
    /* å¸æ©Ÿæ§åˆ¶é¢æ¿ */
    #driver-panel {
      display: none; /* é è¨­éš±è— */
      position: absolute; bottom: 30px; left: 50%; transform: translateX(-50%);
      z-index: 999; width: 90%; max-width: 400px;
      background: rgba(255,255,255,0.95); padding: 15px; border-radius: 20px;
      box-shadow: 0 10px 25px rgba(0,0,0,0.2);
      flex-direction: column; gap: 10px;
    }
    .panel-title { text-align: center; font-size: 14px; color: #666; margin-bottom: 5px; }
    .btn-group { display: flex; gap: 10px; }
    .btn {
      flex: 1; padding: 15px; border: none; border-radius: 12px;
      font-size: 16px; font-weight: bold; cursor: pointer; color: white;
      transition: all 0.2s; display: flex; justify-content: center; align-items: center;
    }
    .btn:active { transform: scale(0.95); }
    
    /* æŒ‰éˆ•é¡è‰² */
    .btn-off { background: #95a5a6; color: #eee; }
    .btn-on { background: #2ecc71; box-shadow: 0 4px 10px rgba(46, 204, 113, 0.4); }
    .btn-empty { background: #27ae60; } 
    .btn-busy { background: #e74c3c; }

    /* å¸æ©Ÿåç‰‡ Popup */
    .driver-popup { text-align: center; font-size: 15px; }
    .call-btn {
      display: block; margin-top: 8px; padding: 8px 0;
      background: #2ecc71; color: white; text-decoration: none;
      border-radius: 5px; font-weight: bold;
    }
  </style>
</head>
<body>

  <div id="hud">
    <span class="status-dot" style="background:gray;"></span> ç³»çµ±é€£ç·šä¸­...
  </div>

  <div id="map"></div>

  <div id="driver-panel">
    <div class="panel-title">ğŸ‘‹ é‹å°‡ <span id="driver-name"></span> çš„æ§åˆ¶å°</div>
    <div class="btn-group">
      <button id="btn-power" class="btn btn-off" onclick="togglePower()">ğŸ”´ å·²ä¸‹ç·š</button>
    </div>
    <div class="btn-group" style="margin-top:10px; display:none;" id="status-row">
      <button id="btn-status" class="btn btn-empty" onclick="toggleStatus()">ğŸŸ¢ ç›®å‰ç©ºè»Š</button>
    </div>
  </div>

  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
    // ========= è¨­å®šå€ (è«‹ä¿®æ”¹é€™è£¡) =========
    const GAS_URL = "https://script.google.com/macros/s/AKfycbznQ9lfruitWXA7D4uzwZ4Aq2cGCPq88mC9yn5HzgMYWah-PVJVgm9u14Laj1IZZ_g/exec"; 
    const LIFF_ID = "2008907691-7ntMtfbA"; 
    // =====================================

    var map, markers = {};
    var currentUser = null;
    var isDriver = false;
    
    // å¸æ©Ÿç‹€æ…‹è®Šæ•¸
    var isOnline = false; // æ˜¯å¦ä¸Šç­
    var isBusy = false;   // æ˜¯å¦è¼‰å®¢
    var updateTimer = null; // ä¸Šå‚³ä½ç½®çš„è¨ˆæ™‚å™¨

    // è‡ªå®šç¾© Icon (ä½¿ç”¨ Emoji çœå»åœ–æª”)
    const iconEmpty = L.divIcon({ html: '<div style="font-size:30px;">ğŸš•</div>', className: '', iconSize: [30, 30], iconAnchor: [15, 15] });
    const iconBusy = L.divIcon({ html: '<div style="font-size:30px;">ğŸŸ¥</div>', className: '', iconSize: [30, 30], iconAnchor: [15, 15] });

    window.onload = async function() {
      initMap();
      await initLiff();
    };

    function initMap() {
      // é è¨­èŠ±è“®å¸‚ä¸­å¿ƒ
      map = L.map('map').setView([23.97565, 121.60684], 14);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: 'Â© OpenStreetMap'
      }).addTo(map);
    }

    async function initLiff() {
      try {
        await liff.init({ liffId: LIFF_ID });
        if (!liff.isLoggedIn()) {
          liff.login();
          return;
        }
        const profile = await liff.getProfile();
        currentUser = profile;
        
        // 1. æª¢æŸ¥èº«åˆ†
        checkRole(profile.userId);

        // 2. å•Ÿå‹•åœ°åœ–è³‡æ–™æ›´æ–° (æ¯10ç§’åˆ·ä¸€æ¬¡)
        fetchDrivers();
        setInterval(fetchDrivers, 10000);

      } catch (err) {
        alert("LIFF åˆå§‹åŒ–å¤±æ•—: " + err);
      }
    }

    // --- èº«åˆ†é©—è­‰ ---
    function checkRole(uid) {
      fetch(`${GAS_URL}?op=check_role&uid=${uid}`)
        .then(res => res.json())
        .then(data => {
          if (data.role === 'driver') {
            isDriver = true;
            document.getElementById('driver-panel').style.display = 'flex';
            document.getElementById('driver-name').innerText = data.name;
          }
        });
    }

    // --- å¸æ©Ÿç«¯åŠŸèƒ½ ---
    function togglePower() {
      isOnline = !isOnline;
      const btn = document.getElementById('btn-power');
      const statusRow = document.getElementById('status-row');

      if (isOnline) {
        // ä¸Šç·š
        btn.className = "btn btn-on";
        btn.innerText = "ğŸŸ¢ ä¸Šç·šä¸­ (æ›´æ–°ä½ç½®)";
        statusRow.style.display = 'flex';
        // ç«‹å³è§¸ç™¼ä¸Šå‚³ï¼Œä¸¦é–‹å§‹å¾ªç’°
        uploadLocation();
        updateTimer = setInterval(uploadLocation, 30000); // 30ç§’ä¸€æ¬¡
      } else {
        // ä¸‹ç·š
        btn.className = "btn btn-off";
        btn.innerText = "ğŸ”´ å·²ä¸‹ç·š";
        statusRow.style.display = 'none';
        clearInterval(updateTimer);
        // å‚³é€ä¸‹ç·šè¨Šè™Ÿ
        postData('offline', isBusy ? 'busy' : 'empty', 0, 0);
      }
    }

    function toggleStatus() {
      isBusy = !isBusy;
      const btn = document.getElementById('btn-status');
      if (isBusy) {
        btn.className = "btn btn-busy";
        btn.innerText = "ğŸŸ¥ è¼‰å®¢ä¸­";
      } else {
        btn.className = "btn btn-empty";
        btn.innerText = "ğŸŸ¢ ç›®å‰ç©ºè»Š";
      }
      // ç‹€æ…‹è®Šæ›´ç«‹åˆ»ä¸Šå‚³ä¸€æ¬¡
      uploadLocation();
    }

    function uploadLocation() {
      if (!isOnline) return;
      
      navigator.geolocation.getCurrentPosition(pos => {
        const lat = pos.coords.latitude;
        const lng = pos.coords.longitude;
        // å¸æ©Ÿè‡ªå·±åœ°åœ–ä¹Ÿè¦è·Ÿè‘—ç§»å‹•åˆ°ç›®å‰ä½ç½®
        // map.setView([lat, lng], 15); // å¯é¸ï¼šæ˜¯å¦è¦å¼·åˆ¶æ‹‰å›è¦–è§’
        
        postData('online', isBusy ? 'busy' : 'empty', lat, lng);
      }, err => {
        console.error("GPS Error");
      });
    }

    function postData(status, work, lat, lng) {
      const payload = {
        userId: currentUser.userId,
        status: status,
        work: work,
        lat: lat,
        lng: lng
      };
      // ä½¿ç”¨ fetch POST (æ³¨æ„ï¼šGAS Web App éœ€è¦ text/plain é¿å… CORS preflight)
      fetch(GAS_URL, {
        method: 'POST',
        body: JSON.stringify(payload)
      }).catch(e => console.log(e));
    }

    // --- ä¹˜å®¢ç«¯ (åœ°åœ–é¡¯ç¤º) ---
    function fetchDrivers() {
      fetch(`${GAS_URL}?op=get_drivers`)
        .then(res => res.json())
        .then(drivers => {
          updateMap(drivers);
          updateHUD(drivers.length);
        });
    }

    function updateMap(drivers) {
      // ç°¡å–®æš´åŠ›æ³•ï¼šæ¸…é™¤æ‰€æœ‰ Marker é‡ç•« (å› ç‚ºè»Šæ•¸å°‘ï¼Œæ•ˆèƒ½å½±éŸ¿ä¸å¤§)
      for (let id in markers) {
        map.removeLayer(markers[id]);
      }
      markers = {};

      drivers.forEach(d => {
        // æ ¹æ“šå¿™ç¢Œç‹€æ…‹æ›åœ–ç¤º
        let icon = d.workStatus === 'busy' ? iconBusy : iconEmpty;
        
        let marker = L.marker([d.lat, d.lng], {icon: icon}).addTo(map);
        marker.bindPopup(`
          <div class="driver-popup">
            <b>${d.name}</b><br>
            ${d.workStatus === 'busy' ? '(è¼‰å®¢ä¸­)' : '(ç©ºè»Š)'}<br>
            <a href="tel:${d.phone}" class="call-btn">ğŸ“ ç›´æ¥é€šè©±</a>
          </div>
        `);
        markers[d.id] = marker;
      });
    }

    function updateHUD(count) {
      const hud = document.getElementById('hud');
      const dot = hud.querySelector('.status-dot');
      if (count > 0) {
        dot.style.background = "#2ecc71";
        hud.innerHTML = `<span class="status-dot" style="background:#2ecc71;"></span> ç·šä¸Šé‹å°‡ï¼š${count} äºº`;
      } else {
        dot.style.background = "#e74c3c";
        hud.innerHTML = `<span class="status-dot" style="background:#e74c3c;"></span> ç›®å‰ç„¡å¸æ©Ÿæœå‹™`;
      }
    }
  </script>
</body>
</html>
