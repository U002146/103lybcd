<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <title>èŠ±è“®è»ŠéšŠ - å¸æ©Ÿç«¯ (v5.6 Mission Ready)</title>
  
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
  <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAIxc6PEhHgUs_A9lyRUg8dNbmwOpSamY8&libraries=geometry"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

  <style>
    body { margin: 0; padding: 0; font-family: -apple-system, Roboto, sans-serif; overflow: hidden; background: #121212; color: white; }
    #map { width: 100vw; height: 100vh; display: none; } 
    
    /* å•Ÿå‹•ç•«é¢ */
    #unlock-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #000; z-index: 20000; display: flex; flex-direction: column; justify-content: center; align-items: center; text-align: center; }
    .btn-unlock { width: 120px; height: 120px; border-radius: 50%; background: radial-gradient(circle, #00C853 0%, #009624 100%); border: 4px solid #fff; box-shadow: 0 0 30px rgba(0,200,83,0.6); color: white; font-size: 24px; font-weight: bold; cursor: pointer; animation: pulse-green 2s infinite; display: flex; flex-direction: column; justify-content: center; align-items: center; }
    .btn-unlock:active { transform: scale(0.9); }
    @keyframes pulse-green { 0% { box-shadow: 0 0 0 0 rgba(0, 200, 83, 0.7); } 70% { box-shadow: 0 0 0 20px rgba(0, 200, 83, 0); } 100% { box-shadow: 0 0 0 0 rgba(0, 200, 83, 0); } }

    /* UI å±¤ */
    #ui-layer { display: none; pointer-events: none; width: 100%; height: 100%; position: absolute; top: 0; left: 0; z-index: 10; }
    #hud { pointer-events: auto; position: absolute; top: 15px; left: 15px; background: rgba(33, 33, 33, 0.9); color: white; padding: 10px 20px; border-radius: 30px; font-weight: bold; font-size: 16px; box-shadow: 0 4px 10px rgba(0,0,0,0.5); display: flex; align-items: center; }
    .status-dot { width: 12px; height: 12px; border-radius: 50%; display: inline-block; margin-right: 8px; }

    /* å³ä¸Šè§’æŒ‰éˆ•ç¾¤ */
    #top-right-panel { pointer-events: auto; position: absolute; top: 15px; right: 15px; display: flex; flex-direction: column; gap: 15px; }
    .circle-btn { width: 60px; height: 60px; border-radius: 50%; border: 2px solid rgba(255,255,255,0.8); color: white; font-weight: bold; font-size: 14px; box-shadow: 0 4px 15px rgba(0,0,0,0.5); cursor: pointer; display: flex; flex-direction: column; justify-content: center; align-items: center; backdrop-filter: blur(4px); position: relative; }
    .circle-btn i { font-size: 20px; margin-bottom: 2px; }
    
    .bg-off { background: linear-gradient(145deg, #7f8c8d, #95a5a6); }
    .bg-on { background: linear-gradient(145deg, #d32f2f, #ef5350); }
    .bg-mission { background: linear-gradient(145deg, #FFD700, #FFA000); color: black; border-color: black; }
    .bg-sos { background: linear-gradient(145deg, #D50000, #FF1744); }
    
    .badge { position: absolute; top: -5px; right: -5px; background: red; color: white; border-radius: 50%; width: 22px; height: 22px; font-size: 12px; display: flex; justify-content: center; align-items: center; border: 2px solid white; font-weight: bold; display: none; }

    /* åº•éƒ¨æ¶å–®é€šçŸ¥å€ (Incoming Alert) */
    #alert-container {
        pointer-events: auto; position: absolute; bottom: 20px; left: 5%; width: 90%;
        display: flex; flex-direction: column; gap: 10px; justify-content: flex-end;
    }
    
    /* ç´…è‰²æ€¥ä»¶å¡ */
    .alert-card {
        background: linear-gradient(145deg, #b71c1c, #d32f2f);
        border: 2px solid #ff5252; border-radius: 15px; padding: 15px;
        color: white; box-shadow: 0 10px 30px rgba(0,0,0,0.6);
        animation: slideUp 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    }
    @keyframes slideUp { from { transform: translateY(100px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
    
    .ac-header { display: flex; justify-content: space-between; font-size: 14px; margin-bottom: 5px; opacity: 0.9; }
    .ac-route { font-size: 20px; font-weight: bold; margin-bottom: 10px; display: flex; align-items: center; gap: 10px; }
    .ac-footer { display: flex; gap: 10px; }
    .btn-grab { flex: 1; background: #fff; color: #d32f2f; border: none; padding: 12px; border-radius: 25px; font-weight: 900; font-size: 18px; cursor: pointer; box-shadow: 0 4px 10px rgba(0,0,0,0.3); }
    .btn-grab:active { transform: scale(0.95); background: #eee; }

    /* æ¨¡æ…‹è¦–çª—é€šç”¨æ¨£å¼ */
    .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 10000; flex-direction: column; }
    .modal-header { padding: 15px; background: #222; color: white; font-size: 18px; font-weight: bold; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #444; }
    .modal-content { flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 15px; }

    /* è¡¨å–®æ¨£å¼ */
    .form-group { margin-bottom: 15px; }
    .form-label { display: block; margin-bottom: 5px; color: #aaa; font-size: 14px; }
    .form-input { width: 100%; padding: 12px; background: #333; border: 1px solid #555; border-radius: 8px; color: white; font-size: 16px; box-sizing: border-box; }
    .btn-post { width: 100%; background: #D50000; color: white; padding: 15px; border: none; border-radius: 8px; font-weight: bold; font-size: 18px; cursor: pointer; }

    /* ä»»å‹™åˆ—è¡¨å¡ç‰‡ */
    .mission-card { background: #fff; color: #333; border-radius: 10px; padding: 15px; border-left: 5px solid #FFD700; margin-bottom: 10px; }
    .mc-actions { display: flex; gap: 10px; margin-top: 10px; border-top: 1px solid #eee; padding-top: 10px; }
    .btn-action { flex: 1; padding: 10px; border-radius: 8px; border: none; font-weight: bold; cursor: pointer; display: flex; justify-content: center; align-items: center; gap: 5px; color: white; }
    .btn-call { background: #00C853; }
    .btn-nav { background: #2962FF; }
    .btn-done { width: 100%; margin-top: 10px; background: #333; color: white; padding: 12px; border-radius: 8px; font-weight: bold; border: none; }

    /* è¨»å†Šæ¡† */
    #register-box { width: 90%; max-width: 400px; background: #222; padding: 25px; border-radius: 15px; border: 1px solid #444; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); display: none; z-index: 30000; }
  </style>
</head>
<body>

  <div id="unlock-screen">
      <button class="btn-unlock" onclick="systemStart()">
          <i class="fa-solid fa-power-off"></i> START
      </button>
      <div style="margin-top:20px;color:#aaa;">é»æ“Šå•Ÿå‹•ç³»çµ±</div>
  </div>

  <div id="map"></div>
  <div id="ui-layer">
      <div id="hud"><span class="status-dot" style="background:gray;"></span> ç³»çµ±å¾…å‘½</div>
      
      <div id="top-right-panel">
        <button id="btn-power" class="circle-btn bg-off" onclick="togglePower()">
            <i class="fa-solid fa-power-off"></i>
            <span class="sub-text">OFF</span>
        </button>
        
        <button id="btn-sos" class="circle-btn bg-sos" style="display:none;" onclick="openPostModal()">
            <i class="fa-solid fa-bullhorn"></i>
            <span class="sub-text">è½‰å–®</span>
        </button>

        <button id="btn-mission" class="circle-btn bg-mission" style="display:none;" onclick="openMissionModal()">
            <i class="fa-solid fa-clipboard-list"></i>
            <div id="mission-badge" class="badge">0</div>
            <span class="sub-text">ä»»å‹™</span>
        </button>
      </div>

      <div id="alert-container"></div>
  </div>

  <div id="post-modal" class="modal-overlay">
      <div class="modal-header">
          <span><i class="fa-solid fa-tower-broadcast"></i> ç™¼å¸ƒè½‰å–® (è«‹æ±‚æ”¯æ´)</span>
          <button onclick="closePostModal()" style="background:none;border:none;color:white;font-size:24px;"><i class="fa-solid fa-xmark"></i></button>
      </div>
      <div class="modal-content">
          <div class="form-group">
              <label class="form-label">å‡ºç™¼æ™‚é–“ (å¿…å¡«)</label>
              <input type="time" id="post-time" class="form-input">
          </div>
          <div class="form-group">
              <label class="form-label">ä¸Šè»Šåœ°é» (å¿…å¡«)</label>
              <input type="text" id="post-from" class="form-input" placeholder="ä¾‹å¦‚: èŠ±è“®è»Šç«™å‰ç«™">
          </div>
          <div class="form-group">
              <label class="form-label">ä¸‹è»Šåœ°é» (é¸å¡«)</label>
              <input type="text" id="post-to" class="form-input" placeholder="æœªå¡«å¯«å‰‡é¡¯ç¤º: ä¸Šè»Šè­°">
          </div>
          <div class="form-group">
              <label class="form-label">ä¹˜å®¢é›»è©± (é¸å¡«)</label>
              <input type="tel" id="post-phone" class="form-input" placeholder="è·¯æ‹›å¯ä¸å¡«">
          </div>
          <div class="form-group" style="display:flex; align-items:center; gap:10px; background:#333; padding:10px; border-radius:8px;">
              <input type="checkbox" id="post-card" style="transform:scale(1.5);">
              <span style="font-weight:bold; color:#FFD700;">ğŸ’³ æ•¬è€å¡ / æ„›å¿ƒå¡</span>
          </div>
          <button class="btn-post" onclick="submitPost()">ğŸ“¡ ç™¼é€å…¨é »å»£æ’­</button>
      </div>
  </div>

  <div id="mission-modal" class="modal-overlay">
      <div class="modal-header">
          <span><i class="fa-solid fa-clipboard-check"></i> æˆ‘çš„ä»»å‹™æ¸…å–®</span>
          <button onclick="closeMissionModal()" style="background:none;border:none;color:white;font-size:24px;"><i class="fa-solid fa-xmark"></i></button>
      </div>
      <div class="modal-content" id="my-mission-list">
          <div style="text-align:center; color:#666; margin-top:50px;">ç›®å‰æ²’æœ‰åŸ·è¡Œä¸­çš„ä»»å‹™</div>
      </div>
  </div>

  <div id="register-box">
      <div style="font-size:24px;font-weight:bold;margin-bottom:20px;text-align:center;color:#FFD700;">ğŸ“‹ å¸æ©Ÿå…¥éšŠç”³è«‹</div>
      <input type="text" id="reg-name" class="form-input" style="margin-bottom:10px;" placeholder="çœŸå¯¦å§“å">
      <input type="text" id="reg-car" class="form-input" style="margin-bottom:10px;" placeholder="è»Šç‰Œ (TDP-123)">
      <input type="tel" id="reg-phone" class="form-input" style="margin-bottom:10px;" placeholder="é›»è©±">
      <input type="text" id="reg-uid" class="form-input" style="margin-bottom:10px;" readonly>
      <button class="btn-post" style="background:#00C853;" onclick="submitRegistration()">é€å‡ºå¯©æ ¸</button>
  </div>

  <audio id="sound-boot" src="data:audio/mpeg;base64,//uQxAAAAANIAAAAAExBTUUzLjEwMKqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqq//uQxAAAAANIAAAAAExBTUUzLjEwMKqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqq"></audio>
  <audio id="sound-alert" src="data:audio/wav;base64,UklGRl9vT1BXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YU"></audio>

  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <script>
    const LIFF_ID = "2008907691-7ntMtfbA"; 
    const firebaseConfig = { databaseURL: "https://hualientaxi-bb32f-default-rtdb.asia-southeast1.firebasedatabase.app/" };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    var map, currentUser = null, isOnline = false, watchId = null;
    var myMissions = []; // æœ¬åœ°å­˜å„²æˆ‘çš„ä»»å‹™

    // å•Ÿå‹•æµç¨‹
    function systemStart() {
        const boot = document.getElementById('sound-boot');
        if(boot) boot.play().catch(e=>{});
        
        document.getElementById('unlock-screen').style.display = 'none';
        document.getElementById('map').style.display = 'block';
        document.getElementById('ui-layer').style.display = 'block';
        
        initGoogleMap();
        initLiff();
        setNowTime();
    }

    function initGoogleMap() {
        map = new google.maps.Map(document.getElementById("map"), { center: { lat: 23.991, lng: 121.601 }, zoom: 15, disableDefaultUI: true });
    }

    async function initLiff() {
        try { 
            await liff.init({ liffId: LIFF_ID });
            if (!liff.isInClient()) { alert("è«‹ä½¿ç”¨ LINE é–‹å•Ÿ"); return; }
            if (!liff.isLoggedIn()) { liff.login(); return; }
            currentUser = await liff.getProfile();
            checkIdentity(currentUser.userId);
        } catch (e) { alert("LIFF Error"); }
    }

    function checkIdentity(uid) {
        db.ref('drivers/' + uid).once('value').then(snapshot => {
            if (snapshot.exists()) {
                const d = snapshot.val();
                document.getElementById('hud').innerHTML = `<span class="status-dot" style="background:#2ecc71;"></span> å—¨ï¼Œ${d.name}`;
                document.getElementById('btn-power').style.display = 'flex';
                // æ¢å¾©ä¸Šæ¬¡é€£ç·šç‹€æ…‹ (v5.6: é è¨­ä¸ä¸Šç·šï¼Œéœ€æ‰‹å‹•æŒ‰)
                listenForOrders(); // é–‹å§‹ç›£è½å…¨é »å»£æ’­
                listenForMyMissions(uid); // ç›£è½æˆ‘çš„ä»»å‹™
            } else {
                document.getElementById('ui-layer').style.display = 'none';
                document.getElementById('register-box').style.display = 'block';
                document.getElementById('reg-uid').value = uid;
            }
        });
    }

    // --- ç™¼å–®é‚è¼¯ (Broadcast) ---
    function openPostModal() { document.getElementById('post-modal').style.display = 'flex'; setNowTime(); }
    function closePostModal() { document.getElementById('post-modal').style.display = 'none'; }
    function setNowTime() { const now = new Date(); document.getElementById('post-time').value = `${String(now.getHours()).padStart(2,'0')}:${String(now.getMinutes()).padStart(2,'0')}`; }

    function submitPost() {
        const time = document.getElementById('post-time').value;
        const from = document.getElementById('post-from').value;
        const to = document.getElementById('post-to').value || "ä¸Šè»Šè­° / æœªæŒ‡å®š";
        const phone = document.getElementById('post-phone').value || ""; // é¸å¡«
        const isCard = document.getElementById('post-card').checked;

        if(!from) { Swal.fire('è«‹å¡«å¯«ä¸Šè»Šåœ°é»'); return; }

        const order = {
            ownerId: currentUser.userId,
            ownerName: currentUser.displayName,
            time: time, from: from, to: to, phone: phone, isCard: isCard,
            status: 'pending', timestamp: firebase.database.ServerValue.TIMESTAMP
        };

        db.ref('orders').push(order);
        closePostModal();
        // æ¸…ç©º
        document.getElementById('post-from').value = "";
        document.getElementById('post-to').value = "";
        document.getElementById('post-phone').value = "";
        document.getElementById('post-card').checked = false;
        
        Swal.fire({icon:'success', title:'å»£æ’­å·²ç™¼é€', timer: 1500, showConfirmButton: false});
    }

    // --- æ¶å–®é‚è¼¯ (Incoming Alert) ---
    function listenForOrders() {
        const container = document.getElementById('alert-container');
        
        db.ref('orders').on('child_added', snapshot => {
            const order = snapshot.val();
            const oid = snapshot.key;
            
            // æ¢ä»¶ï¼šç‹€æ…‹æ˜¯ pending ä¸”ä¸æ˜¯è‡ªå·±ç™¼çš„
            if(order.status !== 'pending') return;
            if(currentUser && order.ownerId === currentUser.userId) return;

            // æ’­æ”¾éŸ³æ•ˆ
            const alert = document.getElementById('sound-alert');
            if(alert) { alert.currentTime=0; alert.play().catch(e=>{}); }
            if(navigator.vibrate) navigator.vibrate([300, 100, 300, 100, 300]);

            // å»ºç«‹å¡ç‰‡
            const card = document.createElement('div');
            card.className = 'alert-card';
            card.id = `alert-${oid}`;
            
            const cardTag = order.isCard ? `<span style="background:white;color:red;padding:2px 5px;border-radius:4px;font-size:12px;font-weight:bold;">ğŸ’³ åˆ·å¡</span>` : '';
            
            card.innerHTML = `
                <div class="ac-header">
                    <span>â± ${order.time}</span>
                    <span>${order.ownerName}</span>
                </div>
                <div class="ac-route">
                    <i class="fa-solid fa-location-dot"></i> ${order.from}
                </div>
                <div style="margin-bottom:10px; font-size:14px; color:#ddd;">
                    <i class="fa-solid fa-arrow-right"></i> ${order.to} ${cardTag}
                </div>
                <div class="ac-footer">
                    <button class="btn-grab" onclick="grabOrder('${oid}')">âš¡ æ¶å–®æ¥å®¢</button>
                </div>
            `;
            container.appendChild(card);
        });

        // ç›£è½è¨‚å–®ç§»é™¤/ç‹€æ…‹æ”¹è®Š (åˆ¥äººæ¶èµ°äº†)
        db.ref('orders').on('child_removed', snap => removeAlert(snap.key));
        db.ref('orders').on('child_changed', snap => {
            if(snap.val().status !== 'pending') removeAlert(snap.key);
        });
    }

    function removeAlert(oid) {
        const el = document.getElementById(`alert-${oid}`);
        if(el) el.remove();
    }

    function grabOrder(oid) {
        if(!currentUser) return;
        
        db.ref(`orders/${oid}`).transaction((order) => {
            if (order && order.status === 'pending') {
                order.status = 'taken';
                order.takerId = currentUser.userId;
                order.takerName = currentUser.displayName;
                return order;
            } else { return; } // æ”¾æ£„
        }, (error, committed, snapshot) => {
            if (error) {
                Swal.fire('æ¶å–®å¤±æ•—', 'ç³»çµ±éŒ¯èª¤', 'error');
            } else if (!committed) {
                Swal.fire('æ…¢äº†ä¸€æ­¥', 'è¢«æ¶èµ°äº†ï¼', 'warning');
                removeAlert(oid);
            } else {
                // æ¶å–®æˆåŠŸï¼
                const val = snapshot.val();
                Swal.fire({
                    icon: 'success',
                    title: 'æ¶å–®æˆåŠŸï¼',
                    text: 'å·²å­˜å…¥ä»»å‹™åˆ—è¡¨',
                    timer: 1500,
                    showConfirmButton: false
                });
                removeAlert(oid);
                // é€™è£¡ä¸éœ€è¦æ‰‹å‹•å­˜ï¼Œå› ç‚º listenForMyMissions æœƒè‡ªå‹•æŠ“åˆ°è®ŠåŒ–
            }
        });
    }

    // --- æˆ‘çš„ä»»å‹™é‚è¼¯ (My Missions) ---
    function listenForMyMissions(uid) {
        // ç›£è½æ‰€æœ‰ã€Œæˆ‘æ˜¯ takerIdã€ä¸”ã€Œç‹€æ…‹æ˜¯ takenã€çš„è¨‚å–®
        // é€™è£¡ç‚ºäº†ç°¡åŒ–ï¼Œæˆ‘å€‘ç›£è½ orders ä¸¦éæ¿¾ (è‹¥è¨‚å–®é‡å¤§å»ºè­°ç”¨ query)
        db.ref('orders').on('value', snapshot => {
            const data = snapshot.val();
            myMissions = [];
            if(data) {
                Object.keys(data).forEach(key => {
                    const order = data[key];
                    if(order.takerId === uid && order.status === 'taken') {
                        order.id = key;
                        myMissions.push(order);
                    }
                });
            }
            updateMissionBadge();
            renderMissionList();
        });
    }

    function updateMissionBadge() {
        const badge = document.getElementById('mission-badge');
        const btn = document.getElementById('btn-mission');
        if(myMissions.length > 0) {
            badge.style.display = 'flex';
            badge.innerText = myMissions.length;
            btn.classList.add('bg-mission'); // äº®ç‡ˆ
        } else {
            badge.style.display = 'none';
            // æ¢å¾©åŸè‰²(é€™è£¡ç°¡åŒ–ï¼Œç›´æ¥ç¶­æŒæ¨£å¼)
        }
    }

    function openMissionModal() {
        document.getElementById('mission-modal').style.display = 'flex';
        renderMissionList();
    }
    function closeMissionModal() { document.getElementById('mission-modal').style.display = 'none'; }

    function renderMissionList() {
        const container = document.getElementById('my-mission-list');
        if(myMissions.length === 0) {
            container.innerHTML = `<div style="text-align:center; color:#666; margin-top:50px;">ç›®å‰æ²’æœ‰åŸ·è¡Œä¸­çš„ä»»å‹™</div>`;
            return;
        }
        
        container.innerHTML = '';
        myMissions.forEach(m => {
            const phoneBtn = m.phone ? `<a href="tel:${m.phone}" class="btn-action btn-call"><i class="fa-solid fa-phone"></i> æ’¥çµ¦ä¹˜å®¢</a>` : `<button class="btn-action btn-call" disabled style="opacity:0.5"><i class="fa-solid fa-phone-slash"></i> ç„¡é›»è©±</button>`;
            
            // å°èˆªé€£çµ (ä½¿ç”¨ Google Maps URL Scheme)
            const navUrl = `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(m.from)}`;
            
            container.innerHTML += `
                <div class="mission-card">
                    <div style="font-weight:bold; font-size:18px; color:#000; margin-bottom:5px;">
                        <i class="fa-solid fa-location-dot" style="color:#d32f2f"></i> ${m.from}
                    </div>
                    <div style="font-size:14px; color:#555; margin-bottom:5px;">
                        <i class="fa-solid fa-flag-checkered"></i> ${m.to}
                    </div>
                    <div style="font-size:14px; color:#888;">
                        ç™¼å–®äºº: ${m.ownerName} (${m.time})
                    </div>
                    <div class="mc-actions">
                        ${phoneBtn}
                        <a href="${navUrl}" target="_blank" class="btn-action btn-nav"><i class="fa-solid fa-diamond-turn-right"></i> å°èˆª</a>
                    </div>
                    <button class="btn-done" onclick="completeMission('${m.id}')">âœ… ä»»å‹™å®Œæˆ (çµæ¡ˆ)</button>
                </div>
            `;
        });
    }

    function completeMission(oid) {
        Swal.fire({
            title: 'ç¢ºèªçµæ¡ˆ?',
            text: "ä»»å‹™å°‡å¾åˆ—è¡¨ä¸­ç§»é™¤",
            icon: 'question',
            showCancelButton: true,
            confirmButtonColor: '#3085d6',
            cancelButtonColor: '#d33',
            confirmButtonText: 'æ˜¯çš„ï¼Œå·²å®Œæˆ!'
        }).then((result) => {
            if (result.isConfirmed) {
                // å°‡ç‹€æ…‹æ”¹ç‚º completed (æˆ–ç›´æ¥åˆªé™¤ï¼Œçœ‹éœ€æ±‚ã€‚é€™è£¡æ”¹ç‹€æ…‹æ¯”è¼ƒå¥½è¿½è¹¤)
                db.ref(`orders/${oid}`).update({ status: 'completed' });
                Swal.fire('å·²çµæ¡ˆ!', 'è¾›è‹¦äº†ï¼Œç¹¼çºŒæ¥å–®å§ã€‚', 'success');
            }
        })
    }

    // --- é€šç”¨å‡½å¼ ---
    function togglePower() {
        const btn = document.getElementById('btn-power');
        const subBtns = ['btn-sos', 'btn-mission'];
        
        if(!isOnline) {
            isOnline = true; localStorage.setItem('isOnline', 'true');
            btn.className = "circle-btn bg-on"; btn.innerHTML = `<i class="fa-solid fa-power-off"></i><span class="sub-text">ON</span>`;
            document.getElementById('hud').innerHTML = `<span class="status-dot" style="background:#00C853;"></span> ä¸Šç·šæ¥å–®ä¸­`;
            subBtns.forEach(id => document.getElementById(id).style.display = 'flex');
            
            if(navigator.geolocation) {
                watchId = navigator.geolocation.watchPosition(pos => {
                    const {latitude, longitude} = pos.coords;
                    db.ref('drivers/' + currentUser.userId).update({
                        lat: latitude, lng: longitude, status: 'online', lastUpdate: firebase.database.ServerValue.TIMESTAMP
                    });
                }, err=>{}, {enableHighAccuracy:true});
            }
        } else {
            isOnline = false; localStorage.setItem('isOnline', 'false');
            btn.className = "circle-btn bg-off"; btn.innerHTML = `<i class="fa-solid fa-power-off"></i><span class="sub-text">OFF</span>`;
            document.getElementById('hud').innerHTML = `<span class="status-dot" style="background:gray;"></span> ç³»çµ±å¾…å‘½`;
            subBtns.forEach(id => document.getElementById(id).style.display = 'none');
            
            if(watchId) navigator.geolocation.clearWatch(watchId);
            db.ref('drivers/' + currentUser.userId).update({ status: 'offline' });
        }
    }

    function submitRegistration() {
        const name = document.getElementById('reg-name').value;
        const car = document.getElementById('reg-car').value;
        const phone = document.getElementById('reg-phone').value;
        const uid = document.getElementById('reg-uid').value;
        if(!name || !car || !phone) return alert("è«‹å¡«å¯«å®Œæ•´");
        
        liff.sendMessages([{type:'text', text:`ã€ç”³è«‹å…¥éšŠã€‘\nå§“å:${name}\nè»Šè™Ÿ:${car}\né›»è©±:${phone}\nID:${uid}`}])
            .then(() => alert("å·²é€å‡ºç”³è«‹"))
            .catch(() => alert("è«‹æ‰‹å‹•è¤‡è£½IDçµ¦ç®¡ç†å“¡: " + uid));
    }
  </script>
</body>
</html>
