<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>èŠ±è“®æ•¬è€æ„›å¿ƒä¹˜è»Šæ”¯æ´å¹³å°</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    body { margin: 0; padding: 0; font-family: -apple-system, system-ui, BlinkMacSystemFont, "Segoe UI", Roboto; overflow: hidden; background: #f0f0f0; }
    #map { width: 100vw; height: 100vh; z-index: 1; transition: opacity 0.5s; }
    
    /* å·¦ä¸Šè§’ HUD */
    #hud {
      position: absolute; top: 15px; left: 15px; z-index: 999;
      background: rgba(30, 30, 30, 0.9); color: white; padding: 12px 20px;
      border-radius: 30px; font-size: 16px; font-weight: bold;
      backdrop-filter: blur(5px); box-shadow: 0 4px 15px rgba(0,0,0,0.3);
      display: flex; align-items: center; gap: 10px; pointer-events: none;
    }
    .status-dot { width: 12px; height: 12px; border-radius: 50%; display: inline-block; }
    
    /* å³ä¸Šè§’æ§åˆ¶å€å®¹å™¨ */
    #top-right-panel {
      position: absolute; top: 15px; right: 15px; z-index: 1000;
      display: flex; flex-direction: column; align-items: center; gap: 12px;
    }

    .circle-btn {
      border: none; border-radius: 50%; color: white;
      font-weight: bold; cursor: pointer;
      box-shadow: 0 6px 20px rgba(0,0,0,0.4);
      display: flex; flex-direction: column; justify-content: center; align-items: center;
      transition: all 0.2s;
      text-shadow: 0 1px 2px rgba(0,0,0,0.3);
    }
    .circle-btn:active { transform: scale(0.85); box-shadow: 0 2px 10px rgba(0,0,0,0.2); }
    
    #btn-power { width: 85px; height: 85px; font-size: 20px; }
    #btn-status { width: 70px; height: 70px; font-size: 16px; display: none; }
    #btn-save-power { width: 70px; height: 70px; font-size: 14px; background: #34495e; display: none; }
    #btn-register { width: 75px; height: 75px; font-size: 15px; background: linear-gradient(135deg, #f39c12, #e67e22); display: none; }
    #btn-share { width: 60px; height: 60px; font-size: 13px; background: linear-gradient(135deg, #3498db, #2980b9); }

    /* æŒ‰éˆ•é¡è‰²æ¨£å¼ */
    .bg-green { background: linear-gradient(135deg, #2ecc71, #27ae60); }
    .bg-red   { background: linear-gradient(135deg, #e74c3c, #c0392b); }
    .bg-blue  { background: linear-gradient(135deg, #3498db, #2980b9); } 
    .bg-gray  { background: linear-gradient(135deg, #bdc3c7, #95a5a6); }
    
    .sub-text { font-size: 12px; opacity: 0.9; margin-top: 4px; }
    .leaflet-bottom { bottom: 140px !important; }

    /* é»‘å±é®ç½© (æ’ç­/çœé›») */
    #power-save-overlay {
      display: none; position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
      background: black; z-index: 2000; color: #444; flex-direction: column;
      justify-content: center; align-items: center;
    }
    #power-save-overlay.active { display: flex; }
    #power-save-overlay p { color: #00ff00; margin-top: 20px; font-size: 18px; opacity: 0.5; }

    /* é€šç”¨å½ˆçª— */
    .modal-overlay {
      display: none; position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
      background: rgba(0,0,0,0.85); z-index: 3000; justify-content: center; align-items: center;
      backdrop-filter: blur(8px);
    }
    .modal-content {
      background: white; width: 85%; max-width: 350px; border-radius: 24px;
      padding: 25px; box-sizing: border-box; text-align: center;
    }

    /* ğŸ”¥ æ–°å¢ï¼šå®šä½æ¬Šé™æ•™å­¸å½ˆçª—æ¨£å¼ */
    #gps-instruction { text-align: left; background: #fff8e1; padding: 15px; border-radius: 10px; margin: 15px 0; border: 2px solid #ffecb3; }
    #gps-instruction ol { padding-left: 20px; margin: 5px 0; color: #555; font-size: 15px; line-height: 1.6; }
    #gps-instruction b { color: #e67e22; }

    /* QR Code é¡¯ç¤ºå€ */
    #qrcode-container {
      background: #f9f9f9; padding: 15px; border-radius: 15px; margin: 15px 0;
      display: flex; justify-content: center; align-items: center;
    }
    #qrcode-container img { width: 200px; height: 200px; }

    /* è¨»å†Šè¡¨å–® */
    .form-group { margin-bottom: 15px; text-align: left; }
    .form-group label { display: block; font-size: 13px; color: #666; margin-bottom: 5px; }
    .form-group input { width: 100%; padding: 12px; border: 2px solid #eee; border-radius: 10px; box-sizing: border-box; font-size: 16px; }

    .modal-btns button { width: 100%; padding: 15px; border-radius: 12px; border: none; font-size: 16px; font-weight: bold; cursor: pointer; margin-top: 10px; }

    /* åº•éƒ¨å¡ç‰‡ */
    #passenger-carousel { position: absolute; bottom: 20px; left: 0; width: 100%; z-index: 1000; display: none; overflow-x: auto; gap: 12px; padding: 0 15px 15px 15px; box-sizing: border-box; scroll-snap-type: x mandatory; -webkit-overflow-scrolling: touch; }
    .driver-card { flex: 0 0 88%; max-width: 340px; background: white; border-radius: 20px; padding: 18px; box-shadow: 0 8px 25px rgba(0,0,0,0.2); scroll-snap-align: center; display: flex; align-items: center; justify-content: space-between; }
    .driver-card .card-call-btn { text-decoration: none; font-size: 24px; width: 50px; height: 50px; background: #2ecc71; color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 10px rgba(46, 204, 113, 0.4); }

  </style>
</head>
<body>

  <div id="power-save-overlay" onclick="togglePowerSaving()">
    <div style="font-size: 60px;">ğŸ…¿ï¸</div>
    <p>æ’ç­/çœé›»æ¨¡å¼ä¸­</p>
    <div style="font-size: 14px; color: #333; margin-top: 50px;">é»æ“Šè¢å¹•å›æ­¸åœ°åœ–</div>
  </div>

  <div id="share-modal" class="modal-overlay">
    <div class="modal-content">
      <h3 style="margin-top:0;">æƒç¢¼åŠ å…¥å¥½å‹</h3>
      <p style="font-size: 14px; color: #666;">æƒæ QR Code<br>åŠ å…¥å®˜æ–¹å¸³è™Ÿ (@631ugnif)</p>
      <div id="qrcode-container">
        <img id="qrcode-img" src="" alt="QR Code">
      </div>
      <div class="modal-btns">
        <button style="background:#eee; color:#333;" onclick="closeModal('share-modal')">é—œé–‰</button>
      </div>
    </div>
  </div>

  <div id="reg-modal" class="modal-overlay">
    <div class="modal-content">
      <h3 style="margin-top:0;">å¸æ©Ÿè¨»å†Šç”³è«‹</h3>
      <div class="form-group">
        <label>LINE ID</label>
        <input type="text" id="reg-uid" readonly style="background:#f0f0f0;">
      </div>
      <div class="form-group">
        <label>å¸æ©Ÿæš±ç¨±</label>
        <input type="text" id="reg-name" placeholder="è«‹å¡«å¯«å§“å">
      </div>
      <div class="form-group">
        <label>è»Šç‰Œè™Ÿç¢¼</label>
        <input type="text" id="reg-car" placeholder="ä¾‹å¦‚: ABC-1234">
      </div>
      <div class="form-group">
        <label>é€£çµ¡é›»è©±</label>
        <input type="tel" id="reg-phone" placeholder="09xx-xxx-xxx">
      </div>
      <div class="modal-btns">
        <button style="background:#2ecc71; color:white;" onclick="submitRegistration()">é€å‡ºè³‡æ–™</button>
        <button style="background:#eee; color:#666;" onclick="closeModal('reg-modal')">å–æ¶ˆ</button>
      </div>
    </div>
  </div>

  <div id="gps-alert-modal" class="modal-overlay" style="z-index: 4000;">
    <div class="modal-content">
      <div style="font-size: 50px;">ğŸ“</div>
      <h2 style="margin: 10px 0; color: #e74c3c;">ç„¡æ³•è®€å–ä½ç½®</h2>
      <p style="color:#666; font-size:14px;">è«‹æª¢æŸ¥æ‰‹æ©Ÿè¨­å®šï¼Œå…è¨± LINE å­˜å–æ‚¨çš„ä½ç½®ã€‚</p>
      
      <div id="gps-instruction">
        <ol>
          <li>é€²å…¥æ‰‹æ©Ÿ<b>ã€è¨­å®šã€‘</b></li>
          <li>æ‰¾åˆ°æ‡‰ç”¨ç¨‹å¼<b>ã€LINEã€‘</b></li>
          <li>é–‹å•Ÿ<b>ã€ä½ç½®/å®šä½ã€‘</b>æ¬Šé™</li>
        </ol>
      </div>
      
      <div class="modal-btns">
        <button style="background:#3498db; color:white;" onclick="retryGPS()">æˆ‘é–‹å¥½äº†ï¼é‡è©¦</button>
        <button style="background:#eee; color:#666; margin-top:8px;" onclick="closeModal('gps-alert-modal')">å–æ¶ˆ (åœ°åœ–å¯èƒ½ä¸æº–)</button>
      </div>
    </div>
  </div>

  <div id="hud">
    <span class="status-dot" style="background:gray;"></span> å®šä½ä¸­...
  </div>

  <div id="map"></div>

  <div id="top-right-panel">
    <button id="btn-power" class="circle-btn bg-gray" style="display:none;" onclick="togglePower()">
      <span>ä¸Šç·š</span>
      <span class="sub-text">OFF</span>
    </button>
    
    <button id="btn-status" class="circle-btn bg-green" onclick="toggleStatus()">
      <span>ç©ºè»Š</span>
    </button>
    
    <button id="btn-save-power" class="circle-btn" onclick="togglePowerSaving()">
      <span>çœé›»</span>
    </button>

    <button id="btn-register" class="circle-btn" onclick="openModal('reg-modal')">
      <span>å¸æ©Ÿ<br>è¨»å†Š</span>
    </button>

    <button id="btn-share" class="circle-btn" onclick="openShareModal()">
      <span>åˆ†äº«<br>å¹³å°</span>
    </button>
  </div>

  <div id="passenger-carousel"></div>

  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
    // ========= è¨­å®šå€ =========
    const GAS_URL = "https://script.google.com/macros/s/AKfycbyfNTgci2gZE2Etxvv6SHaP3puw7Mxt8ineL4gZve7Zyh2UGrcna4Zxap6EOyRICQ/exec"; 
    const LIFF_ID = "2008907691-7ntMtfbA"; 
    const FIREBASE_URL = "https://hualientaxi-bb32f-default-rtdb.asia-southeast1.firebasedatabase.app/"; 
    // =====================================

    var map, markers = {};
    var currentUser = null;
    var isDriver = false;
    var myLat = null, myLng = null;
    var myPhone = ""; 
    
    var currentWorkStatus = 'empty'; 
    var isOnline = false;
    var isPowerSaving = false;
    var updateTimer = null;
    var wakeLock = null;

    var lastUploadLat = 0;
    var lastUploadLng = 0;
    var lastUploadTime = 0;
    
    var hasCenteredMap = false; 
    
    // ğŸ”¥ é˜²æ­¢é‡è¤‡å½ˆå‡ºè­¦å‘Š
    var isGpsAlertShown = false;

    // å®šç¾©åœ–ç¤º
    const iconEmpty = L.divIcon({ html: '<div style="font-size:36px;">ğŸš•</div>', className: '', iconSize: [36, 36], iconAnchor: [18, 18] });
    const iconBusy = L.divIcon({ html: '<div style="font-size:36px; filter: grayscale(100%) opacity(0.6);">ğŸš•</div>', className: '', iconSize: [36, 36], iconAnchor: [18, 18] });
    const iconQueue = L.divIcon({ html: '<div style="font-size:36px; filter: hue-rotate(200deg);">ğŸš•</div>', className: '', iconSize: [36, 36], iconAnchor: [18, 18] });

    window.onload = async function() {
      initMap();
      await initLiff();
      
      document.addEventListener('visibilitychange', async () => {
        if (wakeLock !== null && document.visibilityState === 'visible' && isOnline) {
          await requestWakeLock();
        }
      });
    };

    async function requestWakeLock() {
      if ('wakeLock' in navigator) {
        try { wakeLock = await navigator.wakeLock.request('screen'); } catch (err) {}
      }
    }
    function releaseWakeLock() {
      if (wakeLock !== null) { wakeLock.release().then(() => wakeLock = null); }
    }

    function openShareModal() {
      const oaUrl = "https://line.me/R/ti/p/@631ugnif";
      const qrApiUrl = `https://api.qrserver.com/v1/create-qr-code/?size=250x250&data=${encodeURIComponent(oaUrl)}`;
      document.getElementById('qrcode-img').src = qrApiUrl;
      openModal('share-modal');
    }

    function initMap() {
      map = L.map('map', { zoomControl: false }).setView([23.99000, 121.60684], 13);
      L.control.zoom({ position: 'bottomright' }).addTo(map);
      L.tileLayer('https://{s}.google.com/vt/lyrs=m&x={x}&y={y}&z={z}', {
        maxZoom: 20, subdomains: ['mt0', 'mt1', 'mt2', 'mt3'],
        attribution: 'Map data &copy; Google'
      }).addTo(map);
    }

    async function initLiff() {
      try {
        await liff.init({ liffId: LIFF_ID });
        if (!liff.isLoggedIn()) { liff.login(); return; }
        currentUser = await liff.getProfile();
        
        // å•Ÿå‹•å®šä½è¿½è¹¤ (åŒ…å«éŒ¯èª¤è™•ç†)
        startTrackingLocation();
        
        checkRole(currentUser.userId);
        fetchDrivers(); 
        setInterval(fetchDrivers, 5000); 
      } catch (err) { console.log("LIFF Error:", err); }
    }

    // ğŸ”¥ æ ¸å¿ƒä¿®æ”¹ï¼šå®šä½èˆ‡éŒ¯èª¤æ””æˆª
    function startTrackingLocation() {
      if (navigator.geolocation) {
        navigator.geolocation.watchPosition(
          (pos) => {
            // æˆåŠŸæŠ“åˆ°ä½ç½®
            myLat = pos.coords.latitude; 
            myLng = pos.coords.longitude;
            
            // å¦‚æœä¹‹å‰å½ˆéè­¦å‘Šè¦–çª—ï¼ŒæˆåŠŸå¾Œè‡ªå‹•é—œé–‰
            if (isGpsAlertShown) {
               closeModal('gps-alert-modal');
               isGpsAlertShown = false;
            }

            // ç¬¬ä¸€æ¬¡è‡ªå‹•é£›åˆ°ä½¿ç”¨è€…ä½ç½®
            if (!hasCenteredMap) {
               map.setView([myLat, myLng], 15);
               hasCenteredMap = true; 
               console.log("å·²è‡ªå‹•å®šä½è‡³ä½¿ç”¨è€…ä½ç½®");
            }
          }, 
          (err) => {
            // å¤±æ•—ï¼šæ””æˆªéŒ¯èª¤ä»£ç¢¼
            console.error("GPS Error:", err);
            // ä»£ç¢¼ 1: ä½¿ç”¨è€…æ‹’çµ• / ä»£ç¢¼ 2: æŠ“ä¸åˆ°ä½ç½® (æ²’é–‹ GPS) / ä»£ç¢¼ 3: é€¾æ™‚
            if ((err.code === 1 || err.code === 2) && !isGpsAlertShown) {
               openModal('gps-alert-modal');
               isGpsAlertShown = true; // æ¨™è¨˜å·²é¡¯ç¤ºï¼Œé¿å…ä¸€ç›´é–ƒçˆ
            }
          }, 
          { enableHighAccuracy: true, maximumAge: 0 }
        );
      } else {
        alert("æ‚¨çš„ç€è¦½å™¨ä¸æ”¯æ´å®šä½åŠŸèƒ½");
      }
    }
    
    // æŒ‰ä¸‹ã€Œæˆ‘é–‹å¥½äº†ã€çš„æŒ‰éˆ•åŠŸèƒ½
    function retryGPS() {
       closeModal('gps-alert-modal');
       isGpsAlertShown = false;
       // é‡æ–°è§¸ç™¼ä¸€æ¬¡å®šä½
       startTrackingLocation();
       // æˆ–æ˜¯ç°¡å–®çš„ location.reload(); ä¹Ÿå¯ä»¥
       window.location.reload();
    }

    function checkRole(uid) {
      fetch(`${GAS_URL}?op=check_role&uid=${uid}`)
        .then(res => res.json())
        .then(data => {
          isDriver = (data.role === 'driver');
          if (isDriver) {
            if(data.phone) myPhone = data.phone; 
            document.getElementById('btn-power').style.display = 'flex';
            document.getElementById('btn-register').style.display = 'none';
            document.getElementById('passenger-carousel').style.display = 'none';
          } else {
            document.getElementById('btn-power').style.display = 'none';
            document.getElementById('btn-register').style.display = 'flex';
            document.getElementById('passenger-carousel').style.display = 'flex';
          }
        });
    }

    function togglePower() {
      try {
        const nextState = !isOnline;
        const btnPower = document.getElementById('btn-power');
        const btnStatus = document.getElementById('btn-status');
        const btnSave = document.getElementById('btn-save-power');

        if (nextState) {
          isOnline = true;
          currentWorkStatus = 'empty';
          btnPower.className = "circle-btn bg-red";
          btnPower.innerHTML = `<span>ä¸‹ç·š</span><span class="sub-text">ON</span>`;
          btnStatus.style.display = 'flex';
          updateStatusButton(); 
          btnSave.style.display = 'flex';
          requestWakeLock();
          console.log("å˜—è©¦ä¸Šç·šï¼Œå–å¾— GPS ä¸­...");
          resetUpdateTimer();
        } else {
          isOnline = false;
          btnPower.className = "circle-btn bg-green";
          btnPower.innerHTML = `<span>ä¸Šç·š</span><span class="sub-text">OFF</span>`;
          btnStatus.style.display = 'none';
          btnSave.style.display = 'none';
          clearInterval(updateTimer);
          releaseWakeLock();
          postData('offline', 'empty', 0, 0); 
          if (isPowerSaving) togglePowerSaving();
        }
      } catch (e) {
        alert("æŒ‰éˆ•åŠŸèƒ½ç™¼ç”ŸéŒ¯èª¤ï¼š" + e.message);
      }
    }

    function toggleStatus() {
      if (currentWorkStatus === 'empty') {
        currentWorkStatus = 'queue';
      } else if (currentWorkStatus === 'queue') {
        currentWorkStatus = 'busy';
      } else {
        currentWorkStatus = 'empty';
      }
      
      updateStatusButton();
      uploadLocation(true); 
    }

    function updateStatusButton() {
      const btnStatus = document.getElementById('btn-status');
      if (currentWorkStatus === 'empty') {
        btnStatus.className = "circle-btn bg-green";
        btnStatus.innerHTML = `<span>ç©ºè»Š</span>`;
      } else if (currentWorkStatus === 'queue') {
        btnStatus.className = "circle-btn bg-blue";
        btnStatus.innerHTML = `<span>æ’ç­</span>`;
      } else {
        btnStatus.className = "circle-btn bg-red";
        btnStatus.innerHTML = `<span>è¼‰å®¢</span>`;
      }
    }

    function togglePowerSaving() {
      if (!isOnline) return;
      isPowerSaving = !isPowerSaving;
      const overlay = document.getElementById('power-save-overlay');
      const btnSave = document.getElementById('btn-save-power');
      
      if (isPowerSaving) {
        overlay.classList.add('active');
        btnSave.style.background = "#2ecc71";
        btnSave.innerHTML = `<span>æ­£å¸¸</span>`;
      } else {
        overlay.classList.remove('active');
        btnSave.style.background = "#34495e";
        btnSave.innerHTML = `<span>çœé›»</span>`;
      }
      resetUpdateTimer();
    }

    function resetUpdateTimer() {
      clearInterval(updateTimer);
      uploadLocation(); 
      
      const baseInterval = isPowerSaving ? 120000 : 30000;
      const jitter = Math.floor(Math.random() * 5000); 
      
      updateTimer = setInterval(uploadLocation, baseInterval + jitter);
    }

    function uploadLocation(forceUpdate = false) {
      if (!isOnline) return;
      
      if (!navigator.geolocation) {
        console.warn("ç€è¦½å™¨ä¸æ”¯æ´ GPS");
        return;
      }

      navigator.geolocation.getCurrentPosition(
        (pos) => {
          const curLat = pos.coords.latitude;
          const curLng = pos.coords.longitude;
          const now = Date.now();

          const dist = calculateDistance(lastUploadLat, lastUploadLng, curLat, curLng) * 1000; 
          const timeDiff = now - lastUploadTime;

          const distLimit = 30; 
          const timeLimit = 10 * 60 * 1000; 

          if (dist > distLimit || timeDiff > timeLimit || forceUpdate) {
            console.log(`ğŸš€ ä¸Šå‚³æ›´æ–° [${currentWorkStatus}]ï¼šç§»å‹• ${dist.toFixed(1)}m`);
            postData('online', currentWorkStatus, curLat, curLng);
            
            lastUploadLat = curLat;
            lastUploadLng = curLng;
            lastUploadTime = now;
          } else {
            console.log(`ğŸ’¤ çœæµä¸­...`);
          }
        },
        (err) => {
          // é€™è£¡çš„éŒ¯èª¤è™•ç†ä¸»è¦é‡å°å¸æ©ŸèƒŒæ™¯ä¸Šå‚³
          console.error("GPS Error:", err);
          if(isOnline && err.code === 1) {
              // å¸æ©Ÿä¸Šç·šä¸­æ–·ç·šï¼Œæœƒè·³å‡ºè­¦ç¤º
              openModal('gps-alert-modal');
              togglePower(); // å¼·åˆ¶ä¸‹ç·š
          }
        },
        { enableHighAccuracy: true, timeout: 15000, maximumAge: 0 }
      );
    }

    function postData(status, work, lat, lng) {
      if (!currentUser) return;

      const payload = {
        id: currentUser.userId,
        name: currentUser.displayName,
        phone: myPhone || "ç„¡é›»è©±",
        status: status,
        workStatus: work,
        lat: lat,
        lng: lng,
        lastUpdate: Date.now()
      };

      const url = `${FIREBASE_URL}drivers/${currentUser.userId}.json`;

      fetch(url, {
        method: 'PUT',
        body: JSON.stringify(payload)
      }).catch(e => {
        console.warn("Firebase é€£ç·šå¿™ç¢Œä¸­:", e);
      });
    }

    function openModal(id) {
      if (id === 'reg-modal') document.getElementById('reg-uid').value = currentUser.userId;
      document.getElementById(id).style.display = 'flex';
    }
    function closeModal(id) { document.getElementById(id).style.display = 'none'; }

    async function submitRegistration() {
      const name = document.getElementById('reg-name').value;
      const car = document.getElementById('reg-car').value;
      const phone = document.getElementById('reg-phone').value;
      if (!name || !car || !phone) { alert("å¤§å“¥ï¼Œè³‡æ–™è¦å¡«å®Œæ•´å–”ï¼"); return; }
      const msg = `ğŸš– ã€å¸æ©Ÿè¨»å†Šç”³è«‹ã€‘\næš±ç¨±ï¼š${name}\nè»Šè™Ÿï¼š${car}\né›»è©±ï¼š${phone}\nIDï¼š${currentUser.userId}`;
      try {
        if (!liff.isInClient()) { throw new Error('Not in LINE client'); }
        await liff.sendMessages([{ type: 'text', text: msg }]);
        alert("è³‡æ–™å·²å‚³é€ï¼è«‹ç­‰å€™ç®¡ç†å“¡å¯©æ ¸ã€‚");
        closeModal('reg-modal');
      } catch (err) {
        alert("å³å°‡è·³è½‰è‡³ LINE èŠå¤©å®¤ï¼\n\nè«‹å‹™å¿…ä¾åºåŸ·è¡Œï¼š\n1. é»æ“Šä¸Šæ–¹çš„ã€åŠ å…¥å¥½å‹ã€‘(å¦‚æœªåŠ å…¥)\n2. æŒ‰ä¸‹ã€å‚³é€ã€‘éµé€å‡ºè³‡æ–™");
        const target = "@103lybcd"; 
        const fallbackUrl = `https://line.me/R/oaMessage/${target}/?${encodeURIComponent(msg)}`;
        window.location.href = fallbackUrl;
      }
    }

    // ğŸ”¥ V2.3 æ ¸å¿ƒä¿®æ”¹ï¼š20kmé™åˆ¶ + æ’åº + æ•¸é‡åˆ‡å‰²
    function fetchDrivers() {
      // æ²’æŠ“åˆ°ä½¿ç”¨è€…ä½ç½®å‰ï¼Œå…ˆä¸è¨ˆç®—
      if (!myLat || !myLng) return;

      fetch(`${FIREBASE_URL}drivers.json`)
        .then(res => res.json())
        .then(data => {
          if (!data) { 
             updateHUD(0);
             renderCarousel([]);
             updateMap([]); 
             return; 
          }

          const now = Date.now();
          
          let allDrivers = Object.values(data).filter(d => {
            if (d.status !== 'online') return false;

            let timeoutLimit = 10 * 60 * 1000; 
            if (d.workStatus === 'queue') {
              timeoutLimit = 60 * 60 * 1000; 
            }
            return (now - d.lastUpdate < timeoutLimit);
          });

          // è¨ˆç®—è·é›¢ä¸¦éæ¿¾ 20km å…§
          let nearbyDrivers = allDrivers.map(d => {
              d.distance = calculateDistance(myLat, myLng, d.lat, d.lng);
              return d;
          }).filter(d => {
              return d.distance <= 20; 
          });

          // æ’åº (è¿‘ -> é )
          nearbyDrivers.sort((a, b) => a.distance - b.distance);

          // åˆ‡å‰²æ•¸é‡
          const mapDrivers = nearbyDrivers.slice(0, 10);
          const listDrivers = nearbyDrivers.slice(0, 5);

          updateMap(mapDrivers);
          
          if (!isDriver) {
             renderCarousel(listDrivers);
          }
          
          updateHUD(nearbyDrivers.length); 
        })
        .catch(err => console.error("Firebase è®€å–å¤±æ•—", err));
    }

    function calculateDistance(lat1, lon1, lat2, lon2) {
      if (!lat1 || !lon1 || !lat2 || !lon2) return 9999;
      const R = 6371;
      const dLat = (lat2 - lat1) * Math.PI / 180;
      const dLon = (lon2 - lon1) * Math.PI / 180;
      const a = Math.sin(dLat/2) * Math.sin(dLat/2) + Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * Math.sin(dLon/2) * Math.sin(dLon/2);
      return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
    }

    function updateMap(drivers) {
      for (let id in markers) { map.removeLayer(markers[id]); }
      markers = {};
      drivers.forEach(d => {
        let icon;
        let statusText;
        let colorStyle;

        if (d.workStatus === 'busy') {
          icon = iconBusy;
          statusText = 'è¼‰å®¢ä¸­';
          colorStyle = 'red';
        } else if (d.workStatus === 'queue') {
          icon = iconQueue; 
          statusText = 'æ’ç­ä¸­';
          colorStyle = '#3498db'; 
        } else {
          icon = iconEmpty;
          statusText = 'ç›®å‰ç©ºè»Š';
          colorStyle = 'green';
        }

        let marker = L.marker([d.lat, d.lng], {icon: icon}).addTo(map);
        let distText = (d.distance < 100) ? `(ç´„ ${d.distance.toFixed(1)} km)` : '';
        let phoneBtn = d.phone ? `<a href="tel:${d.phone}" style="display:block; margin-top:10px; padding:10px; background:#2ecc71; color:white; border-radius:10px; text-decoration:none; font-weight:bold;">ğŸ“ è¯çµ¡å¸æ©Ÿ</a>` : '';
        
        marker.bindPopup(`<div style="text-align:center;"><b>ğŸš• ${d.name}</b><br><span style="color:${colorStyle}; font-weight:bold;">â— ${statusText} ${distText}</span><br>${phoneBtn}</div>`);
        markers[d.id] = marker;
      });
    }

    function renderCarousel(drivers) {
      const container = document.getElementById('passenger-carousel');
      if (drivers.length === 0) {
        container.innerHTML = '<div style="flex:0 0 100%; text-align:center; padding:20px; background:white; border-radius:20px;">ğŸ”´ ç›®å‰é™„è¿‘ç„¡å¸æ©Ÿæœå‹™</div>';
        return;
      }
      container.innerHTML = drivers.map(d => {
        let statusText = d.workStatus === 'busy' ? 'è¼‰å®¢ä¸­' : (d.workStatus === 'queue' ? 'æ’ç­ä¸­' : 'ç›®å‰ç©ºè»Š');
        let statusColor = d.workStatus === 'busy' ? 'red' : (d.workStatus === 'queue' ? '#3498db' : 'green');
        
        return `
        <div class="driver-card" onclick="map.setView([${d.lat}, ${d.lng}], 15)">
          <div class="card-info">
            <div class="card-name">ğŸš• ${d.name}</div>
            <div style="font-size:14px; margin:5px 0; color:${statusColor}; font-weight:bold;">â— ${statusText}</div>
            <div style="font-size:14px; color:#666;">ğŸ“ è·é›¢ç´„ ${d.distance.toFixed(1)} km</div>
          </div>
          <a href="tel:${d.phone}" class="card-call-btn">ğŸ“</a>
        </div>
      `}).join('');
    }

    function updateHUD(count) {
      const hud = document.getElementById('hud');
      if (count > 0) hud.innerHTML = `<span class="status-dot" style="background:#2ecc71;"></span> é™„è¿‘é‹å°‡ï¼š${count} äºº`;
      else hud.innerHTML = `<span class="status-dot" style="background:#e74c3c;"></span> é™„è¿‘ç„¡å¸æ©Ÿ`;
    }
  </script>
</body>
</html>
