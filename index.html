<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <title>èŠ±è“®è»ŠéšŠ - å¸æ©Ÿç«¯ (v4.3)</title>
  
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
  <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAIxc6PEhHgUs_A9lyRUg8dNbmwOpSamY8"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

  <style>
    /* UI: ä¿æŒæ¥µç°¡å…¨è¢å¹• */
    body { margin: 0; padding: 0; font-family: -apple-system, Roboto, sans-serif; overflow: hidden; background: #222; }
    #map { width: 100vw; height: 100vh; }
    
    #hud { position: absolute; top: 15px; left: 15px; z-index: 10; background: rgba(0,0,0,0.85); color: white; padding: 10px 20px; border-radius: 30px; font-weight: bold; font-size: 16px; border: 1px solid #444; display: flex; align-items: center; pointer-events: none; transition: all 0.3s; }
    .status-dot { width: 12px; height: 12px; border-radius: 50%; display: inline-block; margin-right: 8px; }
    .hud-uploading { border-color: #00C853 !important; box-shadow: 0 0 15px rgba(0, 200, 83, 0.5); }

    #top-right-panel { position: absolute; top: 15px; right: 15px; z-index: 10; display: flex; flex-direction: column; gap: 15px; }
    .circle-btn { width: 70px; height: 70px; border-radius: 50%; border: 3px solid rgba(255,255,255,0.2); color: white; font-weight: bold; font-size: 16px; box-shadow: 0 6px 20px rgba(0,0,0,0.6); cursor: pointer; display: flex; flex-direction: column; justify-content: center; align-items: center; backdrop-filter: blur(4px); }
    .circle-btn:active { transform: scale(0.95); }
    .sub-text { font-size: 10px; opacity: 0.8; margin-top: 2px; font-weight: normal; }
    
    .bg-off { background: linear-gradient(145deg, #7f8c8d, #95a5a6); } .bg-on { background: linear-gradient(145deg, #c0392b, #e74c3c); } .bg-empty { background: linear-gradient(145deg, #27ae60, #2ecc71); } .bg-queue { background: linear-gradient(145deg, #2980b9, #3498db); } .bg-busy { background: linear-gradient(145deg, #d35400, #e67e22); } .bg-dark { background: linear-gradient(145deg, #2c3e50, #34495e); }
    #btn-power { display: none; }

    #saver-overlay { display: none; position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: black; z-index: 9999; flex-direction: column; justify-content: center; align-items: center; color: #444; }
    #saver-overlay.active { display: flex; }
    .breathing-icon { font-size: 60px; animation: breathe 3s infinite; margin-bottom: 20px; }
    @keyframes breathe { 0% { opacity: 0.3; text-shadow: 0 0 10px #2ecc71; } 50% { opacity: 1; text-shadow: 0 0 30px #2ecc71; } 100% { opacity: 0.3; text-shadow: 0 0 10px #2ecc71; } }

    .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 10000; justify-content: center; align-items: center; }
    .modal-content { background: #333; color: #fff; width: 85%; max-width: 300px; border-radius: 15px; padding: 25px; text-align: center; border: 1px solid #555; }
    .modal-btns button { width: 100%; padding: 12px; margin-top: 15px; border-radius: 10px; border: none; font-weight: bold; cursor: pointer; background: #00bcd4; color: #000; font-size: 16px; }
  </style>
</head>
<body>

  <div id="hud"><span class="status-dot" style="background:gray;"></span> ç³»çµ±å•Ÿå‹•ä¸­...</div>
  <div id="map"></div>
  
  <div id="saver-overlay" onclick="toggleSaver(false)">
      <div class="breathing-icon">ğŸ…¿ï¸</div>
      <p style="color:#2ecc71; font-size: 24px; font-weight:bold;">æ›æ©Ÿå¾…å‘½ä¸­</p>
      <p style="font-size:14px; margin-top:10px;">GPS æŒçºŒé€£ç·š â€¢ é»æ“Šå–šé†’</p>
  </div>
  
  <div id="top-right-panel">
    <button id="btn-power" class="circle-btn bg-off" onclick="togglePower()"><span>ä¸Šç·š</span><span class="sub-text">OFF</span></button>
    <button id="btn-status" class="circle-btn bg-empty" style="display:none;" onclick="toggleStatus()"><span>ç©ºè»Š</span></button>
    <button id="btn-saver" class="circle-btn bg-dark" style="display:none;" onclick="toggleSaver(true)"><span>æ›æ©Ÿ</span></button>
  </div>

  <div id="alert-modal" class="modal-overlay">
    <div class="modal-content"><h2 id="alert-title">æç¤º</h2><p id="alert-msg">å…§å®¹</p><div class="modal-btns"><button onclick="closeModal()">æ”¶åˆ°</button></div></div>
  </div>

  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <script>
    const LIFF_ID = "2008907691-7ntMtfbA"; 
    const firebaseConfig = { databaseURL: "https://hualientaxi-bb32f-default-rtdb.asia-southeast1.firebasedatabase.app/" };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    var map, myMarker, currentUser = null, isOnline = false;
    var currentWorkStatus = 'empty'; 
    var watchId = null, wakeLock = null, heartbeatInterval = null;
    var lastUploadTime = 0, lastUploadLat = 0, lastUploadLng = 0;
    
    // v4.3 æ–°å¢ï¼šæ’ç­ä¸­å¿ƒé»ç´€éŒ„ (ç”¨ä¾†æŠ“å¹½éˆè»Š)
    var queueCenter = null; 

    // çœé›»èˆ‡ç¯€æµè¨­å®š
    const UPDATE_INTERVAL = 15000; 
    const HEARTBEAT_TIME = 180000; 
    const MIN_DIST = 100;

    // v4.3 æ–°å¢ï¼šåœ“å½¢ç®­é ­åœ–ç¤º (å°èˆªé¢¨æ ¼)
    const getNavIcon = (color) => {
        return {
            path: google.maps.SymbolPath.CIRCLE,
            scale: 10,
            fillColor: color,
            fillOpacity: 1,
            strokeWeight: 2,
            strokeColor: 'white'
        };
    };
    // ç®­é ­å¦å¤–ç–ŠåŠ  (å› ç‚º Google Maps Icon æ—‹è½‰æ¯”è¼ƒéº»ç…©ï¼Œæˆ‘å€‘ç°¡åŒ–ç”¨åœ“é»ä»£è¡¨ä½ç½®)
    // æˆ–è€…æˆ‘å€‘ç›´æ¥ç”¨ä¸€å€‹ SVG è·¯å¾‘ç•«å‡ºã€Œåœ“åº•+ç®­é ­ã€
    const getArrowIcon = (color, heading) => {
        return {
            path: "M0,-12 L10,10 L0,5 L-10,10 Z", // é¡ä¼¼ç´™é£›æ©Ÿ/å°èˆªç®­é ­
            fillColor: color,
            fillOpacity: 1,
            scale: 1.5,
            strokeColor: "white",
            strokeWeight: 2,
            rotation: heading || 0 // æ—‹è½‰è§’åº¦
        };
    };

    window.onload = async function() { initGoogleMap(); await initLiff(); };

    function initGoogleMap() {
        map = new google.maps.Map(document.getElementById("map"), {
            center: { lat: 23.991, lng: 121.601 }, zoom: 15,
            disableDefaultUI: true, styles: [ { elementType: "geometry", stylers: [{ color: "#242f3e" }] }, { elementType: "labels.text.stroke", stylers: [{ color: "#242f3e" }] }, { elementType: "labels.text.fill", stylers: [{ color: "#746855" }] } ]
        });
    }

    async function initLiff() {
        try { await liff.init({ liffId: LIFF_ID }); if (!liff.isLoggedIn()) { liff.login(); return; } currentUser = await liff.getProfile(); localStorage.setItem('driverId', currentUser.userId); checkIdentity(currentUser.userId); } catch (err) { const savedId = localStorage.getItem('driverId'); if(savedId) checkIdentity(savedId); else showAlert("éŒ¯èª¤", "LIFF åˆå§‹åŒ–å¤±æ•—"); }
    }

    function checkIdentity(uid) {
        document.getElementById('hud').innerHTML = `<span class="status-dot" style="background:yellow;"></span> é©—è­‰ä¸­...`;
        db.ref('drivers/' + uid).once('value').then((snapshot) => {
            if (snapshot.exists()) {
                const d = snapshot.val();
                document.getElementById('hud').innerHTML = `<span class="status-dot" style="background:#2ecc71;"></span> å—¨ï¼Œ${d.name}`;
                document.getElementById('btn-power').style.display = 'flex';
                if (currentUser && currentUser.pictureUrl) db.ref('drivers/' + uid).update({ photo: currentUser.pictureUrl });
                if (localStorage.getItem('isOnline') === 'true') togglePower(true);
            } else {
                const msg = `æ‚¨çš„ ID æ˜¯ï¼š\n${uid}\n\nè«‹æˆªåœ–æˆ–è¤‡è£½å‚³çµ¦ç®¡ç†å“¡é–‹é€šæ¬Šé™ã€‚`;
                showAlert("ğŸš« æœªæˆæ¬Š", msg);
                document.getElementById('hud').innerHTML = `<span style="color:red">ID: ${uid.substring(0,6)}...</span>`;
                document.body.insertAdjacentHTML('beforeend', `<div style="position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:white;color:black;padding:25px;z-index:99999;text-align:center;border-radius:15px;box-shadow:0 10px 40px rgba(0,0,0,0.6);width:80%;max-width:300px;"><h3 style="margin-top:0;">å°šæœªé–‹é€šæ¬Šé™</h3><p style="color:#555;font-size:14px;">è«‹è¤‡è£½ä¸‹æ–¹ ID å‚³çµ¦ç®¡ç†å“¡ï¼š</p><input type="text" value="${uid}" style="width:100%;padding:12px;font-size:16px;text-align:center;margin:10px 0;background:#f0f0f0;border:1px solid #ccc;border-radius:5px;" onclick="this.select();document.execCommand('copy');alert('å·²è¤‡è£½ ID')"><p style="font-size:12px;color:#999;">(é»æ“Šæ¡†æ¡†å¯è¤‡è£½)</p></div>`);
            }
        });
    }

    function togglePower(forceOn=false) {
        const btns = ['btn-status', 'btn-saver']; const btnPower = document.getElementById('btn-power');
        if (forceOn || !isOnline) {
            isOnline = true; localStorage.setItem('isOnline', 'true');
            btnPower.className = "circle-btn bg-on"; btnPower.innerHTML = `<span>ä¸‹ç·š</span><span class="sub-text">ON</span>`;
            btns.forEach(id => document.getElementById(id).style.display = 'flex');
            requestWakeLock(); startGPS(); 
            if (heartbeatInterval) clearInterval(heartbeatInterval); heartbeatInterval = setInterval(() => forceUpload(), HEARTBEAT_TIME);
        } else {
            isOnline = false; localStorage.setItem('isOnline', 'false');
            btnPower.className = "circle-btn bg-off"; btnPower.innerHTML = `<span>ä¸Šç·š</span><span class="sub-text">OFF</span>`;
            btns.forEach(id => document.getElementById(id).style.display = 'none');
            stopGPS(); releaseWakeLock(); toggleSaver(false);
            if(myMarker) myMarker.setMap(null);
            db.ref('drivers').off(); 
            if (heartbeatInterval) clearInterval(heartbeatInterval);
            if (currentUser) db.ref('drivers/' + currentUser.userId).update({ status: 'offline' });
            document.getElementById('hud').innerHTML = `ğŸ’¤ å·²ä¸‹ç·š`;
            // ä¸‹ç·šæ™‚æ¸…é™¤æ’ç­é–å®š
            queueCenter = null;
        }
    }

    function toggleStatus(){ 
        if(currentWorkStatus==='empty') {
            currentWorkStatus='queue';
            // v4.3: é€²å…¥æ’ç­æ™‚ï¼Œç´€éŒ„ç•¶ä¸‹ä½ç½®ä½œç‚ºä¸­å¿ƒé»
            if(myMarker) {
                const pos = myMarker.getPosition();
                queueCenter = { lat: pos.lat(), lng: pos.lng() };
            }
        }
        else if(currentWorkStatus==='queue') {
            currentWorkStatus='busy';
            queueCenter = null; // é›¢é–‹æ’ç­ï¼Œæ¸…é™¤é–å®š
        }
        else {
            currentWorkStatus='empty';
            queueCenter = null;
        }
        updateStatusBtn(); forceUpload(); 
    }
    
    function toggleSaver(enable){ const overlay=document.getElementById('saver-overlay');const btn=document.getElementById('btn-saver'); if(enable){overlay.classList.add('active');btn.className="circle-btn bg-empty"}else{overlay.classList.remove('active');btn.className="circle-btn bg-dark"} }
    
    function updateStatusBtn(){ const btn=document.getElementById('btn-status');let colorCode='#2ecc71'; if(currentWorkStatus==='empty'){btn.className="circle-btn bg-empty";btn.innerHTML="ç©ºè»Š"}else if(currentWorkStatus==='queue'){btn.className="circle-btn bg-queue";btn.innerHTML="æ’ç­";colorCode='#3498db'}else{btn.className="circle-btn bg-busy";btn.innerHTML="è¼‰å®¢";colorCode='#e67e22'} if(myMarker)myMarker.setIcon(getArrowIcon(colorCode, 0)); }

    function startGPS() {
        if (!navigator.geolocation) return;
        watchId = navigator.geolocation.watchPosition((pos) => {
            const { latitude, longitude, heading } = pos.coords; 
            const latLng = new google.maps.LatLng(latitude, longitude);
            const color = currentWorkStatus==='busy'?'#e67e22':(currentWorkStatus==='queue'?'#3498db':'#2ecc71');
            
            // v4.3: æ›´æ–°åœ–ç¤º (åœ“åº•ç®­é ­) ä¸¦æ—‹è½‰
            if(!myMarker){ 
                myMarker = new google.maps.Marker({ position: latLng, map: map, icon: getArrowIcon(color, heading), title: "æˆ‘" }); 
                map.panTo(latLng); 
            } else { 
                myMarker.setPosition(latLng); 
                myMarker.setIcon(getArrowIcon(color, heading)); // æ›´æ–°æ—‹è½‰è§’åº¦
                if(!document.getElementById('saver-overlay').classList.contains('active')) map.panTo(latLng); 
            }
            
            smartUpload(latitude, longitude);
        }, (err) => console.error(err), { enableHighAccuracy: true, maximumAge: 0 });
    }
    
    function stopGPS() { if (watchId) navigator.geolocation.clearWatch(watchId); }

    function smartUpload(lat, lng) {
        if(!currentUser) return;
        const now = Date.now();
        const distKm = Math.sqrt(Math.pow(lat - lastUploadLat, 2) + Math.pow(lng - lastUploadLng, 2)) * 111;
        const distM = distKm * 1000;

        // v4.3: å¹½éˆè»Šåµæ¸¬ (æ’ç­å€è‡ªå‹•è¸¢å‡º)
        // å¦‚æœç¾åœ¨æ˜¯ã€Œæ’ç­ã€ç‹€æ…‹ï¼Œä¸”è·é›¢æ’ç­ä¸­å¿ƒé»è¶…é 500 å…¬å°º -> è‡ªå‹•åˆ‡å›ç©ºè»Š
        if (currentWorkStatus === 'queue' && queueCenter) {
            const distFromQueue = Math.sqrt(Math.pow(lat - queueCenter.lat, 2) + Math.pow(lng - queueCenter.lng, 2)) * 111000;
            if (distFromQueue > 500) {
                currentWorkStatus = 'empty';
                queueCenter = null;
                updateStatusBtn();
                showAlert("âš ï¸ é›¢é–‹æ’ç­å€", "ç³»çµ±åµæ¸¬æ‚¨å·²é›¢é–‹æ’ç­é»ï¼Œè‡ªå‹•åˆ‡æ›ç‚ºã€Œç©ºè»Šã€ã€‚");
            }
        }

        // ç¯€æµé‚è¼¯ (15ç§’ & 100å…¬å°º)
        if (distM < MIN_DIST) { updateHUD(false, "ğŸ“ å¾…å‘½ä¸­ (çœé›»)"); return; }
        if (now - lastUploadTime < UPDATE_INTERVAL) { return; }

        forceUpload(lat, lng);
    }

    function forceUpload(lat, lng) {
        if(!currentUser) return;
        if(!lat&&myMarker){const pos=myMarker.getPosition();lat=pos.lat();lng=pos.lng()} 
        if(!lat)return; 
        
        updateHUD(true, "âš¡ è³‡æ–™ä¸Šå‚³...");

        db.ref('drivers/'+currentUser.userId).update({
            lat:lat, lng:lng, status:'online', workStatus:currentWorkStatus, lastUpdate:firebase.database.ServerValue.TIMESTAMP
        }).then(() => {
            setTimeout(() => {
                 const statusText=currentWorkStatus==='busy'?'è¼‰å®¢':(currentWorkStatus==='queue'?'æ’ç­':'ç©ºè»Š');
                 updateHUD(false, `ğŸŸ¢ é€£ç·šä¸­ (${statusText})`);
            }, 1000);
        });

        lastUploadLat=lat; lastUploadLng=lng; lastUploadTime=Date.now(); 
    }

    function updateHUD(isUploading, text) {
        const hud = document.getElementById('hud');
        hud.innerHTML = `<span class="status-dot" style="background:${isUploading ? '#00C853' : '#2ecc71'};"></span> ${text}`;
        if(isUploading) hud.classList.add('hud-uploading');
        else hud.classList.remove('hud-uploading');
    }

    async function requestWakeLock() { try { if('wakeLock' in navigator) wakeLock = await navigator.wakeLock.request('screen'); } catch(e){} }
    function releaseWakeLock() { if(wakeLock) wakeLock.release(); }
    function showAlert(t,m){ document.getElementById('alert-title').innerText=t;document.getElementById('alert-msg').innerText=m;document.getElementById('alert-modal').style.display='flex'; }
    function closeModal(){ document.getElementById('alert-modal').style.display='none'; }
  </script>
</body>
</html>
