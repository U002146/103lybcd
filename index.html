<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <title>èŠ±è“®æ•¬è€æ„›å¿ƒ ä¹˜è»Šæ”¯æ´ç¶² (V10.2 ä¿®å¾©ç‰ˆ)</title>
  
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="theme-color" content="#1d4ed8">
  
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  
  <style>
    body { margin: 0; padding: 0; font-family: -apple-system, system-ui, "Microsoft JhengHei", sans-serif; overflow: hidden; background: #f0f0f0; -webkit-tap-highlight-color: transparent; }
    
    /* åœ°åœ–å±¤ */
    #map { width: 100vw; height: 100vh; z-index: 1; transition: opacity 0.5s; }
    #hud {
      position: absolute; top: 15px; left: 15px; z-index: 999;
      background: rgba(30, 30, 30, 0.9); color: white; padding: 12px 20px;
      border-radius: 30px; font-size: 16px; font-weight: bold;
      backdrop-filter: blur(5px); box-shadow: 0 4px 15px rgba(0,0,0,0.3);
      display: flex; align-items: center; gap: 10px; pointer-events: none;
    }
    .status-dot { width: 12px; height: 12px; border-radius: 50%; display: inline-block; }
    
    #top-right-panel {
      position: absolute; top: 15px; right: 15px; z-index: 1000;
      display: flex; flex-direction: column; align-items: center; gap: 12px;
    }
    .circle-btn {
      width: 70px; height: 70px; border: none; border-radius: 50%; color: white;
      font-weight: bold; cursor: pointer;
      box-shadow: 0 6px 20px rgba(0,0,0,0.4);
      display: flex; flex-direction: column; justify-content: center; align-items: center;
      transition: all 0.2s; text-shadow: 0 1px 2px rgba(0,0,0,0.3); font-size: 15px;
    }
    .circle-btn:active { transform: scale(0.85); box-shadow: 0 2px 10px rgba(0,0,0,0.2); }
    #btn-power { width: 85px; height: 85px; font-size: 20px; }
    
    .bg-green { background: linear-gradient(135deg, #2ecc71, #27ae60); }
    .bg-red   { background: linear-gradient(135deg, #e74c3c, #c0392b); }
    .bg-blue  { background: linear-gradient(135deg, #3498db, #2980b9); } 
    .bg-gray  { background: linear-gradient(135deg, #bdc3c7, #95a5a6); }
    .bg-purple { background: linear-gradient(135deg, #9b59b6, #8e44ad); }
    .bg-orange { background: linear-gradient(135deg, #f39c12, #e67e22); }

    .sub-text { font-size: 12px; opacity: 0.9; margin-top: 4px; }
    .leaflet-bottom { bottom: 140px !important; }

    /* è¨˜éŒ„è¡¨è¦†è“‹å±¤ */
    #record-app-view {
        display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background-color: #f3f4f6; z-index: 5000; overflow-y: auto; padding-bottom: 100px;
    }
    .chip:active { transform: scale(0.95); background-color: #e5e7eb; }
    .no-scrollbar::-webkit-scrollbar { display: none; }
    .glass-card { background: linear-gradient(135deg, #ea580c 0%, #c2410c 100%); box-shadow: 0 8px 32px 0 rgba(194, 65, 12, 0.37); color: white; border-radius: 1rem 1rem 0 0; padding: 1.25rem; }

    /* å½ˆçª—èˆ‡é®ç½© */
    .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: rgba(0,0,0,0.85); z-index: 6000; justify-content: center; align-items: center; backdrop-filter: blur(8px); }
    .modal-content { background: white; width: 85%; max-width: 350px; border-radius: 24px; padding: 25px; box-sizing: border-box; text-align: center; }
    
    /* è§£æ±º SweetAlert2 å±¤ç´šå•é¡Œ */
    div:where(.swal2-container) { z-index: 20000 !important; }

    #power-save-overlay { display: none; position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: black; z-index: 2000; color: #444; flex-direction: column; justify-content: center; align-items: center; }
    #power-save-overlay.active { display: flex; }
    
    #gps-instruction { text-align: left; background: #fff8e1; padding: 15px; border-radius: 10px; margin: 15px 0; border: 2px solid #ffecb3; }
    #gps-instruction ol { padding-left: 20px; margin: 5px 0; color: #555; font-size: 15px; line-height: 1.6; }
    
    #passenger-carousel { position: absolute; bottom: 20px; left: 0; width: 100%; z-index: 1000; display: none; overflow-x: auto; gap: 12px; padding: 0 15px 15px 15px; box-sizing: border-box; scroll-snap-type: x mandatory; }
    .driver-card { flex: 0 0 88%; max-width: 340px; background: white; border-radius: 20px; padding: 18px; box-shadow: 0 8px 25px rgba(0,0,0,0.2); scroll-snap-align: center; display: flex; align-items: center; justify-content: space-between; }
    .driver-card .card-call-btn { text-decoration: none; font-size: 24px; width: 50px; height: 50px; background: #2ecc71; color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 10px rgba(46, 204, 113, 0.4); }
    
    .form-group { margin-bottom: 15px; text-align: left; }
    .form-group label { display: block; font-size: 13px; color: #666; margin-bottom: 5px; }
    .form-group input { width: 100%; padding: 12px; border: 2px solid #eee; border-radius: 10px; box-sizing: border-box; font-size: 16px; }
    .modal-btns button { width: 100%; padding: 15px; border-radius: 12px; border: none; font-size: 16px; font-weight: bold; cursor: pointer; margin-top: 10px; }
  </style>
</head>
<body>

  <div id="hud"><span class="status-dot" style="background:gray;"></span> å®šä½ä¸­...</div>
  <div id="map"></div>

  <div id="top-right-panel">
    <button id="btn-power" class="circle-btn bg-gray" style="display:none;" onclick="togglePower()"><span>ä¸Šç·š</span><span class="sub-text">OFF</span></button>
    <button id="btn-status" class="circle-btn bg-green" style="display:none;" onclick="toggleStatus()"><span>ç©ºè»Š</span></button>
    <button id="btn-record" class="circle-btn bg-purple" style="display:none;" onclick="showRecordApp()"><span>å¡«å¯«<br>è¨˜éŒ„</span></button>
    <button id="btn-save-power" class="circle-btn" style="display:none; background:#34495e;" onclick="togglePowerSaving()"><span>çœé›»</span></button>
    <button id="btn-register" class="circle-btn bg-orange" style="display:none;" onclick="openModal('reg-modal')"><span>å¸æ©Ÿ<br>è¨»å†Š</span></button>
    <button id="btn-share" class="circle-btn bg-blue" onclick="openShareModal()"><span>åˆ†äº«</span></button>
  </div>

  <div id="power-save-overlay" onclick="togglePowerSaving()"><div style="font-size: 60px;">ğŸ…¿ï¸</div><p>æ’ç­/çœé›»æ¨¡å¼ä¸­</p><div style="font-size: 14px; color: #333; margin-top: 50px;">é»æ“Šè¢å¹•å›æ­¸åœ°åœ–</div></div>

  <div id="share-modal" class="modal-overlay">
    <div class="modal-content">
      <h3 style="margin-top:0;">æƒç¢¼åŠ å…¥å¥½å‹</h3>
      <div style="background:#f9f9f9; padding:15px; border-radius:15px; margin:15px 0;"><img id="qrcode-img" src="" style="width:200px;height:200px;"></div>
      <div class="modal-btns"><button style="background:#eee; color:#333;" onclick="closeModal('share-modal')">é—œé–‰</button></div>
    </div>
  </div>

  <div id="reg-modal" class="modal-overlay">
    <div class="modal-content">
      <h3 style="margin-top:0;">å¸æ©Ÿè¨»å†Šç”³è«‹</h3>
      <div class="form-group"><label>LINE ID</label><input type="text" id="reg-uid" readonly style="background:#f0f0f0;"></div>
      <div class="form-group"><label>å¸æ©Ÿæš±ç¨±</label><input type="text" id="reg-name" placeholder="è«‹å¡«å¯«å§“å"></div>
      <div class="form-group"><label>è»Šç‰Œè™Ÿç¢¼</label><input type="text" id="reg-car" placeholder="ä¾‹å¦‚: ABC-1234"></div>
      <div class="form-group"><label>é€£çµ¡é›»è©±</label><input type="tel" id="reg-phone" placeholder="09xx-xxx-xxx"></div>
      <div class="modal-btns"><button style="background:#2ecc71; color:white;" onclick="submitRegistration()">é€å‡ºè³‡æ–™</button><button style="background:#eee; color:#666;" onclick="closeModal('reg-modal')">å–æ¶ˆ</button></div>
    </div>
  </div>

  <div id="gps-alert-modal" class="modal-overlay" style="z-index: 4000;">
    <div class="modal-content">
      <div style="font-size: 50px;">ğŸ“</div><h2 style="margin: 10px 0; color: #e74c3c;">ç„¡æ³•è®€å–ä½ç½®</h2>
      <div id="gps-instruction"><ol><li>é€²å…¥æ‰‹æ©Ÿ<b>ã€è¨­å®šã€‘</b></li><li>æ‰¾åˆ°æ‡‰ç”¨ç¨‹å¼<b>ã€LINEã€‘</b></li><li>é–‹å•Ÿ<b>ã€ä½ç½®/å®šä½ã€‘</b>æ¬Šé™</li></ol></div>
      <div class="modal-btns"><button style="background:#3498db; color:white;" onclick="retryGPS()">æˆ‘é–‹å¥½äº†ï¼é‡è©¦</button><button style="background:#eee; color:#666; margin-top:8px;" onclick="closeModal('gps-alert-modal')">å–æ¶ˆ</button></div>
    </div>
  </div>

  <div id="passenger-carousel"></div>

  <div id="record-app-view">
    <div class="bg-blue-700 text-white p-4 sticky top-0 z-50 shadow-md flex justify-between items-center no-print">
      <div class="flex items-center">
        <button onclick="hideRecordApp()" class="mr-3 text-white bg-blue-600 hover:bg-blue-500 rounded-full w-10 h-10 flex items-center justify-center shadow-lg active:scale-95 transition"><i class="fas fa-arrow-left text-lg"></i></button>
        <h1 class="text-xl font-bold tracking-wider" id="record-nav-title">è¼‰é€è¨˜éŒ„</h1>
      </div>
      <div class="flex items-center"><div id="cloud-sync-status" class="mr-2 text-xs opacity-80"></div><button onclick="editDriverInfo()" class="text-sm bg-blue-800 px-3 py-1 rounded"><i class="fas fa-cog"></i></button></div>
    </div>

    <div class="p-4 space-y-6">
      <div class="bg-white rounded-xl shadow-lg p-5 border border-blue-100 ring-4 ring-blue-50/50">
        <h2 class="text-lg font-bold text-gray-700 mb-4 border-b pb-2"><i class="fas fa-edit text-blue-500 mr-2"></i>æ–°å¢è¡Œç¨‹</h2>
        <div class="mb-4"><label class="block text-sm font-bold text-gray-500 mb-1">æ—¥æœŸæ™‚é–“</label><input type="datetime-local" id="input-time" class="w-full p-3 border border-gray-300 rounded-lg bg-gray-50 text-lg font-mono"></div>
        <div class="mb-4 grid grid-cols-2 gap-3">
          <button onclick="setCardType('æ•¬è€å¡')" id="btn-elder" class="p-3 rounded-lg border-2 bg-gray-100 text-gray-600 font-bold transition">æ•¬è€å¡</button>
          <button onclick="setCardType('æ„›å¿ƒå¡')" id="btn-care" class="p-3 rounded-lg border-2 bg-gray-100 text-gray-600 font-bold transition">æ„›å¿ƒå¡</button>
          <input type="hidden" id="input-type">
        </div>
        <div class="mb-4 space-y-3">
          <div><label class="text-sm font-bold text-gray-500">ä¸Šè»Š</label>
            <div class="flex gap-2 overflow-x-auto pb-2 mb-1 no-scrollbar">
                <span onclick="setInput('input-pickup', 'å‰ç«™')" class="chip px-3 py-2 bg-blue-50 text-blue-700 rounded-lg text-sm font-bold border border-blue-100 whitespace-nowrap shadow-sm">å‰ç«™</span>
                <span onclick="setInput('input-pickup', 'å¾Œç«™')" class="chip px-3 py-2 bg-blue-50 text-blue-700 rounded-lg text-sm font-bold border border-blue-100 whitespace-nowrap shadow-sm">å¾Œç«™</span>
                <span onclick="setInput('input-pickup', 'æ…ˆæ¿Ÿ')" class="chip px-3 py-2 bg-blue-50 text-blue-700 rounded-lg text-sm font-bold border border-blue-100 whitespace-nowrap shadow-sm">æ…ˆæ¿Ÿ</span>
                <span onclick="setInput('input-pickup', 'é–€è«¾')" class="chip px-3 py-2 bg-blue-50 text-blue-700 rounded-lg text-sm font-bold border border-blue-100 whitespace-nowrap shadow-sm">é–€è«¾</span>
                <span onclick="setInput('input-pickup', 'èŠ±è“®é†«é™¢')" class="chip px-3 py-2 bg-blue-50 text-blue-700 rounded-lg text-sm font-bold border border-blue-100 whitespace-nowrap shadow-sm">éƒ¨ç«‹èŠ±é†«</span>
                <span onclick="setInput('input-pickup', 'åœ‹è»é†«é™¢')" class="chip px-3 py-2 bg-blue-50 text-blue-700 rounded-lg text-sm font-bold border border-blue-100 whitespace-nowrap shadow-sm">åœ‹è»805</span>
                <span onclick="setInput('input-pickup', 'è¡›ç”Ÿå±€')" class="chip px-3 py-2 bg-blue-50 text-blue-700 rounded-lg text-sm font-bold border border-blue-100 whitespace-nowrap shadow-sm">è¡›ç”Ÿå±€</span>
            </div>
            <input type="text" id="input-pickup" placeholder="ä¸Šè»Šåœ°é»" class="w-full p-3 border border-gray-300 rounded-lg text-lg">
          </div>
          <div><label class="text-sm font-bold text-gray-500">ä¸‹è»Š</label>
            <div class="flex gap-2 overflow-x-auto pb-2 mb-1 no-scrollbar">
                <span onclick="setInput('input-dropoff', 'å‰ç«™')" class="chip px-3 py-2 bg-green-50 text-green-700 rounded-lg text-sm font-bold border border-green-100 whitespace-nowrap shadow-sm">å‰ç«™</span>
                <span onclick="setInput('input-dropoff', 'å¾Œç«™')" class="chip px-3 py-2 bg-green-50 text-green-700 rounded-lg text-sm font-bold border border-green-100 whitespace-nowrap shadow-sm">å¾Œç«™</span>
                <span onclick="setInput('input-dropoff', 'æ…ˆæ¿Ÿ')" class="chip px-3 py-2 bg-green-50 text-green-700 rounded-lg text-sm font-bold border border-green-100 whitespace-nowrap shadow-sm">æ…ˆæ¿Ÿ</span>
                <span onclick="setInput('input-dropoff', 'é–€è«¾')" class="chip px-3 py-2 bg-green-50 text-green-700 rounded-lg text-sm font-bold border border-green-100 whitespace-nowrap shadow-sm">é–€è«¾</span>
            </div>
            <input type="text" id="input-dropoff" placeholder="ä¸‹è»Šåœ°é»" class="w-full p-3 border border-gray-300 rounded-lg text-lg">
          </div>
        </div>
        <input type="text" id="input-remarks" placeholder="å‚™è¨» (é¸å¡«)" class="w-full p-3 border border-gray-300 rounded-lg text-lg bg-yellow-50 mb-4">
        <button onclick="addRecord()" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-4 rounded-xl text-xl shadow-lg active:scale-95 transition flex justify-center items-center"><i class="fas fa-paper-plane mr-2"></i> å¯«å…¥è³‡æ–™</button>
      </div>

      <div>
          <div class="glass-card flex justify-between items-center relative overflow-hidden">
              <div class="absolute -right-5 -top-5 opacity-20"><i class="fas fa-coins text-9xl"></i></div>
              <div class="relative z-10">
                  <div class="text-orange-100 text-xs font-bold mb-1">æœ¬æœˆé ä¼°çé‡‘</div>
                  <div class="text-3xl font-black">$<span id="total-income">0</span></div>
                  <div id="bonus-status" class="text-xs bg-black/20 px-2 py-1 rounded inline-block mt-2">è¨ˆç®—ä¸­...</div>
              </div>
              <div class="text-right relative z-10">
                  <div class="text-orange-100 text-xs mb-1">ç´¯ç©è¶Ÿæ¬¡</div>
                  <div class="text-2xl font-bold"><span id="total-trips">0</span> <span class="text-sm font-normal">è¶Ÿ</span></div>
                  <button onclick="clearAll()" class="text-xs text-orange-200 underline mt-2">æ¸…ç©ºå¿«å–</button>
              </div>
          </div>
          <div class="bg-white rounded-b-xl shadow p-4 min-h-[200px] flex flex-col">
              <div id="record-list" class="space-y-3 pb-4 flex-1"></div>
              <div id="pagination-controls" class="flex justify-between items-center pt-4 border-t border-gray-100 mt-2 text-sm text-gray-500"></div>
          </div>
      </div>
    </div>
  </div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
    const GAS_URL = "https://script.google.com/macros/s/AKfycbyfNTgci2gZE2Etxvv6SHaP3puw7Mxt8ineL4gZve7Zyh2UGrcna4Zxap6EOyRICQ/exec"; 
    const LIFF_ID = "2008907691-7ntMtfbA"; 
    const FIREBASE_URL = "https://hualientaxi-bb32f-default-rtdb.asia-southeast1.firebasedatabase.app/"; 

    var map, markers = {};
    var currentUser = null;
    var isDriver = false;
    var myLat = null, myLng = null;
    var myPhone = ""; 
    var currentWorkStatus = 'empty'; 
    var isOnline = false, isPowerSaving = false;
    var updateTimer = null, wakeLock = null;
    var lastUploadLat = 0, lastUploadLng = 0, lastUploadTime = 0;
    var hasCenteredMap = false, isGpsAlertShown = false;

    // è¨˜éŒ„è¡¨è®Šæ•¸
    let records = JSON.parse(localStorage.getItem('taxi_records_v6')) || [];
    // ğŸ”¥ é—œéµä¿®æ­£ï¼šç¢ºä¿ driverInfo æ°¸é æœ‰å€¼ï¼Œé è¨­å¯†ç¢¼ 0000
    let driverInfo = JSON.parse(localStorage.getItem('driver_info')) || { name: '', plate: '', id: '', delPassword: '0000' };
    let currentPage = 1;
    const itemsPerPage = 25;

    const iconEmpty = L.divIcon({ html: '<div style="font-size:36px;">ğŸš•</div>', className: '', iconSize: [36, 36], iconAnchor: [18, 18] });
    const iconBusy = L.divIcon({ html: '<div style="font-size:36px; filter: grayscale(100%) opacity(0.6);">ğŸš•</div>', className: '', iconSize: [36, 36], iconAnchor: [18, 18] });
    const iconQueue = L.divIcon({ html: '<div style="font-size:36px; filter: hue-rotate(200deg);">ğŸš•</div>', className: '', iconSize: [36, 36], iconAnchor: [18, 18] });

    window.onload = async function() {
      initMap();
      await initLiff();
      initTime(); setCardType('æ•¬è€å¡'); updateDashboard(); renderList();
      
      document.addEventListener('visibilitychange', async () => {
        if (wakeLock !== null && document.visibilityState === 'visible' && isOnline) {
          await requestWakeLock();
        }
      });
    };

    // ğŸ”¥ é—œéµä¿®æ­£ï¼šè¿”å›æ™‚ï¼Œå¼·åˆ¶é—œé–‰ SweetAlert (è§£æ±ºå¹½éˆè¦–çª—)
    function showRecordApp() { document.getElementById('record-app-view').style.display = 'block'; initTime(); }
    function hideRecordApp() { 
        document.getElementById('record-app-view').style.display = 'none'; 
        Swal.close(); // å¼·åˆ¶é—œé–‰ä»»ä½•æ®˜ç•™çš„å½ˆçª—
    }

    async function requestWakeLock() { if ('wakeLock' in navigator) try { wakeLock = await navigator.wakeLock.request('screen'); } catch (err) {} }
    function releaseWakeLock() { if (wakeLock !== null) { wakeLock.release().then(() => wakeLock = null); } }
    function openShareModal() { document.getElementById('qrcode-img').src = `https://api.qrserver.com/v1/create-qr-code/?size=250x250&data=${encodeURIComponent("https://line.me/R/ti/p/@631ugnif")}`; openModal('share-modal'); }

    function initMap() {
      map = L.map('map', { zoomControl: false }).setView([23.99000, 121.60684], 13);
      L.control.zoom({ position: 'bottomright' }).addTo(map);
      L.tileLayer('https://{s}.google.com/vt/lyrs=m&x={x}&y={y}&z={z}', { maxZoom: 20, subdomains: ['mt0', 'mt1', 'mt2', 'mt3'] }).addTo(map);
    }

    async function initLiff() {
      try {
        await liff.init({ liffId: LIFF_ID });
        if (!liff.isLoggedIn()) { liff.login(); return; }
        currentUser = await liff.getProfile();
        
        startTrackingLocation();
        checkRole(currentUser.userId);
        fetchDrivers(); 
        setInterval(fetchDrivers, 5000); 
        fetchCloudRecords();
      } catch (err) { console.log("LIFF Error:", err); }
    }

    function startTrackingLocation() {
      if (navigator.geolocation) {
        navigator.geolocation.watchPosition(
          (pos) => {
            myLat = pos.coords.latitude; myLng = pos.coords.longitude;
            if (isGpsAlertShown) { closeModal('gps-alert-modal'); isGpsAlertShown = false; }
            if (!hasCenteredMap) { map.setView([myLat, myLng], 15); hasCenteredMap = true; console.log("å·²è‡ªå‹•å®šä½"); }
          }, 
          (err) => {
            console.error("GPS Error:", err);
            if ((err.code === 1 || err.code === 2) && !isGpsAlertShown) { openModal('gps-alert-modal'); isGpsAlertShown = true; }
          }, { enableHighAccuracy: true, maximumAge: 0 }
        );
      } else { alert("ç€è¦½å™¨ä¸æ”¯æ´å®šä½"); }
    }
    
    function retryGPS() { closeModal('gps-alert-modal'); isGpsAlertShown = false; startTrackingLocation(); window.location.reload(); }

    // ğŸ”¥ é—œéµä¿®æ­£ï¼šå–å¾—èº«ä»½å¾Œï¼Œç«‹åˆ»åŒæ­¥åˆ° driverInfoï¼Œè§£æ±ºã€Œæˆ‘æ˜¯èª°ã€çš„å•é¡Œ
    function checkRole(uid) {
      fetch(`${GAS_URL}?op=check_role&uid=${uid}`)
        .then(res => res.json())
        .then(data => {
          isDriver = (data.role === 'driver');
          if (isDriver) {
            if(data.phone) myPhone = data.phone;
            
            // â˜… åŒæ­¥è³‡æ–™åˆ°æœ¬åœ°è¨˜éŒ„è¡¨ â˜…
            if (data.name) driverInfo.name = data.name;
            if (data.driverId) driverInfo.id = data.driverId;
            if (data.car) driverInfo.plate = data.car;
            localStorage.setItem('driver_info', JSON.stringify(driverInfo));
            
            document.getElementById('btn-power').style.display = 'flex';
            document.getElementById('btn-record').style.display = 'flex'; 
            document.getElementById('btn-register').style.display = 'none';
            document.getElementById('passenger-carousel').style.display = 'none';
          } else {
            document.getElementById('btn-power').style.display = 'none';
            document.getElementById('btn-register').style.display = 'flex';
            document.getElementById('passenger-carousel').style.display = 'flex';
          }
        });
    }

    function togglePower() {
      try {
        const nextState = !isOnline;
        const btnPower = document.getElementById('btn-power');
        const btnStatus = document.getElementById('btn-status');
        const btnSave = document.getElementById('btn-save-power');
        if (nextState) {
          isOnline = true; currentWorkStatus = 'empty';
          btnPower.className = "circle-btn bg-red"; btnPower.innerHTML = `<span>ä¸‹ç·š</span><span class="sub-text">ON</span>`;
          btnStatus.style.display = 'flex'; updateStatusButton(); btnSave.style.display = 'flex';
          requestWakeLock(); resetUpdateTimer();
        } else {
          isOnline = false;
          btnPower.className = "circle-btn bg-green"; btnPower.innerHTML = `<span>ä¸Šç·š</span><span class="sub-text">OFF</span>`;
          btnStatus.style.display = 'none'; btnSave.style.display = 'none';
          clearInterval(updateTimer); releaseWakeLock();
          postData('offline', 'empty', 0, 0); 
          if (isPowerSaving) togglePowerSaving();
        }
      } catch (e) { alert("æŒ‰éˆ•éŒ¯èª¤ï¼š" + e.message); }
    }

    function toggleStatus() {
      if (currentWorkStatus === 'empty') currentWorkStatus = 'queue';
      else if (currentWorkStatus === 'queue') currentWorkStatus = 'busy';
      else currentWorkStatus = 'empty';
      updateStatusButton(); uploadLocation(true); 
    }

    function updateStatusButton() {
      const btnStatus = document.getElementById('btn-status');
      if (currentWorkStatus === 'empty') { btnStatus.className = "circle-btn bg-green"; btnStatus.innerHTML = `<span>ç©ºè»Š</span>`; } 
      else if (currentWorkStatus === 'queue') { btnStatus.className = "circle-btn bg-blue"; btnStatus.innerHTML = `<span>æ’ç­</span>`; } 
      else { btnStatus.className = "circle-btn bg-red"; btnStatus.innerHTML = `<span>è¼‰å®¢</span>`; }
    }

    function togglePowerSaving() {
      if (!isOnline) return;
      isPowerSaving = !isPowerSaving;
      const overlay = document.getElementById('power-save-overlay');
      const btnSave = document.getElementById('btn-save-power');
      if (isPowerSaving) { overlay.classList.add('active'); btnSave.style.background = "#2ecc71"; btnSave.innerHTML = `<span>æ­£å¸¸</span>`; } 
      else { overlay.classList.remove('active'); btnSave.style.background = "#34495e"; btnSave.innerHTML = `<span>çœé›»</span>`; }
      resetUpdateTimer();
    }

    function resetUpdateTimer() {
      clearInterval(updateTimer); uploadLocation(); 
      const baseInterval = isPowerSaving ? 120000 : 30000;
      const jitter = Math.floor(Math.random() * 5000); 
      updateTimer = setInterval(uploadLocation, baseInterval + jitter);
    }

    function uploadLocation(forceUpdate = false) {
      if (!isOnline) return;
      if (!navigator.geolocation) return;
      navigator.geolocation.getCurrentPosition(
        (pos) => {
          const curLat = pos.coords.latitude; const curLng = pos.coords.longitude;
          const now = Date.now();
          const dist = calculateDistance(lastUploadLat, lastUploadLng, curLat, curLng) * 1000; 
          const timeDiff = now - lastUploadTime;
          const distLimit = 30; const timeLimit = 10 * 60 * 1000; 
          if (dist > distLimit || timeDiff > timeLimit || forceUpdate) {
            postData('online', currentWorkStatus, curLat, curLng);
            lastUploadLat = curLat; lastUploadLng = curLng; lastUploadTime = now;
          }
        },
        (err) => { if(isOnline && err.code === 1) { openModal('gps-alert-modal'); togglePower(); } },
        { enableHighAccuracy: true, timeout: 15000, maximumAge: 0 }
      );
    }

    function postData(status, work, lat, lng) {
      if (!currentUser) return;
      const payload = { id: currentUser.userId, name: currentUser.displayName, phone: myPhone || "ç„¡é›»è©±", status: status, workStatus: work, lat: lat, lng: lng, lastUpdate: Date.now() };
      fetch(`${FIREBASE_URL}drivers/${currentUser.userId}.json`, { method: 'PUT', body: JSON.stringify(payload) }).catch(e => console.warn(e));
    }

    function openModal(id) { if (id === 'reg-modal') document.getElementById('reg-uid').value = currentUser.userId; document.getElementById(id).style.display = 'flex'; }
    function closeModal(id) { document.getElementById(id).style.display = 'none'; }

    async function submitRegistration() {
      const name = document.getElementById('reg-name').value;
      const car = document.getElementById('reg-car').value;
      const phone = document.getElementById('reg-phone').value;
      if (!name || !car || !phone) { alert("è³‡æ–™è¦å¡«å®Œæ•´å–”ï¼"); return; }
      const msg = `ğŸš– ã€å¸æ©Ÿè¨»å†Šç”³è«‹ã€‘\næš±ç¨±ï¼š${name}\nè»Šè™Ÿï¼š${car}\né›»è©±ï¼š${phone}\nIDï¼š${currentUser.userId}`;
      try {
        if (!liff.isInClient()) throw new Error('Not in LINE client');
        await liff.sendMessages([{ type: 'text', text: msg }]);
        alert("è³‡æ–™å·²å‚³é€ï¼"); closeModal('reg-modal');
      } catch (err) {
        alert("å°‡è·³è½‰è‡³ LINE èŠå¤©å®¤å‚³é€");
        window.location.href = `https://line.me/R/oaMessage/@103lybcd/?${encodeURIComponent(msg)}`;
      }
    }

    function fetchDrivers() {
      if (!myLat || !myLng) return;
      fetch(`${FIREBASE_URL}drivers.json`).then(res => res.json()).then(data => {
          if (!data) { updateHUD(0); renderCarousel([]); updateMap([]); return; }
          const now = Date.now();
          let allDrivers = Object.values(data).filter(d => {
            if (d.status !== 'online') return false;
            let timeoutLimit = d.workStatus === 'queue' ? 60*60*1000 : 10*60*1000;
            return (now - d.lastUpdate < timeoutLimit);
          });
          let nearby = allDrivers.map(d => { d.distance = calculateDistance(myLat, myLng, d.lat, d.lng); return d; }).filter(d => d.distance <= 20);
          nearby.sort((a, b) => a.distance - b.distance);
          updateMap(nearby.slice(0, 10));
          if (!isDriver) renderCarousel(nearby.slice(0, 5));
          updateHUD(nearby.length); 
      }).catch(err => console.error(err));
    }

    function calculateDistance(lat1, lon1, lat2, lon2) {
      if (!lat1 || !lon1 || !lat2 || !lon2) return 9999;
      const R = 6371; const dLat = (lat2 - lat1) * Math.PI / 180; const dLon = (lon2 - lon1) * Math.PI / 180;
      const a = Math.sin(dLat/2) * Math.sin(dLat/2) + Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * Math.sin(dLon/2) * Math.sin(dLon/2);
      return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
    }

    function updateMap(drivers) {
      for (let id in markers) { map.removeLayer(markers[id]); } markers = {};
      drivers.forEach(d => {
        let icon = d.workStatus === 'busy' ? iconBusy : (d.workStatus === 'queue' ? iconQueue : iconEmpty);
        let statusText = d.workStatus === 'busy' ? 'è¼‰å®¢ä¸­' : (d.workStatus === 'queue' ? 'æ’ç­ä¸­' : 'ç›®å‰ç©ºè»Š');
        let colorStyle = d.workStatus === 'busy' ? 'red' : (d.workStatus === 'queue' ? '#3498db' : 'green');
        let marker = L.marker([d.lat, d.lng], {icon: icon}).addTo(map);
        let phoneBtn = d.phone ? `<a href="tel:${d.phone}" style="display:block; margin-top:10px; padding:10px; background:#2ecc71; color:white; border-radius:10px; text-decoration:none; font-weight:bold;">ğŸ“ è¯çµ¡å¸æ©Ÿ</a>` : '';
        marker.bindPopup(`<div style="text-align:center;"><b>ğŸš• ${d.name}</b><br><span style="color:${colorStyle}; font-weight:bold;">â— ${statusText}</span><br>${phoneBtn}</div>`);
        markers[d.id] = marker;
      });
    }

    function renderCarousel(drivers) {
      const container = document.getElementById('passenger-carousel');
      if (drivers.length === 0) { container.innerHTML = '<div style="flex:0 0 100%; text-align:center; padding:20px; background:white; border-radius:20px;">ğŸ”´ ç›®å‰é™„è¿‘ç„¡å¸æ©Ÿæœå‹™</div>'; return; }
      container.innerHTML = drivers.map(d => {
        let statusText = d.workStatus === 'busy' ? 'è¼‰å®¢ä¸­' : (d.workStatus === 'queue' ? 'æ’ç­ä¸­' : 'ç›®å‰ç©ºè»Š');
        let statusColor = d.workStatus === 'busy' ? 'red' : (d.workStatus === 'queue' ? '#3498db' : 'green');
        return `<div class="driver-card" onclick="map.setView([${d.lat}, ${d.lng}], 15)"><div class="card-info"><div class="card-name">ğŸš• ${d.name}</div><div style="font-size:14px; margin:5px 0; color:${statusColor}; font-weight:bold;">â— ${statusText}</div><div style="font-size:14px; color:#666;">ğŸ“ è·é›¢ç´„ ${d.distance.toFixed(1)} km</div></div><a href="tel:${d.phone}" class="card-call-btn">ğŸ“</a></div>`;
      }).join('');
    }

    function updateHUD(count) {
      const hud = document.getElementById('hud');
      if (count > 0) hud.innerHTML = `<span class="status-dot" style="background:#2ecc71;"></span> é™„è¿‘é‹å°‡ï¼š${count} äºº`;
      else hud.innerHTML = `<span class="status-dot" style="background:#e74c3c;"></span> é™„è¿‘ç„¡å¸æ©Ÿ`;
    }

    // RECORD APP é‚è¼¯
    function initTime() { const now = new Date(); now.setMinutes(now.getMinutes() - now.getTimezoneOffset()); document.getElementById('input-time').value = now.toISOString().slice(0,16); }
    function updateDashboard() {
        const now = new Date(); const currentMonth = now.getMonth() + 1;
        document.getElementById('record-nav-title').innerText = `${currentMonth}æœˆè¨˜éŒ„è¡¨`;
        const thisMonthRecords = records.filter(r => { const d = new Date(r.timeObj); return d.getMonth() + 1 === currentMonth && d.getFullYear() === now.getFullYear(); });
        const tripCount = thisMonthRecords.length;
        let totalIncome = 0; let statusMsg = "";
        if (tripCount <= 50) { totalIncome = 0; statusMsg = `å·® ${51 - tripCount} è¶Ÿ`; }
        else if (tripCount > 100) { totalIncome = 5000; statusMsg = "æœ€é«˜çé‡‘"; }
        else { totalIncome = tripCount * 50; statusMsg = "ç´¯ç©ä¸­"; }
        document.getElementById("total-income").innerText = totalIncome.toLocaleString();
        document.getElementById("total-trips").innerText = tripCount;
        document.getElementById("bonus-status").innerText = statusMsg;
    }
    function addRecord() {
      const timeStr = document.getElementById('input-time').value; const type = document.getElementById('input-type').value;
      const pickup = document.getElementById('input-pickup').value.trim(); const dropoff = document.getElementById('input-dropoff').value.trim();
      const remarks = document.getElementById('input-remarks').value.trim();
      if (!timeStr || !pickup || !dropoff) return Swal.fire({icon: 'warning', title: 'æœªå¡«å¯«å®Œæ•´', timer: 1000, showConfirmButton: false});
      const dateObj = new Date(timeStr);
      const fmtTime = `${String(dateObj.getMonth()+1).padStart(2,'0')}/${String(dateObj.getDate()).padStart(2,'0')} ${String(dateObj.getHours()).padStart(2,'0')}:${String(dateObj.getMinutes()).padStart(2,'0')}`;
      const newRecord = { id: Date.now(), timeObj: timeStr, formattedTime: fmtTime, type, pickup, dropoff, remarks, syncStatus: 'pending' };
      records.push(newRecord); records.sort((a, b) => new Date(a.timeObj) - new Date(b.timeObj));
      localStorage.setItem('taxi_records_v6', JSON.stringify(records));
      currentPage = 1; renderList(); updateDashboard();
      document.getElementById('input-pickup').value = ''; document.getElementById('input-dropoff').value = ''; document.getElementById('input-remarks').value = ''; initTime();
      syncToCloud(newRecord);
      Swal.fire({ toast: true, position: 'top', icon: 'success', title: 'å¯«å…¥æˆåŠŸ', showConfirmButton: false, timer: 1500 });
    }
    function deleteRecord(id) {
        Swal.fire({ title: 'åˆªé™¤å¯†ç¢¼', input: 'password', showCancelButton: true, confirmButtonColor: '#ef4444', inputValue: '' }).then((res) => {
            // ğŸ”¥ é—œéµä¿®æ­£ï¼šç¢ºä¿é€™è£¡ä½¿ç”¨æœ€æ–°çš„ driverInfo
            if (res.isConfirmed && res.value === (driverInfo.delPassword || '0000')) {
                const target = records.find(r => r.id === id); records = records.filter(r => r.id !== id);
                localStorage.setItem('taxi_records_v6', JSON.stringify(records)); renderList(); updateDashboard();
                if(target && currentUser) fetch(GAS_URL, { method: 'POST', mode: 'no-cors', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({action:'delete', id:target.id, userId: currentUser.userId}) });
            } else if (res.isConfirmed) Swal.fire('å¯†ç¢¼éŒ¯èª¤ (é è¨­0000)');
        });
    }
    function syncToCloud(record) {
        if (!currentUser) return;
        const payload = { ...record, userId: currentUser.userId, driverName: driverInfo.name, driverPlate: driverInfo.plate, driverId: driverInfo.id };
        document.getElementById('cloud-sync-status').innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
        fetch(GAS_URL, { method: 'POST', mode: 'no-cors', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) })
        .then(() => { record.syncStatus = 'synced'; updateRecordStatus(record.id, 'synced'); document.getElementById('cloud-sync-status').innerHTML = '<i class="fas fa-check text-green-300"></i>'; })
        .catch(() => { document.getElementById('cloud-sync-status').innerHTML = '<i class="fas fa-exclamation-triangle text-red-300"></i>'; });
    }
    function fetchCloudRecords() {
        if(!currentUser) return;
        fetch(`${GAS_URL}?userId=${currentUser.userId}`)
        .then(res => res.json())
        .then(data => {
            if(data && Array.isArray(data)) {
                const exist = new Set(records.map(r=>r.id));
                const newRecs = data.filter(r => !exist.has(r.id)).map(r => ({...r, syncStatus:'synced'}));
                if(newRecs.length > 0) {
                    records = [...records, ...newRecs]; records.sort((a,b) => new Date(a.timeObj)-new Date(b.timeObj));
                    localStorage.setItem('taxi_records_v6', JSON.stringify(records)); renderList(); updateDashboard();
                }
            }
        });
    }
    function renderList() {
      const el = document.getElementById('record-list'); const ctrls = document.getElementById('pagination-controls');
      const list = [...records].sort((a, b) => new Date(b.timeObj) - new Date(a.timeObj));
      if(list.length === 0) { el.innerHTML = '<div class="text-center text-gray-400 py-10">å°šç„¡è¨˜éŒ„</div>'; ctrls.innerHTML=''; return; }
      const totalPages = Math.ceil(list.length / itemsPerPage); if(currentPage > totalPages) currentPage = totalPages;
      const display = list.slice((currentPage-1)*itemsPerPage, currentPage*itemsPerPage);
      el.innerHTML = display.map((r, i) => `
        <div class="flex justify-between items-center p-3 border-b border-gray-100">
           <div><div class="text-xs text-gray-500 mb-1"><span class="bg-gray-100 px-1 rounded mr-1">#${list.length - ((currentPage-1)*itemsPerPage + i)}</span>${formatDisplayTime(r.timeObj || r.formattedTime)}<span class="${r.type==='æ•¬è€å¡'?'text-yellow-600 bg-yellow-100':'text-rose-600 bg-rose-100'} px-2 rounded text-xs ml-1">${r.type}</span></div><div class="font-bold text-gray-800">${r.pickup} <i class="fas fa-arrow-right text-xs text-gray-400"></i> ${r.dropoff}</div></div>
           <button onclick="deleteRecord(${r.id})" class="text-gray-300 p-2"><i class="fas fa-trash-alt"></i></button>
        </div>`).join('');
      if(totalPages > 1) { ctrls.innerHTML = `<button onclick="changePage(-1)" ${currentPage===1?'disabled class="opacity-30"':''}>ä¸Šä¸€é </button><span>${currentPage}/${totalPages}</span><button onclick="changePage(1)" ${currentPage===totalPages?'disabled class="opacity-30"':''}>ä¸‹ä¸€é </button>`; } else ctrls.innerHTML = '';
    }
    function changePage(d) { currentPage+=d; renderList(); }
    function setInput(id, val) { document.getElementById(id).value = val; }
    function setCardType(t) { document.getElementById('input-type').value=t; document.getElementById('btn-elder').className = t==='æ•¬è€å¡'?'p-3 rounded-lg border-2 border-yellow-500 bg-yellow-50 text-yellow-700 font-bold':'p-3 rounded-lg border-2 bg-gray-100 text-gray-400'; document.getElementById('btn-care').className = t==='æ„›å¿ƒå¡'?'p-3 rounded-lg border-2 border-rose-500 bg-rose-50 text-rose-700 font-bold':'p-3 rounded-lg border-2 bg-gray-100 text-gray-400'; }
    function formatDisplayTime(t) { if(!t) return ''; const d=new Date(t); return `${d.getMonth()+1}/${d.getDate()} ${String(d.getHours()).padStart(2,'0')}:${String(d.getMinutes()).padStart(2,'0')}`; }
    function updateRecordStatus(id, s) { const idx=records.findIndex(r=>r.id===id); if(idx!==-1) { records[idx].syncStatus=s; localStorage.setItem('taxi_records_v6', JSON.stringify(records)); renderList(); } }
    function editDriverInfo() { Swal.fire({title:'è¨­å®š', html:`<input id="d-name" class="swal2-input" value="${driverInfo.name}" placeholder="å§“å"><input id="d-plate" class="swal2-input" value="${driverInfo.plate}" placeholder="è»Šç‰Œ"><input id="d-pass" class="swal2-input" value="${driverInfo.delPassword||'0000'}" placeholder="åˆªé™¤å¯†ç¢¼ (é è¨­0000)">`, confirmButtonText:'å„²å­˜'}).then(r=>{if(r.isConfirmed){driverInfo.name=document.getElementById('d-name').value; driverInfo.plate=document.getElementById('d-plate').value; driverInfo.delPassword=document.getElementById('d-pass').value; localStorage.setItem('driver_info',JSON.stringify(driverInfo));}}); }
    function clearAll() { Swal.fire({title:'æ¸…ç©º?', showCancelButton:true, confirmButtonText:'æ¸…'}).then(r=>{if(r.isConfirmed){records=[]; localStorage.setItem('taxi_records_v6','[]'); renderList(); updateDashboard();}}); }
  </script>
</body>
</html>
