<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>花蓮車隊 - 戰情中心 (v4.17)</title>
  
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
  <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAIxc6PEhHgUs_A9lyRUg8dNbmwOpSamY8&libraries=geometry"></script>
  
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    /* 整體背景維持深色，比較有質感，但上方地圖會變回亮的 */
    body { margin: 0; padding: 0; background: #121212; color: white; font-family: 'Segoe UI', sans-serif; height: 100vh; display: flex; flex-direction: column; overflow: hidden; }
    
    #map-container { height: 50%; width: 100%; position: relative; border-bottom: 3px solid #00C853; background: #fff; }
    #map { width: 100%; height: 100%; }

    #board-container { height: 50%; width: 100%; display: flex; flex-direction: column; background: #1e1e1e; }
    
    .zone-header { padding: 12px 20px; background: #2c3e50; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #444; cursor: pointer; transition: background 0.2s; }
    .zone-header:hover { background: #34495e; }
    
    .zone-title { font-size: 18px; font-weight: bold; color: #fff; display: flex; align-items: center; }
    .zone-count { background: #f1c40f; color: #000; padding: 2px 12px; border-radius: 20px; font-weight: bold; font-size: 16px; min-width: 30px; text-align: center; }
    
    .driver-list { display: none; padding: 10px; background: #222; border-bottom: 1px solid #444; }
    .driver-list.active { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 10px; }
    
    .driver-card { background: #333; border-radius: 8px; padding: 10px; display: flex; align-items: center; border-left: 4px solid #00C853; }
    .driver-card.queue { border-left-color: #3498db; }
    
    .d-avatar { width: 40px; height: 40px; border-radius: 50%; background: #555; overflow: hidden; margin-right: 10px; }
    .d-avatar img { width: 100%; height: 100%; object-fit: cover; }
    .d-info h3 { margin: 0; font-size: 16px; color: #fff; }
    .d-info p { margin: 2px 0 0; font-size: 12px; color: #aaa; }

    .marquee { background: #000; color: #00C853; padding: 8px; font-size: 14px; white-space: nowrap; overflow: hidden; text-align: center; border-bottom: 1px solid #333; }
  </style>
</head>
<body>

  <div id="map-container"><div id="map"></div></div>
  <div class="marquee">花蓮車隊戰情中心 • 全境監控中 • <span id="clock"></span></div>

  <div id="board-container" style="overflow-y: auto;">
    <div id="zones-wrapper"></div>
  </div>

  <script>
    const firebaseConfig = { databaseURL: "https://hualientaxi-bb32f-default-rtdb.asia-southeast1.firebasedatabase.app/" };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    
    var map, markers = {}, zonePolygons = {}; 

    // v4.17: 顏色、區域、排序皆正確，僅更換地圖風格
    const STRATEGIC_ZONES = [
      { id: 'zone_front', name: '花蓮前站', color: '#2980b9', paths: [ // 藍色
        {lat: 23.984718, lng: 121.596928}, {lat: 23.982712, lng: 121.607351}, {lat: 23.984543, lng: 121.610068}, {lat: 23.989699, lng: 121.607606}, {lat: 23.997632, lng: 121.611692}, {lat: 24.002304, lng: 121.610680}, {lat: 24.005288, lng: 121.611261}, {lat: 24.008085, lng: 121.608395}, {lat: 23.984718, lng: 121.596928}
      ]},
      { id: 'zone_city', name: '花蓮市區', color: '#c0392b', paths: [ // 紅色
        {lat: 24.002572, lng: 121.615389}, {lat: 24.002427, lng: 121.613679}, {lat: 24.002609, lng: 121.613247}, {lat: 24.002705, lng: 121.611896}, {lat: 24.002320, lng: 121.610751}, {lat: 23.997598, lng: 121.611793}, {lat: 23.989744, lng: 121.607680}, {lat: 23.983744, lng: 121.610493}, {lat: 23.981124, lng: 121.610414}, {lat: 23.979328, lng: 121.613916}, {lat: 23.981384, lng: 121.614217}, {lat: 23.981659, lng: 121.615976}, {lat: 23.981051, lng: 121.617465}, {lat: 23.966344, lng: 121.627550}, {lat: 24.013049, lng: 121.654582}, {lat: 24.023939, lng: 121.628669}, {lat: 24.008515, lng: 121.615893}, {lat: 24.006653, lng: 121.616222}, {lat: 24.002572, lng: 121.615389}
      ]},
      { id: 'zone_back', name: '花蓮後站', color: '#95a5a6', paths: [ // 灰色
        {lat: 24.008869, lng: 121.585530}, {lat: 23.996212, lng: 121.594636}, {lat: 23.992778, lng: 121.591602}, {lat: 23.991951, lng: 121.590901}, {lat: 23.990310, lng: 121.589905}, {lat: 23.987049, lng: 121.587939}, {lat: 23.986948, lng: 121.588268}, {lat: 23.976733, lng: 121.582090}, {lat: 23.975331, lng: 121.586392}, {lat: 23.972703, lng: 121.589876}, {lat: 23.974182, lng: 121.591771}, {lat: 23.980759, lng: 121.594907}, {lat: 23.990020, lng: 121.599475}, {lat: 24.008252, lng: 121.608388}, {lat: 24.013099, lng: 121.608283}, {lat: 24.012866, lng: 121.592706}, {lat: 24.008869, lng: 121.585530}
      ]},
      { id: 'zone_tzuchi', name: '慈濟區', color: '#e67e22', paths: [ // 橙色
        {lat: 23.986263, lng: 121.545355}, {lat: 23.984684, lng: 121.552458}, {lat: 23.986663, lng: 121.554937}, {lat: 23.987150, lng: 121.559286}, {lat: 23.987266, lng: 121.562184}, {lat: 23.983092, lng: 121.569926}, {lat: 23.976571, lng: 121.581953}, {lat: 23.986943, lng: 121.588248}, {lat: 23.987048, lng: 121.587924}, {lat: 23.991959, lng: 121.590895}, {lat: 23.992810, lng: 121.591620}, {lat: 23.994374, lng: 121.593011}, {lat: 23.995054, lng: 121.593621}, {lat: 23.996213, lng: 121.594606}, {lat: 24.008887, lng: 121.585425}, {lat: 24.012921, lng: 121.592648}, {lat: 24.014327, lng: 121.591103}, {lat: 24.014095, lng: 121.585069}, {lat: 24.016468, lng: 121.582849}, {lat: 24.018821, lng: 121.579990}, {lat: 24.020122, lng: 121.575885}, {lat: 24.015266, lng: 121.533302}, {lat: 23.986263, lng: 121.545355}
      ]},
      { id: 'zone_jian', name: '吉安區', color: '#2ecc71', paths: [ // 綠色
        {lat: 23.961930, lng: 121.611305}, {lat: 23.962721, lng: 121.608321}, {lat: 23.963904, lng: 121.602475}, {lat: 23.965367, lng: 121.598618}, {lat: 23.972622, lng: 121.589878}, {lat: 23.974142, lng: 121.588108}, {lat: 23.975301, lng: 121.586346}, {lat: 23.976663, lng: 121.582243}, {lat: 23.976513, lng: 121.581985}, {lat: 23.980526, lng: 121.574595}, {lat: 23.987237, lng: 121.562159}, {lat: 23.986643, lng: 121.554976}, {lat: 23.984642, lng: 121.552480}, {lat: 23.986184, lng: 121.545386}, {lat: 23.962442, lng: 121.544927}, {lat: 23.954371, lng: 121.525800}, {lat: 23.968379, lng: 121.495451}, {lat: 23.961343, lng: 121.499089}, {lat: 23.947542, lng: 121.517872}, {lat: 23.932314, lng: 121.533626}, {lat: 23.919727, lng: 121.566912}, {lat: 23.916164, lng: 121.594746}, {lat: 23.941105, lng: 121.607807}, {lat: 23.961930, lng: 121.611305}
      ]},
      { id: 'zone_meilun', name: '美崙區', color: '#2980b9', paths: [ // 藍色
        {lat: 23.984526, lng: 121.610081}, {lat: 23.982696, lng: 121.607336}, {lat: 23.984684, lng: 121.596907}, {lat: 23.980681, lng: 121.594905}, {lat: 23.974145, lng: 121.591774}, {lat: 23.972668, lng: 121.589878}, {lat: 23.968695, lng: 121.594566}, {lat: 23.965400, lng: 121.598629}, {lat: 23.963940, lng: 121.602483}, {lat: 23.962177, lng: 121.611334}, {lat: 23.976222, lng: 121.620666}, {lat: 23.981024, lng: 121.617466}, {lat: 23.981645, lng: 121.615971}, {lat: 23.981366, lng: 121.614234}, {lat: 23.979300, lng: 121.613933}, {lat: 23.981110, lng: 121.610397}, {lat: 23.983729, lng: 121.610474}, {lat: 23.984526, lng: 121.610081}
      ]},
      { id: 'zone_beipu', name: '北埔區', color: '#1abc9c', paths: [ // 青色
        {lat: 24.092128, lng: 121.621902}, {lat: 24.115561, lng: 121.651916}, {lat: 24.141880, lng: 121.667370}, {lat: 24.178480, lng: 121.657309}, {lat: 24.159688, lng: 121.620720}, {lat: 24.154884, lng: 121.619862}, {lat: 24.137640, lng: 121.631556}, {lat: 24.103750, lng: 121.606357}, {lat: 24.100887, lng: 121.608756}, {lat: 24.100360, lng: 121.615998}, {lat: 24.092128, lng: 121.621902}
      ]},
      { id: 'zone_xincheng', name: '新城區', color: '#f1c40f', paths: [ // 黃色
        {lat: 24.091929, lng: 121.621899}, {lat: 24.100232, lng: 121.615914}, {lat: 24.100773, lng: 121.608685}, {lat: 24.103802, lng: 121.606197}, {lat: 24.104586, lng: 121.597101}, {lat: 24.097130, lng: 121.609620}, {lat: 24.048328, lng: 121.582412}, {lat: 24.019984, lng: 121.576428}, {lat: 24.018857, lng: 121.580009}, {lat: 24.016493, lng: 121.582898}, {lat: 24.014129, lng: 121.585095}, {lat: 24.014348, lng: 121.591114}, {lat: 24.012947, lng: 121.592709}, {lat: 24.013167, lng: 121.608355}, {lat: 24.008135, lng: 121.608461}, {lat: 24.005273, lng: 121.611371}, {lat: 24.002395, lng: 121.610810}, {lat: 24.002802, lng: 121.611961}, {lat: 24.002644, lng: 121.613400}, {lat: 24.002631, lng: 121.615342}, {lat: 24.006627, lng: 121.616148}, {lat: 24.008519, lng: 121.615817}, {lat: 24.024010, lng: 121.628654}, {lat: 24.017442, lng: 121.644355}, {lat: 24.091929, lng: 121.621899}
      ]}
    ];

    const getPinIcon = (type) => {
        const isQueue = type === 'queue';
        const color = isQueue ? '#00B0FF' : '#00C853';
        return {
            path: google.maps.SymbolPath.CIRCLE,
            scale: 6, fillColor: color, fillOpacity: 1, strokeColor: "white", strokeWeight: 2
        };
    };

    window.onload = function() {
        initMap();
        listenToDrivers();
        setInterval(() => document.getElementById('clock').innerText = new Date().toLocaleString(), 1000);
    };

    function initMap() {
        map = new google.maps.Map(document.getElementById("map"), {
            center: { lat: 23.991, lng: 121.601 }, zoom: 12, 
            disableDefaultUI: true
            // 移除 styles: [...] 設定，恢復 Google 標準淺色地圖
        });
        
        const wrapper = document.getElementById('zones-wrapper');
        
        STRATEGIC_ZONES.forEach(z => {
            // 繪製戰區多邊形
            const polygon = new google.maps.Polygon({
                paths: z.paths,
                strokeColor: z.color, strokeOpacity: 0.8, strokeWeight: 2,
                fillColor: z.color, fillOpacity: 0.1,
                map: map
            });
            zonePolygons[z.id] = polygon;

            // 建立下方儀表板
            wrapper.innerHTML += `
                <div class="zone-block" id="zone-${z.id}">
                    <div class="zone-header" onclick="toggleList('${z.id}')">
                        <div class="zone-title">
                            <i class="fa-solid fa-map-location-dot" style="margin-right:10px; color:${z.color};"></i> ${z.name}
                        </div>
                        <div class="zone-count" id="count-${z.id}">0</div>
                    </div>
                    <div class="driver-list" id="list-${z.id}"></div>
                </div>
            `;
        });
    }
    
    // 折疊功能
    window.toggleList = function(id) {
        const list = document.getElementById(`list-${id}`);
        list.classList.toggle('active');
    };

    function listenToDrivers() {
        db.ref('drivers').on('value', snapshot => {
            const data = snapshot.val();
            if (!data) return;
            const now = Date.now();
            const zoneDrivers = {}; 
            STRATEGIC_ZONES.forEach(z => zoneDrivers[z.id] = []);
            const activeIds = new Set();

            Object.keys(data).forEach(key => {
                const d = data[key];
                const timeout = d.workStatus === 'queue' ? 3600000 : 600000;
                
                if (d.status !== 'online') return;
                if (now - d.lastUpdate > timeout) return;

                activeIds.add(key);
                const pos = new google.maps.LatLng(d.lat, d.lng);
                
                if (!markers[key]) {
                    markers[key] = new google.maps.Marker({ position: pos, map: map, icon: getPinIcon(d.workStatus), title: d.name });
                } else {
                    markers[key].setPosition(pos);
                    markers[key].setIcon(getPinIcon(d.workStatus));
                }

                // 精準判定在哪個戰區
                STRATEGIC_ZONES.forEach(z => {
                    const poly = zonePolygons[z.id];
                    if (google.maps.geometry.poly.containsLocation(pos, poly)) {
                        zoneDrivers[z.id].push(d);
                    }
                });
            });

            for(let k in markers) { if(!activeIds.has(k)) { markers[k].setMap(null); delete markers[k]; } }

            // 更新儀表板
            STRATEGIC_ZONES.forEach(z => {
                const list = document.getElementById(`list-${z.id}`);
                const count = document.getElementById(`count-${z.id}`);
                list.innerHTML = "";
                
                count.innerText = zoneDrivers[z.id].length;
                
                if(zoneDrivers[z.id].length > 0) {
                    zoneDrivers[z.id].forEach(d => {
                        const statusClass = d.workStatus === 'queue' ? 'queue' : '';
                        const avatar = d.photo || 'https://cdn-icons-png.flaticon.com/512/3237/3237472.png';
                        list.innerHTML += `
                            <div class="driver-card ${statusClass}">
                                <div class="d-avatar"><img src="${avatar}"></div>
                                <div class="d-info"><h3>${d.name}</h3><p>${d.car || '計程車'}</p></div>
                            </div>
                        `;
                    });
                } else {
                    list.innerHTML = `<div style="color:#666;text-align:center;padding:10px;">戰區淨空</div>`;
                }
            });
        });
    }
  </script>
</body>
</html>
