<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Ëä±ËìÆËªäÈöä - ÊéíÁè≠ÂçÄ</title> // v5.0 Áò¶ÂÆ¢Êà∂Á´ØÈ°ØÁ§∫Âô®Áâà (Á¥îÊï∏ÊìöÊ∏≤Êüì)
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
  <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAIxc6PEhHgUs_A9lyRUg8dNbmwOpSamY8&libraries=geometry"></script>
  
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    body { margin: 0; padding: 0; background: #121212; color: white; font-family: 'Segoe UI', sans-serif; height: 100vh; display: flex; flex-direction: column; overflow: hidden; }
    
    #map-container { height: 50%; width: 100%; position: relative; border-bottom: 3px solid #00C853; background: #fff; }
    #map { width: 100%; height: 100%; }

    #board-container { height: 50%; width: 100%; display: flex; flex-direction: column; background: #1e1e1e; }
    
    .zone-header { padding: 10px 15px; background: #2c3e50; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #444; cursor: pointer; transition: background 0.2s; }
    .zone-header:hover { background: #34495e; }
    
    .zone-title { font-size: 16px; font-weight: bold; color: #fff; display: flex; align-items: center; }
    .zone-count { background: #f1c40f; color: #000; padding: 2px 10px; border-radius: 20px; font-weight: bold; font-size: 14px; min-width: 25px; text-align: center; }
    .zone-count.empty { background: #00C853; color: white; animation: pulse 2s infinite; }
    @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(0,200,83,0.7); } 70% { box-shadow: 0 0 0 10px rgba(0,200,83,0); } 100% { box-shadow: 0 0 0 0 rgba(0,200,83,0); } }
    
    .driver-list { display: none; padding: 10px; background: #222; border-bottom: 1px solid #444; }
    .driver-list.active { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 10px; }
    
    .driver-card { background: #333; border-radius: 8px; padding: 10px; display: flex; align-items: center; border-left: 4px solid #00C853; justify-content: space-between; }
    .driver-card.queue { border-left-color: #3498db; }
    .driver-card.busy { border-left-color: #e67e22; opacity: 0.5; }
    
    .d-left { display: flex; align-items: center; }
    .d-avatar { width: 40px; height: 40px; border-radius: 50%; background: #555; overflow: hidden; margin-right: 10px; }
    .d-avatar img { width: 100%; height: 100%; object-fit: cover; }
    .d-info h3 { margin: 0; font-size: 16px; color: #fff; }
    .d-info p { margin: 2px 0 0; font-size: 12px; color: #aaa; }

    .btn-dial { background: #00C853; color: white; width: 40px; height: 40px; border-radius: 50%; display: flex; justify-content: center; align-items: center; text-decoration: none; box-shadow: 0 2px 5px rgba(0,0,0,0.3); transition: transform 0.1s; }
    .btn-dial:active { transform: scale(0.9); }
    .btn-dial.disabled { background: #555; pointer-events: none; }
    .btn-dial i { font-size: 18px; }

    .marquee { background: #000; color: #00C853; padding: 8px; font-size: 14px; white-space: nowrap; overflow: hidden; text-align: center; border-bottom: 1px solid #333; display: flex; justify-content: center; align-items: center; gap: 10px;}
    .radar-indicator { background: #111; color: #00C853; padding: 2px 8px; border-radius: 10px; border: 1px solid #00C853; font-size: 12px; font-weight: bold; font-variant-numeric: tabular-nums;}
  </style>
</head>
<body>

  <div id="map-container"><div id="map"></div></div>
  <div class="marquee">
    <span>ÂÖ®Â¢ÉÁõ£Êéß‰∏≠ (14ÂçÄ)</span>
    <span class="radar-indicator"><i class="fa-solid fa-satellite-dish"></i> <span id="radar-timer">60s</span></span>
    <span id="clock"></span>
  </div>

  <div id="board-container" style="overflow-y: auto;">
    <div id="zones-wrapper"></div>
  </div>

  <script>
    const firebaseConfig = { databaseURL: "https://hualientaxi-bb32f-default-rtdb.asia-southeast1.firebasedatabase.app/" };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    
    var map, markers = {}, zonePolygons = {}; 
    var ZONES_DATA = []; 

    const ZONE_CONFIG = {
        "Ëä±ËìÆÂâçÁ´ô":   { color: "#2980b9", priority: 1 },
        "Ëä±ËìÆÂ∏ÇÂçÄ":   { color: "#c0392b", priority: 2 },
        "Ëä±ËìÆÂæåÁ´ô":   { color: "#95a5a6", priority: 3 },
        "ÊÖàÊøüÈÜ´Èô¢":   { color: "#9b59b6", priority: 4, alias: "ÊÖàÊøüÂçÄ" },
        "Ë≤®Ê´ÉÊòüÂ∑¥ÂÖã": { color: "#e67e22", priority: 5 },
        "ÂêâÂÆâÁ´ô":     { color: "#2ecc71", priority: 6, alias: "ÂêâÂÆâÂçÄ" },
        "ÈñÄË´æÈÜ´Èô¢":   { color: "#34495e", priority: 7, alias: "ÁæéÂ¥ôÂçÄ" },
        "ÂåóÂüîÂçÄ":     { color: "#f1c40f", priority: 8 },
        "Êñ∞ÂüéÂçÄ":     { color: "#1abc9c", priority: 9 },
        "‰∏ÉÊòüÊΩ≠":     { color: "#00bcd4", priority: 10 },
        "Êµ∑Ê¥ãÂÖ¨Âúí":   { color: "#e91e63", priority: 11 },
        "ÈØâÈ≠öÊΩ≠":     { color: "#009688", priority: 12 },
        "Êù±ËèØÂ§ßÂ≠∏":   { color: "#8e44ad", priority: 13 },
        "ÂçóËèØÂçÄ":     { color: "#795548", priority: 14 }
    };

    const GEO_RAW = {
      "type": "FeatureCollection",
      "features": [
        { "type": "Feature", "properties": { "Ëä±ËìÆÂâçÁ´ô": "" }, "geometry": { "coordinates": [ 121.60168998252806, 23.992626784625898 ], "type": "Point" }, "id": 0 },
        { "type": "Feature", "properties": { "ÈñÄË´æÈÜ´Èô¢": "" }, "geometry": { "coordinates": [ 121.62634974720402, 23.988350693835287 ], "type": "Point" }, "id": 1 },
        { "type": "Feature", "properties": { "‰∏ÉÊòüÊΩ≠": "" }, "geometry": { "coordinates": [ 121.62985443925902, 24.0240452839449 ], "type": "Point" }, "id": 2 },
        { "type": "Feature", "properties": { "Ëä±ËìÆÂ∏ÇÂçÄ": "" }, "geometry": { "coordinates": [ 121.60503445968459, 23.975719035539854 ], "type": "Point" }, "id": 3 },
        { "type": "Feature", "properties": { "ÊÖàÊøüÈÜ´Èô¢": "" }, "geometry": { "coordinates": [ 121.59259277050967, 23.99472348051779 ], "type": "Point" }, "id": 4 },
        { "type": "Feature", "properties": { "Ë≤®Ê´ÉÊòüÂ∑¥ÂÖã": "" }, "geometry": { "coordinates": [ 121.59485216992056, 23.93864335170278 ], "type": "Point" }, "id": 5 },
        { "type": "Feature", "properties": { "Êµ∑Ê¥ãÂÖ¨Âúí": "" }, "geometry": { "coordinates": [ 121.60339089561705, 23.90115152457301 ], "type": "Point" }, "id": 6 },
        { "type": "Feature", "properties": { "ÂçóËèØÂçÄ": "" }, "geometry": { "coordinates": [ 121.55015997975681, 23.953530367218633 ], "type": "Point" }, "id": 7 },
        { "type": "Feature", "properties": { "ÈØâÈ≠öÊΩ≠": "" }, "geometry": { "coordinates": [ 121.5059120436257, 23.928738031821098 ], "type": "Point" }, "id": 8 },
        { "type": "Feature", "properties": { "ÂêâÂÆâÁ´ô": "" }, "geometry": { "coordinates": [ 121.58260829450097, 23.968271265573676 ], "type": "Point" }, "id": 9 },
        { "type": "Feature", "properties": { "ÂåóÂüîÂçÄ": "" }, "geometry": { "coordinates": [ 121.6049584313999, 24.036053518573794 ], "type": "Point" }, "id": 10 },
        { "type": "Feature", "properties": { "Êù±ËèØÂ§ßÂ≠∏": "" }, "geometry": { "coordinates": [ 121.53630247302488, 23.903708037772105 ], "type": "Point" }, "id": 11 },
        { "type": "Feature", "properties": { "Êñ∞ÂüéÂçÄ": "" }, "geometry": { "coordinates": [ 121.65311981456426, 24.128359901120476 ], "type": "Point" }, "id": 12 },
        { "type": "Feature", "properties": { "Ëä±ËìÆÂæåÁ´ô": "" }, "geometry": { "coordinates": [ 121.59913250603176, 23.994160342822838 ], "type": "Point" }, "id": 24 },
        
        { "type": "Feature", "geometry": { "coordinates": [[[121.621501,24.092506],[121.653926,24.116610],[121.666316,24.142070],[121.668852,24.178144],[121.657187,24.181655],[121.644718,24.155221],[121.606200,24.166211],[121.600318,24.161506],[121.619900,24.153495],[121.632674,24.137602],[121.613742,24.105961],[121.599645,24.108858],[121.597810,24.104062],[121.607230,24.103632],[121.607789,24.100907],[121.615904,24.100453],[121.621501,24.092506]]], "type": "Polygon" } },
        { "type": "Feature", "geometry": { "coordinates": [[[121.604948,23.901474],[121.610687,23.926220],[121.612580,23.942989],[121.608024,23.941799],[121.591145,23.909209],[121.577361,23.892592],[121.601849,23.876074],[121.604948,23.901474]]], "type": "Polygon" } },
        { "type": "Feature", "geometry": { "coordinates": [[[121.639506,23.993598],[121.648135,24.008651],[121.643382,24.019640],[121.623962,24.042681],[121.619458,24.041224],[121.628747,24.024339],[121.615551,24.008296],[121.618160,24.005953],[121.631206,24.007526],[121.632488,24.008181],[121.638329,24.005843],[121.637199,23.994001],[121.639506,23.993598]]], "type": "Polygon" } },
        { "type": "Feature", "geometry": { "coordinates": [[[121.535547,23.932017],[121.512450,23.889656],[121.515776,23.886672],[121.517735,23.880624],[121.520035,23.876071],[121.526071,23.873088],[121.530713,23.873879],[121.535878,23.879688],[121.542451,23.879972],[121.571687,23.888404],[121.590972,23.909476],[121.535547,23.932017]]], "type": "Polygon" } },
        { "type": "Feature", "geometry": { "coordinates": [[[121.534930,23.932707],[121.520771,23.947018],[121.510697,23.960677],[121.495462,23.969784],[121.479319,23.973066],[121.477172,23.970161],[121.502105,23.953288],[121.500065,23.924869],[121.489372,23.898882],[121.496465,23.884703],[121.512192,23.889863],[121.534930,23.932707]]], "type": "Polygon" } },
        { "type": "Feature", "geometry": { "coordinates": [[[121.621473,24.092329],[121.615890,24.100417],[121.607771,24.100864],[121.607187,24.103606],[121.598394,24.103863],[121.609935,24.097499],[121.602034,24.078485],[121.582579,24.048778],[121.576432,24.021054],[121.582037,24.017281],[121.583576,24.015313],[121.585245,24.014263],[121.589424,24.014322],[121.591092,24.014396],[121.592502,24.013064],[121.595152,24.013873],[121.607105,24.013479],[121.610118,24.011970],[121.628461,24.024218],[121.619209,24.041341],[121.623579,24.042700],[121.616476,24.062867],[121.621473,24.092329]]], "type": "Polygon" } },
        { "type": "Feature", "geometry": { "coordinates": [[[121.608853,23.962525],[121.604308,23.963716],[121.599956,23.959501],[121.592253,23.960256],[121.577888,23.953156],[121.573188,23.944287],[121.561521,23.938944],[121.555415,23.926686],[121.569790,23.920126],[121.595530,23.917945],[121.607366,23.941806],[121.610149,23.942395],[121.606798,23.951657],[121.608853,23.962525]]], "type": "Polygon" } },
        { "type": "Feature", "geometry": { "coordinates": [[[121.636974,23.994142],[121.638162,24.005833],[121.632291,24.008063],[121.631023,24.007418],[121.618029,24.005899],[121.616089,24.007697],[121.613669,24.000403],[121.610744,23.984856],[121.610240,23.984409],[121.610420,23.980999],[121.611960,23.980436],[121.612986,23.979576],[121.613859,23.979451],[121.614167,23.980577],[121.614270,23.981452],[121.615929,23.981655],[121.617623,23.980905],[121.618513,23.979217],[121.626351,23.972007],[121.636974,23.994142]]], "type": "Polygon" } },
        { "type": "Feature", "geometry": { "coordinates": [[[121.554934,23.926874],[121.555328,23.926700],[121.561388,23.939022],[121.573067,23.944405],[121.578220,23.954043],[121.562668,23.962982],[121.548449,23.969906],[121.536591,23.958793],[121.517658,23.951543],[121.536169,23.932649],[121.554934,23.926874]]], "type": "Polygon" } },
        { "type": "Feature", "geometry": { "coordinates": [[[121.608868,23.962642],[121.621165,23.976698],[121.618494,23.979126],[121.617588,23.980866],[121.615902,23.981602],[121.614346,23.981389],[121.614241,23.980583],[121.613927,23.979394],[121.612975,23.979522],[121.611877,23.980374],[121.610332,23.980884],[121.609891,23.984704],[121.607266,23.982964],[121.597024,23.985025],[121.591904,23.974303],[121.589916,23.972727],[121.592345,23.970571],[121.594509,23.968734],[121.597739,23.966114],[121.601150,23.964254],[121.604233,23.963820],[121.608868,23.962642]]], "type": "Polygon" } },
        { "type": "Feature", "geometry": { "coordinates": [[[121.548541,23.970078],[121.548462,23.969917],[121.553956,23.967257],[121.562619,23.963043],[121.565175,23.961586],[121.571708,23.957815],[121.578251,23.954067],[121.577823,23.953184],[121.592196,23.960279],[121.599931,23.959551],[121.604239,23.963751],[121.601175,23.964177],[121.597655,23.966111],[121.586927,23.975055],[121.581145,23.977027],[121.569369,23.983364],[121.562253,23.987210],[121.554964,23.986668],[121.552471,23.984802],[121.545110,23.986579],[121.548541,23.970078]]], "type": "Polygon" } },
        { "type": "Feature", "geometry": { "coordinates": [[[121.597169,23.985151],[121.597097,23.985033],[121.607268,23.982985],[121.609933,23.984753],[121.609994,23.984247],[121.610718,23.984865],[121.613574,24.000349],[121.616080,24.007788],[121.606080,24.003461],[121.601315,23.993537],[121.597169,23.985151]]], "type": "Polygon" } },
        { "type": "Feature", "geometry": { "coordinates": [[[121.616044,24.009066],[121.607110,24.013401],[121.595108,24.013766],[121.594523,23.996108],[121.595495,23.994799],[121.597661,23.992048],[121.599438,23.989763],[121.603343,23.997866],[121.606047,24.003483],[121.616058,24.007805],[121.615502,24.008290],[121.616044,24.009066]]], "type": "Polygon" } },
        { "type": "Feature", "geometry": { "coordinates": [[[121.594514,23.996095],[121.595082,24.013793],[121.592506,24.013038],[121.591056,24.014355],[121.585219,24.014232],[121.583543,24.015290],[121.582019,24.017271],[121.576419,24.021038],[121.573564,24.012905],[121.564777,24.010478],[121.555731,24.005600],[121.545742,24.007521],[121.542729,24.005622],[121.545145,23.986602],[121.552470,23.984834],[121.554959,23.986700],[121.562270,23.987244],[121.569697,23.983203],[121.574546,23.980589],[121.581174,23.977035],[121.586972,23.975072],[121.589810,23.972683],[121.591898,23.974309],[121.597023,23.985056],[121.597143,23.985135],[121.599437,23.989744],[121.597656,23.992029],[121.595497,23.994787],[121.594514,23.996095]]], "type": "Polygon" } }
      ]
    };

    const getPinIcon = (type) => {
        const isQueue = type === 'queue';
        const color = isQueue ? '#00B0FF' : '#00C853';
        return { path: google.maps.SymbolPath.CIRCLE, scale: 6, fillColor: color, fillOpacity: 1, strokeColor: "white", strokeWeight: 2 };
    };

    window.onload = function() {
        initMap();
        processGeoData(); 
        
        fetchRadarData(); 
        startRadarTimer();
        setInterval(() => document.getElementById('clock').innerText = new Date().toLocaleString(), 1000);
    };

    function initMap() {
        map = new google.maps.Map(document.getElementById("map"), {
            center: { lat: 23.991, lng: 121.601 }, zoom: 12, 
            disableDefaultUI: true
        });
    }

    function fetchRadarData() {
        db.ref('drivers').once('value').then(snapshot => {
            updateDashboard(snapshot);
        }).catch(err => console.error("Èõ∑ÈÅîÊéÉÊèèÂ§±Êïó:", err));
    }

    let countdown = 60;
    function startRadarTimer() {
        setInterval(() => {
            countdown--;
            if(countdown <= 0) {
                countdown = 60;
                fetchRadarData(); 
            }
            document.getElementById('radar-timer').innerText = countdown + 's';
        }, 1000);
    }

    // üöÄ v5.0 Ê†∏ÂøÉÔºöÊãîÈô§ÂπΩÈùàËªäÊôÇÈñìÂà§Êñ∑Ôºå100% Áõ∏‰ø° Firebase ÁãÄÊÖã
    function updateDashboard(snapshot) {
        const data = snapshot.val();
        if (!data) return;
        const zoneDrivers = {}; 
        ZONES_DATA.forEach(z => zoneDrivers[z.id] = []);
        const activeIds = new Set();

        Object.keys(data).forEach(key => {
            const d = data[key];
            
            // üõë Âè™Âà§Êñ∑ÁãÄÊÖãÔºåÂÆåÂÖ®‰∏çÂÜçË®àÁÆó lastUpdate ÊôÇÈñìÂ∑ÆÔºÅ
            if (d.status !== 'online') return;

            activeIds.add(key);
            const pos = new google.maps.LatLng(d.lat, d.lng);
            
            if (!markers[key]) {
                markers[key] = new google.maps.Marker({ position: pos, map: map, icon: getPinIcon(d.workStatus), title: d.name });
            } else {
                markers[key].setPosition(pos);
                markers[key].setIcon(getPinIcon(d.workStatus));
            }

            ZONES_DATA.forEach(z => {
                const poly = zonePolygons[z.id];
                if (poly && google.maps.geometry.poly.containsLocation(pos, poly)) {
                    zoneDrivers[z.id].push(d);
                }
            });
        });

        for(let k in markers) { if(!activeIds.has(k)) { markers[k].setMap(null); delete markers[k]; } }

        ZONES_DATA.forEach(z => {
            const list = document.getElementById(`list-${z.id}`);
            const count = document.getElementById(`count-${z.id}`);
            if(!list || !count) return;

            list.innerHTML = "";
            count.innerText = zoneDrivers[z.id].length;
            
            if(zoneDrivers[z.id].length === 0) {
                count.classList.add('empty');
            } else {
                count.classList.remove('empty');
            }
            
            if(zoneDrivers[z.id].length > 0) {
                zoneDrivers[z.id].forEach(d => {
                    const statusClass = d.workStatus === 'queue' ? 'queue' : (d.workStatus === 'busy' ? 'busy' : '');
                    const avatar = d.photo || 'https://cdn-icons-png.flaticon.com/512/3237/3237472.png';
                    const isBusy = d.workStatus === 'busy';
                    
                    const phoneBtn = d.phone 
                        ? `<a href="tel:${d.phone}" class="btn-dial ${isBusy ? 'disabled' : ''}"><i class="fa-solid fa-phone"></i></a>` 
                        : `<div style="width:40px;"></div>`;

                    list.innerHTML += `
                        <div class="driver-card ${statusClass}">
                            <div class="d-left">
                                <div class="d-avatar"><img src="${avatar}"></div>
                                <div class="d-info"><h3>${d.name}</h3><p>${d.car || 'Ë®àÁ®ãËªä'}</p></div>
                            </div>
                            ${phoneBtn}
                        </div>
                    `;
                });
            } else {
                list.innerHTML = `<div style="color:#00C853;text-align:center;padding:10px;font-weight:bold;"><i class="fa-solid fa-bolt"></i> Êà∞ÂçÄÊ∑®Á©∫ÔºåÊÄ•ÈúÄÊîØÊè¥ÔºÅ</div>`;
            }
        });
    }

    function processGeoData() {
        const points = [];
        const polygons = [];

        GEO_RAW.features.forEach(f => {
            if(f.geometry.type === "Point") {
                const name = Object.keys(f.properties)[0];
                points.push({ name: name, lat: f.geometry.coordinates[1], lng: f.geometry.coordinates[0] });
            } else if (f.geometry.type === "Polygon") {
                const paths = f.geometry.coordinates[0].map(c => ({ lat: c[1], lng: c[0] }));
                polygons.push({ paths: paths });
            }
        });

        polygons.forEach(polyData => {
            const googlePoly = new google.maps.Polygon({ paths: polyData.paths });
            let matchedName = null;

            for(let p of points) {
                const latLng = new google.maps.LatLng(p.lat, p.lng);
                if(google.maps.geometry.poly.containsLocation(latLng, googlePoly)) {
                    matchedName = p.name;
                    break; 
                }
            }

            if(matchedName && ZONE_CONFIG[matchedName]) {
                const config = ZONE_CONFIG[matchedName];
                const displayName = config.alias || matchedName;
                
                googlePoly.setOptions({
                    strokeColor: config.color,
                    strokeOpacity: 0.8,
                    strokeWeight: 2,
                    fillColor: config.color,
                    fillOpacity: 0.1,
                    map: map
                });

                zonePolygons[matchedName] = googlePoly;
                
                ZONES_DATA.push({
                    id: matchedName,
                    name: displayName,
                    color: config.color,
                    priority: config.priority
                });
            }
        });

        ZONES_DATA.sort((a, b) => a.priority - b.priority);
        renderZoneList();
    }

    function renderZoneList() {
        const wrapper = document.getElementById('zones-wrapper');
        wrapper.innerHTML = '';
        ZONES_DATA.forEach(z => {
            wrapper.innerHTML += `
                <div class="zone-block" id="zone-${z.id}">
                    <div class="zone-header" onclick="toggleList('${z.id}')">
                        <div class="zone-title">
                            <i class="fa-solid fa-map-location-dot" style="margin-right:10px; color:${z.color};"></i> ${z.name}
                        </div>
                        <div class="zone-count" id="count-${z.id}">0</div>
                    </div>
                    <div class="driver-list" id="list-${z.id}"></div>
                </div>
            `;
        });
    }
    
    window.toggleList = function(id) {
        const list = document.getElementById(`list-${id}`);
        if(list) list.classList.toggle('active');
    };
  </script>
</body>
</html>
