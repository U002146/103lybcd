<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>花蓮車隊 - 數位排班看板 (v1.1)</title>
    
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAIxc6PEhHgUs_A9lyRUg8dNbmwOpSamY8&libraries=geometry"></script>

    <style>
        /* --- UI 設計總監：上下分割戰情室 --- */
        body { margin: 0; padding: 0; display: flex; flex-direction: column; height: 100vh; font-family: "Microsoft JhengHei", sans-serif; background: #000; overflow: hidden; }
        
        /* 上半部：地圖 (40%) */
        #map { width: 100%; height: 40%; border-bottom: 3px solid #333; }

        /* 下半部：看板 (60%) */
        #dashboard { 
            width: 100%; height: 60%; 
            background-color: #121212; 
            padding: 10px; box-sizing: border-box; 
            display: flex; flex-direction: column; gap: 10px; 
            overflow-y: auto; 
        }

        .header { color: #888; text-align: center; font-size: 14px; padding-bottom: 5px; border-bottom: 1px solid #333; margin-bottom: 5px; }

        /* 排班區域容器 */
        .zone-container { 
            background: #1e1e1e; border-radius: 8px; 
            border: 1px solid #333; overflow: hidden; 
            display: flex; flex-direction: column; 
            margin-bottom: 10px;
        }
        
        .zone-header { 
            background: linear-gradient(90deg, #004d40, #00695c); 
            color: #fff; padding: 8px 15px; 
            font-size: 20px; font-weight: bold; 
            display: flex; justify-content: space-between; align-items: center; 
            border-bottom: 1px solid #000; 
        }
        
        .zone-count { 
            background: #ffeb3b; color: #000; 
            padding: 2px 10px; border-radius: 15px; 
            font-size: 16px; font-weight: 800; 
        }

        /* 司機列表 (橫向排列) */
        .driver-list { 
            padding: 10px; 
            display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); 
            gap: 10px; 
        }

        /* 司機卡片 (縮小一點以適應版面) */
        .driver-card { 
            background: #2c2c2c; color: #fff; 
            padding: 10px; border-radius: 6px; 
            border-left: 4px solid #00bcd4; 
            display: flex; flex-direction: column; align-items: center; 
            box-shadow: 0 2px 4px rgba(0,0,0,0.3); 
            animation: popIn 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275); 
        }
        
        .driver-name { font-size: 24px; font-weight: bold; color: #fff; margin: 2px 0; }
        .driver-car { font-size: 16px; color: #ffeb3b; background: #000; padding: 1px 6px; border-radius: 4px; font-family: monospace; }
        .driver-time { font-size: 12px; color: #aaa; margin-top: 5px; }

        .empty-zone { padding: 15px; text-align: center; color: #444; font-size: 16px; font-style: italic; }

        @keyframes popIn { from { transform: scale(0.8); opacity: 0; } to { transform: scale(1); opacity: 1; } }
    </style>
</head>
<body>

    <div id="map"></div>
    <div id="dashboard">
        <div class="header">花蓮車隊數位排班系統 • 即時連線中</div>
        <div id="zones-area"></div>
    </div>

<script>
    // --- Config ---
    const firebaseConfig = { databaseURL: "https://hualientaxi-bb32f-default-rtdb.asia-southeast1.firebasedatabase.app/" };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // --- 電子圍籬 ---
    const ZONES = {
        "花蓮前站": [ {lat: 23.991470, lng: 121.600259}, {lat: 23.990772, lng: 121.602020}, {lat: 23.992854, lng: 121.602981}, {lat: 23.993574, lng: 121.601245} ],
        "花蓮後站": [ {lat: 23.994816, lng: 121.599054}, {lat: 23.992354, lng: 121.597607}, {lat: 23.990972, lng: 121.599851}, {lat: 23.993979, lng: 121.601205} ],
        "慈濟醫院": [ {lat: 23.993878, lng: 121.593012}, {lat: 23.995653, lng: 121.594586}, {lat: 23.996174, lng: 121.594003}, {lat: 23.996475, lng: 121.592131}, {lat: 23.995464, lng: 121.591121} ],
        "門諾醫院": [ {lat: 23.987043, lng: 121.623861}, {lat: 23.985999, lng: 121.625335}, {lat: 23.988932, lng: 121.627639}, {lat: 23.989904, lng: 121.626260} ]
    };

    let map;
    let polygons = {}; 
    let markers = {}; 

    const getIcon = (color) => {
        return { path: "M10,0 C4.5,0 0,4.5 0,10 C0,18 10,30 10,30 C10,30 20,18 20,10 C20,4.5 15.5,0 10,0 Z", fillColor: color, fillOpacity: 1, strokeColor: '#fff', strokeWeight: 2, scale: 1.5, anchor: new google.maps.Point(10, 30) };
    };

    function initMap() {
        map = new google.maps.Map(document.getElementById("map"), {
            center: { lat: 23.992, lng: 121.600 }, zoom: 14, disableDefaultUI: true,
            styles: [ { elementType: "geometry", stylers: [{ color: "#242f3e" }] }, { elementType: "labels.text.stroke", stylers: [{ color: "#242f3e" }] }, { elementType: "labels.text.fill", stylers: [{ color: "#746855" }] } ]
        });

        for (let name in ZONES) {
            polygons[name] = new google.maps.Polygon({
                paths: ZONES[name], strokeColor: "#ff5252", strokeOpacity: 0.8, strokeWeight: 2, fillColor: "#ff5252", fillOpacity: 0.15, map: map
            });
            new google.maps.Marker({
                position: ZONES[name][0], map: map, label: { text: name, color: "white", fontSize: "12px", fontWeight: "bold" }, icon: { path: google.maps.SymbolPath.CIRCLE, scale: 0 }
            });
        }
        listenToDrivers();
    }

    function listenToDrivers() {
        db.ref('drivers').on('value', (snapshot) => {
            const data = snapshot.val();
            if (!data) return;

            const now = Date.now();
            const queueData = { "花蓮前站": [], "花蓮後站": [], "慈濟醫院": [], "門諾醫院": [] };
            const activeDriverIds = new Set();

            Object.keys(data).forEach(id => {
                const d = data[id];
                if (!d.lat || !d.lng) return;
                // 放寬到 1 小時 (配合司機端掛機模式)
                if (now - d.lastUpdate > 3600000) return; 
                if (d.workStatus === 'busy') { if (markers[id]) markers[id].setMap(null); return; }

                activeDriverIds.add(id);
                const pos = new google.maps.LatLng(d.lat, d.lng);
                let isInZone = false;

                for (let zoneName in polygons) {
                    if (google.maps.geometry.poly.containsLocation(pos, polygons[zoneName])) {
                        isInZone = true;
                        queueData[zoneName].push({ name: d.name || "未命名", car: d.car || "計程車", time: d.lastUpdate });
                        break;
                    }
                }
                const color = isInZone ? "#00bcd4" : "#2ecc71"; 
                updateMarker(id, d.name, pos, color);
            });

            for (let id in markers) { if (!activeDriverIds.has(id)) { markers[id].setMap(null); delete markers[id]; } }
            renderDashboard(queueData);
        });
    }

    function updateMarker(id, name, pos, color) {
        if (!markers[id]) { markers[id] = new google.maps.Marker({ position: pos, map: map, icon: getIcon(color), title: name }); } 
        else { markers[id].setPosition(pos); markers[id].setIcon(getIcon(color)); markers[id].setMap(map); }
    }

    function renderDashboard(queueData) {
        const container = document.getElementById('zones-area');
        container.innerHTML = "";

        for (let zoneName in ZONES) {
            const list = queueData[zoneName];
            const zoneHtml = `
                <div class="zone-container">
                    <div class="zone-header"><span>${zoneName}</span><span class="zone-count">${list.length}</span></div>
                    <div class="driver-list">
                        ${list.length === 0 ? '<div class="empty-zone">目前無車輛</div>' : 
                          list.map(d => `<div class="driver-card"><div class="driver-name">${d.name}</div><div class="driver-car">${d.car}</div></div>`).join('')}
                    </div>
                </div>`;
            container.innerHTML += zoneHtml;
        }
    }

    window.onload = initMap;
</script>
</body>
</html>
