<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  
  <title>車隊接單系統</title>
  <meta name="apple-mobile-web-app-title" content="車隊接單">
  <meta name="application-name" content="車隊接單">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="theme-color" content="#1d4ed8"> <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/2312/2312270.png">
  <link rel="icon" type="image/png" href="https://cdn-icons-png.flaticon.com/512/2312/2312270.png">

  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    body { font-family: "Microsoft JhengHei", sans-serif; background-color: #f3f4f6; -webkit-tap-highlight-color: transparent; }
    input, select { font-size: 16px !important; }
    .chip:active { transform: scale(0.95); background-color: #e5e7eb; }
    
    /* 隱藏捲軸 */
    .no-scrollbar::-webkit-scrollbar { display: none; }
    .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

    /* 狀態燈 */
    .status-dot { height: 10px; width: 10px; border-radius: 50%; display: inline-block; }
    .status-ok { background-color: #4ade80; box-shadow: 0 0 5px #4ade80; }
    .status-err { background-color: #ef4444; }

    /* --- 列印核心設計 (Design Master 調校) --- */
    .screen-only { display: block; }
    .print-only { display: none; }
    
    @media print {
      @page { 
        size: A4 portrait; 
        margin: 0; /* 清除瀏覽器預設邊距 */
      }
      html, body { margin: 0; padding: 0; background: white; }
      .screen-only { display: none !important; }
      .print-only { display: block !important; }
      
      /* 每一頁的容器 */
      .print-page { 
        width: 210mm; 
        height: 297mm; 
        padding: 1.2cm 1.5cm; /* 上下邊距微調，左右保持 */
        margin: 0 auto; 
        box-sizing: border-box; 
        page-break-after: always; 
        position: relative; 
      }
      .print-page:last-child { page-break-after: avoid; }
      
      /* 表格設計 */
      .report-table { 
        width: 100%; 
        border-collapse: collapse; 
        font-size: 11pt; /* 字體大小 */
        margin-top: 5px; 
        font-family: "標楷體", "DFKai-SB", serif; 
        table-layout: fixed; /* 固定欄寬，避免跳動 */
      }
      
      /* 格線與高度控制 */
      .report-table th, .report-table td { 
        border: 1px solid black; 
        padding: 2px 4px; 
        text-align: center; 
        height: 29px; /* 強制高度，確保25筆剛好塞滿 */
        overflow: hidden;
        white-space: nowrap;
      }
      .report-table th { 
        background-color: #f0f0f0 !important; 
        height: 35px; /* 標題列稍微高一點 */
      }
      
      /* 頁首頁尾 */
      .report-header { text-align: center; font-size: 18pt; font-weight: bold; margin-bottom: 15px; font-family: "標楷體"; letter-spacing: 1px; }
      .report-info { display: flex; justify-content: space-between; margin-bottom: 5px; font-size: 12pt; font-family: "標楷體"; }
      .page-number { position: absolute; bottom: 0.8cm; right: 1.5cm; font-size: 10pt; color: #444; font-family: "Times New Roman", serif; }
    }
  </style>
</head>
<body class="pb-24">

  <div id="app-view" class="screen-only max-w-md mx-auto">
    <div class="bg-blue-700 text-white p-4 sticky top-0 z-50 shadow-md flex justify-between items-center">
      <div class="flex items-center" onclick="openSettings()">
        <i class="fas fa-cloud-upload-alt mr-2 text-blue-200"></i>
        <div>
            <h1 class="text-xl font-bold tracking-wider leading-none">雲端補單</h1>
            <span class="text-[10px] text-blue-300">V6.3 桌面版</span>
        </div>
        <div id="cloud-status" class="ml-2 status-dot bg-gray-400" title="點擊設定連線"></div>
      </div>
      <div class="flex gap-2">
         <button onclick="showInstallHelp()" class="bg-blue-800 text-blue-100 text-xs py-1 px-2 rounded border border-blue-600">
           <i class="fas fa-mobile-alt mr-1"></i> APP安裝
         </button>
         <button onclick="showPrintPreview()" class="bg-white text-blue-800 font-bold py-2 px-3 rounded shadow text-sm">
           <i class="fas fa-print mr-1"></i> 預覽
         </button>
      </div>
    </div>

    <div class="p-4">
      <div class="bg-white rounded-xl shadow-lg p-5 mb-6 border border-gray-100">
        <div class="flex justify-between items-center mb-4 border-b pb-2">
            <h2 class="text-lg font-bold text-gray-700">新增行程</h2>
            <button onclick="editDriverInfo()" class="text-xs text-blue-600 bg-blue-50 px-2 py-1 rounded">司機設定</button>
        </div>
        
        <div class="mb-4">
          <label class="block text-sm font-bold text-gray-500 mb-1">日期時間</label>
          <input type="datetime-local" id="input-time" class="w-full p-3 border border-gray-300 rounded-lg bg-gray-50 text-lg font-mono">
        </div>

        <div class="mb-4 grid grid-cols-2 gap-3">
          <button onclick="setCardType('敬老卡')" id="btn-elder" class="p-3 rounded-lg border-2 bg-gray-100 text-gray-600 font-bold transition">敬老卡</button>
          <button onclick="setCardType('愛心卡')" id="btn-care" class="p-3 rounded-lg border-2 bg-gray-100 text-gray-600 font-bold transition">愛心卡</button>
          <input type="hidden" id="input-type">
        </div>

        <div class="mb-4 space-y-3">
          <div>
            <label class="text-sm font-bold text-gray-500">上車 (可左右滑動)</label>
            <div class="flex gap-2 overflow-x-auto pb-2 mb-1 no-scrollbar">
                <span onclick="setInput('input-pickup', '前站')" class="chip px-3 py-2 bg-blue-50 text-blue-700 rounded-lg text-sm font-bold border border-blue-100 whitespace-nowrap shadow-sm">前站</span>
                <span onclick="setInput('input-pickup', '後站')" class="chip px-3 py-2 bg-blue-50 text-blue-700 rounded-lg text-sm font-bold border border-blue-100 whitespace-nowrap shadow-sm">後站</span>
                <span onclick="setInput('input-pickup', '慈濟')" class="chip px-3 py-2 bg-blue-50 text-blue-700 rounded-lg text-sm font-bold border border-blue-100 whitespace-nowrap shadow-sm">慈濟</span>
                <span onclick="setInput('input-pickup', '門諾')" class="chip px-3 py-2 bg-blue-50 text-blue-700 rounded-lg text-sm font-bold border border-blue-100 whitespace-nowrap shadow-sm">門諾</span>
                <span onclick="setInput('input-pickup', '花蓮醫院')" class="chip px-3 py-2 bg-blue-50 text-blue-700 rounded-lg text-sm font-bold border border-blue-100 whitespace-nowrap shadow-sm">花蓮醫院</span>
                <span onclick="setInput('input-pickup', '國軍醫院')" class="chip px-3 py-2 bg-blue-50 text-blue-700 rounded-lg text-sm font-bold border border-blue-100 whitespace-nowrap shadow-sm">國軍醫院</span>
            </div>
            <input type="text" id="input-pickup" placeholder="上車地點" class="w-full p-3 border border-gray-300 rounded-lg text-lg">
          </div>
          <div>
            <label class="text-sm font-bold text-gray-500">下車 (可左右滑動)</label>
            <div class="flex gap-2 overflow-x-auto pb-2 mb-1 no-scrollbar">
                <span onclick="setInput('input-dropoff', '前站')" class="chip px-3 py-2 bg-green-50 text-green-700 rounded-lg text-sm font-bold border border-green-100 whitespace-nowrap shadow-sm">前站</span>
                <span onclick="setInput('input-dropoff', '後站')" class="chip px-3 py-2 bg-green-50 text-green-700 rounded-lg text-sm font-bold border border-green-100 whitespace-nowrap shadow-sm">後站</span>
                <span onclick="setInput('input-dropoff', '慈濟')" class="chip px-3 py-2 bg-green-50 text-green-700 rounded-lg text-sm font-bold border border-green-100 whitespace-nowrap shadow-sm">慈濟</span>
                <span onclick="setInput('input-dropoff', '門諾')" class="chip px-3 py-2 bg-green-50 text-green-700 rounded-lg text-sm font-bold border border-green-100 whitespace-nowrap shadow-sm">門諾</span>
                <span onclick="setInput('input-dropoff', '花蓮醫院')" class="chip px-3 py-2 bg-green-50 text-green-700 rounded-lg text-sm font-bold border border-green-100 whitespace-nowrap shadow-sm">花蓮醫院</span>
                <span onclick="setInput('input-dropoff', '國軍醫院')" class="chip px-3 py-2 bg-green-50 text-green-700 rounded-lg text-sm font-bold border border-green-100 whitespace-nowrap shadow-sm">國軍醫院</span>
            </div>
            <input type="text" id="input-dropoff" placeholder="下車地點" class="w-full p-3 border border-gray-300 rounded-lg text-lg">
          </div>
        </div>
        
        <div class="mb-6">
           <label class="text-sm font-bold text-gray-500">備註</label>
           <input type="text" id="input-remarks" placeholder="例如：停靠全聯" class="w-full p-3 border border-gray-300 rounded-lg text-lg bg-yellow-50">
        </div>

        <button onclick="addRecord()" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-4 rounded-xl text-xl shadow-lg active:scale-95 transition flex justify-center items-center">
           <i class="fas fa-paper-plane mr-2"></i> 寫入資料
        </button>
      </div>

      <div class="flex justify-between items-end mb-2 px-1">
        <h3 class="font-bold text-gray-500">本日記錄 (<span id="record-count">0</span>)</h3>
        <button onclick="clearAll()" class="text-xs text-red-400 underline">清空</button>
      </div>
      <div id="record-list" class="space-y-3 pb-20"></div>
    </div>
  </div>

  <div id="preview-modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-95 z-50 flex flex-col items-center justify-center p-2 screen-only">
    <div class="bg-white w-full max-w-2xl h-[90vh] rounded-lg shadow-2xl flex flex-col overflow-hidden">
        <div class="bg-gray-100 p-4 border-b flex justify-between items-center">
             <div class="flex items-center space-x-2">
                <span class="font-bold text-gray-600">月份：</span>
                <select id="report-month-select" onchange="generatePrintHTML()" class="font-bold text-lg text-blue-600 bg-transparent outline-none">
                    <option value="1">1月</option><option value="2">2月</option><option value="3">3月</option><option value="4">4月</option>
                    <option value="5">5月</option><option value="6">6月</option><option value="7">7月</option><option value="8">8月</option>
                    <option value="9">9月</option><option value="10">10月</option><option value="11">11月</option><option value="12">12月</option>
                </select>
            </div>
            <button onclick="closePreview()" class="text-gray-500"><i class="fas fa-times text-2xl"></i></button>
        </div>
        <div id="preview-content" class="flex-1 overflow-auto p-4 bg-gray-500 flex flex-col items-center gap-4"></div>
        <div class="p-4 border-t bg-white flex space-x-3">
            <button onclick="window.print()" class="flex-1 bg-blue-600 text-white font-bold py-3 rounded-lg shadow-lg text-lg"><i class="fas fa-print mr-2"></i> 列印</button>
            <button onclick="closePreview()" class="px-6 bg-gray-200 text-gray-700 font-bold rounded-lg">修改</button>
        </div>
    </div>
  </div>

  <div id="print-area" class="print-only"></div>

  <script>
    let records = JSON.parse(localStorage.getItem('taxi_records_v6')) || [];
    let driverInfo = JSON.parse(localStorage.getItem('driver_info')) || { name: '', plate: '', id: '' };
    let apiUrl = localStorage.getItem('gas_api_url') || '';

    window.onload = function() {
      initTime();
      setCardType('敬老卡');
      renderList();
      checkApiStatus();
      if(!driverInfo.name) editDriverInfo();
      document.getElementById('report-month-select').value = new Date().getMonth() + 1;
    };

    function checkApiStatus() {
        const dot = document.getElementById('cloud-status');
        if(apiUrl && apiUrl.startsWith('http')) {
            dot.classList.remove('bg-gray-400', 'status-err');
            dot.classList.add('status-ok');
            dot.title = "已連線至雲端";
        } else {
            dot.classList.remove('status-ok');
            dot.classList.add('bg-gray-400');
            dot.title = "未設定雲端網址";
        }
    }

    // --- 新增：安裝教學彈窗 ---
    function showInstallHelp() {
        Swal.fire({
            title: '將系統安裝到桌面',
            html: `
              <div class="text-left text-sm space-y-3">
                <p class="font-bold text-blue-600"><i class="fab fa-apple text-lg"></i> iPhone 用戶：</p>
                <ol class="list-decimal pl-5 text-gray-600">
                  <li>點擊下方 Safari 的 <span class="inline-block px-1 border rounded bg-gray-100"><i class="fas fa-share-square"></i> 分享</span> 按鈕</li>
                  <li>往下滑找到 <strong>「加入主畫面」</strong></li>
                  <li>按右上角的「加入」</li>
                </ol>
                <hr class="my-2">
                <p class="font-bold text-green-600"><i class="fab fa-android text-lg"></i> Android 用戶：</p>
                <ol class="list-decimal pl-5 text-gray-600">
                  <li>點擊右上角的 <span class="inline-block px-1 border rounded bg-gray-100"><i class="fas fa-ellipsis-v"></i> 選單</span></li>
                  <li>找到 <strong>「加到主畫面」</strong> 或 「安裝應用程式」</li>
                  <li>按下確認即可</li>
                </ol>
              </div>
            `,
            confirmButtonText: '知道了'
        });
    }

    function openSettings() {
        Swal.fire({
            title: '雲端連線設定',
            html: `<p class="text-sm text-gray-500 mb-2">請貼上 Apps Script 網址</p><input id="swal-url" class="swal2-input" value="${apiUrl}" placeholder="https://script.google.com/...">`,
            showCancelButton: true, confirmButtonText: '儲存', preConfirm: () => document.getElementById('swal-url').value
        }).then((result) => {
            if (result.isConfirmed) {
                apiUrl = result.value.trim();
                localStorage.setItem('gas_api_url', apiUrl);
                checkApiStatus();
                Swal.fire('設定完成', '資料將同步至雲端', 'success');
            }
        });
    }

    function addRecord() {
      const timeStr = document.getElementById('input-time').value;
      const type = document.getElementById('input-type').value;
      const pickup = document.getElementById('input-pickup').value.trim();
      const dropoff = document.getElementById('input-dropoff').value.trim();
      const remarks = document.getElementById('input-remarks').value.trim();

      if (!timeStr || !pickup || !dropoff) return Swal.fire({icon: 'warning', title: '資料不完整', timer: 1500, showConfirmButton: false});

      const dateObj = new Date(timeStr);
      const fmtTime = `${String(dateObj.getMonth()+1).padStart(2,'0')}/${String(dateObj.getDate()).padStart(2,'0')} ${String(dateObj.getHours()).padStart(2,'0')}:${String(dateObj.getMinutes()).padStart(2,'0')}`;
      const newRecord = { id: Date.now(), timeObj: timeStr, formattedTime: fmtTime, type, pickup, dropoff, remarks, syncStatus: 'pending' };

      records.push(newRecord);
      localStorage.setItem('taxi_records_v6', JSON.stringify(records));
      renderList();
      
      document.getElementById('input-pickup').value = '';
      document.getElementById('input-dropoff').value = '';
      document.getElementById('input-remarks').value = '';

      if(apiUrl) syncToCloud(newRecord);
      else Swal.mixin({ toast: true, position: 'top', showConfirmButton: false, timer: 1500 }).fire({ icon: 'success', title: '已儲存 (僅本地)' });
    }

    function syncToCloud(record) {
        const toast = Swal.mixin({ toast: true, position: 'top', showConfirmButton: false });
        toast.fire({ icon: 'info', title: '正在同步到雲端...' });
        const payload = { ...record, driverName: driverInfo.name, driverPlate: driverInfo.plate, driverId: driverInfo.id };
        fetch(apiUrl, { method: 'POST', mode: 'no-cors', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) })
        .then(() => {
            record.syncStatus = 'synced';
            updateRecordStatus(record.id, 'synced');
            toast.fire({ icon: 'success', title: '雲端備份成功！' });
        }).catch(err => {
            updateRecordStatus(record.id, 'error');
            toast.fire({ icon: 'warning', title: '雲端連線失敗' });
        });
    }

    function updateRecordStatus(id, status) {
        const idx = records.findIndex(r => r.id === id);
        if(idx !== -1) {
            records[idx].syncStatus = status;
            localStorage.setItem('taxi_records_v6', JSON.stringify(records));
            renderList();
        }
    }

    function initTime() {
        const now = new Date();
        now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
        document.getElementById('input-time').value = now.toISOString().slice(0,16);
    }
    function editDriverInfo() {
      Swal.fire({
        title: '司機資料',
        html: `<input id="d-name" class="swal2-input" value="${driverInfo.name}" placeholder="姓名"><input id="d-plate" class="swal2-input" value="${driverInfo.plate}" placeholder="車牌"><input id="d-id" class="swal2-input" value="${driverInfo.id}" placeholder="編號">`,
        confirmButtonText: '儲存',
        preConfirm: () => ({ name: document.getElementById('d-name').value, plate: document.getElementById('d-plate').value, id: document.getElementById('d-id').value })
      }).then((r) => { if(r.isConfirmed) { driverInfo = r.value; localStorage.setItem('driver_info', JSON.stringify(driverInfo)); }});
    }
    function setCardType(type) {
      document.getElementById('input-type').value = type;
      const el = (id) => document.getElementById(id);
      if(type === '敬老卡') {
        el('btn-elder').className = 'p-3 rounded-lg border-2 border-yellow-500 bg-yellow-50 text-yellow-700 font-bold shadow-md transform scale-105';
        el('btn-care').className = 'p-3 rounded-lg border-2 border-transparent bg-gray-100 text-gray-400 font-bold opacity-70';
      } else {
        el('btn-care').className = 'p-3 rounded-lg border-2 border-rose-500 bg-rose-50 text-rose-700 font-bold shadow-md
