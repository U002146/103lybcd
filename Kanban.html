<!DOCTYPE html>
<html>
<head>
    <title>花蓮車隊 - 排班數位看板</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style>
        /* UI設計總監：左右分割，左邊地圖監控，右邊大字體看板 */
        body { margin: 0; padding: 0; display: flex; height: 100vh; font-family: 'Microsoft JhengHei', sans-serif; background: #000; }
        
        /* 左側地圖區 (40%) */
        #map { width: 40%; height: 100%; border-right: 2px solid #333; }
        
        /* 右側看板區 (60%) - 黑底黃字，高對比長輩友善 */
        #dashboard { width: 60%; height: 100%; overflow-y: auto; background-color: #1a1a1a; padding: 10px; box-sizing: border-box; }
        
        .zone-block { margin-bottom: 20px; border: 1px solid #444; border-radius: 8px; overflow: hidden; }
        .zone-title { background: #FFD700; color: #000; padding: 10px 20px; font-size: 24px; font-weight: bold; display: flex; justify-content: space-between; }
        .driver-list { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 10px; padding: 10px; }
        
        /* 司機卡片：只有排班中的才會顯示在這裡 */
        .driver-card { background: #333; color: #fff; padding: 15px; border-radius: 5px; text-align: center; border: 1px solid #555; animation: fadeIn 0.5s; }
        .driver-card h3 { margin: 0; font-size: 32px; color: #00e5ff; } /* 車號超大 */
        .driver-card p { margin: 5px 0 0; font-size: 16px; color: #aaa; }
        
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>

    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <script src="https://maps.googleapis.com/maps/api/js?key=YOUR_API_KEY&libraries=geometry"></script>
</head>
<body>

    <div id="map"></div>
    <div id="dashboard">
        </div>

<script>
    // --- 1. 架構師配置：Firebase 設定 (請填入你 Project A 的設定) ---
    const firebaseConfig = {
        apiKey: "YOUR_FIREBASE_API_KEY",
        authDomain: "YOUR_PROJECT.firebaseapp.com",
        databaseURL: "YOUR_DATABASE_URL",
        projectId: "YOUR_PROJECT_ID",
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // --- 2. 在地運將配置：四大排班區座標 (已從你的JSON轉換) ---
    // 注意：Google Maps 格式是 {lat, lng}，順序跟 GeoJSON 相反
    const ZONES = {
        "花蓮前站": [
            {lat: 23.991470, lng: 121.600260},
            {lat: 23.990772, lng: 121.602020},
            {lat: 23.992854, lng: 121.602981},
            {lat: 23.993574, lng: 121.601245}
        ],
        "花蓮後站": [
            {lat: 23.994816, lng: 121.599054},
            {lat: 23.992354, lng: 121.597607},
            {lat: 23.990972, lng: 121.599851},
            {lat: 23.993979, lng: 121.601205}
        ],
        "慈濟醫院": [
            {lat: 23.993878, lng: 121.593012},
            {lat: 23.995653, lng: 121.594586},
            {lat: 23.996174, lng: 121.594003},
            {lat: 23.996475, lng: 121.592131},
            {lat: 23.995464, lng: 121.591121}
        ],
        "門諾醫院": [
            {lat: 23.987043, lng: 121.623861},
            {lat: 23.985999, lng: 121.625335},
            {lat: 23.988932, lng: 121.627639},
            {lat: 23.989904, lng: 121.626260}
        ]
    };

    let map;
    let polygons = {}; // 存放地圖上的紅色圍籬
    let drivers = {};  // 存放司機資料
    let markers = {};  // 存放地圖上的車子圖標

    // --- 3. 初始化地圖與圍籬 ---
    function initMap() {
        // 預設地圖中心 (花蓮火車站)
        map = new google.maps.Map(document.getElementById("map"), {
            center: { lat: 23.992, lng: 121.600 },
            zoom: 14,
            disableDefaultUI: true, // 簡化介面
            styles: [ // 夜間模式地圖樣式 (選用)
                { elementType: "geometry", stylers: [{ color: "#242f3e" }] },
                { elementType: "labels.text.stroke", stylers: [{ color: "#242f3e" }] },
                { elementType: "labels.text.fill", stylers: [{ color: "#746855" }] },
            ]
        });

        // 畫出圍籬 (紅色半透明)
        for (let zoneName in ZONES) {
            const poly = new google.maps.Polygon({
                paths: ZONES[zoneName],
                strokeColor: "#FF0000",
                strokeOpacity: 0.8,
                strokeWeight: 2,
                fillColor: "#FF0000",
                fillOpacity: 0.15, // 淡紅色表示區域
                map: map
            });
            polygons[zoneName] = poly;
        }

        // 開始監聽 Firebase 資料
        listenToDrivers();
    }

    // --- 4. 核心邏輯：監聽與判斷 ---
    function listenToDrivers() {
        // 假設你的資料路徑是 'drivers'，請依實際情況修改
        db.ref('drivers').on('value', (snapshot) => {
            const data = snapshot.val();
            if (!data) return;

            const queueData = { "花蓮前站": [], "花蓮後站": [], "慈濟醫院": [], "門諾醫院": [] };

            // 遍歷每一位司機
            Object.keys(data).forEach(driverId => {
                const driver = data[driverId];
                
                // [過濾 1] 必須有經緯度
                if (!driver.lat || !driver.lng) return;

                const pos = new google.maps.LatLng(driver.lat, driver.lng);

                // [地圖更新] 更新或建立 Marker
                updateMarker(driverId, driver, pos);

                // [過濾 2] 必須是「空車 (EMPTY)」或「排班 (QUEUE)」狀態
                // 如果是「載客 (OCCUPIED)」，直接跳過，不進入排班計算
                if (driver.status === 'OCCUPIED') {
                    // 可以在這裡把地圖上的 Marker 隱藏或變色
                    if(markers[driverId]) markers[driverId].setMap(null); // 隱藏載客車輛
                    return; 
                }

                // [核心算法] 檢查這台車在哪個圍籬內？
                for (let zoneName in polygons) {
                    // 使用 Google Geometry Library 判斷點是否在多邊形內
                    if (google.maps.geometry.poly.containsLocation(pos, polygons[zoneName])) {
                        queueData[zoneName].push(driver);
                        break; // 一台車只能在一個區域
                    }
                }
            });

            // 更新右側看板 UI
            renderDashboard(queueData);
        });
    }

    // --- 5. UI 渲染：更新地圖 Marker ---
    function updateMarker(id, driver, pos) {
        if (!markers[id]) {
            markers[id] = new google.maps.Marker({
                position: pos,
                map: map,
                title: driver.carNumber || id,
                // 可以換成你的車子 icon
                icon: 'http://maps.google.com/mapfiles/kml/shapes/cabs.png' 
            });
        } else {
            markers[id].setPosition(pos);
            markers[id].setMap(map); // 確保顯示 (如果之前被隱藏)
        }
    }

    // --- 6. UI 渲染：更新右側看板 ---
    function renderDashboard(queueData) {
        const dashboard = document.getElementById('dashboard');
        dashboard.innerHTML = ""; // 清空

        for (let zoneName in queueData) {
            const driversInZone = queueData[zoneName];
            
            // 該區塊標題
            const zoneBlock = document.createElement('div');
            zoneBlock.className = 'zone-block';
            
            // 標題列：顯示區域名稱 + 車輛數
            zoneBlock.innerHTML = `
                <div class="zone-title">
                    <span>${zoneName}</span>
                    <span>${driversInZone.length} 台</span>
                </div>
                <div class="driver-list" id="list-${zoneName}"></div>
            `;
            dashboard.appendCh1ild(zoneBlock);

            // 插入司機卡片
            const listDiv = zoneBlock.querySelector(`#list-${zoneName}`);
            if (driversInZone.length === 0) {
                listDiv.innerHTML = `<div style="color:#666; padding:10px;">目前無車輛排班</div>`;
            } else {
                driversInZone.forEach(driver => {
                    const card = document.createElement('div');
                    card.className = 'driver-card';
                    // 顯示內容：車號 (大) + 司機名 (小)
                    card.innerHTML = `
                        <h3>${driver.carNumber || '未知車號'}</h3>
                        <p>${driver.name || '司機'}</p>
                    `;
                    listDiv.appendChild(card);
                });
            }
        }
    }

    // 啟動地圖
    window.onload = initMap;

</script>
</body>
</html>
