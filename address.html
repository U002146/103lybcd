<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å¸¸ç”¨åœ°å€é ç´„</title> // v3.2 æ™‚é–“ä»˜æ¬¾åˆä½µç‰ˆ
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        body { font-family: 'Noto Sans TC', sans-serif; background-color: #f8fafc; overflow-x: hidden; min-height: 100vh; display: flex; flex-direction: column; }
        input, select, textarea { font-size: 17px !important; }
        
        /* èª¿æ•´å®¹å™¨ä¸Šæ–¹é–“è·ï¼Œè®“è¡Œç¨‹è¨­å®šå®Œç¾ç½®é ‚ */
        .main-container { flex: 1; padding: 16px 20px 120px 20px; max-width: 600px; margin: 0 auto; width: 100%; }
        
        .booking-card { background: white; border-radius: 24px; box-shadow: 0 10px 30px rgba(0,0,0,0.04); padding: 20px; margin-bottom: 20px; border: 1px solid #f1f5f9; }
        
        .location-inputs { position: relative; border: 1px solid #e2e8f0; border-radius: 20px; background: #f8fafc; }
        .loc-row { display: flex; align-items: center; padding: 16px; transition: all 0.2s; }
        .loc-row:focus-within { background: #ffffff; box-shadow: 0 0 0 2px rgba(16, 185, 129, 0.2); border-radius: 20px; }
        .loc-divider { height: 1px; background: #e2e8f0; margin: 0 16px; }
        
        .btn-swap { position: absolute; top: 50%; right: 16px; transform: translateY(-50%); width: 40px; height: 40px; background: white; border: 1px solid #e2e8f0; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: #64748b; box-shadow: 0 4px 10px rgba(0,0,0,0.05); cursor: pointer; transition: all 0.2s; z-index: 10; }
        .btn-swap:active { transform: translateY(-50%) scale(0.9); background: #f1f5f9; }

        .input-group { background-color: #ffffff; border: 1px solid #e2e8f0; border-radius: 16px; padding: 12px 16px; transition: all 0.2s; display: flex; align-items: center; margin-bottom: 16px; }
        .input-group:focus-within { border-color: #3b82f6; box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1); }
        .input-icon { width: 24px; text-align: center; margin-right: 12px; }

        .loader { border: 3px solid #f3f3f3; border-top: 3px solid #10B981; border-radius: 50%; width: 24px; height: 24px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        .swal2-popup { border-radius: 24px !important; font-family: 'Noto Sans TC', sans-serif !important; padding-bottom: 20px !important;}
        .location-grid { max-height: 50vh; overflow-y: auto; padding: 4px; }

        /* æ»¿ç‰ˆæ™‚é–“é¸æ“‡å™¨ UI è¨­è¨ˆ */
        #time-selector-modal { position: fixed; top: 0; left: 0; right: 0; bottom: 0; z-index: 100; background: rgba(0,0,0,0.5); display: none; justify-content: center; align-items: flex-end; opacity: 0; transition: opacity 0.3s; }
        
        #time-selector-content { 
            background: white; 
            width: 100%; 
            max-width: 600px; 
            height: 100dvh; 
            padding: 20px; 
            padding-top: max(20px, env(safe-area-inset-top)); 
            padding-bottom: max(20px, env(safe-area-inset-bottom)); 
            transform: translateY(100%); 
            transition: transform 0.3s cubic-bezier(0.2, 0.8, 0.2, 1); 
            display: flex; 
            flex-direction: column; 
        }

        .date-tabs-container { display: flex; overflow-x: auto; gap: 10px; padding-bottom: 5px; scrollbar-width: none; }
        .date-tabs-container::-webkit-scrollbar { display: none; }
        .date-tab { flex: 0 0 auto; padding: 10px 18px; border-radius: 16px; background: #f1f5f9; color: #64748b; font-size: 15px; font-weight: bold; cursor: pointer; transition: all 0.2s; border: 2px solid transparent; }
        .date-tab.active { background: #eff6ff; color: #1d4ed8; border-color: #3b82f6; box-shadow: 0 4px 10px rgba(59, 130, 246, 0.15); }
        
        .time-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; }
        .time-btn { appearance: none; padding: 14px 0; border-radius: 12px; background: #ffffff; border: 1px solid #e2e8f0; color: #334155; font-weight: bold; text-align: center; cursor: pointer; transition: all 0.1s; display: flex; align-items: center; justify-content: center; width: 100%; font-size: 16px; }
        .time-btn:active { transform: scale(0.95); background: #f8fafc; border-color: #94a3b8; }
        .time-btn.selected { background: #e0f2fe; border-color: #3b82f6; color: #1d4ed8; box-shadow: 0 2px 8px rgba(59,130,246,0.2); }
        .time-btn.disabled { opacity: 0.35; background: #f8fafc; pointer-events: none; color: #94a3b8; border-color: #e2e8f0; }
    </style>
</head>
<body>

    <div id="loading-overlay" class="fixed inset-0 bg-white z-[9999] flex flex-col items-center justify-center">
        <div class="loader mb-4 w-12 h-12 border-4 text-emerald-500"></div>
        <p class="text-slate-600 font-bold text-lg tracking-widest animate-pulse">ç³»çµ±é€£ç·šä¸­...</p>
    </div>

    <div id="app" class="hidden flex-col min-h-screen">
        <div class="main-container">
            <div class="booking-card !mt-2">
                <div class="flex items-center justify-between mb-4">
                    <h2 class="text-sm font-bold text-slate-500 uppercase tracking-widest flex items-center">
                        ğŸ“ è¡Œç¨‹è¨­å®š
                        <div id="liff-status-dot" class="ml-2 w-2 h-2 rounded-full bg-red-500 transition-colors duration-300"></div>
                    </h2>
                </div>
                
                <div class="location-inputs">
                    <div class="loc-row relative">
                        <i class="fa-solid fa-circle-dot text-emerald-500 text-lg mr-4 w-5 text-center"></i>
                        <div class="flex-1 mr-12">
                            <label class="block text-[10px] text-slate-400 font-bold uppercase mb-1">Pickup (ä¸Šè»Šé»)</label>
                            <input type="text" id="pickup" placeholder="è«‹è¼¸å…¥æˆ–é¸æ“‡ä¸Šè»Šåœ°å€" class="w-full bg-transparent font-bold text-slate-800 outline-none text-lg">
                        </div>
                        <button onclick="openPresetLocations('pickup')" class="absolute right-4 p-3 -mr-3 text-yellow-400 active:scale-90 transition-transform"><i class="fa-solid fa-star text-xl drop-shadow-sm"></i></button>
                    </div>

                    <div class="loc-divider"></div>

                    <button onclick="swapLocations()" class="btn-swap" title="èµ·è¨–é»å°èª¿">
                        <i class="fa-solid fa-arrow-right-arrow-left rotate-90 text-slate-500"></i>
                    </button>

                    <div class="loc-row relative">
                        <i class="fa-solid fa-location-dot text-rose-500 text-xl mr-4 w-5 text-center"></i>
                        <div class="flex-1 mr-12">
                            <label class="block text-[10px] text-slate-400 font-bold uppercase mb-1">Drop-off (ä¸‹è»Šé» â€¢ é¸å¡«)</label>
                            <input type="text" id="dropoff" placeholder="æœªå¡«å‰‡é¡¯ç¤ºï¼šä¸Šè»Šå‘ŠçŸ¥" class="w-full bg-transparent font-bold text-slate-800 outline-none text-lg">
                        </div>
                        <button onclick="openPresetLocations('dropoff')" class="absolute right-4 p-3 -mr-3 text-yellow-400 active:scale-90 transition-transform"><i class="fa-solid fa-star text-xl drop-shadow-sm"></i></button>
                    </div>
                </div>
            </div>

            <div class="booking-card">
                
                <div class="input-group cursor-pointer relative !bg-blue-50/50 !border-blue-100" onclick="openModernTimeSelector()">
                    <i id="time-icon" class="fa-solid fa-calendar-check input-icon text-blue-600 text-xl"></i>
                    <div class="flex-1">
                        <label class="block text-[10px] text-blue-500 font-bold uppercase">Pickup Time (ç”¨è»Šæ™‚é–“)</label>
                        <div class="flex items-center justify-between mt-1">
                            <span id="time-display" class="font-bold text-slate-400 text-lg">è«‹é»æ“Šé¸æ“‡æ™‚é–“</span>
                            
                            <div class="flex items-center space-x-2" onclick="event.stopPropagation(); openPaymentPicker();">
                                <span class="w-[1px] h-5 bg-blue-200"></span>
                                <div class="flex items-center bg-white px-2 py-1.5 rounded-md border border-blue-100 shadow-sm active:bg-blue-50 transition-colors">
                                    <i id="payment-icon-small" class="fa-solid fa-coins text-slate-600 text-xs mr-1.5"></i>
                                    <span id="payment-text-small" class="text-xs font-bold text-slate-700">ç¾é‡‘</span>
                                    <i class="fa-solid fa-caret-down text-[10px] text-gray-400 ml-1.5"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                    <input type="hidden" id="booking-time-val" value="">
                    <input type="hidden" id="payment-value" value="ç¾é‡‘">
                </div>

                <div class="input-group !mb-0">
                    <i class="fa-solid fa-phone input-icon text-slate-400"></i>
                    <div class="flex-1">
                        <label class="block text-[10px] text-slate-400 font-bold uppercase">Phone (è¯çµ¡é›»è©±)</label>
                        <input type="tel" id="phone" placeholder="09xx-xxx-xxx" class="w-full bg-transparent font-bold text-slate-800 outline-none text-lg">
                    </div>
                </div>
                
            </div>
        </div>

        <div class="fixed bottom-0 left-0 right-0 p-5 bg-white/95 backdrop-blur-md border-t border-gray-100 z-30 max-w-[600px] mx-auto">
            <button id="submitBtn" onclick="submitOrder()" class="w-full bg-slate-900 text-white font-bold py-4 rounded-2xl shadow-xl shadow-slate-300 active:scale-[0.98] transition-all text-xl flex items-center justify-center space-x-3">
                <i class="fa-solid fa-paper-plane"></i>
                <span id="submit-btn-text">ç¢ºèªé€å‡ºé ç´„</span>
            </button>
        </div>
    </div>

    <div id="time-selector-modal" onclick="closeModernTimeSelector(event)">
        <div id="time-selector-content" onclick="event.stopPropagation()">
            
            <div class="flex justify-between items-center mb-5 flex-shrink-0">
                <h3 class="text-2xl font-black text-slate-800 tracking-wide">é¸æ“‡ç”¨è»Šæ™‚é–“</h3>
                <button type="button" onclick="closeModernTimeSelector()" class="w-10 h-10 rounded-full bg-gray-100 text-gray-500 hover:bg-gray-200 flex items-center justify-center text-lg"><i class="fa-solid fa-xmark"></i></button>
            </div>
            
            <div class="flex-1 flex flex-col min-h-0 overflow-y-auto pr-1">
                
                <div class="mb-5 flex-shrink-0">
                    <div class="text-xs text-emerald-600 font-bold mb-2 uppercase tracking-wide flex items-center"><i class="fa-solid fa-calendar-day mr-1"></i> 1. é¸æ“‡æ—¥æœŸ</div>
                    <div class="date-tabs-container" id="date-tabs-list"></div>
                </div>

                <div class="mb-5 flex-shrink-0">
                    <div class="text-xs text-emerald-600 font-bold mb-2 uppercase tracking-wide flex items-center"><i class="fa-solid fa-clock mr-1"></i> 2. é¸æ“‡å°æ™‚ (24H)</div>
                    <div class="time-grid" id="hour-grid"></div>
                </div>

                <div class="mb-4 flex-shrink-0">
                    <div class="text-xs text-emerald-600 font-bold mb-2 uppercase tracking-wide flex items-center"><i class="fa-solid fa-stopwatch mr-1"></i> 3. é¸æ“‡åˆ†é˜</div>
                    <div class="time-grid pb-10" id="minute-grid-container"></div>
                </div>
                
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <script>
        const VERSION = "v3.2"; // æ™‚é–“ä»˜æ¬¾åˆä½µç‰ˆ
        const LIFF_ID = '2008907691-3P676tTN'; 
        const PROJECT_B_URL = 'https://liff.line.me/2008907691-1mAjwojZ'; 

        const PRESET_LOCATIONS = [
            {name:'æˆ‘çš„æœ€æ„› A', icon:'â­', value:'FAV_ADDR_A'},
            {name:'æˆ‘çš„æœ€æ„› B', icon:'â­', value:'FAV_ADDR_B'},
            {name:'èŠ±è“®å‰ç«™', icon:'ğŸš‰'},
            {name:'èŠ±è“®å¾Œç«™', icon:'ğŸš‰'},
            {name:'æ…ˆæ¿Ÿé†«é™¢', icon:'ğŸ¥'},
            {name:'é–€è«¾é†«é™¢', icon:'ğŸ¥'},
            {name:'é æ±ç™¾è²¨', icon:'ğŸ›ï¸'},
            {name:'æ±å¤§é–€å¤œå¸‚', icon:'ğŸŒ­'}
        ];

        const PAYMENT_METHODS = [
            {id:'ç¾é‡‘',label:'ç¾é‡‘',icon:'fa-coins',color:'text-slate-600'},
            {id:'æ•¬è€å¡',label:'æ•¬è€å¡',icon:'fa-person-cane',color:'text-orange-500'},
            {id:'æ„›å¿ƒå¡',label:'æ„›å¿ƒå¡',icon:'fa-heart',color:'text-rose-500'},
            {id:'æ‚ éŠå¡',label:'æ‚ éŠå¡',icon:'fa-id-card',color:'text-blue-400'},
            {id:'ä¿¡ç”¨å¡',label:'ä¿¡ç”¨å¡',icon:'fa-credit-card',color:'text-indigo-500'},
            {id:'LINE PAY',label:'LINE PAY',icon:'fa-brands fa-line',color:'text-green-500'},
            {id:'APPLE PAY',label:'APPLE PAY',icon:'fa-brands fa-apple',color:'text-black'},
            {id:'TWQR',label:'TWQR',icon:'fa-qrcode',color:'text-purple-500'}
        ];

        let pickerState = { dateIndex: 0, hour: null, minute: null, dates: [] };
        let currentTargetInput = 'pickup';
        let userName = "ä¹˜å®¢"; 

        window.onload = function() {
            const savedPhone = localStorage.getItem('taxi_user_phone');
            if(savedPhone) document.getElementById('phone').value = savedPhone;
            const savedPayment = localStorage.getItem('taxi_selected_payment');
            if(savedPayment) { 
                const method = PAYMENT_METHODS.find(m => m.label === savedPayment); 
                if(method) updatePaymentUI(method.label, method.icon, method.color); 
            }

            liff.init({ liffId: LIFF_ID }).then(() => {
                if (!liff.isLoggedIn()) {
                    liff.login({ redirectUri: window.location.href });
                    return; 
                }
                
                liff.getProfile().then(profile => {
                    userName = profile.displayName;
                    unlockUI(); 
                }).catch(err => {
                    unlockUI(); 
                });

            }).catch(err => {
                Swal.fire({
                    icon: 'error',
                    title: 'é€£ç·šå¤±æ•—',
                    text: 'ç„¡æ³•é€£çµ LINE ä¼ºæœå™¨ï¼Œè«‹é‡æ–°é–‹å•Ÿã€‚',
                    confirmButtonText: 'ç¢ºå®š'
                });
            });
        };

        function unlockUI() {
            document.getElementById('loading-overlay').style.display = 'none';
            document.getElementById('app').classList.remove('hidden');
            document.getElementById('app').classList.add('flex');
            document.getElementById('liff-status-dot').classList.replace('bg-red-500', 'bg-green-500');
        }

        function swapLocations() {
            const pickupEl = document.getElementById('pickup');
            const dropoffEl = document.getElementById('dropoff');
            const temp = pickupEl.value;
            pickupEl.value = dropoffEl.value;
            dropoffEl.value = temp;
            const inputs = document.querySelectorAll('.loc-row');
            inputs.forEach(el => { el.style.transform = 'scale(0.98)'; setTimeout(() => el.style.transform = 'scale(1)', 150); });
        }

        function openPresetLocations(target) { 
            currentTargetInput = target; 
            const targetName = target === 'pickup' ? 'ä¸Šè»Šé»' : 'ä¸‹è»Šé»';
            let html = '<div class="grid grid-cols-2 gap-3 mt-2 location-grid">'; 
            PRESET_LOCATIONS.forEach(loc => { 
                let bgClass = (loc.value && loc.value.includes('FAV')) ? 'bg-yellow-50 hover:bg-yellow-100 border-yellow-200' : 'bg-gray-50 hover:bg-slate-100 border-gray-100'; 
                html += `<button type="button" onclick="selectPreset('${loc.value || loc.name}', '${loc.name}')" class="flex flex-col items-center justify-center p-3 border rounded-xl transition-all active:scale-95 ${bgClass}"><span class="text-2xl mb-1">${loc.icon}</span><span class="text-sm font-bold text-slate-700">${loc.name}</span></button>`; 
            }); 
            html += '</div>'; 
            Swal.fire({ title: `å¿«é€Ÿé¸æ“‡${targetName}`, html: html, showConfirmButton: false, showCloseButton: true, customClass: {popup: 'rounded-[24px]'} }); 
        }

        window.selectPreset = function(val, label) { 
            const input = document.getElementById(currentTargetInput); 
            if (val.includes('FAV')) { 
                const key = val === 'FAV_ADDR_A' ? 'taxi_fav_a' : 'taxi_fav_b'; 
                const savedAddr = localStorage.getItem(key); 
                if (savedAddr) { 
                    Swal.fire({ title: `ğŸ“ ä½¿ç”¨ã€Œ${label}ã€ï¼Ÿ`, text: savedAddr, showDenyButton: true, confirmButtonText: 'å¡«å…¥', denyButtonText: 'ä¿®æ”¹åœ°å€', confirmButtonColor: '#10b981', denyButtonColor: '#94a3b8' }).then((r) => { 
                        if (r.isConfirmed) { input.value = savedAddr; Swal.close(); } else if (r.isDenied) { promptSave(key, label, input); } 
                    }); 
                } else { promptSave(key, label, input); } 
            } else { input.value = val; Swal.close(); } 
        };

        function promptSave(key, label, input) { 
            Swal.fire({ title: `è¨­å®š${label}`, input: 'text', inputPlaceholder: 'è«‹è¼¸å…¥å®Œæ•´åœ°å€...', showCancelButton: true, confirmButtonText: 'è¨˜æ†¶ä¸¦å¥—ç”¨', confirmButtonColor: '#0f172a' }).then((r) => { 
                if (r.isConfirmed && r.value) { localStorage.setItem(key, r.value); input.value = r.value; Swal.fire({ icon: 'success', title: 'å·²è¨˜æ†¶ï¼', timer: 1000, showConfirmButton: false }); } 
            }); 
        }

        function openPaymentPicker() { 
            let html = '<div class="grid grid-cols-2 gap-3 mt-2 location-grid">'; 
            const currentVal = document.getElementById('payment-value').value; 
            PAYMENT_METHODS.forEach(m => { 
                let activeClass = m.label === currentVal ? 'border-slate-800 bg-slate-900 text-white ring-2 ring-slate-200' : 'bg-white border-gray-200 text-slate-600 hover:bg-gray-50'; 
                let iconColor = m.label === currentVal ? 'text-white' : m.color; 
                html += `<button type="button" onclick="selectPaymentMethod('${m.label}', '${m.icon}', '${m.color}')" class="flex flex-col items-center justify-center p-4 border rounded-2xl transition-all active:scale-95 ${activeClass}"><i class="fa-solid ${m.icon} ${iconColor} text-2xl mb-2"></i><span class="text-sm font-bold">${m.label}</span></button>`; 
            }); 
            html += '</div>'; 
            Swal.fire({ title: 'é¸æ“‡ä»˜æ¬¾æ–¹å¼', html: html, showConfirmButton: false, showCloseButton: true, customClass: {popup: 'rounded-[24px]'} }); 
        }
        
        window.selectPaymentMethod = function(label, iconClass, colorClass) { 
            updatePaymentUI(label, iconClass, colorClass); 
            localStorage.setItem('taxi_selected_payment', label); 
            Swal.close(); 
        }
        
        function updatePaymentUI(label, iconClass, colorClass) { 
            document.getElementById('payment-value').value = label; 
            document.getElementById('payment-text-small').innerText = label; 
            const iconElem = document.getElementById('payment-icon-small'); 
            // ğŸŒŸ æ¢å¾©åŸç‰ˆå°å·§çš„ icon å°ºå¯¸ï¼ŒåŒ¹é…åŒä¸€æ¬„çš„ç‰ˆé¢
            iconElem.className = `fa-solid ${iconClass} text-xs mr-1.5`; 
            if(label !== 'ç¾é‡‘') iconElem.classList.add(colorClass.split(' ')[0]); 
        }

        function generateDates() { 
            const dates = []; const today = new Date(); 
            const weekDays = ['æ—¥','ä¸€','äºŒ','ä¸‰','å››','äº”','å…­']; 
            for(let i=0; i<7; i++) { 
                const d = new Date(today); d.setDate(today.getDate() + i); d.setHours(0,0,0,0);
                const m = (d.getMonth()+1).toString(); const day = d.getDate().toString(); const w = weekDays[d.getDay()]; 
                const label = i === 0 ? 'ä»Šå¤©' : (i === 1 ? 'æ˜å¤©' : `${m}/${day}`); 
                dates.push({ val: i, label: label, sub: i > 1 ? `é€±${w}` : '', fullDate: `${m}æœˆ${day}æ—¥`, rawDate: d }); 
            } 
            return dates; 
        }
        
        function openModernTimeSelector() { 
            const modal = document.getElementById('time-selector-modal'); 
            const content = document.getElementById('time-selector-content'); 
            pickerState.dates = generateDates(); 
            pickerState.hour = null; 
            pickerState.minute = null;
            renderDateTabs(); 
            renderHourGrid(); 
            renderMinuteGrid();
            modal.style.display = 'flex'; 
            setTimeout(() => { modal.style.opacity = '1'; content.style.transform = 'translateY(0)'; }, 10); 
        }

        function closeModernTimeSelector(e) { 
            if(e && e.target.id !== 'time-selector-modal' && !e.target.closest('button')) return; 
            const modal = document.getElementById('time-selector-modal'); 
            const content = document.getElementById('time-selector-content'); 
            modal.style.opacity = '0'; content.style.transform = 'translateY(100%)'; 
            setTimeout(() => { modal.style.display = 'none'; }, 300); 
        }

        function renderDateTabs() { 
            const container = document.getElementById('date-tabs-list'); 
            container.innerHTML = pickerState.dates.map((d, idx) => ` 
                <div onclick="selectPickerDate(${idx})" class="date-tab ${idx === pickerState.dateIndex ? 'active' : ''}"> 
                    <div class="text-center leading-tight"> 
                        <div>${d.label}</div> 
                        ${d.sub ? `<div class="text-[10px] opacity-80 mt-1">${d.sub}</div>` : ''} 
                    </div> 
                </div> `).join(''); 
        }

        window.selectPickerDate = function(idx) { 
            pickerState.dateIndex = idx; 
            pickerState.hour = null; 
            renderDateTabs(); 
            renderHourGrid(); 
            renderMinuteGrid();
        }

        function renderHourGrid() { 
            const container = document.getElementById('hour-grid'); 
            const minTime = new Date(new Date().getTime() + 30 * 60000); 
            const selectedDateObj = pickerState.dates[pickerState.dateIndex];
            
            let html = ''; 
            for(let h=0; h<24; h++) { 
                let disabled = '';
                const testTime = new Date(selectedDateObj.rawDate);
                testTime.setHours(h, 59, 59); 

                if (testTime < minTime) { disabled = 'disabled'; }
                const selected = (pickerState.hour === h) ? 'selected' : ''; 
                html += `<button type="button" onclick="selectPickerHour(${h})" class="time-btn ${disabled} ${selected}">${h.toString().padStart(2, '0')}:00</button>`; 
            } 
            container.innerHTML = html; 
        }

        window.selectPickerHour = function(h) { 
            pickerState.hour = h; 
            renderHourGrid(); 
            renderMinuteGrid(); 
        }

        function renderMinuteGrid() { 
            const container = document.getElementById('minute-grid-container'); 
            if (pickerState.hour === null) {
                container.innerHTML = '<div class="col-span-4 text-center text-slate-400 py-6 font-bold bg-slate-50 rounded-2xl border border-dashed border-slate-200">è«‹å…ˆé¸æ“‡ä¸Šæ–¹å°æ™‚</div>';
                return;
            }

            const minTime = new Date(new Date().getTime() + 30 * 60000);
            const selectedDateObj = pickerState.dates[pickerState.dateIndex];

            let html = ''; 
            for(let m=0; m<60; m+=5) { 
                let disabled = '';
                const testTime = new Date(selectedDateObj.rawDate);
                testTime.setHours(pickerState.hour, m, 0);

                if (testTime < minTime) { disabled = 'disabled'; }
                html += `<button type="button" onclick="selectMinute('${m.toString().padStart(2, '0')}')" class="time-btn text-lg ${disabled}">${m.toString().padStart(2, '0')} åˆ†</button>`; 
            } 
            container.innerHTML = html; 
        }

        window.selectMinute = function(m) { 
            pickerState.minute = m; 
            applyBookingTime(); 
            closeModernTimeSelector(); 
        }
        
        function applyBookingTime() { 
            const dateObj = pickerState.dates[pickerState.dateIndex]; 
            const hStr = pickerState.hour.toString().padStart(2, '0'); 
            const timeStr = `${dateObj.fullDate} ${hStr}:${pickerState.minute}`; 
            document.getElementById('booking-time-val').value = timeStr; 
            
            const display = document.getElementById('time-display'); 
            display.innerText = timeStr; 
            display.classList.remove('text-slate-400'); 
            display.classList.add('text-blue-700'); 
            document.getElementById('time-icon').className = "fa-solid fa-calendar-check input-icon text-blue-600 text-xl"; 
        }

        async function submitOrder() {
            if (!liff.isLoggedIn() && !liff.isInClient()) {
                return Swal.fire('å°šæœªé€£ç·š', 'è«‹é‡æ–°æ•´ç†é é¢æˆ–åœ¨ LINE å…§éƒ¨é–‹å•Ÿ', 'error');
            }

            const phone = document.getElementById('phone').value;
            const pickup = document.getElementById('pickup').value.trim();
            let dropoff = document.getElementById('dropoff').value.trim();
            
            if (!dropoff) dropoff = "ä¸Šè»Šå‘ŠçŸ¥ / æœªæŒ‡å®š";
            const payment = document.getElementById('payment-value').value;
            const bookingTime = document.getElementById('booking-time-val').value;

            if(!pickup) return Swal.fire('è«‹å¡«å¯«ä¸Šè»Šé»', 'ç³»çµ±éœ€è¦çŸ¥é“å»å“ªæ¥æ‚¨', 'warning');
            if(!bookingTime) return Swal.fire('è«‹é¸æ“‡æ™‚é–“', 'æ­¤å°ˆæ¡ˆç‚ºé ç´„å«è»Šï¼Œè«‹æŒ‡å®šç”¨è»Šæ™‚é–“', 'warning');
            if(!phone || phone.length < 8) return Swal.fire('è«‹è¼¸å…¥é›»è©±', 'è«‹ç•™ä¸‹è¯çµ¡æ–¹å¼', 'warning');

            localStorage.setItem('taxi_user_phone', phone);
            
            const btn = document.getElementById('submitBtn');
            btn.disabled = true;
            btn.innerHTML = '<div class="loader mr-3 w-5 h-5 border-2 border-white border-t-transparent"></div> è™•ç†ä¸­...';

            const mapBaseUrl = "https://www.google.com/maps/search/?api=1&query=";
            const googleMapUrl = mapBaseUrl + encodeURIComponent(pickup);
            const dropoffMapUrl = mapBaseUrl + encodeURIComponent(dropoff);
            
            const flexMsg = {
                type: "flex",
                altText: `é ç´„ï¼š${bookingTime}`,
                contents: {
                    type: "bubble",
                    styles: { header: { backgroundColor: "#FFFFFF" }, body: { backgroundColor: "#FFFFFF" }, footer: { backgroundColor: "#F8F8F8" } },
                    header: {
                        type: "box", layout: "vertical",
                        contents: [ 
                            { 
                                type: "text", 
                                text: `${bookingTime}`, 
                                weight: "bold", 
                                size: "xxl", 
                                color: "#1d4ed8", 
                                align: "center",
                                adjustMode: "shrink-to-fit" 
                            } 
                        ],
                        paddingAll: "5px"
                    },
                    body: {
                        type: "box", layout: "vertical",
                        contents: [
                            {
                                type: "box", layout: "horizontal", margin: "md",
                                contents: [ { type: "text", text: "ğŸ‘¤ ä¹˜å®¢", flex: 2, color: "#888888", size: "md" }, { type: "text", text: userName, flex: 5, color: "#111111", size: "md", weight: "bold" } ]
                            },
                            { type: "separator", margin: "md", color: "#EEEEEE" },
                            {
                                type: "box", layout: "horizontal", margin: "md",
                                contents: [ { type: "text", text: "ğŸŸ¢ ä¸Šè»Š", flex: 2, color: "#888888", size: "md" }, { type: "text", text: pickup, flex: 5, color: "#111111", size: "md", wrap: true, action: { type: "uri", label: "å°èˆª", uri: googleMapUrl } } ]
                            },
                            { type: "separator", margin: "md", color: "#EEEEEE" },
                            {
                                type: "box", layout: "horizontal", margin: "md",
                                contents: [ { type: "text", text: "ğŸ”´ ä¸‹è»Š", flex: 2, color: "#888888", size: "md" }, { type: "text", text: dropoff, flex: 5, color: "#111111", size: "md", wrap: true, action: { type: "uri", label: "å°èˆª", uri: dropoffMapUrl } } ]
                            },
                            { type: "separator", margin: "lg", color: "#EEEEEE" },
                            {
                                type: "box", layout: "horizontal", margin: "lg",
                                contents: [ { type: "text", text: "ğŸ“ é›»è©±", flex: 2, color: "#888888", size: "md" }, { type: "text", text: phone, flex: 5, color: "#111111", size: "md", weight: "bold", action: { type: "uri", label: "æ’¥è™Ÿ", uri: `tel:${phone}` } } ]
                            },
                            { type: "separator", margin: "lg", color: "#EEEEEE" },
                            {
                                type: "box", layout: "horizontal", margin: "lg",
                                contents: [ { type: "text", text: "ğŸ’° ä»˜æ¬¾", flex: 2, color: "#888888", size: "md" }, { type: "text", text: payment, flex: 5, color: "#111111", size: "md", weight: "bold" } ]
                            }
                        ]
                    },
                    footer: {
                        type: "box", layout: "vertical", spacing: "sm", contents: [
                            {
                                type: "button", style: "primary", color: "#10B981", height: "sm",
                                action: { type: "uri", label: "ğŸ‘€ æŸ¥çœ‹å¸æ©Ÿä½ç½®", uri: PROJECT_B_URL }
                            }
                        ]
                    }
                }
            };

            try {
                if (liff.isInClient()) {
                    await liff.sendMessages([flexMsg]);
                    liff.closeWindow(); 
                } else {
                    Swal.fire({ icon: 'info', title: 'å¤–éƒ¨æ¸¬è©¦æ¨¡å¼', text: 'è«‹åœ¨ LINE èŠå¤©å®¤å…§é–‹å•Ÿæ­¤é€£çµï¼Œå¡ç‰‡æ‰èƒ½ç›´æ¥å‚³é€å‡ºå»å–”ï¼' });
                    btn.disabled = false;
                    btn.innerHTML = '<i class="fa-solid fa-paper-plane"></i><span id="submit-btn-text">ç¢ºèªé€å‡ºé ç´„</span>';
                }
            } catch (e) {
                Swal.fire({ icon: 'error', title: 'ç™¼é€å¤±æ•—', text: 'LINE API å›å‚³éŒ¯èª¤: ' + e.message });
                btn.disabled = false;
                btn.innerHTML = '<i class="fa-solid fa-paper-plane"></i><span id="submit-btn-text">ç¢ºèªé€å‡ºé ç´„</span>';
            }
        }
    </script>
</body>
</html>
