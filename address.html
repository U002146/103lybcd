<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å€‹äººè»Šè¡Œï¼šé è·é ç´„</title> // v1.0 ç•°åœ°ç´”é ç´„ç‰ˆ
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

    <style>
        body { font-family: 'Noto Sans TC', sans-serif; background-color: #f8fafc; overflow-x: hidden; min-height: 100vh; display: flex; flex-direction: column; }
        input, select, textarea { font-size: 17px !important; }
        
        .main-container { flex: 1; padding: 20px; padding-bottom: 120px; max-width: 600px; margin: 0 auto; width: 100%; }
        
        /* é ç´„å¡ç‰‡æ¨£å¼ */
        .booking-card { background: white; border-radius: 24px; box-shadow: 0 10px 30px rgba(0,0,0,0.04); padding: 20px; margin-bottom: 20px; border: 1px solid #f1f5f9; }
        
        /* åœ°é»è¼¸å…¥æ¡†çµ„ */
        .location-inputs { position: relative; border: 1px solid #e2e8f0; border-radius: 20px; background: #f8fafc; }
        .loc-row { display: flex; align-items: center; padding: 16px; transition: all 0.2s; }
        .loc-row:focus-within { background: #ffffff; box-shadow: 0 0 0 2px rgba(16, 185, 129, 0.2); border-radius: 20px; }
        .loc-divider { height: 1px; background: #e2e8f0; margin: 0 16px; }
        
        /* æ›¿æ›æŒ‰éˆ• */
        .btn-swap { position: absolute; top: 50%; right: 16px; transform: translateY(-50%); width: 40px; height: 40px; background: white; border: 1px solid #e2e8f0; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: #64748b; box-shadow: 0 4px 10px rgba(0,0,0,0.05); cursor: pointer; transition: all 0.2s; z-index: 10; }
        .btn-swap:active { transform: translateY(-50%) scale(0.9); background: #f1f5f9; }

        .input-group { background-color: #ffffff; border: 1px solid #e2e8f0; border-radius: 16px; padding: 12px 16px; transition: all 0.2s; display: flex; align-items: center; margin-bottom: 16px; }
        .input-group:focus-within { border-color: #3b82f6; box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1); }
        .input-icon { width: 24px; text-align: center; margin-right: 12px; }

        .loader { border: 3px solid #f3f3f3; border-top: 3px solid #10B981; border-radius: 50%; width: 24px; height: 24px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        .swal2-popup { border-radius: 24px !important; font-family: 'Noto Sans TC', sans-serif !important; padding-bottom: 20px !important;}
        .location-grid { max-height: 50vh; overflow-y: auto; padding: 4px; }

        /* Time Picker CSS */
        #time-selector-modal { position: fixed; top: 0; left: 0; right: 0; bottom: 0; z-index: 100; background: rgba(0,0,0,0.5); display: none; justify-content: center; align-items: flex-end; opacity: 0; transition: opacity 0.3s; }
        #time-selector-content { background: white; width: 100%; max-width: 500px; border-top-left-radius: 24px; border-top-right-radius: 24px; padding: 20px; padding-bottom: 40px; transform: translateY(100%); transition: transform 0.3s cubic-bezier(0.2, 0.8, 0.2, 1); max-height: 85vh; display: flex; flex-direction: column; }
        .date-tabs-container { display: flex; overflow-x: auto; gap: 10px; padding-bottom: 10px; margin-bottom: 15px; scrollbar-width: none; }
        .date-tabs-container::-webkit-scrollbar { display: none; }
        .date-tab { flex: 0 0 auto; padding: 8px 16px; border-radius: 99px; background: #f1f5f9; color: #64748b; font-size: 14px; font-weight: bold; cursor: pointer; transition: all 0.2s; border: 1px solid transparent; }
        .date-tab.active { background: #0f172a; color: white; box-shadow: 0 4px 10px rgba(15, 23, 42, 0.2); }
        .time-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; max-height: 300px; overflow-y: auto; }
        .time-btn { appearance: none; padding: 12px 0; border-radius: 12px; background: #ffffff; border: 1px solid #e2e8f0; color: #334155; font-weight: bold; text-align: center; cursor: pointer; transition: all 0.1s; display: flex; align-items: center; justify-content: center; width: 100%; }
        .time-btn:active { transform: scale(0.95); background: #f8fafc; border-color: #94a3b8; }
        .time-btn.selected { background: #e0f2fe; border-color: #3b82f6; color: #1d4ed8; }
        .time-btn.disabled { opacity: 0.3; background: #f1f5f9; pointer-events: none; color: #94a3b8; }
        #minute-selection-view { flex-direction: column; }
    </style>
</head>
<body>

    <div class="bg-white px-6 py-4 shadow-sm flex items-center justify-between sticky top-0 z-40">
        <div>
            <h1 class="text-xl font-black text-slate-800 tracking-wide">å°ˆå±¬é ç´„ç³»çµ±</h1>
            <p class="text-xs text-emerald-600 font-bold mt-0.5">è·¨ç¸£å¸‚å…åœ°åœ– â€¢ ç›´è¦ºç§’é ç´„</p>
        </div>
        <div id="liff-status-dot" class="w-3 h-3 rounded-full bg-red-500 shadow-md"></div>
    </div>

    <div class="main-container">
        
        <div class="booking-card">
            <div class="flex items-center justify-between mb-4">
                <h2 class="text-sm font-bold text-slate-500 uppercase tracking-widest">è¡Œç¨‹è¨­å®š</h2>
            </div>
            
            <div class="location-inputs">
                <div class="loc-row relative">
                    <i class="fa-solid fa-circle-dot text-emerald-500 text-lg mr-4 w-5 text-center"></i>
                    <div class="flex-1 mr-12">
                        <label class="block text-[10px] text-slate-400 font-bold uppercase mb-1">Pickup (ä¸Šè»Šé»)</label>
                        <input type="text" id="pickup" placeholder="è«‹è¼¸å…¥æˆ–é¸æ“‡ä¸Šè»Šåœ°å€" class="w-full bg-transparent font-bold text-slate-800 outline-none text-lg">
                    </div>
                    <button onclick="openPresetLocations('pickup')" class="absolute right-4 p-3 -mr-3 text-yellow-400 active:scale-90 transition-transform"><i class="fa-solid fa-star text-xl drop-shadow-sm"></i></button>
                </div>

                <div class="loc-divider"></div>

                <button onclick="swapLocations()" class="btn-swap" title="èµ·è¨–é»å°èª¿">
                    <i class="fa-solid fa-arrow-right-arrow-left rotate-90 text-slate-500"></i>
                </button>

                <div class="loc-row relative">
                    <i class="fa-solid fa-location-dot text-rose-500 text-xl mr-4 w-5 text-center"></i>
                    <div class="flex-1 mr-12">
                        <label class="block text-[10px] text-slate-400 font-bold uppercase mb-1">Drop-off (ä¸‹è»Šé» â€¢ é¸å¡«)</label>
                        <input type="text" id="dropoff" placeholder="æœªå¡«å‰‡é¡¯ç¤ºï¼šä¸Šè»Šå‘ŠçŸ¥" class="w-full bg-transparent font-bold text-slate-800 outline-none text-lg">
                    </div>
                    <button onclick="openPresetLocations('dropoff')" class="absolute right-4 p-3 -mr-3 text-yellow-400 active:scale-90 transition-transform"><i class="fa-solid fa-star text-xl drop-shadow-sm"></i></button>
                </div>
            </div>
        </div>

        <div class="booking-card">
            <div class="input-group cursor-pointer !bg-blue-50/50 !border-blue-100" onclick="openModernTimeSelector()">
                <i id="time-icon" class="fa-solid fa-calendar-check input-icon text-blue-600 text-xl"></i>
                <div class="flex-1">
                    <label class="block text-[10px] text-blue-500 font-bold uppercase">Pickup Time (ç”¨è»Šæ™‚é–“)</label>
                    <div class="flex items-center justify-between mt-1">
                        <span id="time-display" class="font-bold text-blue-700 text-lg">è«‹é¸æ“‡é ç´„æ™‚é–“</span>
                        <div class="bg-blue-100 text-blue-700 px-2 py-1 rounded-md text-xs font-bold">é»æ“Šé¸æ“‡</div>
                    </div>
                </div>
                <input type="hidden" id="booking-mode" value="RESERVE">
                <input type="hidden" id="booking-time-val" value="">
            </div>

            <div class="input-group">
                <i class="fa-solid fa-phone input-icon text-slate-400"></i>
                <div class="flex-1">
                    <label class="block text-[10px] text-slate-400 font-bold uppercase">Phone (è¯çµ¡é›»è©±)</label>
                    <input type="tel" id="phone" placeholder="09xx-xxx-xxx" class="w-full bg-transparent font-bold text-slate-800 outline-none text-lg">
                </div>
            </div>

            <div class="flex items-center justify-between p-3 bg-gray-50 rounded-xl mt-2 cursor-pointer active:bg-gray-100" onclick="openPaymentPicker()">
                <div class="flex items-center">
                    <i class="fa-solid fa-wallet text-slate-500 mr-3"></i>
                    <span class="text-sm font-bold text-slate-600">ä»˜æ¬¾æ–¹å¼</span>
                </div>
                <div class="flex items-center">
                    <i id="payment-icon-small" class="fa-solid fa-coins text-slate-600 mr-2"></i>
                    <span id="payment-text-small" class="font-bold text-slate-800">ç¾é‡‘</span>
                    <i class="fa-solid fa-chevron-right text-xs text-slate-400 ml-2"></i>
                </div>
                <input type="hidden" id="payment-value" value="ç¾é‡‘">
            </div>
        </div>

    </div>

    <div class="fixed bottom-0 left-0 right-0 p-5 bg-white/95 backdrop-blur-md border-t border-gray-100 z-30 max-w-[600px] mx-auto">
        <button id="submitBtn" onclick="submitOrder()" class="w-full bg-slate-900 text-white font-bold py-4 rounded-2xl shadow-xl shadow-slate-300 active:scale-[0.98] transition-all text-xl flex items-center justify-center space-x-3">
            <i class="fa-solid fa-paper-plane"></i>
            <span id="submit-btn-text">ç¢ºèªé€å‡ºé ç´„</span>
        </button>
    </div>

    <div id="time-selector-modal" onclick="closeModernTimeSelector(event)">
        <div id="time-selector-content" onclick="event.stopPropagation()">
            <div class="flex justify-between items-center mb-4 pb-2 border-b border-gray-100">
                <div class="flex items-baseline"><h3 class="text-xl font-bold text-slate-800 mr-2">é¸æ“‡ç”¨è»Šæ™‚é–“</h3></div>
                <button type="button" onclick="closeModernTimeSelector()" class="w-8 h-8 rounded-full bg-gray-100 text-gray-500 hover:bg-gray-200 flex items-center justify-center"><i class="fa-solid fa-xmark"></i></button>
            </div>
            <button type="button" onclick="selectNowAndClose()" id="btn-quick-now" class="w-full bg-gray-100 text-slate-700 py-3 rounded-xl font-bold mb-4 flex items-center justify-center active:scale-[0.98] transition-transform"><i class="fa-solid fa-bolt mr-2 text-yellow-500"></i> æˆ‘è¦ç¾åœ¨ç«‹åˆ»å‡ºç™¼</button>
            
            <div class="text-xs text-emerald-600 font-bold mb-2 uppercase tracking-wide">é ç´„æœªä¾†æ™‚é–“</div>
            <div id="hour-selection-view"><div class="date-tabs-container" id="date-tabs-list"></div><div class="text-sm text-gray-500 mb-2 font-bold">é¸æ“‡å°æ™‚ (24H)</div><div class="time-grid" id="hour-grid"></div></div>
            <div id="minute-selection-view" class="hidden h-64"><div class="flex items-center mb-4"><button type="button" onclick="backToHourView()" class="mr-3 w-8 h-8 rounded-full border border-gray-200 flex items-center justify-center text-gray-600 active:bg-gray-100"><i class="fa-solid fa-arrow-left"></i></button><span class="text-lg font-bold text-slate-800"><span id="selected-date-display" class="text-slate-500 mr-1 text-base"></span><span id="selected-hour-display" class="text-blue-600 text-2xl"></span><span class="text-slate-400">é»</span></span></div><div class="text-sm text-gray-500 mb-2 font-bold">é¸æ“‡åˆ†é˜ (5åˆ†é–“éš”)</div><div class="grid grid-cols-4 gap-3" id="minute-grid-container"></div></div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <script>
        const VERSION = "v1.0"; // ç•°åœ°ç´”é ç´„ç‰ˆ - æ‹”é™¤åœ°åœ–å„ªåŒ–é•·é€”é ç´„é«”é©—
        
        // --- è¨­å®šèˆ‡ API ---
        const LIFF_ID = '2008907691-MAdAtfyf'; 
        const PROJECT_B_URL = 'https://liff.line.me/2008907691-1mAjwojZ'; 
        const MY_DRIVER_ID = 'U467348846c6b1fa433990d7b75c935b5'; 

        const firebaseConfig = { databaseURL: "https://hualientaxi-bb32f-default-rtdb.asia-southeast1.firebasedatabase.app/" };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        // é è¨­æ¸…å–®
        const PRESET_LOCATIONS = [
            {name:'æˆ‘çš„æœ€æ„› A', icon:'â­', value:'FAV_ADDR_A'},
            {name:'æˆ‘çš„æœ€æ„› B', icon:'â­', value:'FAV_ADDR_B'},
            {name:'èŠ±è“®ç«è»Šç«™', icon:'ğŸš‰'},
            {name:'èŠ±è“®å¾Œç«è»Šç«™', icon:'ğŸš‰'},
            {name:'æ…ˆæ¿Ÿé†«é™¢', icon:'ğŸ¥'},
            {name:'é–€è«¾é†«é™¢', icon:'ğŸ¥'},
            {name:'é æ±ç™¾è²¨', icon:'ğŸ›ï¸'},
            {name:'æ±å¤§é–€å¤œå¸‚', icon:'ğŸŒ­'}
        ];

        const PAYMENT_METHODS = [
            {id:'ç¾é‡‘',label:'ç¾é‡‘',icon:'fa-coins',color:'text-slate-600'},
            {id:'æ•¬è€å¡',label:'æ•¬è€å¡',icon:'fa-person-cane',color:'text-orange-500'},
            {id:'LINE PAY',label:'LINE Pay',icon:'fa-brands fa-line',color:'text-green-500'},
            {id:'TWRQ',label:'TWRQ',icon:'fa-qrcode',color:'text-purple-500'}
        ];

        let pickerState = { dateIndex: 0, hour: null, minute: null, dates: [] };
        let currentTargetInput = 'pickup'; // è¨˜éŒ„ç›®å‰æ“ä½œçš„æ˜¯ä¸Šè»Šé‚„æ˜¯ä¸‹è»Š

        window.onload = function() {
            initLiff();
            const savedPhone = localStorage.getItem('taxi_user_phone');
            if(savedPhone) document.getElementById('phone').value = savedPhone;
            
            const savedPayment = localStorage.getItem('taxi_selected_payment');
            if(savedPayment) { 
                const method = PAYMENT_METHODS.find(m => m.label === savedPayment); 
                if(method) updatePaymentUI(method.label, method.icon, method.color); 
            }
        };

        async function initLiff() {
            try { 
                await liff.init({ liffId: LIFF_ID }); 
                if(liff.isLoggedIn()) {
                    document.getElementById('liff-status-dot').classList.remove('bg-red-500'); 
                    document.getElementById('liff-status-dot').classList.add('bg-green-500');
                }
            } catch (e) { console.error('LIFF Init Failed:', e); }
        }

        // --- åœ°é»äº’æ›åŠŸèƒ½ ---
        function swapLocations() {
            const pickupEl = document.getElementById('pickup');
            const dropoffEl = document.getElementById('dropoff');
            const temp = pickupEl.value;
            pickupEl.value = dropoffEl.value;
            dropoffEl.value = temp;
            
            // è¦–è¦ºéœ‡å‹•å›é¥‹
            const inputs = document.querySelectorAll('.loc-row');
            inputs.forEach(el => {
                el.style.transform = 'scale(0.98)';
                setTimeout(() => el.style.transform = 'scale(1)', 150);
            });
        }

        // --- å¸¸ç”¨åœ°å€åŠŸèƒ½ ---
        function openPresetLocations(target) { 
            currentTargetInput = target; // è¨­å®šç›®æ¨™è¼¸å…¥æ¡† ('pickup' æˆ– 'dropoff')
            const targetName = target === 'pickup' ? 'ä¸Šè»Šé»' : 'ä¸‹è»Šé»';
            
            let html = '<div class="grid grid-cols-2 gap-3 mt-2 location-grid">'; 
            PRESET_LOCATIONS.forEach(loc => { 
                let bgClass = (loc.value && loc.value.includes('FAV')) ? 'bg-yellow-50 hover:bg-yellow-100 border-yellow-200' : 'bg-gray-50 hover:bg-slate-100 border-gray-100'; 
                html += `<button type="button" onclick="selectPreset('${loc.value || loc.name}', '${loc.name}')" class="flex flex-col items-center justify-center p-3 border rounded-xl transition-all active:scale-95 ${bgClass}"><span class="text-2xl mb-1">${loc.icon}</span><span class="text-sm font-bold text-slate-700">${loc.name}</span></button>`; 
            }); 
            html += '</div>'; 
            
            Swal.fire({ 
                title: `å¿«é€Ÿé¸æ“‡${targetName}`, 
                html: html, 
                showConfirmButton: false, 
                showCloseButton: true, 
                customClass: {popup: 'rounded-[24px]'} 
            }); 
        }

        window.selectPreset = function(val, label) { 
            const input = document.getElementById(currentTargetInput); 
            if (val.includes('FAV')) { 
                const key = val === 'FAV_ADDR_A' ? 'taxi_fav_a' : 'taxi_fav_b'; 
                const savedAddr = localStorage.getItem(key); 
                if (savedAddr) { 
                    Swal.fire({ 
                        title: `ğŸ“ ä½¿ç”¨ã€Œ${label}ã€ï¼Ÿ`, 
                        text: savedAddr, 
                        showDenyButton: true, 
                        confirmButtonText: 'å¡«å…¥', 
                        denyButtonText: 'ä¿®æ”¹åœ°å€', 
                        confirmButtonColor: '#10b981', 
                        denyButtonColor: '#94a3b8' 
                    }).then((r) => { 
                        if (r.isConfirmed) { input.value = savedAddr; Swal.close(); } 
                        else if (r.isDenied) { promptSave(key, label, input); } 
                    }); 
                } else { 
                    promptSave(key, label, input); 
                } 
            } else { 
                input.value = val; 
                Swal.close(); 
            } 
        };

        function promptSave(key, label, input) { 
            Swal.fire({ 
                title: `è¨­å®š${label}`, 
                input: 'text', 
                inputPlaceholder: 'è«‹è¼¸å…¥å®Œæ•´åœ°å€...', 
                showCancelButton: true, 
                confirmButtonText: 'è¨˜æ†¶ä¸¦å¥—ç”¨', 
                confirmButtonColor: '#0f172a' 
            }).then((r) => { 
                if (r.isConfirmed && r.value) { 
                    localStorage.setItem(key, r.value); 
                    input.value = r.value; 
                    Swal.fire({ icon: 'success', title: 'å·²è¨˜æ†¶ï¼', timer: 1000, showConfirmButton: false }); 
                } 
            }); 
        }

        // --- ä»˜æ¬¾æ–¹å¼ ---
        function openPaymentPicker() { 
            let html = '<div class="grid grid-cols-2 gap-3 mt-2 location-grid">'; 
            const currentVal = document.getElementById('payment-value').value; 
            PAYMENT_METHODS.forEach(m => { 
                let activeClass = m.label === currentVal ? 'border-slate-800 bg-slate-900 text-white ring-2 ring-slate-200' : 'bg-white border-gray-200 text-slate-600 hover:bg-gray-50'; 
                let iconColor = m.label === currentVal ? 'text-white' : m.color; 
                html += `<button type="button" onclick="selectPaymentMethod('${m.label}', '${m.icon}', '${m.color}')" class="flex flex-col items-center justify-center p-3 border rounded-2xl transition-all active:scale-95 ${activeClass}"><i class="fa-solid ${m.icon} ${iconColor} text-xl mb-1"></i><span class="text-sm font-bold">${m.label}</span></button>`; 
            }); 
            html += '</div>'; 
            Swal.fire({ title: 'é¸æ“‡ä»˜æ¬¾æ–¹å¼', html: html, showConfirmButton: false, showCloseButton: true, customClass: {popup: 'rounded-[24px]'} }); 
        }
        window.selectPaymentMethod = function(label, iconClass, colorClass) { 
            updatePaymentUI(label, iconClass, colorClass); 
            localStorage.setItem('taxi_selected_payment', label); 
            Swal.close(); 
        }
        function updatePaymentUI(label, iconClass, colorClass) { 
            document.getElementById('payment-value').value = label; 
            document.getElementById('payment-text-small').innerText = label; 
            const iconElem = document.getElementById('payment-icon-small'); 
            iconElem.className = `fa-solid ${iconClass} text-slate-600 mr-2`; 
            if(label !== 'ç¾é‡‘') iconElem.classList.add(colorClass.split(' ')[0]); 
        }

        // --- æ™‚é–“é¸æ“‡å™¨é‚è¼¯ ---
        function generateDates() { const dates = []; const today = new Date(); const weekDays = ['æ—¥','ä¸€','äºŒ','ä¸‰','å››','äº”','å…­']; for(let i=0; i<7; i++) { const d = new Date(today); d.setDate(today.getDate() + i); const m = (d.getMonth()+1).toString(); const day = d.getDate().toString(); const w = weekDays[d.getDay()]; const label = i === 0 ? 'ä»Šå¤©' : (i === 1 ? 'æ˜å¤©' : `${m}/${day}`); dates.push({ val: i, label: label, sub: i > 1 ? `é€±${w}` : '', fullDate: `${m}æœˆ${day}æ—¥` }); } return dates; }
        function openModernTimeSelector() { const modal = document.getElementById('time-selector-modal'); const content = document.getElementById('time-selector-content'); pickerState.dates = generateDates(); renderDateTabs(); renderHourGrid(); document.getElementById('hour-selection-view').classList.remove('hidden'); document.getElementById('minute-selection-view').classList.add('hidden'); document.getElementById('minute-selection-view').classList.remove('flex'); modal.style.display = 'flex'; setTimeout(() => { modal.style.opacity = '1'; content.style.transform = 'translateY(0)'; }, 10); }
        function closeModernTimeSelector(e) { if(e && e.target.id !== 'time-selector-modal' && !e.target.closest('button')) return; const modal = document.getElementById('time-selector-modal'); const content = document.getElementById('time-selector-content'); modal.style.opacity = '0'; content.style.transform = 'translateY(100%)'; setTimeout(() => { modal.style.display = 'none'; }, 300); }
        function renderDateTabs() { const container = document.getElementById('date-tabs-list'); container.innerHTML = pickerState.dates.map((d, idx) => ` <div onclick="selectPickerDate(${idx})" class="date-tab ${idx === pickerState.dateIndex ? 'active' : ''}"> <div class="text-center leading-tight"> <div>${d.label}</div> ${d.sub ? `<div class="text-[10px] opacity-80">${d.sub}</div>` : ''} </div> </div> `).join(''); }
        window.selectPickerDate = function(idx) { pickerState.dateIndex = idx; renderDateTabs(); renderHourGrid(); }
        function renderHourGrid() { const container = document.getElementById('hour-grid'); const currentHour = new Date().getHours(); let html = ''; for(let h=0; h<24; h++) { const isPast = pickerState.dateIndex === 0 && h <= currentHour; const displayH = h.toString().padStart(2, '0'); const disabledClass = isPast ? 'disabled' : ''; html += `<button type="button" onclick="selectPickerHour(${h})" class="time-btn ${disabledClass}">${displayH}:00</button>`; } container.innerHTML = html; }
        window.selectPickerHour = function(h) { pickerState.hour = h; const hourView = document.getElementById('hour-selection-view'); const minView = document.getElementById('minute-selection-view'); hourView.classList.add('hidden'); minView.classList.remove('hidden'); minView.classList.add('flex'); const dateObj = pickerState.dates[pickerState.dateIndex]; document.getElementById('selected-date-display').innerText = dateObj.fullDate; document.getElementById('selected-hour-display').innerText = h.toString().padStart(2, '0'); renderMinuteGrid(); }
        function renderMinuteGrid() { const container = document.getElementById('minute-grid-container'); let html = ''; for(let m=0; m<60; m+=5) { const displayM = m.toString().padStart(2, '0'); html += `<button type="button" onclick="selectMinute('${displayM}')" class="time-btn text-lg">${displayM} åˆ†</button>`; } container.innerHTML = html; }
        window.backToHourView = function() { document.getElementById('minute-selection-view').classList.add('hidden'); document.getElementById('minute-selection-view').classList.remove('flex'); document.getElementById('hour-selection-view').classList.remove('hidden'); }
        window.selectMinute = function(m) { pickerState.minute = m; applyBookingTime(); closeModernTimeSelector(); }
        
        window.selectNowAndClose = function() { 
            document.getElementById('booking-mode').value = 'NOW'; 
            document.getElementById('booking-time-val').value = ''; 
            const display = document.getElementById('time-display'); 
            display.innerText = "ç¾åœ¨ç«‹åˆ»å‡ºç™¼"; 
            display.classList.remove('text-blue-700'); 
            display.classList.add('text-slate-800'); 
            document.getElementById('time-icon').className = "fa-solid fa-bolt input-icon text-yellow-500 text-xl"; 
            document.getElementById('submit-btn-text').innerText = "ç¢ºèªå«è»Š (å³æ™‚)"; 
            closeModernTimeSelector(); 
        }
        
        function applyBookingTime() { 
            document.getElementById('booking-mode').value = 'RESERVE'; 
            const dateObj = pickerState.dates[pickerState.dateIndex]; 
            const hStr = pickerState.hour.toString().padStart(2, '0'); 
            const timeStr = `${dateObj.fullDate} ${hStr}:${pickerState.minute}`; 
            document.getElementById('booking-time-val').value = timeStr; 
            const display = document.getElementById('time-display'); 
            display.innerText = timeStr; 
            display.classList.remove('text-slate-800'); 
            display.classList.add('text-blue-700'); 
            document.getElementById('time-icon').className = "fa-solid fa-calendar-check input-icon text-blue-600 text-xl"; 
            document.getElementById('submit-btn-text').innerText = "ç¢ºèªé ç´„"; 
        }

        // --- é€å‡ºè¨‚å–® (å­—ä¸²ç´”æ·¨ç‰ˆ) ---
        async function submitOrder() {
            const phone = document.getElementById('phone').value;
            const pickup = document.getElementById('pickup').value.trim();
            let dropoff = document.getElementById('dropoff').value.trim();
            
            if (!dropoff) dropoff = "ä¸Šè»Šå‘ŠçŸ¥ / æœªæŒ‡å®š";
            const payment = document.getElementById('payment-value').value;
            const bookingMode = document.getElementById('booking-mode').value;
            const bookingTime = document.getElementById('booking-time-val').value;

            // æ“‹ä¸‹å¿…å¡«é …ç›®
            if(!pickup) return Swal.fire('è«‹å¡«å¯«ä¸Šè»Šé»', 'ç³»çµ±éœ€è¦çŸ¥é“å»å“ªæ¥æ‚¨', 'warning');
            if(bookingMode === 'RESERVE' && !bookingTime) return Swal.fire('è«‹é¸æ“‡æ™‚é–“', 'æ‚¨é‚„æ²’æŒ‡å®šç”¨è»Šæ™‚é–“å–”', 'warning');
            if(!phone || phone.length < 8) return Swal.fire('è«‹è¼¸å…¥é›»è©±', 'è«‹ç•™ä¸‹è¯çµ¡æ–¹å¼', 'warning');

            localStorage.setItem('taxi_user_phone', phone);
            
            const btn = document.getElementById('submitBtn');
            btn.disabled = true;
            btn.innerHTML = '<div class="loader mr-3 w-5 h-5 border-2 border-white border-t-transparent"></div> è™•ç†ä¸­...';

            // ğŸš€ æ”¹ç”¨ Google Maps æ–‡å­—æœå°‹ URL
            const mapBaseUrl = "https://www.google.com/maps/search/?api=1&query=";
            const googleMapUrl = mapBaseUrl + encodeURIComponent(pickup);
            const dropoffMapUrl = mapBaseUrl + encodeURIComponent(dropoff);
            
            const nowTimeStr = new Date().toLocaleTimeString('zh-TW', {hour:'2-digit', minute:'2-digit', hour12:false});
            let headerTitle = bookingMode === 'NOW' ? `å³æ™‚å–® ${nowTimeStr}` : `é ç´„å–® ${bookingTime}`;
            let headerColor = bookingMode === 'NOW' ? "#000000" : "#1d4ed8";

            // 1. å¯«å…¥ Firebase (ç§»é™¤ lat/lngï¼Œç´”å­—ä¸²)
            try {
                await db.ref(`drivers/${MY_DRIVER_ID}/request`).set({
                    pickup: pickup,
                    dropoff: dropoff,
                    mode: bookingMode,
                    bookingTime: bookingTime,
                    timestamp: firebase.database.ServerValue.TIMESTAMP
                });
            } catch(e) {
                console.error("Firebase Error", e);
            }

            // 2. ç”¢ç”Ÿ Flex Message
            const flexMsg = {
                type: "flex",
                altText: bookingMode === 'NOW' ? "ğŸš• å³æ™‚å«è»Š" : "ğŸ“… é è·é ç´„",
                contents: {
                    type: "bubble",
                    styles: { header: { backgroundColor: "#FFFFFF" }, body: { backgroundColor: "#FFFFFF" }, footer: { backgroundColor: "#F8F8F8" } },
                    header: {
                        type: "box", layout: "vertical",
                        contents: [ { type: "text", text: headerTitle, weight: "bold", size: "xxl", color: headerColor, align: "center" } ],
                        paddingAll: "5px"
                    },
                    body: {
                        type: "box", layout: "vertical",
                        contents: [
                            {
                                type: "box", layout: "horizontal", margin: "md",
                                contents: [ { type: "text", text: "ğŸŸ¢ ä¸Šè»Š", flex: 2, color: "#888888", size: "md" }, { type: "text", text: pickup, flex: 5, color: "#111111", size: "md", wrap: true, action: { type: "uri", label: "å°èˆª", uri: googleMapUrl } } ]
                            },
                            { type: "separator", margin: "md", color: "#EEEEEE" },
                            {
                                type: "box", layout: "horizontal", margin: "md",
                                contents: [ { type: "text", text: "ğŸ”´ ä¸‹è»Š", flex: 2, color: "#888888", size: "md" }, { type: "text", text: dropoff, flex: 5, color: "#111111", size: "md", wrap: true, action: { type: "uri", label: "å°èˆª", uri: dropoffMapUrl } } ]
                            },
                            { type: "separator", margin: "lg", color: "#EEEEEE" },
                            {
                                type: "box", layout: "horizontal", margin: "lg",
                                contents: [ { type: "text", text: "ğŸ“ é›»è©±", flex: 2, color: "#888888", size: "md" }, { type: "text", text: phone, flex: 5, color: "#111111", size: "md", weight: "bold", action: { type: "uri", label: "æ’¥è™Ÿ", uri: `tel:${phone}` } } ]
                            },
                            { type: "separator", margin: "lg", color: "#EEEEEE" },
                            {
                                type: "box", layout: "horizontal", margin: "lg",
                                contents: [ { type: "text", text: "ğŸ’° ä»˜æ¬¾", flex: 2, color: "#888888", size: "md" }, { type: "text", text: payment, flex: 5, color: "#111111", size: "md", weight: "bold" } ]
                            }
                        ]
                    },
                    footer: {
                        type: "box", layout: "vertical", spacing: "sm", contents: [
                            {
                                type: "button", style: "primary", color: "#10B981", height: "sm",
                                action: { type: "uri", label: "ğŸ‘€ æŸ¥çœ‹å¸æ©Ÿä½ç½®", uri: PROJECT_B_URL }
                            }
                        ]
                    }
                }
            };

            try {
                if (liff.isInClient()) {
                    await liff.sendMessages([flexMsg]);
                    liff.closeWindow(); 
                } else {
                    Swal.fire({ icon: 'success', title: 'é ç´„å·²é€å‡º', text: 'ç´”æ–‡å­—é ç´„å–®å·²å¯«å…¥ Firebaseã€‚' });
                    btn.disabled = false; btn.innerHTML = '<i class="fa-solid fa-paper-plane mr-2"></i>ç¢ºèªé€å‡ºé ç´„';
                }
            } catch (e) {
                Swal.fire({ icon: 'error', title: 'ç™¼é€å¤±æ•—', text: e.message });
                btn.disabled = false; btn.innerHTML = '<i class="fa-solid fa-paper-plane mr-2"></i>ç¢ºèªé€å‡ºé ç´„';
            }
        }
    </script>
</body>
</html>
