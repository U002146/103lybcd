<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ’ç­å°é»ƒ-èŠ±è“®ç«™</title>
    <meta name="description" content="èŠ±è“®åœ¨åœ°è¨ˆç¨‹è»Šæ’ç­ç³»çµ±">
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/vue@2/dist/vue.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background-color: #f8f9fa; font-family: "Microsoft JhengHei", sans-serif; }
        .zone-card { cursor: pointer; transition: 0.2s; border: 2px solid transparent; }
        .zone-card:active { transform: scale(0.98); }
        .zone-card.full { border-color: #dc3545; background-color: #ffe6e6; opacity: 0.8; }
        .driver-badge { font-size: 0.8rem; background: #ffc107; color: #000; padding: 2px 5px; border-radius: 4px; }
        .loading-mask { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); color: white; display: flex; justify-content: center; align-items: center; z-index: 9999; flex-direction: column; }
    </style>
</head>
<body>

<div id="app" class="container py-3">
    <div v-if="loading" class="loading-mask">
        <div class="spinner-border text-warning mb-2" role="status"></div>
        <div>{{ loadingText }}</div>
    </div>

    <div class="d-flex justify-content-between align-items-center mb-3">
        <h4 class="fw-bold">ğŸš• æ’ç­å¤§å»³</h4>
        <button v-if="!isDriver" @click="showRegModal = true" class="btn btn-sm btn-outline-dark">å¸æ©Ÿè¨»å†Š</button>
        <span v-else class="driver-badge">å¸æ©Ÿ: {{ driverName }}</span>
    </div>

    <div v-if="isDriver && currentZoneId" class="alert alert-warning d-flex justify-content-between align-items-center shadow-sm mb-4">
        <div>
            <small class="text-muted">ç›®å‰ä½ç½®</small><br>
            <strong>ğŸ“ {{ getZoneName(currentZoneId) }}</strong>
        </div>
        <button @click="leaveZone" class="btn btn-danger btn-sm px-3 shadow">
            ä¸‹ç­ / é€€æ’
        </button>
    </div>

    <div class="row g-3">
        <div v-for="zone in zones" :key="zone.id" class="col-6 col-md-4">
            <div class="card h-100 shadow-sm zone-card" 
                 :class="{ full: zone.count >= 10 }"
                 @click="enterZone(zone)">
                <div class="card-body text-center p-2">
                    <h6 class="card-title fw-bold mb-1">{{ zone.name }}</h6>
                    <div class="mt-2">
                        <span class="badge" :class="zone.count >= 10 ? 'bg-danger' : 'bg-success'">
                            {{ zone.count }} / 10 å°
                        </span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div v-if="showRegModal" class="modal d-block" style="background: rgba(0,0,0,0.5)">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">é‹å°‡è¨»å†Š</h5>
                    <button type="button" class="btn-close" @click="showRegModal = false"></button>
                </div>
                <div class="modal-body">
                    <input v-model="regForm.name" class="form-control mb-2" placeholder="æš±ç¨± (å¦‚: é˜¿é¾)">
                    <input v-model="regForm.plate" class="form-control mb-2" placeholder="è»Šè™Ÿ (å¦‚: TDC-1234)">
                    <input v-model="regForm.phone" class="form-control mb-2" placeholder="é›»è©±">
                </div>
                <div class="modal-footer">
                    <button @click="submitRegister" class="btn btn-warning w-100">é€å‡ºå¯©æ ¸</button>
                </div>
            </div>
        </div>
    </div>

    <div v-if="showDriverListModal" class="modal d-block" style="background: rgba(0,0,0,0.5)">
        <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">é¸æ“‡è»Šè¼›</h5>
                    <button type="button" class="btn-close" @click="showDriverListModal = false"></button>
                </div>
                <div class="modal-body">
                    <div v-if="activeDrivers.length === 0" class="text-center text-muted my-3">
                        é™„è¿‘æš«ç„¡æ’ç­è»Šè¼›
                    </div>
                    <div v-for="d in activeDrivers" :key="d.userId" 
                         class="card mb-2 shadow-sm" @click="selectDriver(d)">
                        <div class="card-body d-flex justify-content-between align-items-center">
                            <div>
                                <h6 class="mb-0 fw-bold">{{ d.plate }}</h6>
                                <small class="text-muted">{{ d.name }}</small>
                            </div>
                            <button class="btn btn-sm btn-primary">å«è»Š</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

</div>

<script>
// â˜…â˜…â˜… è«‹å‹™å¿…æª¢æŸ¥é€™å…©è¡Œ â˜…â˜…â˜…
const GAS_URL = 'https://script.google.com/macros/s/AKfycbx4ncVkSKRLIkiisyftbtONCYI1OIbklzTsv4_h5gy4FX2ElcA1sWpKCA51O14cEj3p/exec'; // é€™è£¡è¦å¡«ä½ çš„ GAS ç¶²å€
const LIFF_ID = '2008907691-7ntMtfbA';        // é€™è£¡è¦å¡«ä½ çš„ LIFF ID

new Vue({
    el: '#app',
    data: {
        liffId: LIFF_ID,
        userId: '',
        zones: [],
        isDriver: false,
        driverName: '',
        currentZoneId: '', // è¨˜éŒ„å¸æ©Ÿç•¶å‰ä½ç½®
        loading: true,
        loadingText: 'ç³»çµ±é€£ç·šä¸­...',
        showRegModal: false,
        showDriverListModal: false,
        regForm: { name: '', plate: '', phone: '' },
        activeDrivers: []
    },
    async mounted() {
        await this.initLiff();
    },
    methods: {
        async initLiff() {
            try {
                await liff.init({ liffId: this.liffId });
                if (!liff.isLoggedIn()) {
                    liff.login();
                    return;
                }
                const profile = await liff.getProfile();
                this.userId = profile.userId;
                this.fetchLobby();
            } catch (err) {
                alert('LIFF åˆå§‹åŒ–å¤±æ•—: ' + err);
                this.loading = false;
            }
        },
        async fetchLobby() {
            this.loadingText = 'è®€å–æ’ç­ç‹€æ³...';
            try {
                const res = await axios.post(GAS_URL, JSON.stringify({
                    type: 'getLobbyData',
                    userId: this.userId
                }));
                this.zones = res.data.zones;
                this.isDriver = res.data.isDriver;
                if (this.isDriver && res.data.driverData) {
                    this.driverName = res.data.driverData[1];
                    this.currentZoneId = res.data.driverData[5]; // æ›´æ–°ç›®å‰ä½ç½®
                }
                this.loading = false;
            } catch (err) {
                alert('é€£ç·šéŒ¯èª¤');
                this.loading = false;
            }
        },
        getZoneName(id) {
            const z = this.zones.find(item => item.id === id);
            return z ? z.name : 'æœªçŸ¥å€åŸŸ';
        },
        async leaveZone() {
            if(!confirm('ç¢ºå®šè¦ä¸‹ç­/é€€å‡ºæ’ç­å—ï¼Ÿ')) return;
            this.loading = true;
            this.loadingText = 'é€€ç­è™•ç†ä¸­...';
            try {
                const res = await axios.post(GAS_URL, JSON.stringify({
                    type: 'leaveZone',
                    userId: this.userId
                }));
                alert(res.data.msg);
                this.fetchLobby(); // åˆ·æ–°
            } catch(e) {
                alert('é€£ç·šå¤±æ•—');
                this.loading = false;
            }
        },
        async submitRegister() {
            if(!this.regForm.name || !this.regForm.plate) return alert('è³‡æ–™è«‹å¡«å¯«å®Œæ•´');
            this.loading = true;
            try {
                const res = await axios.post(GAS_URL, JSON.stringify({
                    type: 'register',
                    userId: this.userId,
                    ...this.regForm
                }));
                alert(res.data.msg);
                if(res.data.status === 'success') {
                    liff.sendMessages([{
                        type: 'text',
                        text: `ã€å¸æ©Ÿè¨»å†Šç”³è«‹ã€‘\næš±ç¨±ï¼š${this.regForm.name}\nè»Šè™Ÿï¼š${this.regForm.plate}\né›»è©±ï¼š${this.regForm.phone}\nè«‹ç®¡ç†å“¡å¯©æ ¸ã€‚`
                    }]).then(() => liff.closeWindow());
                }
            } catch(e) { alert('è¨»å†Šå¤±æ•—'); }
            this.loading = false;
        },
        enterZone(zone) {
            if (this.isDriver && zone.count >= 10) return alert('æ­¤å€å·²æ»¿ï¼');
            this.loadingText = 'å®šä½ä¸­...';
            this.loading = true;
            if (!navigator.geolocation) {
                this.loading = false;
                return alert('æ‚¨çš„è£ç½®ä¸æ”¯æ´ GPS');
            }
            navigator.geolocation.getCurrentPosition(async (pos) => {
                const lat = pos.coords.latitude;
                const lng = pos.coords.longitude;
                try {
                    const res = await axios.post(GAS_URL, JSON.stringify({
                        type: 'enterZone',
                        userId: this.userId,
                        zoneId: zone.id,
                        userLat: lat,
                        userLng: lng
                    }));
                    this.loading = false;
                    if (res.data.status === 'error') {
                        alert(res.data.msg);
                    } else if (res.data.role === 'driver') {
                        alert(res.data.msg);
                        this.fetchLobby();
                    } else if (res.data.role === 'passenger') {
                        this.activeDrivers = res.data.drivers;
                        this.showDriverListModal = true;
                    }
                } catch (e) {
                    this.loading = false;
                    alert('ç³»çµ±å¿™ç·šä¸­');
                }
            }, (err) => {
                this.loading = false;
                alert('ç„¡æ³•å–å¾—ä½ç½®ï¼Œè«‹é–‹å•Ÿ GPS');
            }, { enableHighAccuracy: true, timeout: 10000 });
        },
        selectDriver(driver) {
            // ç¾åŒ–ç‰ˆ Flex Message (v2.0)
            const flexMessage = {
                type: 'flex',
                altText: `æ‚¨çš„è»Šè¼› ${driver.plate} å·²ç¢ºèª`,
                contents: {
                    type: "bubble",
                    header: {
                        type: "box",
                        layout: "vertical",
                        contents: [
                            { type: "text", text: "ğŸš– å·²ç‚ºæ‚¨å®‰æ’è»Šè¼›", color: "#856404", size: "xs", weight: "bold" }
                        ],
                        backgroundColor: "#FFF3CD", paddingTop: "15px", paddingBottom: "15px"
                    },
                    hero: {
                        type: "box",
                        layout: "vertical",
                        contents: [
                            { type: "text", text: driver.plate, size: "4xl", weight: "bold", align: "center", color: "#111111", margin: "md" }
                        ],
                        paddingBottom: "10px"
                    },
                    body: {
                        type: "box",
                        layout: "vertical",
                        contents: [
                            { type: "separator", margin: "md", color: "#eeeeee" },
                            {
                                type: "box", layout: "baseline", margin: "lg", spacing: "md",
                                contents: [
                                    { type: "text", text: "å¸æ©Ÿ", color: "#aaaaaa", size: "sm", flex: 2 },
                                    { type: "text", text: driver.name, wrap: true, color: "#666666", size: "lg", weight: "bold", flex: 5 }
                                ]
                            }
                        ]
                    },
                    footer: {
                        type: "box", layout: "vertical", spacing: "sm",
                        contents: [
                            {
                                type: "button", style: "primary", height: "sm", color: "#00C300",
                                action: { type: "uri", label: `ğŸ“ æ’¥æ‰“çµ¦ ${driver.name}`, uri: `tel:${driver.phone}` }
                            },
                            { type: "text", text: "è«‹ç•™æ„ä¾†è»Šï¼Œç¥æ‚¨æ—…é€”æ„‰å¿«", size: "xxs", color: "#aaaaaa", align: "center", margin: "md" }
                        ],
                        paddingAll: "20px"
                    }
                }
            };
            liff.sendMessages([flexMessage]).then(() => {
                liff.closeWindow();
            }).catch(err => {
                console.error(err);
                alert('ç™¼é€å¤±æ•—ï¼Œè«‹å¾ LINE é–‹å•Ÿ');
            });
        }
    }
});
</script>
</body>
</html>
