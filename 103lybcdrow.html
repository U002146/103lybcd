<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ’ç­å°é»ƒ-èŠ±è“®ç«™</title>
    <meta name="description" content="èŠ±è“®åœ¨åœ°è¨ˆç¨‹è»Šæ’ç­ç³»çµ±">
    <meta property="og:title" content="æ’ç­å°é»ƒ-èŠ±è“®ç«™">
    <meta property="og:description" content="é»æ“Šé€²å…¥æ’ç­å¤§å»³ï¼ŒæŸ¥çœ‹å³æ™‚è»Šè¼›ä½ç½®ã€‚">
    
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/vue@2/dist/vue.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

    <style>
        body { background-color: #f0f2f5; font-family: "Microsoft JhengHei", sans-serif; -webkit-overflow-scrolling: touch; }
        .zone-card { cursor: pointer; transition: 0.2s; border: none; border-radius: 12px; }
        .zone-card:active { transform: scale(0.98); }
        .zone-card.full { border: 2px solid #dc3545; background-color: #fff5f5; opacity: 0.8; }
        .driver-badge { font-size: 0.9rem; background: #FFD700; color: #000; padding: 4px 10px; border-radius: 20px; font-weight: bold; }
        .loading-mask { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); color: white; display: flex; justify-content: center; align-items: center; z-index: 9999; flex-direction: column; backdrop-filter: blur(5px); }
        .full-page-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: #f8f9fa; z-index: 2000; overflow-y: auto; padding-bottom: 80px; }
        .driver-card-full { background: white; border-radius: 16px; box-shadow: 0 4px 12px rgba(0,0,0,0.05); margin-bottom: 16px; overflow: hidden; transition: transform 0.2s; border: 1px solid #eee; }
        .driver-card-full:active { transform: scale(0.98); background-color: #fafafa; }
        .tag-badge { font-size: 0.75rem; padding: 4px 8px; border-radius: 6px; background-color: #e9ecef; color: #495057; margin-right: 6px; margin-bottom: 6px; display: inline-block; }
        .tag-badge.pay { background-color: #e3f2fd; color: #0d6efd; } 
        .tag-badge.feature { background-color: #e8f5e9; color: #198754; }
    </style>
</head>
<body>

<div id="app">
    <div v-if="loading" class="loading-mask">
        <div class="spinner-border text-warning mb-3" role="status" style="width: 3rem; height: 3rem;"></div>
        <div class="h5">{{ loadingText }}</div>
    </div>

    <div v-show="!showDriverListFullPage" class="container py-3">
        <div class="d-flex justify-content-between align-items-center mb-4 px-2">
            <div>
                <h3 class="fw-bold mb-0">ğŸš• æ’ç­å¤§å»³</h3>
                <small class="text-muted">èŠ±è“®è¨ˆç¨‹è»Šæ•¸ä½è»ŠéšŠ</small>
            </div>
            <button v-if="!isDriver" @click="showRegModal = true" class="btn btn-outline-dark rounded-pill px-3">
                <i class="fas fa-id-card me-1"></i> å¸æ©Ÿè¨»å†Š
            </button>
            <span v-else class="driver-badge shadow-sm">
                <i class="fas fa-taxi me-1"></i> {{ driverName }}
            </span>
        </div>

        <div v-if="isDriver && currentZoneId" class="alert alert-warning border-0 shadow-sm rounded-3 d-flex justify-content-between align-items-center mb-4 mx-1">
            <div class="d-flex align-items-center">
                <div class="bg-white p-2 rounded-circle me-3 text-warning">
                    <i class="fas fa-map-marker-alt fa-lg"></i>
                </div>
                <div>
                    <small class="text-muted">ç›®å‰æ’ç­ä½ç½®</small><br>
                    <strong class="h5 mb-0">{{ getZoneName(currentZoneId) }}</strong>
                </div>
            </div>
            <button @click="leaveZone" class="btn btn-danger btn-sm px-3 rounded-pill shadow-sm">
                ä¸‹ç­é€€æ’
            </button>
        </div>

        <div class="row g-3">
            <div v-for="zone in zones" :key="zone.id" class="col-6 col-md-4">
                <div class="card h-100 shadow-sm zone-card" 
                     :class="{ full: zone.count >= 10 }"
                     @click="enterZone(zone)">
                    <div class="card-body text-center p-3">
                        <div class="mb-2">
                            <span class="badge rounded-pill" 
                                  :class="zone.count >= 10 ? 'bg-danger' : (zone.count > 0 ? 'bg-success' : 'bg-secondary')">
                                {{ zone.count }} / 10 å°
                            </span>
                        </div>
                        <h6 class="card-title fw-bold text-dark mb-0">{{ zone.name }}</h6>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div v-if="showDriverListFullPage" class="full-page-overlay">
        <div class="bg-white shadow-sm sticky-top px-3 py-3 d-flex align-items-center">
            <button @click="closeDriverList" class="btn btn-light rounded-circle me-3" style="width: 40px; height: 40px;">
                <i class="fas fa-arrow-left"></i>
            </button>
            <div>
                <h5 class="mb-0 fw-bold">é¸æ“‡è»Šè¼›</h5>
                <small class="text-muted">{{ currentZoneName }} ({{ activeDrivers.length }}å°è»Š)</small>
            </div>
        </div>

        <div class="container py-3">
            <div v-if="activeDrivers.length === 0" class="text-center text-muted mt-5">
                <i class="fas fa-car-side fa-3x mb-3 text-light"></i>
                <p>é™„è¿‘æš«ç„¡æ’ç­è»Šè¼›ï¼Œè«‹ç¨å€™å†è©¦ã€‚</p>
            </div>

            <div v-for="d in activeDrivers" :key="d.userId" 
                 class="driver-card-full p-3" @click="selectDriver(d)">
                
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <div class="d-flex align-items-center">
                        <img :src="d.avatar || 'https://via.placeholder.com/50'" 
                             class="rounded-circle me-2 border" width="40" height="40" style="object-fit: cover;">
                        <h4 class="fw-bold text-dark mb-0">{{ d.name }}</h4>
                    </div>
                    <div class="bg-warning text-dark px-3 py-1 rounded-pill fw-bold h5 mb-0 font-monospace">
                        {{ d.plate }}
                    </div>
                </div>

                <hr class="my-2" style="opacity: 0.1">

                <div class="d-flex align-items-center text-secondary mb-3">
                    <i class="fas fa-car me-2"></i>
                    <span class="fw-bold me-2">{{ d.carModel || 'ä¸€èˆ¬è½è»Š' }}</span>
                    <span class="text-muted me-3">|</span>
                    <i class="fas fa-users me-2"></i>
                    <span>{{ d.capacity || '4' }}äººåº§</span>
                </div>

                <div class="d-flex flex-wrap">
                    <span v-for="f in (d.features ? d.features.split(',') : [])" :key="'f'+f" class="tag-badge feature">
                        <i class="fas fa-check-circle me-1"></i>{{ f }}
                    </span>
                    <span v-for="p in (d.payment ? d.payment.split(',') : [])" :key="'p'+p" class="tag-badge pay">
                        <i class="fas fa-credit-card me-1"></i>{{ p }}
                    </span>
                    <span v-if="!d.features && !d.payment" class="tag-badge text-muted">ç„¡ç‰¹æ®Šæ¨™è¨»</span>
                </div>

                <div class="mt-3">
                    <button class="btn btn-success w-100 rounded-pill fw-bold">
                        <i class="fas fa-phone-alt me-2"></i> å‘¼å«å¸æ©Ÿ
                    </button>
                </div>
            </div>
            
            <div class="text-center text-muted small mt-4 mb-5">-- å·²ç¶“åˆ°åº•äº† --</div>
        </div>
    </div>

    <div v-if="showRegModal" class="modal d-block" style="background: rgba(0,0,0,0.5); overflow-y: auto;">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content border-0 shadow">
                <div class="modal-header bg-warning">
                    <h5 class="modal-title fw-bold text-dark"><i class="fas fa-user-plus me-2"></i>é‹å°‡è¨»å†Š</h5>
                    <button type="button" class="btn-close" @click="showRegModal = false"></button>
                </div>
                <div class="modal-body p-4">
                    <div class="mb-3">
                        <label class="form-label text-muted small fw-bold">ç¬¬ä¸€åˆ—ï¼šåŸºæœ¬è³‡æ–™</label>
                        <div class="row g-2">
                            <div class="col-6"><input v-model="regForm.name" class="form-control" placeholder="æš±ç¨±"></div>
                            <div class="col-6"><input v-model="regForm.plate" class="form-control" placeholder="è»Šè™Ÿ"></div>
                        </div>
                        <input v-model="regForm.phone" class="form-control mt-2" placeholder="æ‰‹æ©Ÿè™Ÿç¢¼">
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label text-muted small fw-bold">ç¬¬äºŒåˆ—ï¼šè»Šè¼›è³‡è¨Š</label>
                        <input v-model="regForm.carModel" class="form-control mb-2" placeholder="è»Šå‹é¡è‰²">
                        <select v-model="regForm.capacity" class="form-control">
                            <option value="" disabled selected>å¯è¼‰å®¢äººæ•¸</option>
                            <option value="4">4äºº</option>
                            <option value="5">5äºº (ä¼‘æ—…)</option>
                            <option value="6">6äºº (WISH/Sienna)</option>
                            <option value="8">8äºº (ä¹äººåº§)</option>
                        </select>
                    </div>

                    <div class="mb-3">
                        <label class="form-label text-muted small fw-bold">ç¬¬ä¸‰åˆ—ï¼šæœå‹™èˆ‡æ”¯ä»˜</label>
                        <div class="d-flex flex-wrap gap-2">
                            <div v-for="opt in allOptions" :key="opt" class="form-check form-check-inline border rounded px-2 py-1 m-0">
                                <input class="form-check-input" type="checkbox" :value="opt" v-model="regForm.features">
                                <label class="form-check-label small">{{opt}}</label>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer border-0">
                    <button @click="submitRegister" class="btn btn-dark w-100 rounded-pill py-2">é€å‡ºå¯©æ ¸</button>
                </div>
            </div>
        </div>
    </div>

</div>

<script>
// â˜…â˜…â˜… è«‹å‹™å¿…ä¿®æ”¹é€™å…©è¡Œ â˜…â˜…â˜…
const GAS_URL = 'https://script.google.com/macros/s/AKfycbx4ncVkSKRLIkiisyftbtONCYI1OIbklzTsv4_h5gy4FX2ElcA1sWpKCA51O14cEj3p/exec'; 
const LIFF_ID = '2008907691-je5XDhbB'; 

new Vue({
    el: '#app',
    data: {
        liffId: LIFF_ID,
        userId: '',
        userAvatar: '', 
        zones: [],
        isDriver: false,
        driverName: '',
        currentZoneId: '',
        
        loading: true,
        loadingText: 'ç³»çµ±é€£ç·šä¸­...',
        timer: null, 

        showRegModal: false,
        showDriverListFullPage: false,
        currentZoneName: '',
        currentViewingZoneId: null,

        regForm: { 
            name: '', plate: '', phone: '', 
            carModel: '', capacity: '', features: [] 
        },
        allOptions: [
            'ç„¡è¸è»Š', 'å¯µç‰©å‹å–„', 'æ•¬è€å¡', 'æ„›å¿ƒå¡', 'ä¹˜è»Šåˆ¸', 
            'ä¿¡ç”¨å¡', 'LinePay', 'è‹±èªOK', 'è¼”åŠ©ä¸Šä¸‹è»Š'
        ],
        activeDrivers: []
    },
    async mounted() {
        await this.initLiff();
        // â˜… è‡ªå‹•åˆ·æ–°æ©Ÿåˆ¶ï¼šæ¯ 15 ç§’æ›´æ–°ä¸€æ¬¡
        this.timer = setInterval(() => { this.autoRefresh(); }, 15000); 
    },
    beforeDestroy() {
        if(this.timer) clearInterval(this.timer);
    },
    methods: {
        autoRefresh() {
            if (this.showDriverListFullPage && this.currentViewingZoneId) {
                this.refreshZoneList(this.currentViewingZoneId);
            } else if (!this.showRegModal) {
                this.fetchLobby(true);
            }
        },
        async initLiff() {
            try {
                await liff.init({ liffId: this.liffId });
                if (!liff.isLoggedIn()) { liff.login(); return; }
                const profile = await liff.getProfile();
                this.userId = profile.userId;
                this.userAvatar = profile.pictureUrl; 
                this.fetchLobby(false); 
            } catch (err) { alert('LIFF åˆå§‹åŒ–å¤±æ•—'); this.loading = false; }
        },
        async fetchLobby(isBackground = false) {
            if (!isBackground) { this.loadingText = 'è®€å–æ’ç­ç‹€æ³...'; this.loading = true; }
            try {
                const res = await axios.post(GAS_URL, JSON.stringify({ type: 'getLobbyData', userId: this.userId }));
                this.zones = res.data.zones;
                this.isDriver = res.data.isDriver;
                if (this.isDriver && res.data.driverData) {
                    this.driverName = res.data.driverData[1];
                    this.currentZoneId = res.data.driverData[5];
                }
                if (!isBackground) this.loading = false;
            } catch (err) { if (!isBackground) this.loading = false; }
        },
        getZoneName(id) {
            const z = this.zones.find(item => item.id === id);
            return z ? z.name : 'æœªçŸ¥å€åŸŸ';
        },
        async leaveZone() {
            if(!confirm('ç¢ºå®šè¦ä¸‹ç­/é€€å‡ºæ’ç­å—ï¼Ÿ')) return;
            this.loading = true;
            try {
                await axios.post(GAS_URL, JSON.stringify({ type: 'leaveZone', userId: this.userId }));
                this.fetchLobby(false);
            } catch(e) { alert('é€£ç·šå¤±æ•—'); this.loading = false; }
        },
        async submitRegister() {
            const f = this.regForm;
            if(!f.name || !f.plate || !f.phone || !f.carModel || !f.capacity) return alert('è«‹å¡«å¯«å®Œæ•´è³‡æ–™');
            
            const paymentKw = ['ä¿¡ç”¨å¡', 'LinePay', 'æ•¬è€å¡', 'æ„›å¿ƒå¡', 'ä¹˜è»Šåˆ¸'];
            const paymentList = f.features.filter(i => paymentKw.some(k => i.includes(k)));
            const featureList = f.features.filter(i => !paymentKw.some(k => i.includes(k)));

            this.loading = true;
            try {
                const res = await axios.post(GAS_URL, JSON.stringify({
                    type: 'register',
                    userId: this.userId,
                    avatar: this.userAvatar, 
                    name: f.name,
                    plate: f.plate,
                    phone: "'" + f.phone, // â˜… è¨»å†Šè£œå–®å¼•è™Ÿ
                    carModel: f.carModel,
                    capacity: f.capacity,
                    features: featureList.join(','), 
                    payment: paymentList.join(',')
                }));
                alert(res.data.msg);
                if(res.data.status === 'success') { liff.closeWindow(); }
            } catch(e) { alert('è¨»å†Šå¤±æ•—'); }
            this.loading = false;
        },
        enterZone(zone) {
            if (this.isDriver && zone.count >= 10) return alert('æ­¤å€å·²æ»¿ï¼');
            this.loadingText = 'å®šä½ä¸­...';
            this.loading = true;
            if (!navigator.geolocation) { this.loading = false; return alert('ä¸æ”¯æ´ GPS'); }
            navigator.geolocation.getCurrentPosition(async (pos) => {
                this.handleZoneEntry(zone, pos.coords.latitude, pos.coords.longitude, false);
            }, (err) => { this.loading = false; alert('è«‹é–‹å•Ÿ GPS'); }, { enableHighAccuracy: true });
        },
        // â˜… èƒŒæ™¯åˆ·æ–°ï¼šå‚³é€ 0,0 åº§æ¨™
        async refreshZoneList(zoneId) {
             try {
                const res = await axios.post(GAS_URL, JSON.stringify({
                    type: 'enterZone', userId: this.userId, zoneId: zoneId, userLat: 0, userLng: 0
                }));
                if (res.data.role === 'passenger') { this.activeDrivers = res.data.drivers; }
             } catch(e) { console.log('Auto refresh failed'); }
        },
        async handleZoneEntry(zone, lat, lng, isBackground) {
             try {
                const res = await axios.post(GAS_URL, JSON.stringify({
                    type: 'enterZone', userId: this.userId, zoneId: zone.id, userLat: lat, userLng: lng
                }));
                if (!isBackground) this.loading = false;
                
                if (res.data.status === 'error') {
                    if(!isBackground) alert(res.data.msg); 
                } else if (res.data.role === 'driver') {
                    if(!isBackground) alert(res.data.msg);
                    this.fetchLobby(isBackground);
                } else if (res.data.role === 'passenger') {
                    this.activeDrivers = res.data.drivers;
                    this.currentZoneName = zone.name;
                    this.currentViewingZoneId = zone.id;
                    this.showDriverListFullPage = true; 
                }
            } catch (e) { if(!isBackground) { this.loading = false; alert('å¿™ç·šä¸­'); } }
        },
        closeDriverList() {
            this.showDriverListFullPage = false;
            this.currentViewingZoneId = null;
            this.fetchLobby(false); 
        },
        selectDriver(driver) {
            const flexMessage = {
                type: 'flex',
                altText: `æ¨è–¦è»Šè¼› ${driver.plate}`,
                contents: {
                    type: "bubble",
                    header: {
                        type: "box", layout: "vertical",
                        contents: [ { type: "text", text: "ğŸš– æ¨è–¦è»Šè¼›", color: "#856404", size: "xs", weight: "bold" } ],
                        backgroundColor: "#FFF3CD", paddingTop: "15px", paddingBottom: "15px"
                    },
                    hero: {
                        type: "box", layout: "vertical",
                        contents: [
                            { type: "image", url: driver.avatar || "https://via.placeholder.com/150", size: "lg", aspectMode: "cover", aspectRatio: "1:1", action: { type: "uri", uri: driver.avatar || "https://line.me" }, margin: "md" },
                            { type: "text", text: driver.plate, size: "3xl", weight: "bold", align: "center", margin: "md" },
                            { type: "text", text: `${driver.carModel} (${driver.capacity}äºº)`, size: "sm", color: "#666666", align: "center" }
                        ],
                        paddingBottom: "10px"
                    },
                    body: {
                        type: "box", layout: "vertical",
                        contents: [
                            { type: "separator", margin: "md", color: "#eeeeee" },
                            { type: "box", layout: "vertical", margin: "md", spacing: "sm", contents: [
                                    { type: "text", text: "æœå‹™èˆ‡æ”¯ä»˜", color: "#aaaaaa", size: "xs" },
                                    { type: "text", text: (driver.features + ',' + driver.payment).replace(/^,|,$/g,''), wrap: true, color: "#666666", size: "sm" }
                                ] }
                        ]
                    },
                    footer: {
                        type: "box", layout: "vertical", spacing: "sm",
                        contents: [ { type: "button", style: "primary", color: "#00C300", action: { type: "uri", label: `ğŸ“ å‘¼å« ${driver.name}`, uri: `tel:${driver.phone}` } } ],
                        paddingAll: "20px"
                    }
                }
            };
            liff.sendMessages([flexMessage]).then(() => liff.closeWindow());
        }
    }
});
</script>
</body>
</html>
