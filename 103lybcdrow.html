<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ’ç­å°é»ƒ-èŠ±è“®ç«™</title>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/vue@2/dist/vue.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background-color: #f8f9fa; font-family: "Microsoft JhengHei", sans-serif; }
        .zone-card { cursor: pointer; transition: 0.2s; border: 2px solid transparent; }
        .zone-card:active { transform: scale(0.98); }
        .zone-card.full { border-color: #dc3545; background-color: #ffe6e6; opacity: 0.8; }
        .driver-badge { font-size: 0.8rem; background: #ffc107; color: #000; padding: 2px 5px; border-radius: 4px; }
        .loading-mask { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); color: white; display: flex; justify-content: center; align-items: center; z-index: 9999; flex-direction: column; }
        .feature-tag { font-size: 0.7rem; background: #e9ecef; border-radius: 10px; padding: 2px 6px; margin-right: 4px; display: inline-block; }
    </style>
</head>
<body>

<div id="app" class="container py-3">
    <div v-if="loading" class="loading-mask">
        <div class="spinner-border text-warning mb-2" role="status"></div>
        <div>{{ loadingText }}</div>
    </div>

    <div class="d-flex justify-content-between align-items-center mb-3">
        <h4 class="fw-bold">ğŸš• æ’ç­å¤§å»³</h4>
        <button v-if="!isDriver" @click="showRegModal = true" class="btn btn-sm btn-outline-dark">å¸æ©Ÿè¨»å†Š</button>
        <span v-else class="driver-badge">å¸æ©Ÿ: {{ driverName }}</span>
    </div>

    <div v-if="isDriver && currentZoneId" class="alert alert-warning d-flex justify-content-between align-items-center shadow-sm mb-4">
        <div>
            <small class="text-muted">ç›®å‰ä½ç½®</small><br>
            <strong>ğŸ“ {{ getZoneName(currentZoneId) }}</strong>
        </div>
        <button @click="leaveZone" class="btn btn-danger btn-sm px-3 shadow">é€€ç­</button>
    </div>

    <div class="row g-3">
        <div v-for="zone in zones" :key="zone.id" class="col-6 col-md-4">
            <div class="card h-100 shadow-sm zone-card" 
                 :class="{ full: zone.count >= 10 }"
                 @click="enterZone(zone)">
                <div class="card-body text-center p-2">
                    <h6 class="card-title fw-bold mb-1">{{ zone.name }}</h6>
                    <div class="mt-2">
                        <span class="badge" :class="zone.count >= 10 ? 'bg-danger' : 'bg-success'">
                            {{ zone.count }} / 10 å°
                        </span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div v-if="showRegModal" class="modal d-block" style="background: rgba(0,0,0,0.5); overflow-y: auto;">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">é‹å°‡è¨»å†Š (è³‡æ–™å®Œå–„ç‰ˆ)</h5>
                    <button type="button" class="btn-close" @click="showRegModal = false"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-2">
                        <label class="form-label text-muted small">åŸºæœ¬è³‡æ–™</label>
                        <input v-model="regForm.name" class="form-control mb-2" placeholder="æš±ç¨± (å¦‚: é˜¿é¾)">
                        <input v-model="regForm.plate" class="form-control mb-2" placeholder="è»Šè™Ÿ (å¦‚: TDC-1234)">
                        <input v-model="regForm.phone" class="form-control mb-2" placeholder="æ‰‹æ©Ÿè™Ÿç¢¼">
                    </div>
                    
                    <div class="mb-2">
                        <label class="form-label text-muted small">è»Šè¼›è³‡è¨Š</label>
                        <input v-model="regForm.carModel" class="form-control mb-2" placeholder="è»Šå‹é¡è‰² (å¦‚: Toyota Altis ç™½)">
                        <select v-model="regForm.capacity" class="form-control mb-2">
                            <option value="" disabled selected>å¯è¼‰å®¢äººæ•¸</option>
                            <option value="4">4äºº</option>
                            <option value="6">6äºº (WISH/Sienna)</option>
                            <option value="8">8äºº (ä¹äººåº§)</option>
                        </select>
                    </div>

                    <div class="mb-2">
                        <label class="form-label text-muted small">å‹å–„ç‰¹è³ª (å¯è¤‡é¸)</label>
                        <div class="d-flex flex-wrap gap-2">
                            <div v-for="opt in featureOptions" :key="opt" class="form-check form-check-inline">
                                <input class="form-check-input" type="checkbox" :value="opt" v-model="regForm.features">
                                <label class="form-check-label small">{{opt}}</label>
                            </div>
                        </div>
                    </div>

                    <div class="mb-2">
                        <label class="form-label text-muted small">æ”¯ä»˜æ–¹å¼ (å¯è¤‡é¸)</label>
                        <div class="d-flex flex-wrap gap-2">
                            <div v-for="opt in paymentOptions" :key="opt" class="form-check form-check-inline">
                                <input class="form-check-input" type="checkbox" :value="opt" v-model="regForm.payment">
                                <label class="form-check-label small">{{opt}}</label>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button @click="submitRegister" class="btn btn-warning w-100">é€å‡ºå¯©æ ¸</button>
                </div>
            </div>
        </div>
    </div>

    <div v-if="showDriverListModal" class="modal d-block" style="background: rgba(0,0,0,0.5)">
        <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">é¸æ“‡è»Šè¼›</h5>
                    <button type="button" class="btn-close" @click="showDriverListModal = false"></button>
                </div>
                <div class="modal-body p-2">
                    <div v-if="activeDrivers.length === 0" class="text-center text-muted my-3">
                        é™„è¿‘æš«ç„¡æ’ç­è»Šè¼›
                    </div>
                    <div v-for="d in activeDrivers" :key="d.userId" 
                         class="card mb-2 shadow-sm border-0" @click="selectDriver(d)">
                        <div class="card-body p-3">
                            <div class="d-flex align-items-center">
                                <img :src="d.avatar || 'https://via.placeholder.com/50'" class="rounded-circle me-3" width="50" height="50" style="object-fit: cover;">
                                <div class="flex-grow-1">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <h5 class="mb-0 fw-bold text-dark">{{ d.plate }}</h5>
                                        <span class="badge bg-primary rounded-pill">{{ d.capacity }}äººåº§</span>
                                    </div>
                                    <div class="small text-muted mb-1">{{ d.carModel }} | {{ d.name }}</div>
                                    <div v-if="d.features">
                                        <span v-for="f in d.features.split(',')" class="feature-tag">{{f}}</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

</div>

<script>
// â˜…â˜…â˜… è«‹ç¢ºèªé€™å…©è¡Œ â˜…â˜…â˜…
const GAS_URL = 'https://script.google.com/macros/s/AKfycbx4ncVkSKRLIkiisyftbtONCYI1OIbklzTsv4_h5gy4FX2ElcA1sWpKCA51O14cEj3p/exec'; 
const LIFF_ID = '2008907691-7ntMtfbA'; 

new Vue({
    el: '#app',
    data: {
        liffId: LIFF_ID,
        userId: '',
        userAvatar: '', // å­˜è‡ªå·±çš„é ­åƒ
        zones: [],
        isDriver: false,
        driverName: '',
        currentZoneId: '',
        loading: true,
        loadingText: 'ç³»çµ±é€£ç·šä¸­...',
        showRegModal: false,
        showDriverListModal: false,
        // æ–°ç‰ˆè¨»å†Šè¡¨å–®è³‡æ–™
        regForm: { 
            name: '', plate: '', phone: '', 
            carModel: '', capacity: '', features: [], payment: [] 
        },
        featureOptions: ['å¯µç‰©å‹å–„', 'ç„¡è¸è»Š', 'è‹±èªOK', 'å¯è¼‰å–®è»Š', 'è¼”åŠ©ä¸Šä¸‹è»Š'],
        paymentOptions: ['æ•¬è€å¡æ„›å¿ƒå¡', 'LinePay', 'åˆ·å¡', 'è¡—å£'],
        activeDrivers: []
    },
    async mounted() {
        await this.initLiff();
    },
    methods: {
        async initLiff() {
            try {
                await liff.init({ liffId: this.liffId });
                if (!liff.isLoggedIn()) {
                    liff.login();
                    return;
                }
                const profile = await liff.getProfile();
                this.userId = profile.userId;
                this.userAvatar = profile.pictureUrl; // æŠ“å–é ­åƒ
                this.fetchLobby();
            } catch (err) {
                alert('LIFF åˆå§‹åŒ–å¤±æ•—');
                this.loading = false;
            }
        },
        async fetchLobby() {
            this.loadingText = 'è®€å–æ’ç­ç‹€æ³...';
            try {
                const res = await axios.post(GAS_URL, JSON.stringify({
                    type: 'getLobbyData', userId: this.userId
                }));
                this.zones = res.data.zones;
                this.isDriver = res.data.isDriver;
                if (this.isDriver && res.data.driverData) {
                    this.driverName = res.data.driverData[1];
                    this.currentZoneId = res.data.driverData[5];
                }
                this.loading = false;
            } catch (err) {
                this.loading = false;
            }
        },
        getZoneName(id) {
            const z = this.zones.find(item => item.id === id);
            return z ? z.name : 'æœªçŸ¥å€åŸŸ';
        },
        async leaveZone() {
            if(!confirm('ç¢ºå®šè¦ä¸‹ç­/é€€å‡ºæ’ç­å—ï¼Ÿ')) return;
            this.loading = true;
            try {
                await axios.post(GAS_URL, JSON.stringify({ type: 'leaveZone', userId: this.userId }));
                this.fetchLobby();
            } catch(e) { alert('é€£ç·šå¤±æ•—'); this.loading = false; }
        },
        async submitRegister() {
            const f = this.regForm;
            if(!f.name || !f.plate || !f.phone || !f.carModel || !f.capacity) 
                return alert('è«‹å¡«å¯«å®Œæ•´è³‡æ–™ (å«è»Šå‹èˆ‡äººæ•¸)');
            
            this.loading = true;
            try {
                const res = await axios.post(GAS_URL, JSON.stringify({
                    type: 'register',
                    userId: this.userId,
                    avatar: this.userAvatar, // è‡ªå‹•å¸¶å…¥é ­åƒ
                    name: f.name,
                    plate: f.plate,
                    phone: f.phone,
                    carModel: f.carModel,
                    capacity: f.capacity,
                    features: f.features.join(','), // é™£åˆ—è½‰å­—ä¸²
                    payment: f.payment.join(',')    // é™£åˆ—è½‰å­—ä¸²
                }));
                alert(res.data.msg);
                if(res.data.status === 'success') {
                    liff.closeWindow();
                }
            } catch(e) { alert('è¨»å†Šå¤±æ•—'); }
            this.loading = false;
        },
        enterZone(zone) {
            if (this.isDriver && zone.count >= 10) return alert('æ­¤å€å·²æ»¿ï¼');
            this.loadingText = 'å®šä½ä¸­...';
            this.loading = true;
            if (!navigator.geolocation) {
                this.loading = false; return alert('ä¸æ”¯æ´ GPS');
            }
            navigator.geolocation.getCurrentPosition(async (pos) => {
                try {
                    const res = await axios.post(GAS_URL, JSON.stringify({
                        type: 'enterZone',
                        userId: this.userId,
                        zoneId: zone.id,
                        userLat: pos.coords.latitude,
                        userLng: pos.coords.longitude
                    }));
                    this.loading = false;
                    if (res.data.status === 'error') {
                        alert(res.data.msg);
                    } else if (res.data.role === 'driver') {
                        alert(res.data.msg);
                        this.fetchLobby();
                    } else if (res.data.role === 'passenger') {
                        this.activeDrivers = res.data.drivers;
                        this.showDriverListModal = true;
                    }
                } catch (e) { this.loading = false; alert('å¿™ç·šä¸­'); }
            }, (err) => { this.loading = false; alert('è«‹é–‹å•Ÿ GPS'); }, { enableHighAccuracy: true });
        },
        selectDriver(driver) {
            // â˜…â˜…â˜… æ–°ç‰ˆåç‰‡ Flex Message â˜…â˜…â˜…
            const flexMessage = {
                type: 'flex',
                altText: `æ¨è–¦è»Šè¼› ${driver.plate}`,
                contents: {
                    type: "bubble",
                    header: {
                        type: "box", layout: "vertical",
                        contents: [
                            { type: "text", text: "ğŸš– æ¨è–¦è»Šè¼›", color: "#856404", size: "xs", weight: "bold" }
                        ],
                        backgroundColor: "#FFF3CD", paddingTop: "15px", paddingBottom: "15px"
                    },
                    hero: {
                        type: "box", layout: "vertical",
                        contents: [
                            // é€™è£¡é¡¯ç¤º LINE å¤§é ­è²¼
                            {
                                type: "image", url: driver.avatar || "https://via.placeholder.com/150",
                                size: "lg", aspectMode: "cover", aspectRatio: "1:1",
                                action: { type: "uri", uri: driver.avatar || "https://line.me" },
                                margin: "md"
                            },
                            { type: "text", text: driver.plate, size: "3xl", weight: "bold", align: "center", margin: "md" },
                            { type: "text", text: `${driver.carModel} (${driver.capacity}äºº)`, size: "sm", color: "#666666", align: "center" }
                        ],
                        paddingBottom: "10px"
                    },
                    body: {
                        type: "box", layout: "vertical",
                        contents: [
                            { type: "separator", margin: "md", color: "#eeeeee" },
                            // é¡¯ç¤ºç‰¹è³ªæ¨™ç±¤
                            {
                                type: "box", layout: "horizontal", margin: "md", spacing: "sm",
                                contents: driver.features ? driver.features.split(',').map(f => ({
                                    type: "text", text: f, size: "xxs", color: "#ffffff",
                                    backgroundColor: "#1DB446", paddingAll: "xs", cornerRadius: "sm", flex: 0, align: "center"
                                })) : [{ type: "text", text: "å„ªè³ªå¸æ©Ÿ", size: "xxs", color: "#999999" }]
                            },
                            // é¡¯ç¤ºæ”¯ä»˜æ–¹å¼
                            {
                                type: "box", layout: "baseline", margin: "md", spacing: "sm",
                                contents: [
                                    { type: "text", text: "æ”¯ä»˜", color: "#aaaaaa", size: "xs", flex: 2 },
                                    { type: "text", text: driver.payment || "ç¾é‡‘", wrap: true, color: "#666666", size: "xs", flex: 5 }
                                ]
                            }
                        ]
                    },
                    footer: {
                        type: "box", layout: "vertical", spacing: "sm",
                        contents: [
                            {
                                type: "button", style: "primary", color: "#00C300",
                                action: { type: "uri", label: `ğŸ“ å‘¼å« ${driver.name}`, uri: `tel:${driver.phone}` }
                            }
                        ],
                        paddingAll: "20px"
                    }
                }
            };
            liff.sendMessages([flexMessage]).then(() => liff.closeWindow());
        }
    }
});
</script>
</body>
</html>
