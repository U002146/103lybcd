<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>èŠ±è“®è»ŠéšŠ - é›»å­åœç±¬ç¹ªè£½å™¨</title> <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <style>
        body { margin: 0; padding: 0; overflow: hidden; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; }
        #map { height: 100vh; width: 100vw; z-index: 1; }
        
        /* æ‡¸æµ®æ§åˆ¶é¢æ¿ - é‡å° iPad å„ªåŒ–å°ºå¯¸ */
        .control-panel {
            position: absolute;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 1000;
            display: flex;
            gap: 15px;
            background: rgba(255, 255, 255, 0.9);
            padding: 15px;
            border-radius: 20px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            backdrop-filter: blur(5px);
        }

        .btn {
            padding: 12px 24px;
            font-size: 18px; /* å¤§å­—é«” */
            font-weight: bold;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            transition: transform 0.1s;
        }
        .btn:active { transform: scale(0.95); }
        
        .btn-add { background-color: #3498db; color: white; } /* è—è‰²ï¼šæ¨™è¨˜ */
        .btn-undo { background-color: #f39c12; color: white; } /* æ©˜è‰²ï¼šå¾©åŸ */
        .btn-clear { background-color: #e74c3c; color: white; } /* ç´…è‰²ï¼šæ¸…é™¤ */
        .btn-save { background-color: #2ecc71; color: white; } /* ç¶ è‰²ï¼šè¼¸å‡º */

        /* é ‚éƒ¨æç¤ºæ¢ */
        .header-bar {
            position: absolute;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 1000;
            background: rgba(0,0,0,0.7);
            color: white;
            padding: 8px 20px;
            border-radius: 50px;
            font-size: 16px;
            pointer-events: none; /* è®“é»æ“Šç©¿é€ */
        }
    </style>
</head>
<body>

    <div class="header-bar">ğŸ“ é»æ“Šåœ°åœ–ä»¥å»ºç«‹åœç±¬é ‚é» (iPad Pencil Ready)</div>

    <div id="map"></div>

    <div class="control-panel">
        <button class="btn btn-undo" onclick="undoPoint()">â†©ï¸ å¾©åŸ</button>
        <button class="btn btn-clear" onclick="clearMap()">ğŸ—‘ï¸ é‡ç•«</button>
        <button class="btn btn-save" onclick="exportCoords()">âœ… è¼¸å‡ºä»£ç¢¼</button>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <script>
        const VERSION = "v3.2"; // iPad å„ªåŒ–ç‰ˆ - æ”¯æ´è§¸æ§èˆ‡ SweetAlert è¼¸å‡º

        // 1. åˆå§‹åŒ–åœ°åœ– (é è¨­èŠ±è“®è»Šç«™)
        // ä½¿ç”¨ OpenStreetMap (å…è²»ï¼Œç„¡éœ€ API Key)
        var map = L.map('map', { tap: true }).setView([23.9936, 121.6015], 16);

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; OpenStreetMap contributors'
        }).addTo(map);

        // 2. è®Šæ•¸å„²å­˜
        var points = [];      // å­˜åº§æ¨™ [lat, lng]
        var markers = [];     // å­˜æ¨™è¨˜åœ–å±¤
        var polygon = null;   // å­˜å¤šé‚Šå½¢åœ–å±¤

        // 3. é»æ“Šåœ°åœ–äº‹ä»¶ (æ”¯æ´æ‰‹æŒ‡/ç­†)
        map.on('click', function(e) {
            var lat = e.latlng.lat;
            var lng = e.latlng.lng;
            addPoint(lat, lng);
        });

        function addPoint(lat, lng) {
            // å­˜å…¥æ•¸æ“š
            points.push([lat, lng]);

            // ç•«é» (Marker)
            var marker = L.circleMarker([lat, lng], {
                color: '#e74c3c',
                fillColor: '#fff',
                fillOpacity: 1,
                radius: 6
            }).addTo(map);
            markers.push(marker);

            // ç•«ç·š/é¢ (Polygon)
            drawPolygon();
        }

        function drawPolygon() {
            // å¦‚æœèˆŠçš„æœ‰ç•«ï¼Œå…ˆç§»é™¤
            if (polygon) {
                map.removeLayer(polygon);
            }
            
            // è‡³å°‘3é»æ‰èƒ½æ§‹æˆé¢ï¼Œä½†ç‚ºäº†è¦–è¦ºå›é¥‹ï¼Œ2é»æˆ‘å€‘ç•«ç·šï¼Œ3é»ä»¥ä¸Šç•«ç´…å€
            if (points.length > 0) {
                polygon = L.polygon(points, {
                    color: '#3498db',
                    fillColor: '#3498db',
                    fillOpacity: 0.3,
                    weight: 3
                }).addTo(map);
            }
        }

        // 4. åŠŸèƒ½æŒ‰éˆ•é‚è¼¯
        function undoPoint() {
            if (points.length === 0) return;
            
            // ç§»é™¤æ•¸æ“š
            points.pop();
            
            // ç§»é™¤åœ°åœ–ä¸Šçš„æœ€å¾Œä¸€å€‹æ¨™è¨˜
            var lastMarker = markers.pop();
            map.removeLayer(lastMarker);

            // é‡ç¹ªå¤šé‚Šå½¢
            drawPolygon();
        }

        function clearMap() {
            points = [];
            // ç§»é™¤æ‰€æœ‰æ¨™è¨˜
            markers.forEach(m => map.removeLayer(m));
            markers = [];
            // ç§»é™¤å¤šé‚Šå½¢
            if (polygon) map.removeLayer(polygon);
            polygon = null;
        }

        function exportCoords() {
            if (points.length < 3) {
                Swal.fire({
                    icon: 'warning',
                    title: 'é»æ•¸ä¸è¶³',
                    text: 'é›»å­åœç±¬è‡³å°‘éœ€è¦ 3 å€‹é»æ‰èƒ½åœæˆä¸€å€‹å€åŸŸå–”ï¼',
                    confirmButtonColor: '#3498db'
                });
                return;
            }

            // æ ¼å¼åŒ–ç‚º JSON å­—ä¸²
            const jsonOutput = JSON.stringify(points, null, 2);

            // ä½¿ç”¨ SweetAlert é¡¯ç¤ºä¸¦è¤‡è£½
            Swal.fire({
                title: 'åœç±¬åº§æ¨™ç”¢ç”Ÿå®Œç•¢',
                html: `<p>å·²ç”Ÿæˆ ${points.length} å€‹é ‚é»åº§æ¨™</p>
                       <textarea id="codeArea" style="width:100%; height:150px; border-radius:10px; border:1px solid #ccc; padding:10px;">${jsonOutput}</textarea>`,
                showCancelButton: true,
                confirmButtonText: 'ğŸ“‹ è¤‡è£½ä»£ç¢¼',
                cancelButtonText: 'é—œé–‰',
                confirmButtonColor: '#2ecc71',
                preConfirm: () => {
                    var copyText = document.getElementById("codeArea");
                    copyText.select();
                    document.execCommand("copy");
                }
            }).then((result) => {
                if (result.isConfirmed) {
                    Swal.fire({
                        icon: 'success',
                        title: 'å·²è¤‡è£½ï¼',
                        text: 'è«‹å›åˆ° VS Code è²¼ä¸Šå³å¯ã€‚',
                        timer: 1500,
                        showConfirmButton: false
                    });
                }
            });
        }
    </script>
</body>
</html> // v3.2 è§¸æ§å„ªåŒ–ç‰ˆ
